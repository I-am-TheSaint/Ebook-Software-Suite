#Region ;**** Directives created by AutoIt3Wrapper_GUI ****
#AutoIt3Wrapper_icon=Reader.ico
#AutoIt3Wrapper_Add_Constants=n
#EndRegion ;**** Directives created by AutoIt3Wrapper_GUI ****
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;                                                                                       ;;
;;  AutoIt Version: 3.3.0.0                                                              ;;
;;                                                                                       ;;
;;  Template AutoIt script.                                                              ;;
;;                                                                                       ;;
;;  AUTHOR:  TheSaint <thsaint@ihug.com.au>                                              ;;
;;                                                                                       ;;
;;  SCRIPT FUNCTION:   Program to query an Amazon ebook page and return current price    ;;
;;                                                                                       ;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; GUI FUNCTIONS
; ChangePriceGUI(), GetModeFromPromptGUI(), ImageDataGUI(), SettingsGUI()
; FUNCTIONS
; AddEbookToAnotherUser($how), AddNewEbookToList($val), AddPrivateComment(), AddSelectedToQueryList($from)
; AddSharedComment(), AddToListForExcel(), AddToOrRemoveFromQueryList($from), BackupAllUsersFile(), BackupUserFile()
; BoughtThisEbook(), CheckForConnection(), CheckForNonFavorite(), CheckFromOtherUser($val), CheckIfLowIsZero()
; CheckIfOnlyDigits($digit), CheckIfSweet(), CheckOnSortRequirement($del), CreateContextMenuForListView()
; DeleteContextMenuForListView(), DetermineComment(), DisableOrEnable($cstate), DisableListChoices()
; EditTitleOrAuthorName(), FillTheListWithEbooks(), GetAllChanges(), GetAndSetOtherData(), GetAnotherImageEntry()
; GetBookDescription($pud), GetDetailReport(), GetDifferenceToLastPrice(), GetExchangeRate($val), GetImageData()
; GetImageDataForGUI(), GetLastControlID($men), GetOtherDetails(), GetPreviousSearches(), GetPriceDifferenceResult()
; GetPublisher(), GetQueryTimeTaken(), GetSaveSlots(), GetSelectedIndex($for)
; GetSetCorrectLineColor($row), GetSetCurrentStateAfterChanges(), GetTagSettings(), GetTheAuthor()
; GetTheASIN(), GetValueForPrice($value), GetValueSettings(), InsertHtmlImage(), PriceFixAndTabCheck()
; QueryCurrentPrice($val), QueryNonFavorites(), RemoveAllFromQueryList(), RemoveSelectedEbook()
; RemoveSelectedFromQueryList($from), RemoveSpacesFromPrice($key, $value), ReportForQuery(), ResetQueryAssignments()
; RestoreFromQueryBackup(), RestoreLineColor(), RestorePreQuerySlotValues(), SaveReportToFile()
; SetItemAsFavorite(), SetTheColumnWidths(), SetUsernameAndEbooks(), SetWinOnTop(), ShowNoResultSplash()
; SortByColumnNumber(), StopCheck(), StoreInitialPrices(), TidyUpSummary(), TimeCheck()
; TryToActivateAmazonTab()

; JUMP POINTS
; CONTROLS, CONTEXT_MENU, OS_SETTINGS, SETTINGS, GuiSetState(), Exit

; Script generated by AutoBuilder 0.8 Prototype

#include <Constants.au3>
#include <GUIConstantsEx.au3>
#include <Misc.au3>
#include <WindowsConstants.au3>
#include <ButtonConstants.au3>
#include <ListViewConstants.au3>
#include <EditConstants.au3>
#include <StaticConstants.au3>
#include <ComboConstants.au3>
#include <UpdownConstants.au3>
#include <GuiListView.au3>
#include <GuiComboBox.au3>
#include <Inet.au3>
#include <Date.au3>
#include <File.au3>
#include <IE.au3>
#include <WinAPI.au3>
#include <Array.au3>
#include "Excel_UDF.au3"

Local $exe, $handle, $pid, $script, $status, $w, $wins

Global $Scriptname = "KindEbook Wishlist v8.5"

$status = _Singleton("kindebook-wishlist-thsaint", 1)
If $status = 0 Then
	; Attempt to retore and activate a non-active or minimized window.
	If @Compiled = 1 Then
		$pid = ProcessExists(@ScriptName)
		$exe = @ScriptName
	Else
		$pid = ProcessExists("AutoIt3.exe")
		$exe = "AutoIt3.exe"
	EndIf
	$script = @AutoItPID
	If $script <> $pid Then
		$wins = WinList($Scriptname, "")
		For $w = 1 to $wins[0][0]
			$handle = $wins[$w][1]
			If WinGetProcess($handle, "") = $pid Then
				WinSetState($handle, "", @SW_RESTORE)
				WinActivate($handle, "")
				ExitLoop
			EndIf
		Next
		Exit
	EndIf
EndIf

Global $Button_add, $Button_changed, $Button_clip, $Button_find, $Button_i, $Button_ontop
Global $Button_opts, $Button_query, $Button_rem, $Button_x
Global $Checkbox_nofav, $Checkbox_quall, $Checkbox_qufav, $Checkbox_quit, $Checkbox_sort
Global $Combo_comm, $Combo_find, $Combo_tag, $Combo_user, $Combo_val, $Combo_where
Global $Edit_com, $Edit_rep, $Group_comm, $Group_list, $Group_user, $Input_comms, $Input_rate
Global $Input_URL, $Input_where
Global $Item_add, $Item_author, $Item_change, $Item_check, $Item_clear, $Item_compall, $Item_compare
Global $Item_coplist, $Item_copy, $Item_data, $Item_diff, $Item_edit, $Item_end, $Item_entry
Global $Item_excel, $Item_exempt, $Item_failed, $Item_favorite, $Item_find, $Item_goauthor, $Item_gotitle
Global $Item_history, $Item_image, $Item_jpeg, $Item_kobo, $Item_last, $Item_list, $Item_mode, $Item_move
Global $Item_movlist, $Item_notes, $Item_others, $Item_paid, $Item_preord, $Item_preorder, $Item_price
Global $Item_private, $Item_publish, $Item_query, $Item_receiver, $Item_relocate, $Item_rem, $Item_rename
Global $Item_report, $Item_restore, $Item_save, $Item_search, $Item_show, $Item_skip, $Item_start
Global $Item_stored, $Item_summary, $Item_sweet, $Item_time, $Item_title, $Item_totlist
Global $Item_url, $Item_urls, $Item_user, $Item_view, $Item_warn, $Item_web, $Item_wipe
Global $Label_find, $Label_rate, $Label_time, $Label_wait, $Listview_ebooks, $Menu_list, $Menu_query
Global $Submenu_detail, $Submenu_entry, $Submenu_list, $Submenu_missing, $Submenu_notes
Global $Submenu_price, $Submenu_queries, $Submenu_save, $Submenu_users, $Submenu_wiki

Global $Copy_Item, $Edit_Item, $Entry_Item, $Excel_Item, $Favorite_Item, $Image_Item, $Move_Item
Global $Notes_Item, $Paid_Item, $Private_Item, $Sweet_Item, $Warn_Item

Global $Item_remlist, $remlist, $cmdlne, $count, $file, $fixfle, $pipes, $urlfld, $urlini

Global $activate, $addit, $advice, $advise, $alert, $allchars, $alltags, $altered, $ans, $ASIN, $assigned
Global $asterisk, $aut, $author, $backup, $backups, $basic, $begin, $bigid, $blanks, $bought, $browdel
Global $browser, $c, $cat, $catfle, $ceiling, $changed, $changes, $char, $chars, $check, $checktot
Global $chosen, $chrcnt, $clear, $clip, $clipboard, $cliptxt, $colnum, $comfle, $comment, $comments
Global $connection, $continue, $contxtmenu, $coplist, $copyto, $copywait, $cost, $csign, $cstate, $ctrl
Global $curr, $currency, $current, $currval, $curval, $d, $data, $date, $defchars, $deftags, $del, $delay
Global $dif, $diff, $differ, $digit, $disable, $div, $dll, $e, $ebooktxt, $end, $endpos, $entry, $ents
Global $errcol, $errors, $excel, $exchange, $exchprog, $excoms, $excon, $exdel, $exempt, $exist, $extra
Global $failed, $failtxt, $favorite, $favorites, $field, $find, $first, $fixed, $flash, $fndtxt, $for
Global $found, $from, $ftyp, $getcnt, $getot, $googcon, $googet, $googpart1, $googpart2, $googpart3, $goto
Global $hash, $hide, $high, $higher, $highval, $how, $hrs, $htmfle, $html, $http, $icoDwn, $icofle, $icoI
Global $icoN, $icoS, $icoUp, $icoX, $ID, $image, $ImageGUI, $imgfld, $imgfle, $include, $ind, $indx
Global $inifle, $inputxt1, $inputxt2, $inputxt3, $instant, $IP, $item, $job, $jpeg, $jpgsav, $keep, $key
Global $kindtxt, $kobo, $kobocheck, $koboexe, $kobofle, $koboquery, $last, $lasturl, $leeway, $left, $lescol
Global $limit, $link, $list, $lne, $logfile, $loop, $low, $lower, $lowid, $lowval, $lvtop, $match, $max, $men
Global $minclip, $mincol, $mins, $missing, $mode, $modes, $morcol, $moredel, $movlist, $msg, $multi, $n
Global $name, $namfle, $nons, $noprice, $notepad, $now, $num, $nums, $oBody, $oIE, $onedel, $ontop, $orders
Global $original, $other, $others, $paid, $params, $passes, $pause, $pcsets, $pingerr, $pos, $prcfle, $preord
Global $preorder, $press, $prev, $previous, $prevval, $price, $pricefld, $PriceQueryGUI, $prices, $pricetxt
Global $prime, $prior, $private, $progman, $pth, $pubdate, $publisher, $pud, $quall, $query, $querybak
Global $querytxt, $quit, $random, $range, $rate, $read, $realtot, $rec, $record, $reduced, $relax, $remain
Global $rep, $repeat, $repfle, $replace, $replaced, $replines, $report, $reportmsg, $reps, $res, $resort
Global $restof, $result, $resulted, $rndtrip, $row, $rows, $s, $save, $saved, $savpth, $scriptdir, $searchadd
Global $searches, $second, $secondary, $secondfavs, $secs, $selected, $series, $server, $shell, $shift, $show
Global $shut, $single, $skicol, $skip, $skipit, $sleep, $slick, $slots, $sorted, $splash, $split, $start
Global $started, $startpos, $starval, $stop, $store, $sum, $sumfiles, $sumfld, $sumfle, $summary, $swecol
Global $sweet, $sweetval, $t, $tabclose, $tabdel, $tag, $tagreps, $tags, $test, $text, $time, $timechk
Global $timeout, $timer, $tit, $title, $titlecheck, $titletxt, $tmpfle, $top, $totchans, $totlist, $txtpth
Global $txtval, $up, $updated, $URL, $usd, $user, $user32, $users, $usertmp, $v, $val, $valreps, $value
Global $wait, $waitcol, $warning, $webfle, $webtxt, $what, $when, $where, $whom, $wikurl, $win, $wincheck
Global $winpos, $wintit, $wipe

Global $etext, $items, $l, $lines, $linetxt

$inifle = @ScriptDir & "\Settings.ini"
$pcsets = IniRead($inifle, "Settings Mode", "pc", "")
If $pcsets = "" Then
	$pcsets = "Laptop"
	IniWrite($inifle, "Settings Mode", "pc", $pcsets)
	$scriptdir = @ScriptDir
Else
	If $pcsets = "Laptop" Then
		$scriptdir = @ScriptDir
	ElseIf $pcsets = "Netbook" Then
		$ans = MsgBox(262193, "Mode Alert & Query", _
			"WARNING - The program is currently" & @LF & _
			"set in Netbook settings Mode, which" & @LF & _
			"means it is using the 'Settings.ini' file" & @LF & _
			"and other files found in the Netbook" & @LF & _
			"sub-folder." & @LF & @LF & _
			"OK = Continue." & @LF & _
			"CANCEL = Revert to Laptop Mode." & @LF & @LF & _
			"NOTE - Revert does not change the" & @LF & _
			"saved setting, just changes what is" & @LF & _
			"set for the current session only. To" & @LF & _
			"make a permanent change, modify" & @LF & _
			"the mode entry manually. This can" & @LF & _
			"be found in the 'Settings.ini' file in" & @LF & _
			"the main program folder. Just wipe" & @LF & _
			"or make a change so 'pc=Laptop'" & @LF & _
			"in the 'Settings Mode' section.", 0)
		If $ans = 1 Then
			$scriptdir = @ScriptDir & "\Netbook"
		ElseIf $ans = 2 Then
			$pcsets = "Laptop"
			$scriptdir = @ScriptDir
		EndIf
		If FileExists($scriptdir) = 1 Then
			$inifle = $scriptdir & "\Settings.ini"
		Else
			$pcsets = "Laptop"
			$scriptdir = @ScriptDir
		EndIf
	EndIf
EndIf

$backups = $scriptdir & "\Backups"
$catfle = $scriptdir & "\Catalog.ini"
$comfle = $scriptdir & "\Comments.ini"
$ebooktxt = $scriptdir & "\Html.txt"
$exchprog = $scriptdir & "\Exchange Rate Query.exe"
$failtxt = $scriptdir & "\Failed.txt"
$fixfle = @ScriptDir & "\Fixfile.lnk"
$htmfle = $scriptdir & "\Blank.html"
$imgfld = $scriptdir & "\Image Data"
$koboexe = @ScriptDir & "\KoboChecker.exe"
$logfile = $scriptdir & "\Log.txt"
$notepad = @WindowsDir & "\Notepad.exe "
$pricefld = $scriptdir & "\Prices"
$querybak = $backups & "\Restore.ini"
$querytxt = $scriptdir & "\Query.txt"
$repfle = $scriptdir & "\Report.txt"
$sumfld = $scriptdir & "\Summaries"
$webfle = $scriptdir & "\Webcopy.txt"
$wincheck = $scriptdir & "\CheckForWin.exe"

; Testing Only
;~ GetModeFromPromptGUI()
;~ Exit

If Not FileExists($backups) Then DirCreate($backups)

If Not FileExists($ebooktxt) Then _FileCreate($ebooktxt)

If Not FileExists($querytxt) Then _FileCreate($querytxt)

_FileCreate($failtxt)

If Not FileExists($htmfle) Then
	_FileCreate($htmfle)
	$basic = "<html>" & @CRLF & "<head>" & @CRLF & "<title>Blank Page</title>" & @CRLF & "</head>" & @CRLF &  _
		@CRLF & "<body>" & @CRLF & "</body>" & @CRLF & @CRLF & "</html>"
	_FileWriteToLine($htmfle, 1, $basic)
EndIf

If Not FileExists($imgfld) Then DirCreate($imgfld)

$users = IniRead($inifle, "User", "names", "")

If Not FileExists($sumfld) Then DirCreate($sumfld)
$sumfiles = IniRead($inifle, "Summary", "files", "")
If $sumfiles = "" Then
	If $users = "" Then
		$sumfiles = 4
	Else
		$ans = MsgBox(262179, "Update Query (1)", _
			"As a file size reduction measure, the program is now writing" & @LF & _
			"any Summary to a separate text file for each ebook, based" & @LF & _
			"on the ebook ID and stored in a folder named 'Summaries'." & @LF & @LF & _
			"Do you want the reduction to occur for previous listings?" & @LF & @LF & _
			"YES = Reduce now (RECOMMENDED)." & @LF & _
			"NO = Not now, but ask again." & @LF & _
			"CANCEL = No, and don't ask again." & @LF & @LF & _
			"WARNING - The reduction process for previous listings is" & @LF & _
			"likely to take a while, if a large number of ebooks exist." & @LF & @LF & _
			"This is a once only process, including ALL users.", 0)
		If $ans = 6 Then
			$sumfiles = 1
			SplashTextOn("", "Reducing!", 200, 140, -1, -1, 33)
			IniWrite($inifle, "Summary Reduction", "start", _Now())
			$check = StringSplit($users, "|", 1)
			For $c = 1 To $check[0]
				$name = $check[$c]
				$namfle = $scriptdir & "\" & $name & ".ini"
				If FileExists($namfle) Then
					;$entries = IniReadSectionNames($namfle)
					;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
					;	$nmb = StringLen(_ArrayToString($entries, "|", 1))
					;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
					$entries = FileRead($namfle)
					$entries = StringSplit($entries, @LF, 1)
					If Not @error Then
						;$count = $entries[0]
						;For $u = 1 To $count
						;	$IDNB = $entries[$u]
						$u = 0
						$lines = $entries[0]
						$count = $lines
						For $l = 1 To $lines
							$linetxt = $entries[$l]
							If StringLeft($linetxt, 1) = "[" Then
								$IDNB = StringTrimLeft($linetxt, 1)
								$IDNB = StringStripCR($IDNB)
								$IDNB = StringTrimRight($IDNB, 1)
								;MsgBox(262192, "Line Text", $IDNB, 0, $PriceQueryGUI)
								If $IDNB <> "" Then
									$u = $u + 1
									$sumfle = $sumfld & "\" & $IDNB & ".txt"
									$summary = IniRead($namfle, $IDNB, "summary", "")
									If $summary <> "" Then
										If FileExists($sumfle) Then
											$read = StringStripWS(FileRead($sumfle), 8)
											If $read = "" Then
												_FileCreate($sumfle)
												FileWrite($sumfle, $summary)
											EndIf
										Else
											FileWrite($sumfle, $summary)
										EndIf
									EndIf
									If FileExists($sumfle) Then IniDelete($namfle, $IDNB, "summary")
									SplashTextOn("", $u & " of " & $count & @LF & @LF & "(Reducing)" & @LF & @LF & $name, 200, 140, -1, -1, 33)
								EndIf
							Else
								$count = $count - 1
							EndIf
						Next
					EndIf
				EndIf
			Next
			IniWrite($inifle, "Summary Reduction", "end", _Now())
			SplashOff()
		ElseIf $ans = 7 Then
			;$sumfiles = ""
		ElseIf $ans = 2 Then
			$sumfiles = 4
		EndIf
	EndIf
	IniWrite($inifle, "Summary", "files", $sumfiles)
EndIf

If Not FileExists($pricefld) Then DirCreate($pricefld)
$prices = IniRead($inifle, "Prices", "files", "")
If $prices = "" Then
	If $users = "" Then
		$prices = 4
	Else
		$ans = MsgBox(262179, "Update Query (2)", _
			"As a file size reduction measure, the program is now writing" & @LF & _
			"any Changes to a separate text file for each ebook, based" & @LF & _
			"on the ebook ID and stored in a folder named 'Prices'." & @LF & @LF & _
			"Do you want the reduction to occur for previous listings?" & @LF & @LF & _
			"YES = Reduce now (RECOMMENDED)." & @LF & _
			"NO = Not now, but ask again." & @LF & _
			"CANCEL = No, and don't ask again." & @LF & @LF & _
			"WARNING - The reduction process for previous listings is" & @LF & _
			"likely to take a while, if a large number of ebooks exist." & @LF & @LF & _
			"This is a once only process, including ALL users.", 0)
		If $ans = 6 Then
			$prices = 1
			SplashTextOn("", "Reducing!", 200, 140, -1, -1, 33)
			IniWrite($inifle, "Prices Reduction", "start", _Now())
			$check = StringSplit($users, "|", 1)
			For $c = 1 To $check[0]
				$name = $check[$c]
				$namfle = $scriptdir & "\" & $name & ".ini"
				If FileExists($namfle) Then
					;$entries = IniReadSectionNames($namfle)
					;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
					;	$nmb = StringLen(_ArrayToString($entries, "|", 1))
					;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
					$entries = FileRead($namfle)
					$entries = StringSplit($entries, @LF, 1)
					If Not @error Then
						;$count = $entries[0]
						;For $u = 1 To $count
						;	$IDNB = $entries[$u]
						$u = 0
						$lines = $entries[0]
						$count = $lines
						For $l = 1 To $lines
							$linetxt = $entries[$l]
							If StringLeft($linetxt, 1) = "[" Then
								$IDNB = StringTrimLeft($linetxt, 1)
								$IDNB = StringStripCR($IDNB)
								$IDNB = StringTrimRight($IDNB, 1)
								;MsgBox(262192, "Line Text", $IDNB, 0, $PriceQueryGUI)
								If $IDNB <> "" Then
									$u = $u + 1
									$prcfle = $pricefld & "\" & $IDNB & ".txt"
									$changes = IniRead($namfle, $IDNB, "changes", "")
									If $changes <> "" Then
										If FileExists($prcfle) Then
											$read = StringStripWS(FileRead($prcfle), 8)
											If $read = "" Then
												_FileCreate($prcfle)
												FileWrite($prcfle, $changes)
											EndIf
										Else
											FileWrite($prcfle, $changes)
										EndIf
									EndIf
									If FileExists($prcfle) Then IniDelete($namfle, $IDNB, "changes")
									SplashTextOn("", $u & " of " & $count & @LF & @LF & "(Reducing)" & @LF & @LF & $name, 200, 140, -1, -1, 33)
								EndIf
							Else
								$count = $count - 1
							EndIf
						Next
					EndIf
				EndIf
			Next
			IniWrite($inifle, "Prices Reduction", "end", _Now())
			SplashOff()
		ElseIf $ans = 7 Then
			;$prices = ""
		ElseIf $ans = 2 Then
			$prices = 4
		EndIf
	EndIf
	IniWrite($inifle, "Prices", "files", $prices)
EndIf

If $CmdLine[0] <> "" Then
	$cmdlne = $CmdLine[1]
	If $cmdlne <> "/fix" Then $cmdlne = ""
Else
	$cmdlne = ""
	If Not FileExists($fixfle) Then
		If @Compiled = 1 Then FileCreateShortcut(@ScriptFullPath, $fixfle, @ScriptDir, "/fix", "Fix seemingly corrupt current user file.", @ScriptDir & "\Fix.ico")
	EndIf
EndIf

; GUI CREATE
$left = IniRead($inifle, "Program Window", "left", -1)
$top = IniRead($inifle, "Program Window", "top", -1)
$PriceQueryGUI = GuiCreate($Scriptname, 855, 530, $left, $top, $WS_OVERLAPPED + $WS_CAPTION _
							+ $WS_SYSMENU + $WS_VISIBLE + $WS_CLIPSIBLINGS + $WS_MINIMIZEBOX, $WS_EX_TOPMOST)
; CONTROLS
$Group_list = GuiCtrlCreateGroup("List Of Kindle Ebooks", 10, 10, 835, 440)
;
$Label_find = GUICtrlCreateLabel("FIND", 20, 25, 43, 21, $SS_CENTER + $SS_CENTERIMAGE + $SS_SUNKEN + $SS_NOTIFY)
GUICtrlSetBkColor($Label_find, 0x000000)
GUICtrlSetColor($Label_find, 0xF0F030)
GUICtrlSetFont($Label_find, 7, 600, 0, "Small Fonts")
$Combo_where = GUICtrlCreateCombo("", 63, 25, 62, 21)
GUICtrlSetTip($Combo_where, "Where to Search!")
$Combo_find = GUICtrlCreateCombo("", 125, 25, 125, 21)
GUICtrlSetTip($Combo_find, "What to Find!")
$Button_find = GuiCtrlCreateButton("", 253, 25, 20, 20, $BS_ICON)
GUICtrlSetTip($Button_find, "Search for selected in title or author!")
;
$Button_changed = GuiCtrlCreateButton("*", 278, 25, 20, 20, $BS_ICON)
GUICtrlSetTip($Button_changed, "List of ebooks where current price has changed!")
;
$Input_where = GUICtrlCreateInput("", 302, 25, 220, 21)
GUICtrlSetTip($Input_where, "Selected entry column text for Search!")
;
$Button_clip = GuiCtrlCreateButton("C", 525, 25, 20, 20, $BS_ICON)
GUICtrlSetTip($Button_clip, "Copy Author &/or Title or MOBI-ASIN to clipboard!")
;
$Label_wait = GUICtrlCreateLabel("Please Wait!", 550, 25, 210, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_SUNKEN)
$waitcol = 0xF00000
GUICtrlSetBkColor($Label_wait, 0x00F000)
GUICtrlSetColor($Label_wait, $waitcol)
GUICtrlSetFont($Label_wait, 9, 600)
GUICtrlSetState($Label_wait, $GUI_HIDE)
;
$Label_time = GUICtrlCreateLabel("00:00:00", 765, 25, 70, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_SUNKEN)
GUICtrlSetBkColor($Label_time, 0x000000)
GUICtrlSetColor($Label_time, 0xF0F000)
GUICtrlSetFont($Label_time, 9, 600)
GUICtrlSetState($Label_time, $GUI_HIDE)
;
$lvtop = 52
$Listview_ebooks = GUICtrlCreateListView("No.|Title|MOBI-ASIN|Author|Start|Low|High|Last|Current", 20, $lvtop, 815, 388, _
										$GUI_SS_DEFAULT_LISTVIEW, $LVS_EX_FULLROWSELECT + $LVS_EX_GRIDLINES)
					;$GUI_SS_DEFAULT_LISTVIEW + $LVS_SORTASCENDING, $LVS_EX_FULLROWSELECT + $LVS_EX_GRIDLINES)
SetTheColumnWidths()
; Pale Green
GUICtrlSetBkColor($Listview_ebooks, 0xC0F0C0)
GUICtrlSetTip($Listview_ebooks, "List of ebooks!")
;
$Group_comm = GuiCtrlCreateGroup("Comments", 10, 460, 250, 55)
$Combo_comm = GUICtrlCreateCombo("", 20, 480, 230, 21)
;
$Group_user = GuiCtrlCreateGroup("Username", 270, 460, 125, 55)
$Combo_user = GUICtrlCreateCombo("", 280, 480, 105, 21)
;
$Button_add = GuiCtrlCreateButton("ADD", 405, 465, 48, 25)
GUICtrlSetFont($Button_add, 7, 600, 0, "Small Fonts")
GUICtrlSetTip($Button_add, "Add another ebook!")
;
$Button_rem = GuiCtrlCreateButton("Remove", 463, 465, 63, 25)
GUICtrlSetFont($Button_rem, 7, 600, 0, "Small Fonts")
GUICtrlSetTip($Button_rem, "Remove selected ebook!")
;
$Label_rate = GUICtrlCreateLabel("", 405, 497, 70, 18, $SS_CENTER + $SS_CENTERIMAGE + $SS_SUNKEN + $SS_NOTIFY)
GUICtrlSetBkColor($Label_rate, 0x000000)
GUICtrlSetColor($Label_rate, 0xF0F030)
GUICtrlSetFont($Label_rate, 6, 600, 0, "Small Fonts")
GUICtrlSetTip($Label_rate, "Click to show the Exchange Rate!")
$Input_rate = GUICtrlCreateInput("", 475, 497, 50, 18, $ES_CENTER)
GUICtrlSetFont($Input_rate, 7, 400, 0, "Small Fonts")
GUICtrlSetTip($Input_rate, "Exchange rate conversion price or normal (Red = cheaper at Kobo)!")
;
$Checkbox_quit = GUICtrlCreateCheckbox("STOP", 543, 499, 50, 18)
GUICtrlSetTip($Checkbox_quit, "STOP the Query process!")
GUICtrlSetState($Checkbox_quit, $GUI_HIDE)
;
$Button_query = GuiCtrlCreateButton("QUERY", 536, 465, 60, 50, $BS_MULTILINE)
;$Button_query = GuiCtrlCreateButton("WAIT", 536, 465, 60, 32, $BS_MULTILINE)
GUICtrlSetFont($Button_query, 7, 600, 0, "Small Fonts")
GUICtrlSetTip($Button_query, "Query selected ebook!")
;
$Checkbox_quall = GUICtrlCreateCheckbox("", 601, 466, 20, 15)
GUICtrlSetTip($Checkbox_quall, "Query all ebooks!")
;$Checkbox_qufav = GUICtrlCreateCheckbox("", 601, 483, 20, 15)
$Checkbox_qufav = GUICtrlCreateCheckbox("", 601, 483, 20, 15, $BS_AUTO3STATE)
GUICtrlSetTip($Checkbox_qufav, "Query favorite ebooks!")
$Checkbox_nofav = GUICtrlCreateCheckbox("", 601, 500, 20, 15)
GUICtrlSetTip($Checkbox_nofav, "Query non-favorite ebooks!")
;
;$Button_ontop = GUICtrlCreateCheckbox("ON" & @LF & "TOP", 571, 465, 50, 50, $BS_PUSHLIKE + $BS_MULTILINE)
$Button_ontop = GUICtrlCreateCheckbox("ON TOP", 626, 465, 50, 30, $BS_PUSHLIKE)
GUICtrlSetFont($Button_ontop, 6, 600, 0, "Small Fonts")
GUICtrlSetTip($Button_ontop, "Toggle the On Top setting!")
;
$Checkbox_sort = GUICtrlCreateCheckbox("Sorted", 626, 500, 50, 15)
GUICtrlSetTip($Checkbox_sort, "Keep the Sort order as default!")
;
$Button_opts = GuiCtrlCreateButton("Setup", 686, 465, 45, 50, $BS_ICON)
GUICtrlSetTip($Button_opts, "Program Settings!")
;
$Button_i = GuiCtrlCreateButton("Info", 741, 465, 45, 50, $BS_ICON)
GUICtrlSetTip($Button_i, "Program Information!")
$Button_x = GuiCtrlCreateButton("EXIT", 796, 465, 49, 50, $BS_ICON)
GUICtrlSetTip($Button_x, "Quit, Close or Exit program!")
;
; DUMMY CONTROLS (for Accelerator Keys)
$Image_Item = GUICtrlCreateDummy()
$Entry_Item = GUICtrlCreateDummy()
$Paid_Item = GUICtrlCreateDummy()
$Favorite_Item = GUICtrlCreateDummy()
$Copy_Item = GUICtrlCreateDummy()
$Move_Item = GUICtrlCreateDummy()
$Sweet_Item = GUICtrlCreateDummy()
$Warn_Item = GUICtrlCreateDummy()
$Edit_Item = GUICtrlCreateDummy()
$Notes_Item = GUICtrlCreateDummy()
$Private_Item = GUICtrlCreateDummy()
$Excel_Item = GUICtrlCreateDummy()
;
;$lowid = $Button_x
; CONTEXT_MENUS
$Menu_query = GUICtrlCreateContextMenu($Button_query)
$Item_movlist = GUICtrlCreateMenuItem("Enable Move List", $Menu_query, -1, 0)
$Item_coplist = GUICtrlCreateMenuItem("Enable Copy List", $Menu_query, -1, 0)
GUICtrlCreateMenuItem("", $Menu_query)
$Item_remlist = GUICtrlCreateMenuItem("Enable Remove List", $Menu_query, -1, 0)
GUICtrlCreateMenuItem("", $Menu_query)
$Item_kobo = GUICtrlCreateMenuItem("Enable Kobo Query", $Menu_query, -1, 0)
GUICtrlCreateMenuItem("", $Menu_query)
$Item_totlist = GUICtrlCreateMenuItem("Enable Get Total", $Menu_query, -1, 0)
GUICtrlSetState($Item_movlist, $GUI_DISABLE)
GUICtrlSetState($Item_coplist, $GUI_DISABLE)
GUICtrlSetState($Item_remlist, $GUI_DISABLE)
If Not FileExists($koboexe) Then GUICtrlSetState($Item_kobo, $GUI_DISABLE)
GUICtrlSetState($Item_totlist, $GUI_DISABLE)
GUICtrlCreateMenuItem("", $Menu_query)
$Item_mode = GUICtrlCreateMenuItem("EXCEL Mode", $Menu_query, -1, 0)
$excel = 4
$rows = 0
$hide = IniRead($inifle, "Excel Query Mode", "hide", "")
If $hide = "" Then
	;$hide = 1
	;IniWrite($inifle, "Excel Query Mode", "hide", $hide)
EndIf
If $hide = 1 Then GUICtrlSetState($Item_mode, $GUI_DISABLE)
;
;~ CreateContextMenuForListView()
GetLastControlID("")
; ALERT - Also see the following for $lowid (when changing)
; Case $msg = $GUI_EVENT_PRIMARYDOWN And $contxtmenu = 1
; Case $msg = $GUI_EVENT_PRIMARYUP
; Case $msg = $GUI_EVENT_SECONDARYDOWN
; Case $msg = $Label_find  (a manual reset)
; GetSetCurrentStateAfterChanges()
;
; SET ACCELERATOR KEYS
Global $AccelKeys[12][2]=[["^i", $Image_Item], ["^t", $Entry_Item], ["^b", $Paid_Item], ["^f", $Favorite_Item], _
	["!c", $Copy_Item], ["!m", $Move_Item], ["^s", $Sweet_Item], ["^w", $Warn_Item], ["^e", $Edit_Item], _
	["!s", $Notes_Item], ["!p", $Private_Item], ["!x", $Excel_Item]]
GUISetAccelerators($AccelKeys, $PriceQueryGUI)
;
;~ SplashTextOn("", "Hold CTRL down if you" & @LF & "want to Bypass the" & @LF & "last user list Loading!", 200, 140, $left + 300, $top + 200, 33)
;~ Sleep(3000)
;
; OS_SETTINGS
$shell = @SystemDir & "\shell32.dll"
$user32 = @SystemDir & "\user32.dll"
$progman = @SystemDir & "\Progman.exe"
If FileExists($progman) Then
	$icofle = $progman
	$icoUp = -48
	$icoDwn = -45
Else
	$icofle = IniRead($inifle, "Arrow Icon File", "path", "")
	If $icofle = "" Then
		$icofle = @SystemDir & "\wpdshext.dll"
		IniWrite($inifle, "Arrow Icon File", "path", $icofle)
	EndIf
	$icoUp = IniRead($inifle, "Arrow Icon File", "up_id", "")
	If $icoUp = "" Then
		$icoUp = "-26"
		IniWrite($inifle, "Arrow Icon File", "up_id", $icoUp)
	EndIf
	$icoDwn = IniRead($inifle, "Arrow Icon File", "down_id", "")
	If $icoDwn = "" Then
		$icoDwn = "-27"
		IniWrite($inifle, "Arrow Icon File", "down_id", $icoDwn)
	EndIf
EndIf
$icoI = -5
$icoS = -22
If StringLeft(@OSVersion, 5) <> "WIN_9" And @OSVersion <> "WIN_ME" Then
	; WIN_NT4, WIN_2000, WIN_XP, WIN_2003
	$icoN = -70
	$icoX = -28
Else
	$icoN = -67
	$icoX = -4
EndIf
;
; SETTINGS
GUICtrlSetImage($Button_find, $shell, -23, 0)
GUICtrlSetImage($Button_changed, $shell, -44, 0)
GUICtrlSetImage($Button_opts, $shell, $icoS, 1)
GUICtrlSetImage($Button_i, $user32, $icoI, 1)
GUICtrlSetImage($Button_x, $shell, $icoX, 1)
;
$clipboard = @SystemDir & "\clipbrd.exe"
If FileExists($clipboard) Then
	GUICtrlSetImage($Button_clip, $clipboard, -2, 0)
Else
	GUICtrlSetImage($Button_clip, $shell, -261, 0)
EndIf
;
$usd = IniRead($inifle, "Conversion", "from", "")
If $usd = "" Then
	$usd = "USD"
	IniWrite($inifle, "Conversion", "from", $usd)
EndIf
;
$currency = IniRead($inifle, "Conversion", "currency", "")
If $currency = "" Then
	$currency = "USD"
	IniWrite($inifle, "Conversion", "currency", $currency)
EndIf
GUICtrlSetData($Label_rate, $usd & " -> " & $currency)
;
$excon = IniRead($inifle, "Conversion", "exchange", "")
If $excon = "" Then
	$excon = 4
	IniWrite($inifle, "Conversion", "exchange", $excon)
EndIf
If $excon = 4 Then
	GUICtrlSetState($Input_rate, $GUI_DISABLE)
	;GUICtrlSetState($Label_rate, $GUI_DISABLE)
EndIf
;
$where = "Titles"
GUICtrlSetData($Combo_where, "Authors|Titles|Both|Simple|ASIN", $where)
;
$show = IniRead($inifle, "Indexes", "show", "")
If $show = "" Then
	$show = 4
	IniWrite($inifle, "Indexes", "show", $show)
EndIf
;
$test = IniRead($inifle, "Read Html Page", "test", "")
If $test = "" Then
	$test = 4
	IniWrite($inifle, "Read Html Page", "test", $test)
EndIf
;
$csign = IniRead($inifle, "Currency", "sign", "")
If $csign = "" Then
	$csign = "£"
	IniWrite($inifle, "Currency", "sign", $csign)
EndIf
;
$time = IniRead($inifle, "Now Date Format", "time", "")
If $time = "" Then
	$time = 4
	IniWrite($inifle, "Now Date Format", "time", $time)
EndIf
;
$record = IniRead($inifle, "All Price Changes", "record", "")
If $record = "" Then
	$record = 1
	IniWrite($inifle, "All Price Changes", "record", $record)
EndIf
;If $record <> 1 Then GUICtrlSetState($Item_history, $GUI_DISABLE)
;
$updated = IniRead($inifle, "Program", "updated", '')
;
;$users = IniRead($inifle, "User", "names", "")
If FileExists($catfle) Then
	While 1
		$user = InputBox("First Time Username", "Enter the name you wish the list to be for.", @UserName, " M", 240, 130, -1, -1, 0, $PriceQueryGUI)
		If @error = 0 And $user <> "" Then
			IniWrite($inifle, "User", "name", $user)
			$catfle = $scriptdir & "\" & $user & ".ini"
			FileMove($scriptdir & "\Catalog.ini", $catfle)
			;
			If IniRead($inifle, "Last Query Result", "1", "") <> "" Then
				IniRenameSection($inifle, "Last Query Result", "Last Query Result - " & $user)
			EndIf
			;
			IniRenameSection($inifle, "Save Query Results", "Save Query Results - " & $user)
			;
			If IniRead($inifle, "Last Saved List File", "path", "") <> "" Then
				IniRenameSection($inifle, "Last Saved List File", "Last Saved List File - " & $user)
			EndIf
			;
			ExitLoop
		EndIf
	WEnd
Else
	$user = IniRead($inifle, "User", "name", "")
	If $user = "" Then
		While 1
			$user = InputBox("First Time Username", "Enter the name you wish the list to be for.", @UserName, " M", 240, 130, -1, -1, 0, $PriceQueryGUI)
			If @error = 0 And $user <> "" Then
				IniWrite($inifle, "User", "name", $user)
				$fixed = 1
				IniWrite($inifle, "Spaces In Prices", $user & "_fixed", $fixed)
				$pipes = 1
				IniWrite($inifle, "Pipes In Title & Author", $user & "_fixed", $pipes)
				ExitLoop
			EndIf
		WEnd
	EndIf
	$catfle = $scriptdir & "\" & $user & ".ini"
EndIf
If $users = "" Then
	$users = "|" & $user & "|"
	IniWrite($inifle, "User", "names", $users)
EndIf
GUICtrlSetData($Combo_user, $users, $user)
$usertmp = $scriptdir & "\" & $user & ".tmp"
;
If FileExists($catfle) Then
	If $cmdlne = "/fix" Then
		$ans = MsgBox(262209, "Fix Query", _
			"Not sure why, but I had a scenario where the first entry in a user file," & @LF & _
			"wasn't being read. In the end it was solved by recreating the file and" & @LF & _
			"copying all entries across. No matter what I tried to do, by deleting or" & @LF & _
			"moving entries around, nothing else would fix the situation. I can only" & @LF & _
			"speculate, that the file had somehow become corrupt at the start." & @LF & @LF & _
			"OK = Attempt the fix (this recreates the file & copies content over)." & @LF & @LF & _
			"NOTE - Original user file has had .old added to the end of its name," & @LF & _
			"and can be deleted if the fix was successful.", 0, $PriceQueryGUI)
		If $ans = 1 Then
			SplashTextOn("", "Fixing!", 200, 120, -1, -1, 33)
			Local $oldfile = $catfle & ".old"
			If FileExists($oldfile) Then
				$ans = MsgBox(262209, "Delete Query", _
					"ALERT - The .old file already exists." & @LF & @LF & _
					"FIX will not work without its removal." & @LF & _
					"OK = Remove (Delete) the .old file.", 0, $PriceQueryGUI)
				If $ans = 1 Then
					FileDelete($oldfile)
					Sleep(1000)
				EndIf
			EndIf
			$res = FileMove($catfle, $oldfile, 0)
			If $res = 1 Then
				$file = FileOpen($oldfile, 0)
				$ents = FileRead($file)
				FileClose($file)
				;_FileCreate($catfle)
				FileDelete($catfle)
				Sleep(1000)
				IniWrite($catfle, "TEMPORARY", "key", "value")
				$file = FileOpen($catfle, 2)
				Sleep(2000)
				;FileWrite($file, @CRLF & $ents)
				FileWrite($file, $ents)
				FileClose($file)
			Else
				SplashTextOn("", "Failed!", 200, 120, -1, -1, 33)
				Sleep(1000)
			EndIf
			SplashOff()
		EndIf
	EndIf
EndIf
;
;If StringRight($user, 4) = " (b)" Then GUICtrlSetState($Item_relocate, $GUI_DISABLE)
;
$exempt = IniRead($inifle, $user, "exempt", "")
If $exempt = "" Then
	$exempt = 4
	IniWrite($inifle, $user, "exempt", $exempt)
EndIf
;
$backup = IniRead($inifle, "User Files", "backup", "")
If $backup = "" Then
	$backup = 1
	IniWrite($inifle, "User Files", "backup", $backup)
EndIf
If $backup = 1 Then BackupAllUsersFile()
;
$errcol = IniRead($inifle, "Price Change Color", "error", "")
If $errcol = "" Then
	; Red (error)
	$errcol = "0xF02000"
	IniWrite($inifle, "Price Change Color", "error", $errcol)
EndIf
;
$mincol = IniRead($inifle, "Price Change Color", "minor", "")
If $mincol = "" Then
	; Yellow (minor)
	$mincol = "0xF0F000"
	IniWrite($inifle, "Price Change Color", "minor", $mincol)
EndIf
;
$lescol = IniRead($inifle, "Price Change Color", "less", "")
If $lescol = "" Then
	; Green (major less)
	$lescol = "0x60E000"
	IniWrite($inifle, "Price Change Color", "less", $lescol)
EndIf
;
$morcol = IniRead($inifle, "Price Change Color", "more", "")
If $morcol = "" Then
	; Orange (major more)
	$morcol = "0xF09000"
	IniWrite($inifle, "Price Change Color", "more", $morcol)
EndIf
;
$swecol = IniRead($inifle, "Price Change Color", "sweet", "")
If $swecol = "" Then
	; White (sweet)
	$swecol = "0xFFFFFF"
	IniWrite($inifle, "Price Change Color", "sweet", $swecol)
EndIf
;
$skicol = IniRead($inifle, "Price Change Color", "skip", "")
If $skicol = "" Then
	; Dark Pink (skip)
	$skicol = "0xF000F0"
	IniWrite($inifle, "Price Change Color", "skip", $skicol)
EndIf
;
If IniRead($inifle, "Conversion", "recheck", "") = "" Then
	; Recheck conversion rate after 59 minutes (default).
	IniWrite($inifle, "Conversion", "recheck", 59)
EndIf
;
$flash = IniRead($inifle, "Flashing Please Wait", "use", "")
If $flash = "" Then
	$flash = 1
	IniWrite($inifle, "Flashing Please Wait", "use", $flash)
EndIf
;
$rate = IniRead($inifle, "Flashing Please Wait", "rate", "")
If $rate = "" Then
	$rate = 2
	IniWrite($inifle, "Flashing Please Wait", "rate", $rate)
EndIf
;
$favorites = ""
$secondfavs = ""
GUICtrlSetState($Checkbox_qufav, $GUI_DISABLE)
GUICtrlSetState($Checkbox_nofav, $GUI_DISABLE)
;
$slick = IniRead($inifle, "Visuals For Loading Etc", "slicker", "")
If $slick = "" Then
	$slick = 4
	IniWrite($inifle, "Visuals For Loading Etc", "slicker", $slick)
EndIf
;~ Sleep(500)
;~ SplashOff()
;~ If _IsPressed("11") = 0 Then
;~ 	CheckOnSortRequirement(0)
;~ Else
;~ 	$nums = 0
;~ 	$lne = $num
;~ 	$ind = -1
;~ EndIf
$ans = MsgBox(262433, "Load Query", _
	"In 5 seconds the last used User" & @LF & _
	"list will begin loading." & @LF & @LF & _
	"OK = Load last used User list." & @LF & _
	"CANCEL = Abort any load.", 5, $PriceQueryGUI)
If $ans = 1 Or $ans = -1 Then
	CheckOnSortRequirement(0)
ElseIf $ans = 2 Then
	$nums = 0
	$lne = $num
	$ind = -1
EndIf
;
$ID = MouseGetCursor()
;
If $updated < 2 Then
	Local $comm, $entries, $IDNB, $u
	;
	SplashTextOn("", "Updating!", 200, 120, -1, -1, 33)
	If FileExists($catfle) Then
		;$entries = IniReadSectionNames($catfle)
		;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
		;	$nmb = StringLen(_ArrayToString($entries, "|", 1))
		;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
		$entries = FileRead($catfle)
		$entries = StringSplit($entries, @LF, 1)
		If Not @error Then
			;$count = $entries[0]
			;For $u = 1 To $count
			;	$IDNB = $entries[$u]
			$u = 0
			$lines = $entries[0]
			For $l = 1 To $lines
				$linetxt = $entries[$l]
				If StringLeft($linetxt, 1) = "[" Then
					$IDNB = StringTrimLeft($linetxt, 1)
					$IDNB = StringStripCR($IDNB)
					$IDNB = StringTrimRight($IDNB, 1)
					;MsgBox(262192, "Line Text", $IDNB, 0, $PriceQueryGUI)
					If $IDNB <> "" Then
						$u = $u + 1
						$comm = IniRead($catfle, $IDNB, "comment", "")
						IniWrite($comfle, $IDNB, "comment", $comm)
					EndIf
				EndIf
			Next
			$count = $u
		EndIf
	EndIf
	$check = StringSplit($users, "|", 1)
	For $c = 1 To $check[0]
		$name = $check[$c]
		If $name <> $user Then
			$namfle = $scriptdir & "\" & $name & ".ini"
			If FileExists($namfle) Then
				;$entries = IniReadSectionNames($namfle)
				;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
				;	$nmb = StringLen(_ArrayToString($entries, "|", 1))
				;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
				$entries = FileRead($namfle)
				$entries = StringSplit($entries, @LF, 1)
				If Not @error Then
					;$count = $entries[0]
					;For $u = 1 To $count
					;	$IDNB = $entries[$u]
					$u = 0
					$lines = $entries[0]
					For $l = 1 To $lines
						$linetxt = $entries[$l]
						If StringLeft($linetxt, 1) = "[" Then
							$IDNB = StringTrimLeft($linetxt, 1)
							$IDNB = StringStripCR($IDNB)
							$IDNB = StringTrimRight($IDNB, 1)
							;MsgBox(262192, "Line Text", $IDNB, 0, $PriceQueryGUI)
							If $IDNB <> "" Then
								$u = $u + 1
								$comm = IniRead($namfle, $IDNB, "comment", "")
								$exist = IniRead($comfle, $IDNB, "comment", "")
								If $exist = "" Then
									IniWrite($comfle, $IDNB, "comment", $comm)
								ElseIf $exist <> $comm Then
									IniWrite($comfle, $IDNB, "comment", $exist & "|" & $comm)
								EndIf
							EndIf
						EndIf
					Next
					$count = $u
				EndIf
			EndIf
		EndIf
	Next
	;
	$updated = 2
	IniWrite($inifle, "Program", "updated", $updated)
	;
	DetermineComment()
	SplashOff()
	;
	MsgBox(262208, "Update Advice", _
		"All of the 'Shared Comments' for every user have now been copied" & @LF & _
		"into a single file (Comments.ini), so that they truly are shared, and" & @LF & _
		"can be updated for every user by each user." & @LF & @LF & _
		"NOTE - Any clashes between comments by users, that occurred for" & @LF & _
		"a shared ebook, meant they were combined, but separated by the" & @LF & _
		"pipe '|' character.   All 'Private Comments' were left alone, and still" & @LF & _
		"remain accessible in each user file.", 0, $PriceQueryGUI)
EndIf
;
$ontop = IniRead($inifle, "Program Window", "on_top", "")
If $ontop = "" Then
	$ontop = 1
	IniWrite($inifle, "Program Window", "on_top", $ontop)
EndIf
GUICtrlSetState($Button_ontop, $ontop)
If $ontop = 4 Then WinSetOnTop($PriceQueryGUI, "", 0)
;
$disable = IniRead($inifle, "On Top During Add Ebook", "disable", "")
If $disable = "" Then
	$disable = 1
	IniWrite($inifle, "On Top During Add Ebook", "disable", $disable)
EndIf
;
$getcnt = IniRead($inifle, "Html Read", "increase", "")
If $getcnt == "" Then
	$getcnt = 0
	IniWrite($inifle, "Html Read", "increase", $getcnt)
EndIf
;
$multi = ""
;
$relax = IniRead($inifle, "URL Format", "relax", "")
If $relax = "" Then
	$relax = 1
	IniWrite($inifle, "URL Format", "relax", $relax)
EndIf
;
$data = IniRead($inifle, "Image Data", "store", "")
If $data = "" Then
	$data = 1
	IniWrite($inifle, "Image Data", "store", $data)
EndIf
;If $data = 4 Then GUICtrlSetState($Item_image, $GUI_DISABLE)
$jpgsav = IniRead($inifle, "JPG Image", "save", "")
If $jpgsav = "" Then
	If $data = 1 Then
		$ans = MsgBox(262179, "JPG Query (Setting Update)", _
			"Do you want to be prompted to Save the" & @LF & _
			"JPG file, when Image data is not present?" & @LF & @LF & _
			"YES = Prompt to Save the JPG file." & @LF & _
			"NO = Don't prompt, just Save the JPG." & @LF & @LF & _
			"CANCEL = Skip the saving of JPG files.", 0, $PriceQueryGUI)
		$jpgsav = $ans
	Else
		$jpgsav = 2
	EndIf
	IniWrite($inifle, "JPG Image", "save", $jpgsav)
EndIf
;
;GUICtrlSetState($Item_start, $GUI_DISABLE)
;GUICtrlSetState($Item_end, $GUI_DISABLE)
;GUICtrlSetState($Item_show, $GUI_DISABLE)
$first = ""
$end = ""
;
$deftags = "<BR />:pipe|<br>:pipe|<b>|</b>|<i>|</i>|<p>:pipe|</p>"
$tags = IniRead($inifle, "Html Replace", "tags", "")
If $tags = "" Then
	$tags = $deftags
	IniWrite($inifle, "Html Replace", "tags", $tags)
EndIf
;
$defchars = "||&nbsp;: |&ndash;:-|&mdash;: - |&lsquo;:'|&rsquo;:'|&#160;|&#65533;:e|&#xfffd;:e|" & '&ldquo;:"|&rdquo;:"|&#x201c;:"|&#x201d;:"|' _
		& "&#x2013;:-|&#x2014;: - |&#x2018;:'|&#x2019;:'|&#x2026;:...|&#xea;:e|"
$chars = IniRead($inifle, "Html Replace", "characters", "")
If $chars = "" Then
	$chars = $defchars
	IniWrite($inifle, "Html Replace", "characters", $chars)
Else
	If StringLeft($chars, 2) <> "||" Then
		$chars = "||" & $chars
		IniWrite($inifle, "Html Replace", "characters", $chars)
	EndIf
	If StringRight($chars, 1) <> "|" Then
		$chars = $chars & "|"
		IniWrite($inifle, "Html Replace", "characters", $chars)
	EndIf
EndIf
;
$excoms = IniRead($inifle, "Selected Entry Detail", "changes", "")
If $excoms = "" Then
	$excoms = 1
	IniWrite($inifle, "Selected Entry Detail", "changes", $excoms)
EndIf
;
$savpth = IniRead($inifle, "Last Saved List File - " & $user, "path", "")
;
$splash = IniRead($inifle, "Query Splash Screen", "show", "")
If $splash = "" Then
	$splash = 4
	IniWrite($inifle, "Query Splash Screen", "show", $splash)
EndIf
;
$loop = IniRead($inifle, "ADD URL Input", "loop", "")
If $loop = "" Then
	$loop = 4
	IniWrite($inifle, "ADD URL Input", "loop", $loop)
EndIf
;
GetSaveSlots()
;
$stop = IniRead($inifle, "Stop For Query", "enable", "")
If $stop = "" Then
	$stop = 1
	IniWrite($inifle, "Stop For Query", "enable", $stop)
EndIf
;
$resort = IniRead($inifle, "After An Entry Removal", "resort", "")
If $resort = "" Then
	$resort = 1
	IniWrite($inifle, "After An Entry Removal", "resort", $resort)
EndIf
;
$limit = IniRead($inifle, "Show Price History", "limit", "")
If $limit = "" Then
	$limit = 20
	IniWrite($inifle, "Show Price History", "limit", $limit)
EndIf
;
$instant = IniRead($inifle, "Query Non-Favorites", "instant", "")
If $instant = "" Then
	$instant = 4
	IniWrite($inifle, "Query Non-Favorites", "instant", $instant)
EndIf
;
$skip = IniRead($inifle, "Price Change Less", "skip", "")
If $skip = "" Then
	$skip = 4
	IniWrite($inifle, "Price Change Less", "skip", $skip)
EndIf
;
$max = IniRead($inifle, "Price Change Less", "maximum", "")
If $max = "" Then
	$max = 9
	IniWrite($inifle, "Price Change Less", "maximum", $max)
EndIf
;
$replines = IniRead($inifle, "Report Message Limit", "lines", "")
If $replines = "" Then
	$replines = 20
	IniWrite($inifle, "Report Message Limit", "lines", $replines)
EndIf
;
$server = IniRead($inifle, "Web", "server", "")
If $server = "" Then
	; "www.amazon.com" always time out
	; "www.google.com"
	$server = "www.google.com"
	IniWrite($inifle, "Web", "server", $server)
EndIf
;
$timeout = IniRead($inifle, "Ping", "timeout", "")
If $timeout = "" Then
	; AutoIt default is 4000 milliseconds
	$timeout = 4000
	IniWrite($inifle, "Ping", "timeout", $timeout)
EndIf
;
$timer = IniRead($inifle, "Display", "timer", "")
If $timer = "" Then
	$timer = 4
	IniWrite($inifle, "Display", "timer", $timer)
EndIf
;
$others = 4
$nons = 4
$quall = 4
;
$advice = IniRead($inifle, "Comments", "advice", "")
If $advice = "" Then
	$advice = 4
	IniWrite($inifle, "Comments", "advice", $advice)
EndIf
If $advice = 4 Then
	$ans = MsgBox(262209, "Advice About Comments", _
		"A change has occurred to the way Comments are stored." & @LF & _
		"They can now be split into Private and Shared comments," & @LF & _
		"though Shared are not truly shared at this point, but just" & @LF & _
		"paving the way for that facility in v4.0 of the program." & @LF & @LF & _
		"It is suggested, because of the impending v4.0 Updater," & @LF & _
		"that all your comments now be checked, and any secret" & @LF & _
		"(or Private) ones be relocated (cut & paste) to the newly" & @LF & _
		"provided 'Private' storage field, via the right-click options." & @LF & @LF & _
		"This advice is pertinent for all users, to maintain privacy" & @LF & _
		"during the v4.0 updating process." & @LF & @LF & _
		"CANCEL = Don't show this advice again.", 0, $PriceQueryGUI)
	If $ans = 2 Then
		$advice = 1
		IniWrite($inifle, "Comments", "advice", $advice)
	EndIf
EndIf
;
$pause = IniRead($inifle, "Multiple Queries", "pause", "")
If $pause = "" Then
	$pause = 4
	IniWrite($inifle, "Multiple Queries", "pause", $pause)
EndIf
;
$delay = IniRead($inifle, "Multiple Queries", "delay", "")
If $delay = "" Then
	$delay = 0
	IniWrite($inifle, "Multiple Queries", "delay", $delay)
EndIf
;
$random = IniRead($inifle, "Multiple Queries", "random", "")
If $random = "" Then
	$random = 4
	IniWrite($inifle, "Multiple Queries", "random", $random)
EndIf
;
$advise = IniRead($inifle, "Mode", "advise", "")
$modes = "automatic|manual|semi-auto|prompt"
$mode = IniRead($inifle, "Query", "mode", "")
If $mode = "" Then
	$mode = "automatic"
	IniWrite($inifle, "Query", "mode", $mode)
	$advise = 1
	IniWrite($inifle, "Mode", "advise", $advise)
ElseIf $advise = "" Then
	$advise = 1
	IniWrite($inifle, "Mode", "advise", $advise)
	If $mode <> "automatic" Then
		$ans = MsgBox(262193, "Mode Advice & Query", _
			"It has been determined that you are not using 'automatic' mode." & @LF & @LF & _
			"In the earliest incarnation of this program, it only had an automatic mode of processing." & @LF & _
			"At that point, the program was also named a little differently - KindEbook Price Query." & @LF & @LF & _
			"One day it stopped working, and it looked like it would never work again. In an effort to" & @LF & _
			"get the program working again, invaluable as I had found it, I created a 'manual' mode." & @LF & _
			"I then later managed to get a few of the elements working automatically, so created a" & @LF & _
			"'semi-auto' mode. Around that time or just a bit before, this program was renamed to" & @LF & _
			"what it has been called ever since. The reasons for that have been listed elsewhere." & @LF & @LF & _
			"By the time this program had reached v1.4, I had discovered it was possible to use an" & @LF & _
			"'automatic' mode again, and so that was created as an option. I was a bit tentative at" & @LF & _
			"that point about making 'automatic' the default, so left it as 'manual'. Then I promptly" & @LF & _
			"forgot I had left it in that state, until it was brought to my attention recently. So this" & @LF & _
			"dialog is both an apology and an amendment for that. It is clear, that even though I" & @LF & _
			"had mentioned the change in v1.4 comments and notes, it was not picked up by all." & @LF & @LF & _
			"I seriously recommend that you now use 'automatic' mode." & @LF & @LF & _
			"Do you wish to change to 'automatic' mode and give it a try?" & @LF & @LF & _
			"NOTE - This question will not be asked again. Mode can always be changed in settings.", 0)
		If $ans = 1 Then
			$mode = "automatic"
			IniWrite($inifle, "Query", "mode", $mode)
		EndIf
	EndIf
EndIf
;
$tabclose = IniRead($inifle, "Browser Tab", "close", "")
If $tabclose = "" Then
	$tabclose = 4
	IniWrite($inifle, "Browser Tab", "close", $tabclose)
EndIf
;
$activate = IniRead($inifle, "Amazon Browser Tab", "activate", "")
If $activate = "" Then
	$activate = 4
	IniWrite($inifle, "Amazon Browser Tab", "activate", $activate)
EndIf
;
$browdel = IniRead($inifle, "Browser Start Up", "delay", "")
If $browdel = "" Then
	$browdel = 99
	IniWrite($inifle, "Browser Start Up", "delay", $browdel)
EndIf
;
$tabdel = IniRead($inifle, "Browser Tab Load", "delay", "")
If $tabdel = "" Then
	$tabdel = 30
	IniWrite($inifle, "Browser Tab Load", "delay", $tabdel)
EndIf
;
$browser = IniRead($inifle, "Web Browser", "executable", "")
If $browser = "" Then
	IniWrite($inifle, "Web Browser", "executable", $browser)
EndIf
;
$titlecheck = IniRead($inifle, "Semi Auto Title Compare", "check", "")
If $titlecheck = "" Then
	$titlecheck = 1
	IniWrite($inifle, "Semi Auto Title Compare", "check", $titlecheck)
EndIf
;
$copywait = IniRead($inifle, "Copy Delay", "wait", "")
If $copywait = "" Then
	$copywait = 1000
	IniWrite($inifle, "Copy Delay", "wait", $copywait)
EndIf
;
$onedel = IniRead($inifle, "First Query Item", "delay", "")
If $onedel = "" Then
	$onedel = 10
	IniWrite($inifle, "First Query Item", "delay", $onedel)
EndIf
;
$extra = IniRead($inifle, "Extra On Failure", "use", "")
If $extra = "" Then
	$extra = 4
	IniWrite($inifle, "Extra On Failure", "use", $extra)
EndIf
;
$exdel = IniRead($inifle, "Extra On Failure", "delay", "")
If $exdel = "" Then
	$exdel = 2
	IniWrite($inifle, "Extra On Failure", "delay", $exdel)
EndIf
;
$blanks = IniRead($inifle, "Add Ebook Summary Remove", "blanks", "")
If $blanks = "" Then
	$blanks = 1
	IniWrite($inifle, "Add Ebook Summary Remove", "blanks", $blanks)
EndIf
;
$div = IniRead($inifle, "Html Read", "divisor", "")
If $div = "" Then
	$div = 6
	IniWrite($inifle, "Html Read", ";default", "6")
	IniWrite($inifle, "Html Read", "divisor", $div)
EndIf
;
$wait = IniRead($inifle, "Error Dialog", "pause", "")
If $wait = "" Then
	$wait = 6
	IniWrite($inifle, "Error Dialog", "pause", $wait)
EndIf
;
$include = IniRead($inifle, "Preorders With Favorites", "include", "")
If $include = "" Then
	$include = 4
	IniWrite($inifle, "Preorders With Favorites", "include", $include)
EndIf
;If $include = 1 Then GUICtrlSetState($Item_preord, $GUI_CHECKED)
;
$alert = IniRead($inifle, "Large Price Change", "alert", "")
If $alert = "" Then
	$alert = 30
	IniWrite($inifle, "Large Price Change", "alert", $alert)
EndIf
;
$getot = IniRead($inifle, "Total Changes", "get", "")
If $getot = "" Then
	$getot = 4
	IniWrite($inifle, "Total Changes", "get", $getot)
EndIf
;
$searchadd = IniRead($inifle, "Amazon Search", "address", "")
If $searchadd = "" Then
	$searchadd = "http://www.amazon.com.au"
	IniWrite($inifle, "Amazon Search", "address", $searchadd)
EndIf
;
$whom = IniRead($inifle, "Other User Price", "compare", "")
;
$save = IniRead($inifle, "Other User Price", "record", "")
If $save = "" Then
	$save = 4
	IniWrite($inifle, "Other User Price", "record", $save)
EndIf
;
$single = IniRead($inifle, "Single Item Query", "report", "")
If $single = "" Then
	$single = 1
	IniWrite($inifle, "Single Item Query", "report", $single)
EndIf
;
$minclip = IniRead($inifle, "Clipboard Button Clicked", "minimize", "")
If $minclip = "" Then
	$minclip = 4
	IniWrite($inifle, "Clipboard Button Clicked", "minimize", $minclip)
EndIf
;
$kobocheck = 4
;~ $kobocheck = IniRead($inifle, "Kobo", "autocheck", "")
;~ If $kobocheck = "" Then
;~ 	$kobocheck = 4
;~ 	IniWrite($inifle, "Kobo", "autocheck", $kobocheck)
;~ EndIf
$leeway = IniRead($inifle, "Kobo", "leeway", "")
If $leeway = "" Then
	$leeway = 0.0
	IniWrite($inifle, "Kobo", "leeway", $leeway)
EndIf
$notify = IniRead($inifle, "Kobo", "notify", "")
If $notify = "" Then
	$notify = 20
	IniWrite($inifle, "Kobo", "notify", $notify)
EndIf
;
; Testing
;$lne = $lowid + $ind + 2
;GUICtrlSetBkColor($lne, $COLOR_LIME)
;GUICtrlSetColor($lne, $COLOR_BLUE)
;GUICtrlSetFont($lne, 8, 400, 2, "Times New Roman")
;
$list = ""
$ctrl = ""
$shift = ""
$saved = ""
$shut = ""
;
GetPreviousSearches()
;
$movlist = 4
$coplist = 4
$remlist = 4
$koboquery = 4
$totlist = 4
;MsgBox(262192, "$lowid $bigid", $lowid & " : " & $bigid, 0)


GuiSetState()
While 1
	$msg = GuiGetMsg()
	If $ctrl = 1 Then
		; Need this fix for CTRL staying down issue (AutoIt bug with Listview).
		Send("{CTRLDOWN}")
		;SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
		;Sleep(1000)
		;SplashOff()
		Send("{CTRLUP}")
		$ctrl = ""
	EndIf
	If $shift = 1 Then
		; Need this fix for SHIFT staying down issue (AutoIt bug).
		Send("{SHIFTDOWN}")
		Send("{SHIFTUP}")
		$shift = ""
	EndIf
	Select
	Case $msg = $GUI_EVENT_SECONDARYDOWN And $contxtmenu = ""
		; After right-click #32768
		$cursor = GUIGetCursorInfo($PriceQueryGUI)
		If $cursor[4] = $Listview_ebooks Then
			;MsgBox(262192, "Message", "right-click!", 0, $PriceQueryGUI)
			GetSelectedIndex("detail")
			CreateContextMenuForListView()
			;MouseClick("right", $cursor[0], $cursor[1], 1, 0)
			ControlClick($PriceQueryGUI, "", $Listview_ebooks, "right", 1, $cursor[0], $cursor[1] - $lvtop)
		EndIf
	Case $msg = $GUI_EVENT_PRIMARYDOWN And $contxtmenu = 1
		; After left-click
		;$lowid = $Button_x
		;$contxtmenu = ""
		;GUICtrlDelete($Menu_list)
		;$lowid = $Item_mode
		GetLastControlID("delete")
		GetSelectedIndex("detail")
		;MsgBox(262192, "Message", "left-click!", 0, $PriceQueryGUI)
	Case $msg = $GUI_EVENT_CLOSE Or $msg = $Button_x Or $shut = 1
		; Quit, Close or Exit program
		$check = StringSplit($users, "|", 1)
		For $c = 1 To $check[0]
			$name = $check[$c]
			$usertmp = $scriptdir & "\" & $name & ".tmp"
			If FileExists($usertmp) Then
				_FileCreate($usertmp)
			EndIf
		Next
		;
		;MsgBox(262192, "User", $user, 0, $PriceQueryGUI)
		If StringRight($user, 4) = " (b)" Then
			$ans = MsgBox(262177, "User Query", _
				"A bought user is the current active user for the program." & @LF & @LF & _
				"Do you wish to revert to the normal user name instead?" & @LF & _
				"(Making that the user for the next program start.)" & @LF & @LF & _
				"OK = Change to the normal user name." & @LF & _
				"CANCEL = Leave as the bought user name." & @LF & @LF & _
				"NOTE - A bought user name ends in (b).", 0, $PriceQueryGUI)
			If $ans = 1 Then
				$user = StringTrimRight($user, 4)
				If StringInStr($users, "|" & $user & "|") > 0 Then
					IniWrite($inifle, "User", "name", $user)
				EndIf
			EndIf
		EndIf
		;
		$winpos = WinGetPos($PriceQueryGUI, "")
		$left = $winpos[0]
		If $left < 0 Then
			$left = 2
		ElseIf $left > @DesktopWidth - $winpos[2] Then
			$left = @DesktopWidth - $winpos[2]
		EndIf
		IniWrite($inifle, "Program Window", "left", $left)
		$top = $winpos[1]
		If $top < 0 Then
			$top = 2
		ElseIf $top > @DesktopHeight - $winpos[3] Then
			$top = @DesktopHeight - $winpos[3]
		EndIf
		IniWrite($inifle, "Program Window", "top", $top)
		;
		GUIDelete($PriceQueryGUI)
		ExitLoop
	Case $msg = $Button_rem
		; Remove selected ebook
		GUICtrlSetState($Button_rem, $GUI_DISABLE)
		If _GUICtrlListView_GetItemSelected($Listview_ebooks, $ind) = True Then
;~ 			$ans = MsgBox(262177, "Removal Query", _
;~ 				"Are you sure you wish to delete the currently selected list entry?" & @LF & @LF & _
;~ 				$title, 0, $PriceQueryGUI)
;~ 			If $ans = 1 Then
			$shut = ""
			$ans = MsgBox(262435, "Removal & Exit Query", _
				"Are you sure you wish to delete (remove) the currently" & @LF & _
				"selected list entry, as well as Exit (Close) the program?" & @LF & @LF & _
				$title & @LF & @LF & _
				"YES = Do Both (removal & exit)." & @LF & _
				"NO = Just Delete (removal only)." & @LF & _
				"CANCEL = Neither (no removal or exit).", 0, $PriceQueryGUI)
			If $ans <> 2 Then
				If $ans = 6 Then $shut = 1
				If $timer = 1 Then GUICtrlSetState($Label_time, $GUI_HIDE)
				$imgfle = $imgfld & "\" & $ASIN & ".dat"
				If FileExists($imgfle) Then
					$keep = ""
					$check = StringSplit($users, "|", 1)
					For $c = 1 To $check[0]
						$name = $check[$c]
						If $name <> $user Then
							$namfle = $scriptdir & "\" & $name & ".ini"
							If FileExists($namfle) Then
								If IniRead($namfle, $ASIN, "title", "") <> "" Then
									$keep = 1
									ExitLoop
								EndIf
							EndIf
						EndIf
					Next
					If $keep = "" Then
						FileDelete($imgfle)
						IniDelete($comfle, $ASIN, "comment")
					EndIf
				EndIf
				RemoveSelectedEbook()
			EndIf
		Else
			MsgBox(262192, "Remove Error", "No list entry is selected!", 0, $PriceQueryGUI)
		EndIf
		GUICtrlSetState($Button_rem, $GUI_ENABLE)
	Case $msg = $Button_query And (StringLeft(GUICtrlRead($Button_query), 4) = "MOVE" Or StringLeft(GUICtrlRead($Button_query), 4) = "COPY" _
		Or StringLeft(GUICtrlRead($Button_query), 6) = "REMOVE")
		; Use Move or Copy List
		; NOTE - It is important to reset $multi = "" afterward or list item selection doesn't work.
		If $movlist = 1 Or $coplist = 1 Or $remlist = 1 Then
			If $list <> "" Then
				If $movlist = 1 Then
					$job = "move"
				ElseIf $coplist = 1 Then
					$job = "copy"
					$clear = ""
					$ans = MsgBox(262193, "Copy Query", _
						"Do you want to clear the items from the" & @LF & _
						"Copy List after they have been copied?" & @LF & @LF & _
						"OK = Clear (Remove) items from List." & @LF & _
						"CANCEL = Leave items on the List." & @LF & @LF & _
						"NOTE - You would only normally leave" & @LF & _
						"items on the List, if you intend to copy" & @LF & _
						"them elsewhere as well.", 0, $PriceQueryGUI)
					If $ans = 1 Then
						$clear = 1
					EndIf
				ElseIf $remlist = 1 Then
					$job = "remove"
				EndIf
				If $remlist = 1 Then
					; Remove listed items
					GUICtrlSetState($Button_rem, $GUI_DISABLE)
					$ans = MsgBox(262177, "Removal Query", _
						"Are you sure you wish to delete the currently indicated list entries?", 0, $PriceQueryGUI)
					If $ans = 1 Then
						If $flash = 1 Then
							GUICtrlSetData($Label_wait, "Please Wait!")
							GUICtrlSetState($Label_wait, $GUI_SHOW)
						Else
							SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
						EndIf
						If FileExists($catfle) Then
							$multi = 1
							$selected = 0
							$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
							GUICtrlSetState($Listview_ebooks, $GUI_FOCUS)
							Send("{END}")
							_GUICtrlListView_SetItemSelected($Listview_ebooks, $nums - 1, True, True)
							For $e = $nums To 1 Step -1
								$ind = $e - 1
								If $selected = 0 Or $ind >= $selected Then
									_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
									_GUICtrlListView_EnsureVisible($Listview_ebooks, $ind, False)
									;
									GetTheASIN()
									If StringInStr($list, $ASIN) > 0 Then
										$entry = IniReadSection($catfle, $ASIN)
										If Not @error Then
											_GUICtrlListView_DeleteItem($Listview_ebooks, $ind)
											IniDelete($catfle, $ASIN)
											SplashTextOn("", $ASIN & " Removed!", 200, 120, -1, -1, 33)
											If $flash = 1 Then
												Sleep(1000)
											Else
												Sleep(500)
											EndIf
											$imgfle = $imgfld & "\" & $ASIN & ".dat"
											If FileExists($imgfle) Then
												$keep = ""
												$check = StringSplit($users, "|", 1)
												For $c = 1 To $check[0]
													$name = $check[$c]
													If $name <> $user Then
														$namfle = $scriptdir & "\" & $name & ".ini"
														If FileExists($namfle) Then
															If IniRead($namfle, $ASIN, "title", "") <> "" Then
																$keep = 1
																ExitLoop
															EndIf
														EndIf
													EndIf
												Next
												If $keep = "" Then
													FileDelete($imgfle)
													IniDelete($comfle, $ASIN, "comment")
												EndIf
											EndIf
											If $flash = 1 Then SplashOff()
										EndIf
									EndIf
								Else
									MsgBox(262192, "Remove Error", "No list entry is selected!", 0, $PriceQueryGUI)
								EndIf
							Next
							$multi = ""
							$indx = ""
							$list = ""
							DisableListChoices()
							GUICtrlSetData($Button_query, "QUERY")
							GUICtrlSetData($Combo_comm, "", "")
							$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
							If $resort = 1 And $nums > 0 Then
								If $ind > 0 Then $indx = $ind - 1
								If $slick = 1 Then
									GUISetState($PriceQueryGUI, @SW_DISABLE + @SW_LOCK)
									_GUICtrlListView_BeginUpdate($Listview_ebooks)
								EndIf
								_GUICtrlListView_DeleteAllItems($Listview_ebooks)
								;SortByColumnNumber(1)
								SortByColumnNumber()
								If $slick = 1 Then
									_GUICtrlListView_EndUpdate($Listview_ebooks)
									GUISetState($PriceQueryGUI, @SW_ENABLE + @SW_UNLOCK)
								EndIf
								$indx = ""
							Else
								If $nums > 0 Then
									For $e = 1 To $nums
										$ind = $e - 1
										$num = StringRight("000" & $e, 4)
										$start = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 4)
										$current = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 8)
										If $current <> $start Then $num = $num & "*"
										_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $num, 0)
									Next
									$ind = 0
								Else
									$ind = -1
								EndIf
								;GetSetCurrentStateAfterChanges(1)
								GetSetCurrentStateAfterChanges()
							EndIf
							GUICtrlSetData($Group_list, "List Of Kindle Ebooks  (" & $nums & ")")
						EndIf
						If $flash = 1 Then
							GUICtrlSetState($Label_wait, $GUI_HIDE)
						Else
							SplashOff()
						EndIf
					EndIf
					GUICtrlSetState($Button_rem, $GUI_ENABLE)
				Else
					Local $heir = ""
					If $name = "" And $copyto = "" Then
						If $job = "move" Then
							$copyto = IniRead($inifle, "Last Move Recipient", "name", $user)
						Else
							$copyto = IniRead($inifle, "Last Copy Recipient", "name", $user)
						EndIf
					ElseIf $copyto = "" Then
						If $job = "move" Then
							$copyto = IniRead($inifle, "Last Move Recipient", "name", $name)
						Else
							$copyto = IniRead($inifle, "Last Copy Recipient", "name", $user)
						EndIf
					EndIf
					$dll = DllOpen("user32.dll")
					While 1
						If $heir = "" Then $heir = $copyto
						$name = InputBox("Destination Username", "Enter the user name you wish to " & $job & " the current ebooks to." _
							& @LF & @LF & "Hold down CTRL while clicking CANCEL to cycle through names.", $heir, " M", 340, 150, -1, -1, 0, $PriceQueryGUI)
						If @error = 1 Then
							If _IsPressed("11", $dll) Then
								$check = StringSplit($users, "|", 1)
								If IsArray($check) Then
									$count = $check[0] - 1
									$c = _ArraySearch($check, $heir, 0, 0, 0, 0)
									If $c > -1 Then
										If $c < $count Then
											$c = $c + 1
										Else
											$c = 2
										EndIf
										$heir = $check[$c]
									EndIf
								EndIf
							Else
								ExitLoop
							EndIf
						ElseIf @error = 0 And $name <> "" And $name <> $user Then
							If StringInStr($users, "|" & $name & "|") > 0 Then
								If $flash = 1 Then
									GUICtrlSetData($Label_wait, "Please Wait!")
									GUICtrlSetState($Label_wait, $GUI_SHOW)
								Else
									SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
								EndIf
								$copyto = $name
								If $job = "move" Then
									IniWrite($inifle, "Last Move Recipient", "name", $name)
								Else
									IniWrite($inifle, "Last Copy Recipient", "name", $name)
								EndIf
								$namfle = $scriptdir & "\" & $name & ".ini"
								If Not FileExists($namfle) Then _FileCreate($namfle)
								If FileExists($catfle) Then
									$multi = 1
									$selected = 0
									$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
									GUICtrlSetState($Listview_ebooks, $GUI_FOCUS)
									Send("{END}")
									_GUICtrlListView_SetItemSelected($Listview_ebooks, $nums - 1, True, True)
									For $e = $nums To 1 Step -1
										$ind = $e - 1
										If $selected = 0 Or $ind >= $selected Then
											_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
											_GUICtrlListView_EnsureVisible($Listview_ebooks, $ind, False)
											;
											GetTheASIN()
											If StringInStr($list, $ASIN) > 0 Then
												;SplashTextOn("", $ASIN, 200, 120, -1, -1, 33)
												;Sleep(500)
												If IniRead($namfle, $ASIN, "title", "") = "" Then
													$entry = IniReadSection($catfle, $ASIN)
													If Not @error Then
														IniWriteSection($namfle, $ASIN, $entry)
														If Not @error Then
															$private = IniRead($catfle, $ASIN, "private", "")
															If $job = "move" Then
																_GUICtrlListView_DeleteItem($Listview_ebooks, $ind)
																IniDelete($catfle, $ASIN)
																SplashTextOn("", $ASIN & " Moved!", 200, 120, -1, -1, 33)
															Else
																If $clear = 1 Then RestoreLineColor()
																SplashTextOn("", $ASIN & " Copied!", 200, 120, -1, -1, 33)
															EndIf
															If $flash = 1 Then
																Sleep(1000)
																SplashOff()
															Else
																Sleep(500)
															EndIf
															If $private <> "" Then
																$ans = MsgBox(262177, "Private Comments Query", _
																	"Do you also want the Private Comments copied to this user?" & @LF & @LF & _
																	"NOTE - If this is a move rather than copy, then the Private" & @LF & _
																	"Comments will be lost, unless they are copied to this user.", 0, $PriceQueryGUI)
																If $ans = 2 And $job = "move" Then
																	IniDelete($namfle, $ASIN, "private")
																EndIf
															EndIf
														EndIf
													EndIf
												ElseIf $job = "move" Then
													$ans = MsgBox(262193, "Move Selected Entry Error", _
														"The selected entry already exists on the recipient's list." & @LF & @LF & _
														"Do you wish to just Remove it from current user's list?", 0, $PriceQueryGUI)
													If $ans = 1 Then
														_GUICtrlListView_DeleteItem($Listview_ebooks, $ind)
														IniDelete($catfle, $ASIN)
													EndIf
												ElseIf $job = "copy" Then
													SplashTextOn("", "Already Exists!", 200, 120, -1, -1, 33)
													Sleep(1000)
													If $flash = 1 Then SplashOff()
												EndIf
											Else
												Sleep(20)
											EndIf
										Else
											MsgBox(262192, "Move or Copy Error", "No list entry is selected!", 0, $PriceQueryGUI)
										EndIf
									Next
									$multi = ""
									$indx = ""
									If $job = "move" Then
										RemoveAllFromQueryList()
										DisableListChoices()
										GUICtrlSetData($Button_query, "QUERY")
										GUICtrlSetData($Combo_comm, "", "")
										$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
										If $resort = 1 And $nums > 0 Then
											If $ind > 0 Then $indx = $ind - 1
											If $slick = 1 Then
												GUISetState($PriceQueryGUI, @SW_DISABLE + @SW_LOCK)
												_GUICtrlListView_BeginUpdate($Listview_ebooks)
											EndIf
											_GUICtrlListView_DeleteAllItems($Listview_ebooks)
											;SortByColumnNumber(1)
											SortByColumnNumber()
											If $slick = 1 Then
												_GUICtrlListView_EndUpdate($Listview_ebooks)
												GUISetState($PriceQueryGUI, @SW_ENABLE + @SW_UNLOCK)
											EndIf
											$indx = ""
										Else
											If $nums > 0 Then
												If $slick = 1 Then
													GUISetState($PriceQueryGUI, @SW_DISABLE + @SW_LOCK)
													_GUICtrlListView_BeginUpdate($Listview_ebooks)
												EndIf
												For $e = 1 To $nums
													$ind = $e - 1
													$num = StringRight("000" & $e, 4)
													$start = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 4)
													$current = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 8)
													If $current <> $start Then $num = $num & "*"
													_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $num, 0)
												Next
												If $slick = 1 Then
													_GUICtrlListView_EndUpdate($Listview_ebooks)
													GUISetState($PriceQueryGUI, @SW_ENABLE + @SW_UNLOCK)
												EndIf
												$ind = 0
											Else
												$ind = -1
											EndIf
											GetSetCurrentStateAfterChanges()
										EndIf
										GUICtrlSetData($Group_list, "List Of Kindle Ebooks  (" & $nums & ")")
									EndIf
								ElseIf $job = "copy" Then
									If $clear = 1 Then $list = ""
								EndIf
								If $flash = 1 Then
									GUICtrlSetState($Label_wait, $GUI_HIDE)
								Else
									SplashOff()
								EndIf
								ExitLoop
							Else
								MsgBox(262192, "User Error", "That name does not yet exist!", 0, $PriceQueryGUI)
							EndIf
						ElseIf $name = $user Then
							MsgBox(262192, "User Error", "You cannot Move or Copy to current user!", 0, $PriceQueryGUI)
						EndIf
					WEnd
					DllClose($dll)
				EndIf
			EndIf
		EndIf
	Case ($msg = $Button_query Or $nons = 1) And StringLeft(GUICtrlRead($Button_query), 5) = "QUERY"
		; Query selected ebook(s)
		$press = _IsPressed("11")
		If $totlist = 1 Or $press = 1 Then
			; Get Total Price of selected items (or all items if CTRL was held down)
			If $list <> "" Or $press = 1 Then
				SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
				If FileExists($catfle) Then
					$sum = 0
					$multi = 1
					$selected = 0
					$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
					GUICtrlSetState($Listview_ebooks, $GUI_FOCUS)
					Send("{HOME}")
					_GUICtrlListView_SetItemSelected($Listview_ebooks, 0, True, True)
					For $e = 1 To $nums
						$ind = $e - 1
						If $selected = 0 Or $ind >= $selected Then
							_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
							_GUICtrlListView_EnsureVisible($Listview_ebooks, $ind, False)
							;
							GetTheASIN()
							If StringInStr($list, $ASIN) > 0 Or $press = 1 Then
								$current = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 8)
								$current = StringReplace($current, "*", "")
								$current = StringReplace($current, "#", "")
								$curr = StringLeft($current, 1)
								$current = StringReplace($current, $curr, "")
								$current = StringReplace($current, ".", "")
								$sum = $sum + $current
							EndIf
						Else
							MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
						EndIf
					Next
					$multi = ""
					$indx = ""
					If $sum > 0 Then
						$sum = StringTrimRight($sum, 2) & "." & StringRight($sum, 2)
						$curval = ""
						;$exchange = 1.04
						If $excon = 1 And $exchange <> "" And $exempt = 4 Then
							If StringIsFloat($exchange) = 1 Then
								$curval = Round($sum * $exchange, 2)
								If StringIsDigit($curval) Then $curval = $curval & ".00"
								While StringLeft(StringRight($curval, 3), 1) <> "."
									$curval = $curval & "0"
								WEnd
								$curval = $curr & $curval
							EndIf
						Else
							; Query of Exchange Rate failed this session (probably no web connection).
							$exchange = "???"
						EndIf
						$sum = $curr & $sum
						If $curval = "" Then $curval = "????"
						$curval = "  (" & $curval & " " & $currency & " at Exchange Rate of " & $exchange & ")"
						$sum = $sum & $curval
						$ans = MsgBox(262465, "Sum Total", _
							"The total price of all selected items added together." & @LF & @LF & _
							$sum & @LF & @LF & _
							"OK = Copy to clipboard.", 0, $PriceQueryGUI)
						If $ans = 1 Then
							ClipPut($sum)
						EndIf
					EndIf
				EndIf
				SplashOff()
			Else
				MsgBox(262192, "List Error", "No items are selected!", 0, $PriceQueryGUI)
			EndIf
		ElseIf $excel = 1 Then
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				Local $active, $attach, $exauthor, $extitle, $r, $SheetArray, $string, $wintxt, $oExcel
				SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
				Opt("WinTitleMatchMode", 3)
				;Workbooks("BKUPDATE.XLS").Worksheets("NEW BOOKS").Activate
				;Windows("BKUPDATE.XLS").Activate
				;WinSetState("Microsoft Excel - Bkupdate.xls", "", @SW_MINIMIZE)
				;WinWaitNotActive("Microsoft Excel - Bkupdate.xls", "", 5)
				;$wintxt = WinGetTitle("[TITLE:Microsoft Excel - Booklist.xls; CLASS:XLMAIN]", "")
				;MsgBox(262192, "Title Result", '"' & $wintxt & '"', 0, $PriceQueryGUI)
				WinActivate("[TITLE:Microsoft Excel - Booklist.xls; CLASS:XLMAIN]", "")
				WinWaitActive("[TITLE:Microsoft Excel - Booklist.xls; CLASS:XLMAIN]", "", 10)
				$active = WinActive("[TITLE:Microsoft Excel - Booklist.xls; CLASS:XLMAIN]", "")
				If $active = 1 Then
					; NOTE = Don't let this program be set as RunSafer in Online Armor firewall
					; as it prevents the Excel object being created.
					$oExcel = _ExcelBookAttach("Booklist.xls", "FileName")
					If @error = 1 Then
						$oExcel = _ExcelBookAttach("BOOKLIST", "FileName")
						If @error = 1 Then
							$oExcel = _ExcelBookAttach("Microsoft Excel - Booklist.xls", "FileName")
							If @error = 1 Then
								$oExcel = _ExcelBookAttach("Microsoft Excel - Booklist.xls", "Title")
								If @error = 1 Then
									$attach = 0
								Else
									$attach = 4
								EndIf
							Else
								$attach = 3
							EndIf
						Else
							$attach = 2
						EndIf
					Else
						$attach = 1
					EndIf
					;MsgBox(262192, "Attach Method", $attach, 0, $PriceQueryGUI)
					If $attach > 0 Then
						;$oExcel.Windows("Booklist.xls").Activate
						;MsgBox(262192, "Object Result", $objExcel, 0, $PriceQueryGUI)
						;MsgBox(262192, "Attach Result", "Booklist.xls was found!", 0, $PriceQueryGUI)
						;WinSetState("Microsoft Excel - Booklist.xls", "", @SW_RESTORE)
						;WinActivate("Microsoft Excel - Booklist.xls", "")
						;WinWaitActive("Microsoft Excel - Booklist.xls", "", 5)
						$res = _ExcelSheetActivate($oExcel, "BOOKLIST")
						If $res = 1 Then
							;Local $string = _ExcelSheetNameGet($oExcel)
							;MsgBox(262192, "Attach Result", $string, 0, $PriceQueryGUI)
							;_ExcelSheetList($objExcel)
							;Local $SheetArray = _ExcelSheetList($oExcel)
							;_ArrayDisplay($SheetArray, "All The WorkSheets In this WorkBook")
							If $rows < 1 Then
								;SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
								$SheetArray = _ExcelReadSheetToArray($oExcel, 2, 2, 0, 1, 1)
								$rows = $SheetArray[0][0]
							EndIf
							SplashOff()
							While 1
								$text = InputBox("Check Ebook Title", "Make desired changes for Excel search.", $title, "", 250, 130, -1, -1, 0, $PriceQueryGUI)
								If @error = 0 And $text <> "" Then
									; Case changes also detected.
									$extitle = StringReplace($text, ".", ". ")
									$extitle = StringStripWS($extitle, 7)
									If StringLeft($extitle, 4) = "The " Then
										$extitle = StringTrimLeft($extitle, 4) & ", The"
									EndIf
								Else
									ContinueLoop 2
								EndIf
								$text = InputBox("Check Ebook Author", "Make desired changes for Excel search.", $author, "", 240, 130, -1, -1, 0, $PriceQueryGUI)
								If @error = 0 And $text <> "" Then
									; Case changes also detected.
									$exauthor = StringReplace($text, ".", ". ")
									$exauthor = StringStripWS($exauthor, 7)
									$exauthor = StringUpper($exauthor)
								Else
									ContinueLoop 2
								EndIf
								SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
								For $r = 1 To $rows
									$string = _ExcelReadCell($oExcel, $r, 2)
									If StringInStr($string, $exauthor) > 0 Then
										$string = _ExcelReadCell($oExcel, $r, 4)
										If StringInStr($string, $extitle) > 0 Then
											WinActivate("Microsoft Excel - Booklist.xls", "")
											_ExcelSelectCell($oExcel, $r, 4)
											SplashOff()
											ExitLoop 2
										EndIf
									ElseIf $string = "" Or $r = $rows Then
										$ans = MsgBox(262451, "Search Result", _
											"Selected entry not found!" & @LF & @LF & _
											"YES = Try Again." & @LF & _
											"NO = Create New Entry." & @LF & _
											"CANCEL = Abort further processing..", 0, $PriceQueryGUI)
										If $ans = 6 Then
											SplashOff()
											ExitLoop
										ElseIf $ans = 7 Then
											$rows = 0
											ClipPut($exauthor & " <-+-> " & $extitle)
											;PERSONAL.XLA!AlphaJumpDialog
											;Application.Run "Booklist.xls!EntryChoice"
											WinActivate("Microsoft Excel - Booklist.xls", "")
											_ExcelSelectCell($oExcel, 2, 2)
											;_ExcelRunMacro($oExcel, "EntryChoice")
											SplashOff()
											_ExcelRunMacro($oExcel, "PERSONAL.XLA!AlphaJumpDialog")
											ExitLoop 2
										ElseIf $ans = 2 Then
											ExitLoop 2
										EndIf
									EndIf
								Next
								;SplashOff()
								;ExitLoop
								;MsgBox(262192, "Array Result", "Rows = " & $rows & @LF & "Columns = " & $SheetArray[0][1], 0, $PriceQueryGUI)
							WEnd
						Else
							MsgBox(262192, "Excel Error", "BOOKLIST Worksheet not found! " & $res, 0, $PriceQueryGUI)
						EndIf
					Else
						MsgBox(262192, "Excel Error", "Booklist.xls not found!", 0, $PriceQueryGUI)
					EndIf
				Else
					MsgBox(262192, "Excel Error", "Booklist.xls not active!", 0, $PriceQueryGUI)
				EndIf
				SplashOff()
				Opt("WinTitleMatchMode", 1)
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf			
		Else
			IniWrite($inifle, "Time Taken", "1_start", _NowTime(5))
			If _IsPressed("10") Then
				$ans = MsgBox(262179, "Single Item Query Report", _
					"YES = Show a report for every single item query." & @LF & _
					"NO = Don't show a report for current session." & @LF & _
					"CANCEL = Disable reporting for all future sessions." & @LF & @LF & _
					"NOTE - Report is only when a change has occurred." & @LF & _
					"Current session is while the program remains open." & @LF & _
					"YES & CANCEL modify the stored setting.", 0, $PriceQueryGUI)
				If $ans = 6 Then
					$single = 1
					IniWrite($inifle, "Single Item Query", "report", $single)
				ElseIf $ans = 7 Then
					$single = 4
				ElseIf $ans = 2 Then
					$single = 4
					IniWrite($inifle, "Single Item Query", "report", $single)
				EndIf
				IniWrite($inifle, "Time Taken", "1a_report", _NowTime(5))
			Else
				IniWrite($inifle, "Time Taken", "1a_report", "")
			EndIf
			If StringRight($user, 4) = " (b)" Then
				$ans = MsgBox(262449, "User Query", _
					"The current user appears to be one for relocated bought ebooks." & @LF & @LF & _
					"Do you really want to continue with a Query for this user?", 0, $PriceQueryGUI)
				If $ans = 2 Then
					ContinueLoop
				EndIf
				IniWrite($inifle, "Time Taken", "1b_user", _NowTime(5))
			Else
				IniWrite($inifle, "Time Taken", "1b_user", "")
			EndIf
			$errors = 0
			$wipe = ""
			; Probably don't need to replace this function instance,
			; as it is just being used to check that any names exist.
			IniReadSectionNames($usertmp)
			If Not @error Then
				;$ans = MsgBox(262433, "Remove Asterisks & Hashes Query", _
				;If $ans = 1 Then
				;	_FileCreate($usertmp)
				$ans = MsgBox(262179, "Update Asterisks & Hashes", _
					"(dialog auto-closes in 25 seconds, no changes)" & @LF & @LF & _
					"Before proceeding with Query, do you want existing" & @LF & _
					"asterisks etc in the Current price column to be kept?" & @LF & @LF & _
					"YES = Keep existing asterisks & hashes, if possible." & @LF & _
					"NO = Wipe all existing asterisks & hashes." & @LF & _
					"CANCEL = Wipe only if entry is re-checked." & @LF & @LF & _
					"NOTE - YES may not apply for an item, where a" & @LF & _
					"further change has occurred when re-checked," & @LF & _
					"but it will depend on the nature of the change." & @LF & _
					"Wipe is immediately permanent for ALL on NO.", 25, $PriceQueryGUI)
				If $ans = 7 Then
					$wipe = 1
					_FileCreate($usertmp)
				ElseIf $ans = 2 Then
					$wipe = 2
				EndIf
				IniWrite($inifle, "Time Taken", "1c_asterisks", _NowTime(5))
			Else
				IniWrite($inifle, "Time Taken", "1c_asterisks", "")
			EndIf
			;
			$mode = IniRead($inifle, "Query", "mode", "")
			If $mode = "prompt" Then
				GetModeFromPromptGUI()
			EndIf
			;
			If $mode = "semi-auto" Or $mode = "manual" Then
				MsgBox(262192, "Mode Warning", _
					"(dialog auto-closes in 30 seconds)" & @LF & @LF & _
					"It is advised, when using either the 'semi-auto' or 'manual' mode," & @LF & _
					"that you don't use your PC to do anything else, so as to prevent" & @LF & _
					"likely errors and unwanted consequences, some of which could" & @LF & _
					"conceivably be devastating." & @LF & @LF & _
					"STOP - Best method to stop during a Query ALL, is to hold down" & @LF & _
					"your keyboard PAUSE key (usually registered in a few seconds)." & @LF & @LF & _
					"NOTE - 'manual' mode relies on (if enabled) a hotkey combination" & @LF & _
					"of 'Ctrl+W' to close the current browser tab, as does 'semi-auto'" & @LF & _
					"mode, which also uses 'Ctrl+A' and 'Ctrl+C' and the Clipboard.", 30, $PriceQueryGUI)
				IniWrite($inifle, "Time Taken", "1d_warn", _NowTime(5))
			Else
				IniWrite($inifle, "Time Taken", "1d_warn", "")
			EndIf
			;
			If $timer = 1 Then
				GUICtrlSetState($Label_time, $GUI_SHOW)
				GUICtrlSetData($Label_time, "00:00:00")
				$begin = TimerInit()
			EndIf
			;
			$nons = 4
			If $flash = 1 Then
				GUICtrlSetData($Label_wait, "Please Wait!")
				GUICtrlSetState($Label_wait, $GUI_SHOW)
				$altered = 0
			Else
				SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
			EndIf
			;ContinueLoop
			;Local $ID = MouseGetCursor()
			GUISetCursor(15, 1, $PriceQueryGUI)
			DisableOrEnable($GUI_DISABLE)
			GUICtrlSetState($Checkbox_quall, $GUI_DISABLE)
			GUICtrlSetState($Button_query, $GUI_DISABLE)
			;
	;~ 		$IP = _GetIP()
	;~ 		If (@error = 1 Or $IP = -1) And $test = 4 Then
	;~ 			MsgBox(262192, "Query Error", "No connection detected!", 0, $PriceQueryGUI)
	;~ 		Else
			;If (Not @error And $IP <> -1) Or $test = 1 Then
			If $test = 1 Then
				$connection = 1
			Else
			;ElseIf $mode = "automatic" Then
				CheckForConnection()
				IniWrite($inifle, "Time Taken", "2_connect", _NowTime(5))
			EndIf
			;
			If $timer = 1 Then GetQueryTimeTaken()
			;
			$failed = ""
			;
			If $connection = 1 Or $mode = "manual" Then
				_FileCreate($querybak)
				IniWrite($querybak, "User", "name", $user)
				;
				If $mode = "manual" Or ($mode = "semi-auto" And $test <> 1) Then
					GUISetState(@SW_MINIMIZE, $PriceQueryGUI)
					Opt("WinTitleMatchMode", 1)
				EndIf
				;
				$started = 1
				If $quall = 1 Or $list <> "" Then
					; Query ALL ebooks
					$quit = ""
					If $stop = 1 And ($mode = "automatic" Or $mode = "semi-auto") Then
						;GUICtrlSetState($Button_query, $GUI_ENABLE)
						;GUICtrlSetData($Button_query, "STOP")
						GUICtrlSetData($Button_query, "WAIT")
						GUICtrlSetPos($Button_query, 536, 465, 60, 32)
						GUICtrlSetState($Checkbox_quit, $GUI_SHOW)
						If $mode = "semi-auto" Then $dll = DllOpen("user32.dll")
						$msg = ""
						$up = ""
						If $flash = 1 Then $passes = 0
						AdlibEnable("StopCheck")
					ElseIf $timer = 1 Then
						AdlibEnable("TimeCheck", 1000)
					EndIf
					;
					$multi = 1
					$report = ""
					$selected = 0
					GUICtrlSetState($Listview_ebooks, $GUI_FOCUS)
					If $ind <> 0 Then
						$ans = MsgBox(262433, "Start At Entry Query", _
							"(defaults to first ebook entry in 15 seconds)" & @LF & @LF & _
							"Do you want Query ALL to start from the currently selected entry?" & @LF & @LF & _
							"(Item " & $ind + 1 & ") " & $title & @LF & @LF & _
							"OK = Start from currently selected entry." & @LF & _
							"CANCEL = Start at the first listed ebook entry.", 15, $PriceQueryGUI)
						If $ans = 1 Then
							$selected = $ind
						ElseIf $ans = 2 Or $ans = -1 Then
							Send("{HOME}")
							_GUICtrlListView_SetItemSelected($Listview_ebooks, 0, True, True)
						EndIf
						IniWrite($inifle, "Time Taken", "2a_from", _NowTime(5))
					Else
						IniWrite($inifle, "Time Taken", "2a_from", "")
					EndIf
					;
					If $mode = "semi-auto" Then
						If $tabclose = 4 Then
							$ans = MsgBox(262193, "Close Tab Setting Query", _
								"The 'Close Browser Tab' option is not currently set, and you are using 'semi-auto' mode" & @LF & _
								"for a Query ALL.   This has the potential to cause errors, and have many ebook pages" & @LF & _
								"open. There is a possible impact on computer memory usage for many open pages." & @LF & @LF & _
								"Do you want the setting to be enabled? (this is seriously recommended)", 0, $PriceQueryGUI)
							If $ans = 1 Then
								$tabclose = 1
								IniWrite($inifle, "Browser Tab", "close", $tabclose)
							EndIf
						EndIf
						$copywait = IniRead($inifle, "Copy Delay", "wait", 1000)
						$moredel = 0
					EndIf
					;
					If $favorites = 1 Then
						_FileWriteLog($logfile, "QUERY Favorites.", -1)
					ElseIf $secondfavs = 1 Then
						_FileWriteLog($logfile, "QUERY Second Favorites.", -1)
					ElseIf $others = 1 Then
						_FileWriteLog($logfile, "QUERY Non-Favorites.", -1)
					Else
						_FileWriteLog($logfile, "QUERY Specified (ALL etc).", -1)
					EndIf
					_FileWriteLog($logfile, "User = " & $user, -1)
					$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
					For $e = 1 To $nums
						$ind = $e - 1
						If $selected = 0 Or $ind >= $selected Then
							_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
							_GUICtrlListView_EnsureVisible($Listview_ebooks, $ind, False)
							;
							If $test = 1 And ($mode = "automatic" Or $mode = "semi-auto") Then
								; TESTING ONLY
								GetTheASIN()
								$skipit = IniRead($catfle, $ASIN, "skip", "")
								If $skipit <> 1 Then
									If $list = "" Then
										; Query ALL based on options, if any.
										If $favorites = 1 Then
											$favorite = IniRead($catfle, $ASIN, "favorite", "")
											If $favorite = 1 Then
												$check = 1
											ElseIf $include = 1 Then
												$preorder = IniRead($catfle, $ASIN, "preorder", "")
												If $preorder = 1 Then
													$check = 1
												Else
													$check = ""
												EndIf
											Else
												$check = ""
											EndIf
										ElseIf $secondfavs = 1 Then
											$secondary = IniRead($catfle, $ASIN, "secondary", "")
											If $secondary = 1 Then
												$check = 1
											Else
												$check = ""
											EndIf
										ElseIf $first <> "" Then
											If $first = $ASIN Then
												Sleep(1500)
												If $end = $first Then $end = 1
												$first = ""
												;GUICtrlSetState($Item_start, $GUI_UNCHECKED)
												If $others = 1 Then
													CheckForNonFavorite()
												Else
													$check = 1
												EndIf
											Else
												$check = ""
											EndIf
										ElseIf $end <> "" Then
											If $end = $ASIN Then
												$end = 1
											Else
												If $others = 1 Then
													CheckForNonFavorite()
												Else
													$check = 1
												EndIf
											EndIf
										ElseIf $others = 1 Then
											CheckForNonFavorite()
										Else
											$check = 1
										EndIf
									Else
										; Query by list
										If StringInStr($list, $ASIN) > 0 Then
											$check = 1
										Else
											$check = ""
										EndIf
									EndIf
									If $check = 1 And $pause = 1 And $delay > 0 Then
										If $ind > 0 And $ind > $selected Then
											; Sleep is now split up to make a smoother time display
											; plus a quicker WAIT shown for STOP response.
											If $random = 1 Then
												; Integer
												;$sleep = Random(0, $delay, 1)
												; One Decimal Point (changed to for greater variation)
												$sleep = Random(0, $delay)
												$sleep = Round($sleep, 1)
												;Sleep($sleep * 1000)
												$ceiling = Ceiling($sleep)
												For $d = 1 To $ceiling
													If $d = $ceiling Then
														$sleep = $sleep - 1
														Sleep($sleep * 1000)
													Else
														;Sleep(1000)
														Sleep(500)
														Sleep(500)
													EndIf
												Next
											Else
												;Sleep($delay * 1000)
												For $d = 1 To $delay
													;Sleep(1000)
													Sleep(500)
													Sleep(500)
												Next
											EndIf
										EndIf
									EndIf
									;
									If $check = 1 And ($favorites = 1 Or $end = 1) Then
										;GUICtrlSetBkColor(-1, 0xF00000)
										$lne = $lowid + $ind + 1
										GUICtrlSetBkColor($lne, $lescol)
										$altered = $altered + 1
										If $flash = 1 Then GUICtrlSetData($Label_wait, "Please Wait   -   " & $altered & " changed")
										$title = IniRead($catfle, $ASIN, "title", "")
										IniWrite($inifle, "Query Title", $e, $title)
										If $end = 1 And $others = 1 Then
											CheckForNonFavorite()
											If $check = 1 Then Sleep(2000)
										Else
											Sleep(2000)
										EndIf
									ElseIf $check = 1 Then
										Sleep(750)
									Else
										Sleep(300)
									EndIf
								EndIf
							Else
								; NOT TESTING
								IniWrite($inifle, "Time Taken", "3_query", _NowTime(5))
								QueryCurrentPrice(1)
							EndIf
						EndIf
						If GUICtrlRead($Checkbox_quit) = $GUI_CHECKED Then
							GUICtrlSetState($Checkbox_quit, $GUI_UNCHECKED)
							$quit = 1
						EndIf
						If ($stop = 1 And $quit = 1) Or $end = 1 Then
							ExitLoop
						EndIf
					Next
					_FileWriteLog($logfile, "QUERY Completed.", -1)
					FileWriteLine($logfile, "")
					;
					If $mode = "manual" Or ($mode = "semi-auto" And $test <> 1) Then
						If $ontop = 4 Then
							WinSetOnTop($PriceQueryGUI, "", 1)
							$ontop = 1
							IniWrite($inifle, "Program Window", "on_top", $ontop)
							GUICtrlSetState($Button_ontop, $ontop)
						EndIf
						GUISetState(@SW_RESTORE, $PriceQueryGUI)
					EndIf
					;
					$multi = ""
					_GUICtrlListView_ClickItem($Listview_ebooks, $ind, "left", False, 1, 1)
					;
					If $end = 1 Then
						$end = ""
						$check = ""
						;GUICtrlSetState($Item_end, $GUI_UNCHECKED)
						;If $first = "" Then GUICtrlSetState($Item_show, $GUI_DISABLE)
					EndIf
					;
					If $flash = 1 Then
						GUICtrlSetColor($Label_wait, 0xF00000)
						GUICtrlSetData($Label_wait, "Finished   -   " & $altered & " changed")
					EndIf
					If $stop = 1 Then
						AdlibDisable()
						GUICtrlSetState($Checkbox_quit, $GUI_HIDE)
						GUICtrlSetPos($Button_query, 536, 465, 60, 50)
						;GUICtrlSetState($Button_query, $GUI_DISABLE)
						If $quall = 1 Then
							If $favorites = 1 Then
								GUICtrlSetData($Button_query, "QUERY" & @LF & "FAVS")
							ElseIf $secondfavs = 1 Then
								GUICtrlSetData($Button_query, "QUERY" & @LF & "SECS")
							ElseIf $others = 1 Then
								GUICtrlSetData($Button_query, "QUERY" & @LF & "NONS")
							Else
								GUICtrlSetData($Button_query, "QUERY" & @LF & "ALL")
							EndIf
						ElseIf $list <> "" Then
							GUICtrlSetData($Button_query, "QUERY" & @LF & "LIST")
						Else
							GUICtrlSetData($Button_query, "QUERY")
						EndIf
						If $mode = "semi-auto" Then DllClose($dll)
					ElseIf $timer = 1 Then
						AdlibDisable()
					EndIf
					;
					$timechk = ""
					If $timer = 1 Then
						If $hrs > 0 Then
							$timechk = $hrs & " hour(s) "
						EndIf
						If $mins > 0 Then
							$timechk = $timechk & $mins & " minute(s) "
						EndIf
						If $secs > 0 Then
							$timechk = $timechk & $secs & " second(s)"
						EndIf
						$timechk = StringStripWS($timechk, 2)
						IniWrite($inifle, "Last Query", "time", $timechk)
						$timechk = "---- Time Taken = " & $timechk & " ----"
					EndIf
					;
					If $errors > 0 Then
						If $report = "" Then
							$report = $errors & " errors occurred."
						Else
							$report = $report & @LF & $errors & " errors occurred."
						EndIf
					EndIf
					IniWrite($inifle, "Time Taken", "9_finish", _NowTime(5))
					;
					If $report <> "" Then
						; Create or Update one of a specified number of records
						If $slots > 0 Then
							While 1
								If IniRead($inifle, "Last Query Result - " & $user, 1, "") = "" Then
									IniWrite($inifle, "Last Query Result - " & $user, 1, "(" & _Now() & ")|" & StringReplace($report, @LF, "|"))
									;If IniRead($querybak, "Last Query Result - " & $user, 1, "") = "" Then IniWrite($querybak, "Last Query Result - " & $user, 1, "")
									ExitLoop
								Else
									; This will initially create blank entries until specified number of queries have occurred and all slots filled.
									$rec = $slots
									$exist = IniRead($inifle, "Last Query Result - " & $user, $rec, "")
									IniWrite($querybak, "Last Query Result - " & $user, $rec, $exist)
									While 1
										$exist = IniRead($inifle, "Last Query Result - " & $user, $rec - 1, "")
										IniWrite($inifle, "Last Query Result - " & $user, $rec, $exist)
										If $rec > 1 Then IniWrite($querybak, "Last Query Result - " & $user, $rec - 1, $exist)
										$rec = $rec - 1
										If $rec = 0 Then ExitLoop
									WEnd
								EndIf
							WEnd
						EndIf
						;
;~ 						; Limit number of lines in report (default is 20 lines)
;~ 						$reportmsg = ""
;~ 						$check = StringSplit($report, @LF, 1)
;~ 						If $check[0] <= $replines Then
;~ 							$reportmsg = $report
;~ 						Else
;~ 							For $c = 1 To $replines
;~ 								$reportmsg &= $check[$c] & @LF
;~ 							Next
;~ 							$reportmsg = $reportmsg & "(Report was limited to " & $replines & " lines)" & @LF
;~ 						EndIf
;~ 						;
						; Split number of lines for cycled report (default is 20 lines)
						$reportmsg = ""
						$check = StringSplit($report, @LF, 1)
						$checktot = $check[0]
						If $check[$checktot] = "" Or $check[$checktot - 1] = "" Then
							;$checktot = $checktot - 1
							$realtot = $checktot - 1
						Else
							$realtot = $checktot
						EndIf
						If $errors > 0 Then
							;$checktot = $checktot - 1
							$realtot = $realtot - 1
						EndIf
						If $realtot <= $replines Then
							$reportmsg = $report
							SaveReportToFile()
							ReportForQuery()
						Else
							SaveReportToFile()
							$split = $replines
							For $c = 1 To $checktot
								$reportmsg &= $check[$c] & @LF
								If $c = $split Or $c = $checktot Then
									;$split = $split + $c
									$split = $split + $replines
									If $c = $checktot Then
										$n = $realtot
									Else
										$n = $c
									EndIf
									$reportmsg = $reportmsg & "(Report was split every " & $replines & " lines)(" & $n & " of " & $realtot & ")" & @LF
									ReportForQuery()
									$reportmsg = ""
								EndIf
							Next
						EndIf
;~ 						;
;~ 						; Save Report to a temporary text file.
;~ 						_FileCreate($repfle)
;~ 						$report = StringReplace($report, @LF, @CRLF)
;~ 						_FileWriteToLine($repfle, 1, _Now() & @CRLF & $report & @CRLF & $timechk, 1)
;~ 						;
;~ 						$ans = MsgBox(262707, "Query Report", _
;~ 							"Some prices have changed since being added to the database." & @LF & @LF & _
;~ 							$reportmsg & $timechk & @LF & @LF & _
;~ 							"YES = Copy full result to the clipboard." & @LF & _
;~ 							"NO = See full result in temporary text file.", 0, $PriceQueryGUI)
;~ 						If $ans <> 2 Then
;~ 							If $ans = 6 Then
;~ 								ClipPut($report)
;~ 							ElseIf $ans = 7 Then
;~ 								If FileExists($repfle) Then Run($notepad & $repfle)
;~ 							EndIf
;~ 						EndIf
;~ 						;
					ElseIf $splash = 1 Then
						ShowNoResultSplash()
					EndIf
				ElseIf _GUICtrlListView_GetItemSelected($Listview_ebooks, $ind) = True Then
					; Query currently selected ebook
					IniWrite($inifle, "Time Taken", "3_query", _NowTime(5))
					$report = ""
					QueryCurrentPrice(1)
					GUICtrlSetData($Label_wait, "Finished!")
					Sleep(300)
					If $mode = "manual" Or $mode = "semi-auto" Then
						GUISetState(@SW_RESTORE, $PriceQueryGUI)
					EndIf
					GUICtrlSetTip($Listview_ebooks, "Queried - " & $ASIN & @LF & $title & @LF & $author & @LF & _Now())
					;
					IniWrite($inifle, "Time Taken", "9_finish", _NowTime(5))
					If $single = 1 Then
						If $errors > 0 Then
							If $report = "" Then
								$report = $errors & " errors occurred."
							Else
								$report = $report & @LF & $errors & " errors occurred."
							EndIf
						EndIf
						;
						If $report <> "" Then
							$realtot = 1
							$reportmsg = $report
							SaveReportToFile()
							ReportForQuery()
							$reportmsg = ""
						ElseIf $splash = 1 Then
							ShowNoResultSplash()
						EndIf
					EndIf
				Else
					MsgBox(262192, "Query Error", "No list entry is selected!", 0, $PriceQueryGUI)
				EndIf
			EndIf
			GUICtrlSetState($Button_query, $GUI_ENABLE)
			GUICtrlSetState($Checkbox_quall, $GUI_ENABLE)
			DisableOrEnable($GUI_ENABLE)
			If $flash = 1 Then
				GUICtrlSetState($Label_wait, $GUI_HIDE)
			Else
				SplashOff()
			EndIf
			GUISetCursor($ID, 1, $PriceQueryGUI)
			;
			If $failed = 1 Then
				If FileExists($failtxt) Then Run($notepad & $failtxt)
			EndIf
			;MsgBox(262192, "$IP", $IP, 0, $PriceQueryGUI)
		EndIf
	Case $msg = $Button_query And GUICtrlRead($Button_query) = "KOBO" & @LF & "QUERY" And $koboquery = 1
		; Query selected ebook(s)
		If FileExists($koboexe) Then ShellExecute($koboexe)
	Case $msg = $Button_opts
		; SETTINGS
		SettingsGUI()
	Case $msg = $Button_ontop
		; Toggle the On Top setting
		If GUICtrlRead($Button_ontop) = $GUI_CHECKED Then
			$ontop = 1
			WinSetOnTop($PriceQueryGUI, "", 1)
		Else
			$ontop = 4
			WinSetOnTop($PriceQueryGUI, "", 0)
		EndIf
		IniWrite($inifle, "Program Window", "on_top", $ontop)
	Case $msg = $Button_i
		; Program Information
		$ans = MsgBox(262209, "Program Information - Page 1", _
			"This program is in no way, shape or form etc, affiliated with or" & @LF & _
			"supported or even recommended by Amazon &/or partners." & @LF & @LF & _
			"Amazon Kindle Ebooks can have a price that varies over time," & @LF & _
			"so it can pay to keep tabs on ones you are interested in, just" & @LF & _
			"in case one becomes low enough for you to purchase." & @LF & @LF & _
			"This program aims to simplify the process of doing that." & @LF & @LF & _
			"Basically, you get the URL web address of an ebook you are" & @LF & _
			"interested in. You could already have this URL (link) in your" & @LF & _
			"Amazon Wishlist. Copy this to your clipboard, then click the" & @LF & _
			"ADD button. The clipboard entry should appear in the input" & @LF & _
			"field presented, or you can just paste it there. The field may" & @LF & _
			"be blank, because you are repeating the last item. After a" & @LF & _
			"few moments, all the List fields for a new entry should get" & @LF & _
			"populated. If they don't, it will be due to an unrecognized" & @LF & _
			"situation in the linked to web page for the URL (the only" & @LF & _
			"fix for that ebook page is an update of this program)." & @LF & @LF & _
			"Once you have added an ebook to the list, you can check it" & @LF & _
			"again, by selecting it and clicking on the QUERY button. You" & @LF & _
			"can also check any others, all at once (one after the other)" & @LF & _
			"by enabling the ALL checkbox. The 'Current' price field will" & @LF & _
			"be updated each time, but the 'Low' or 'High' fields won't be" & @LF & _
			"unless the current price is less or more. The 'Start' price will" & @LF & _
			"never change from what it was when book was first added." & @LF & @LF & _
			"Click OK to read more information." & @LF & @LF & _
			"© January 2015 - program created by TheSaint.", 0, $PriceQueryGUI)
		If $ans = 1 Then
			$ans = MsgBox(262209, "Program Information - Page 2", _
				"If an error occurs, but the web page was successfully read," & @LF & _
				"the text should be in the Html.txt or Query.txt file, until it is" & @LF & _
				"overwritten by the next error (which helps with diagnosing)." & @LF & @LF & _
				"Sorting can be done, by clicking on the column headers, with" & @LF & _
				"Column 1 (by Add order), Column 2 (by Titles alphabetically)," & @LF & _
				"Column 3 (by Titles alphabetically, All the special items first)," & @LF & _
				"Column 4 (by Authors alphabetically, with Editors first)," & @LF & _
				"Column 6 (by Price changes, decrease first, increase last)," & @LF & _
				"Column 8 (last) (by Current price, lowest to highest)." & @LF & _
				"NOTE - Special items includes Bought, Favorites, Pre-Orders." & @LF & _
				"Column 6 (Low) has all unchanged listed between decreased" & @LF & _
				"and increased, with all results shown in Column 8 (Current)." & @LF & _
				"Column 5 (Start), NO sort, jump to first ebook entry." & @LF & _
				"Column 7 (High), NO sort, jump to last ebook entry." & @LF & @LF & _
				"Selecting a list entry, shows both the added date and last" & @LF & _
				"checked date in the Comments field." & @LF & @LF & _
				"Asterisk (*) are used in Column 1 after the number, to show" & @LF & _
				"that the price has changed for that entry since it was added." & @LF & _
				"This is a permanent indicator, and unlike any asterisk or hash" & @LF & _
				"shown as the latest Query result in the Current (8th) column," & @LF & _
				"that may be lost after sort, user change, program close, etc." & @LF & @LF & _
				"The SAVE button can be used to save a comma delimited CSV" & @LF & _
				"file or view (while CTRL key held down) the 'Catalog.ini' file," & @LF & _
				"or view (while SHIFT key held down) the last saved file." & @LF & @LF & _
				"Click OK to read more information.", 0, $PriceQueryGUI)
			If $ans = 1 Then
				MsgBox(262208, "Program Information - Page 3", _
					"Price change comments and values are either relevant to the" & @LF & _
					"Start price or the last Low, High or Current price." & @LF & @LF & _
					"When the ALL option for a QUERY is checked, then the Start" & @LF & _
					"and End entry options will become available for assignment." & @LF & @LF & _
					"The 'Single Item Query' report setting can be altered, from a" & @LF & _
					"dialog shown if clicking Query button while CTRL held down." & @LF & @LF & _
					"TIPS - A quicker way to add an ebook to the Query, Move or" & @LF & _
					"Copy List, is to hold down LEFT CTRL while clicking the ebook" & @LF & _
					"entry. If clicking an already added entry, it will unlist it. Look" & @LF & _
					"at the QUERY button right-click menu for List choice selection," & @LF & _
					"which now also includes an 'Enable Get Total' option for total" & @LF & _
					"sum of prices, for the selected ebooks on the Query List." & @LF & @LF & _
					"Hold down CTRL while clicking the QUERY button, to get the" & @LF & _
					"total price of all ebooks on the current user list." & @LF & @LF & _
					"Holding down CTRL when the program starts, prevents the" & @LF & _
					"last user list from loading (if you are quick enough)." & @LF & @LF & _
					"THANKS to all those who assisted me in any way - visit the" & @LF & _
					"AutoIt Forum pages for this program, to see that detail." & @LF & @LF & _
					"Program updated thru January 2015 -> May 2020.", 0, $PriceQueryGUI)
			EndIf
		EndIf
	Case $msg = $Button_find Or $msg = $Combo_find
		; Search for selected in title or author
		$find = GUICtrlRead($Combo_find)
		If $find <> "" Then
			If $where = "Both" Then
				MsgBox(262192, "Search Error", "Either 'Authors' or 'Titles' must be selected!" & @LF & _
					"Both is used purely for Display or Clipboard Copy.", 0, $PriceQueryGUI)
				ContinueLoop
			EndIf
			If $where = "Simple" Then
				$ans = MsgBox(262179, "Simple Search Query", _
					"Find the specified text in the chosen" & @LF & _
					"column, and then select that row." & @LF & @LF & _
					"YES = Search for Title." & @LF & _
					"NO = Search for Author." & @LF & _
					"CANCEL = Abort." & @LF & @LF & _
					"NOTE - Search starts at the selected" & @LF & _
					"entry and wraps around as needed.", 0, $PriceQueryGUI)
				If $ans = 6 Then
					$cat = "Title"
				ElseIf $ans = 7 Then
					$cat = "Author"
				ElseIf $ans = 2 Then
					ContinueLoop
				EndIf
				$found = ""
				$match = ""
				$e = _GUICtrlListView_GetSelectedIndices($Listview_ebooks, True)
				If $e[0] = 1 Then
					; One item selected (as starting point)
					$e = $e[1]
				Else
					; No item selected (so start at -1 ... before first entry)
					$e = -1
				EndIf
				;MsgBox(262192, "Selected", $e, 0, $PriceQueryGUI)
				While 1
					$e = _GUICtrlListView_FindInText($Listview_ebooks, $find, $e, True)
					;MsgBox(262192, "Found", $e, 0, $PriceQueryGUI)
					If $e > -1 Then
						If $found = "" Then
							$found = $e
						ElseIf $found = $e Then
							ExitLoop
						EndIf
						If $cat = "Author" Then
							$author = _GUICtrlListView_GetItemText($Listview_ebooks, $e, 3)
							If StringInStr($author, $find) > 0 Then
								$match = 1
								ExitLoop
							EndIf
						Else
							$title = _GUICtrlListView_GetItemText($Listview_ebooks, $e, 1)
							If StringInStr($title, $find) > 0 Then
								$match = 1
								ExitLoop
							EndIf
						EndIf
					Else
						$e = _GUICtrlListView_GetSelectedIndices($Listview_ebooks, True)
						If $e[0] > 0 Then
							$e = $e[1]
							If $cat = "Author" Then
								$author = _GUICtrlListView_GetItemText($Listview_ebooks, $e, 3)
								If StringInStr($author, $find) > 0 Then
									$match = 1
								EndIf
							Else
								$title = _GUICtrlListView_GetItemText($Listview_ebooks, $e, 1)
								If StringInStr($title, $find) > 0 Then
									$match = 1
								EndIf
							EndIf
						Else
							$e = -1
						EndIf
						ExitLoop
					EndIf
				WEnd
				If $e > -1 And $match = 1 Then
					_GUICtrlListView_SetItemSelected($Listview_ebooks, $e, True, True)
					_GUICtrlListView_ClickItem($Listview_ebooks, $e, "left", False, 1, 1)
				Else
					MsgBox(262192, "Find Result", "Nothing found matching criteria specified!", 0, $PriceQueryGUI)
				EndIf
			ElseIf $where = "ASIN" Then
				$e = _GUICtrlListView_FindInText($Listview_ebooks, $find, -1, False, False)
				If $e > -1 Then
					_GUICtrlListView_SetItemSelected($Listview_ebooks, $e, True, True)
					_GUICtrlListView_ClickItem($Listview_ebooks, $e, "left", False, 1, 1)
				Else
					$check = StringSplit($users, "|", 1)
					For $c = 1 To $check[0]
						$name = $check[$c]
						If $name <> "" And $name <> $user Then
							$namfle = $scriptdir & "\" & $name & ".ini"
							If FileExists($namfle) Then
								If IniRead($namfle, $find, "title", "") <> "" Then
									$title = IniRead($namfle, $find, "title", "")
									$author = IniRead($namfle, $find, "author", "")
									$date = IniRead($namfle, $find, "date", "")
									$date = StringSplit($date, " ", 1)
									$date = $date[1]
									$date = StringSplit($date, "/", 1)
									$date = $date[3] & "-" & $date[2] & "-" & StringRight("0" & $date[1], 2)
									$detail = InputBox("Search Result", "Found in user - " & $name & '.   Click on OK to copy to the clipboard.   Result = "Title - Author - Date"', _
																	$title & " - " & $author &" - " & $date, "", 500, 130, -1, -1, 0, $PriceQueryGUI)
									If @error = 0 Then
										ClipPut($detail)
										ExitLoop
									ElseIf $c <> ($check[0] - 1) Then
										$ans = MsgBox(262177, "Search", "Find another instance (different user)?", 0, $PriceQueryGUI)
										If $ans = 2 Then ExitLoop
									EndIf
								ElseIf $c = ($check[0] - 1) Then
									MsgBox(262192, "Find Result", "Nothing found matching criteria specified!", 0, $PriceQueryGUI)
								EndIf
							EndIf
						EndIf
					Next
				EndIf
			Else
				If _IsPressed("11") Then
					If StringInStr($searches, "|" & $find & "|") > 0 Then
						$ans = MsgBox(262177, "Remove Query", "Delete selected search text item?", 0, $PriceQueryGUI)
						If $ans = 1 Then
							$searches = StringReplace($searches, "|" & $find & "|", "|")
							IniWrite($inifle, $user, $what, $searches)
							GUICtrlSetData($Combo_find, "", "")
							GUICtrlSetData($Combo_find, $searches, "")
						EndIf
					EndIf
				Else
					If $timer = 1 Then GUICtrlSetState($Label_time, $GUI_HIDE)
					If StringInStr($searches, "|" & $find & "|") < 1 Then
						$searches = $searches & $find & "|"
						IniWrite($inifle, $user, $what, $searches)
						GUICtrlSetData($Combo_find, "", "")
						GUICtrlSetData($Combo_find, $searches, $find)
					EndIf
					$name = "Search"
					$namfle = $scriptdir & "\" & $name & ".ini"
					If Not FileExists($namfle) Then
						$users = $users & $name & "|"
						IniWrite($inifle, "User", "names", $users)
						GUICtrlSetData($Combo_user, "", "")
						GUICtrlSetData($Combo_user, $users, $user)
						IniWrite($inifle, "Save Query Results - " & $name, "slots", 5)
					EndIf
					; Creates or Wipes
					_FileCreate($namfle)
					;
					If FileExists($catfle) Then
						SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
						;$ents = IniReadSectionNames($catfle)
						;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
						;	$nmb = StringLen(_ArrayToString($ents, "|", 1))
						;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
						$ents = FileRead($catfle)
						$ents = StringSplit($ents, @CRLF, 1)
						If Not @error Then
							;$nums = $ents[0]
							;For $e = 1 To $nums
							;	$ASIN = $ents[$e]
							$e = 0
							$lines = $ents[0]
							For $l = 1 To $lines
								$linetxt = $ents[$l]
								If StringLeft($linetxt, 1) = "[" Then
									$ASIN = StringTrimLeft($linetxt, 1)
									$ASIN = StringStripCR($ASIN)
									$ASIN = StringTrimRight($ASIN, 1)
									;MsgBox(262192, "Line Text", $ASIN, 0, $PriceQueryGUI)
									If $ASIN <> "" Then
										$e = $e + 1
										$found = ""
										If $where = "Titles" Then
											$title = IniRead($catfle, $ASIN, "title", "")
											If StringInStr($title, $find) > 0 Then $found = 1
										ElseIf $where = "Authors" Then
											$author = IniRead($catfle, $ASIN, "author", "")
											If StringInStr($author, $find) > 0 Then $found = 1
										EndIf
										If $found = 1 Then
											$entry = IniReadSection($catfle, $ASIN)
											If Not @error Then 
												IniWriteSection($namfle, $ASIN, $entry)
											EndIf
										EndIf
									EndIf
								EndIf
							Next
							$nums = $e
							$user = $name
							GUICtrlSetData($Combo_user, $user)
							SetUsernameAndEbooks()
						EndIf
						SplashOff()
					EndIf
				EndIf
			EndIf
		EndIf
	Case $msg = $Button_clip
		; Copy Author &/or Title or MOBI-ASIN to clipboard
		$cliptxt = GUICtrlRead($Input_where)
		ClipPut($cliptxt)
		$val = _IsPressed("11")
		If $minclip = 1 And $val <> 1 Then
			GUISetState(@SW_MINIMIZE, $PriceQueryGUI)
		ElseIf $minclip = 4 And $val = 1 Then
			GUISetState(@SW_MINIMIZE, $PriceQueryGUI)
		EndIf
	Case $msg = $Button_changed
		; List of ebooks where current price has changed
		If $timer = 1 Then GUICtrlSetState($Label_time, $GUI_HIDE)
		$name = "Changed"
		$namfle = $scriptdir & "\" & $name & ".ini"
		If Not FileExists($namfle) Then
			$users = $users & $name & "|"
			IniWrite($inifle, "User", "names", $users)
			GUICtrlSetData($Combo_user, "", "")
			GUICtrlSetData($Combo_user, $users, $user)
			IniWrite($inifle, "Save Query Results - " & $name, "slots", 5)
		EndIf
		; Creates or Wipes
		_FileCreate($namfle)
		;
		If FileExists($catfle) Then
			$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
			If $nums > 0 Then
				SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
				For $e = 1 To $nums
					$ind = $e - 1
					$current = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 8)
					If StringInStr($current, "*") > 0 Or StringInStr($current, "#") > 0 Then
						GetTheASIN()
						$entry = IniReadSection($catfle, $ASIN)
						If Not @error Then 
							IniWriteSection($namfle, $ASIN, $entry)
						EndIf
					EndIf
				Next
				$user = $name
				GUICtrlSetData($Combo_user, $user)
				SetUsernameAndEbooks()
				SplashOff()
			EndIf
		EndIf
	Case $msg = $Button_add
		; Add another ebook
		GUICtrlSetState($Button_add, $GUI_DISABLE)
		GUICtrlSetState($Listview_ebooks, $GUI_FOCUS)
		Send("{END}")
		_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, False)
		If $test = 1 Then
			$connection = 1
		Else
			CheckForConnection()
		EndIf
		If $connection = 1 Then
			If $timer = 1 Then GUICtrlSetState($Label_time, $GUI_HIDE)
			;
			$mode = IniRead($inifle, "Query", "mode", "")
			If $mode = "prompt" Then
				GetModeFromPromptGUI()
			EndIf
			;
			If $ontop = 1 And $disable = 1 Then
				; Deselect On Top setting.
				WinSetOnTop($PriceQueryGUI, "", 0)
				GUICtrlSetState($Button_ontop, 4)
			EndIf
			;
			While 1
				If $test = 1 Then
					$link = "http://www.amazon.com/dp/B00N333333/ref=wl_it_dp_o_pC_nS_ttl?_encoding=UTF8&colid=111111111111&coliid=22222222222222"
				Else
					$clip = ClipGet()
					$http = StringLeft($clip, 7)
					If $http = "http://" Or $http = "https:/" Then $link = $clip
					If $lasturl = $link Then $link = ""
				EndIf
				$link = InputBox("ADD an Ebook to the List", "Enter the URL for an ebook (i.e. from a link in your Amazon Wishlist)." _
					& @LF & @LF & "(For any next URL --> Hold down CTRL while clicking CANCEL, to re-import from the clipboard.)", $link, "", 500, 160, -1, -1, 0, $PriceQueryGUI)
				If @error = 0 And $link <> "" Then
					If StringLeft($link, 7) = "http://" Or StringLeft($link, 8) = "https://" Then
						;If (StringInStr($link, "://www.amazon.com/") > 0 And StringInStr($link, "/dp/") > 0 _
						;If (StringInStr($link, "://www.amazon.com") > 0 And StringInStr($link, "/dp/") > 0 _
						$link = StringReplace($link, "/dp/product/", "/dp/")
						$link = StringReplace($link, "/gp/product/", "/dp/")
						$link = StringReplace($link, "/gp/", "/dp/")
						ClipPut($link)
						If (StringInStr($link, ".amazon.com") > 0 And StringInStr($link, "/dp/") > 0 _
							And $relax = 1) Or StringInStr($link, "://www.amazon.com/dp/") > 0 Then
							$URL = $link
						Else
							$URL = ""
						EndIf
					Else
						$URL = ""
					EndIf
				Else
					$URL = ""
				EndIf
				;If @error = 0 And $link <> "" And ((StringLeft($link, 22) = "http://www.amazon.com/" And StringInStr($link, "/dp/") > 0 And $relax = 1) _
				;	Or StringLeft($link, 25) = "http://www.amazon.com/dp/") Then
				If $URL <> "" Then
					If $flash = 1 Then
						GUICtrlSetData($Label_wait, "Please Wait!")
						GUICtrlSetState($Label_wait, $GUI_SHOW)
					Else
						SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
					EndIf
					$lasturl = $URL
					$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
					$num = StringRight("000" & $nums + 1, 4)
					$lne = $num
					;
					If StringLeft($URL, 25) = "http://www.amazon.com/dp/" Then
						$ASIN = StringReplace($URL, "http://www.amazon.com/dp/", "")
					ElseIf StringLeft($URL, 26) = "https://www.amazon.com/dp/" Then
						$ASIN = StringReplace($URL, "https://www.amazon.com/dp/", "")
					Else
						$ASIN = StringSplit($URL, "/dp/", 1)
						$ASIN = $ASIN[2]
					EndIf
					$ASIN = StringSplit($ASIN, "/", 1)
					$ASIN = $ASIN[1]
					$ASIN = StringSplit($ASIN, "?", 1)
					$ASIN = $ASIN[1]
					If IniRead($catfle, $ASIN, "title", "") = "" Then
						$date = _Now()
						IniWrite($catfle, $ASIN, "date", $date)
						IniWrite($catfle, $ASIN, "url", $URL)
						;
						; Check other users for same MOBI-ASIN (previously called ISBN)
						$addit = 1
						$tit = ""
						$aut = ""
						$check = StringSplit($users, "|", 1)
						For $c = 1 To $check[0]
							$name = $check[$c]
							If $name <> $user Then
								$namfle = $scriptdir & "\" & $name & ".ini"
								If FileExists($namfle) Then
									If IniRead($namfle, $ASIN, "title", "") <> "" Then
										$title = IniRead($namfle, $ASIN, "title", "")
										IniWrite($catfle, $ASIN, "title", $title)
										$author = IniRead($namfle, $ASIN, "author", "")
										IniWrite($catfle, $ASIN, "author", $author)
										;
										$ans = MsgBox(262691, "Duplicate Title", _
											"The current ebook being added, already exists for another user." & @LF & @LF & _
											"YES = Get an updated version of same ebook for current user." & @LF & _
											"NO = Get details from other user and just query price." & @LF & @LF & _
											"CANCEL = Abort any update or copy transfer of detail." & @LF & @LF & _
											"NOTE - Detail stored for the other user is not changed, except" & @LF & _
											"perhaps for Image Data, if missing or if replacing is indicated.", 0, $PriceQueryGUI)
										If $ans = 6 Then
											$tit = $title
											$aut = $author
										ElseIf $ans = 7 Then
											$addit = ""
											$start = ""
											IniWrite($catfle, $ASIN, "start", $start)
											$low = ""
											IniWrite($catfle, $ASIN, "low", $low)
											$high = ""
											IniWrite($catfle, $ASIN, "high", $high)
											$last = ""
											IniWrite($catfle, $ASIN, "last", $last)
											$current = "$0.00"
											IniWrite($catfle, $ASIN, "current", $current)
											IniWrite($catfle, $ASIN, "query", _Now())
											;
											If $sumfiles <> 1 Then
												$summary = IniRead($namfle, $ASIN, "summary", "")
												IniWrite($catfle, $ASIN, "summary", $summary)
											EndIf
											$preord = IniRead($namfle, $ASIN, "preorder", "")
											AddNewEbookToList(2)
											;
											GUICtrlSetState($Button_query, $GUI_DISABLE)
											QueryCurrentPrice(2)
											GUICtrlSetState($Button_query, $GUI_ENABLE)
										ElseIf $ans = 2 Then
											$addit = ""
										EndIf
										ExitLoop
									EndIf
								EndIf
							EndIf
						Next
						;
						If $addit = 1 Then
							If $mode = "manual" Or $mode = "semi-auto" Then
								GUISetState(@SW_MINIMIZE, $PriceQueryGUI)
								If $flash <> 1 Then SplashOff()
								$win = "Manually Add Ebook"
								$item = "title"
								$txtval = "Ebook Title"
								$inputxt1 = " from web page && paste into"
								$inputxt2 = "the input field below."
								$inputxt3 = "OK = Use new or ignore original input text." & @LF & "CANCEL = Abort ADD."
								While 1
									SetWinOnTop()
									$field = InputBox($win, "Copy the " & $item & $inputxt1 & @LF & $inputxt2 & @LF & @LF & $inputxt3, $txtval, "", 250, 185, 10, 30, 0, $PriceQueryGUI)
									If @error = 0 And ($field <> "" Or ($field = "" And ($item = "preorder" Or $item = "description"))) Then
										$field = StringStripWS($field, 3)
										If $item = "title" Then
											$title = $field
											IniWrite($catfle, $ASIN, "title", $title)
											$item = "author"
											$txtval = "Author Name"
											$inputxt1 = " from web page && paste"
											$inputxt2 = "into the input field below."
										ElseIf $item = "author" Then
											$author = $field
											IniWrite($catfle, $ASIN, "author", $author)
											$item = "price"
											$txtval = "$0.00"
											$inputxt1 = " from web page && paste into"
											$inputxt2 = "the input field below."
										ElseIf $item = "price" Then
											$price = $field
											StoreInitialPrices()
											$item = "preorder date"
											$txtval = "Publication Date"
											$inputxt1 = " from web page &&"
											$inputxt2 = "paste into the input field below."
										ElseIf $item = "preorder date" Then
											If $field <> "" And $field <> "Publication Date" Then
												$pubdate = $field
												IniWrite($comfle, $ASIN, "comment", "Publication Date: " & $pubdate & "|")
												$preorder = 1
												IniWrite($catfle, $ASIN, "preorder", $preorder)
											Else
												$preorder = ""
											EndIf
											$item = "description"
											$txtval = "Book Description"
										ElseIf $item = "description" Then
											If $field = "Book Description" Then $field = ""
											$summary = $field
											If $summary <> "" Then
												If StringLeft($summary, 10) = StringLeft(ClipGet(), 10) Then
													If $summary <> ClipGet() Then $summary = ClipGet()
												EndIf
												$summary = StringReplace($summary, @CR, " ")
												$summary = StringReplace($summary, @CRLF, " ")
												$summary = StringReplace($summary, @LF, " ")
												$check = StringSplit($tags, "|")
												For $t = 1 To $check[0]
													$tag = StringSplit($check[$t], ":")
													If $tag[0] = 2 Then
														$replace = $tag[2]
														If $replace = "pipe" Then $replace = "|"
													Else
														$replace = ""
													EndIf
													$tag = $tag[1]
													$summary = StringReplace($summary, $tag, $replace)
												Next
												$summary = StringReplace($summary, "| |", "||")
												$summary = StringReplace($summary, "|||", "||")
												TidyUpSummary()
											EndIf
											$item = ""
											ExitLoop
										EndIf
									Else
										$title = ""
										IniDelete($catfle, $ASIN)
										ExitLoop
									EndIf
								WEnd
								GUISetState(@SW_RESTORE, $PriceQueryGUI)
								If $title <> "" Then
									If $preorder = 1 Then
										$BKID = "Pre-Order - " & $ASIN
									Else
										$BKID = $ASIN
									EndIf
									;
									_FileWriteLog($logfile, "ADDED = " & $BKID, -1)
									_FileWriteLog($logfile, "Title = " & $title, -1)
									_FileWriteLog($logfile, "Author = " & $author, -1)
									_FileWriteLog($logfile, "Price = " & $start, -1)
									_FileWriteLog($logfile, "User = " & $user, -1)
									FileWriteLine($logfile, "")
									GUICtrlCreateListViewItem($num & "|" & $title & "|" & $BKID & "|" & $author & "|" & $start & "|" & $low & "|" & $high & "|" & $last & "|" & $current, $Listview_ebooks)
									If IsInt($lne / 2) = 1 Then GUICtrlSetBkColor(-1, 0xF0D0F0)
									;
									$ind = $num - 1
									GetSetCurrentStateAfterChanges()
									GUICtrlSetData($Group_list, "List Of Kindle Ebooks  (" & $nums & ")")
									;
									$URL = ""
									$title = ""
									$author = ""
									$price = ""
									$pubdate = ""
									$preorder = ""
								EndIf
							ElseIf $mode = "automatic" Then
								$html = _INetGetSource($URL)
								If @error <> 1 Or $test = 1 Then
									If $test = 1 Then
										; Testing only
										Local $txtfle
										; NOTE - Change the MOBI-ASIN (previously called ISBN) in the above section '$link = ' (line 1692) to avoid existing title response.
										;$txtfle = FileOpen($scriptdir & "\Ebook.html", 0)
										;$txtfle = FileOpen($scriptdir & "\HTML\Testing.htm", 0)
										$txtfle = FileOpen($scriptdir & "\HTML Query\Dani Silver Thriller\Html.txt", 0)
										$html = FileRead($txtfle)
										FileClose($txtfle)
										$txtfle = ""
									EndIf
									$html = StringStripWS($html, 7)
									_FileWriteToLine($ebooktxt, 1, $html, 1)
									If $data = 1 Then GetImageData()
									If $div > 2 Then
										;$chrcnt = Round(StringLen($html) / 4)
										$chrcnt = Round(StringLen($html) / $div)
										IniWrite($inifle, "Html Read", "reduction", $chrcnt)
										$chrcnt = $chrcnt - $getcnt
										$html = StringTrimLeft($html, $chrcnt)
										$html = StringTrimRight($html, $chrcnt)
										;MsgBox(262208, "$chrcnt", $chrcnt, 0, $PriceQueryGUI)
									EndIf
									;
									; NEW METHOD
									; Get Price
									$continue = ""
									$etext = ""
									If StringInStr($html, "Kindle Price:") > 0 Then
										$check = StringSplit($html, "Kindle Price:", 1) ; Line 2316
										$preord = ""
									ElseIf StringInStr($html, "Pre-order Price:") > 0 Then
										$check = StringSplit($html, "Pre-order Price:", 1)
										$preord = 1
									ElseIf StringInStr($html, ">Kindle<") > 0 Then
										$check = StringSplit($html, ">Kindle<", 1)
									Else
										$check = StringSplit($html, ">eTextbook<", 1)
										$etext = 1
									EndIf
									If $check[0] < 2 Then
										$preord = ""
										$ans = MsgBox(262193, "Read Error 2", _
											"The ebook's 'Price' could not be determined!" & @LF & @LF & _
											"Do you wish to continue with ADD?" & @LF & @LF & _
											"OK = Use a price of $0.00 for the ebook." & @LF & _
											"CANCEL = Abort adding current ebook." & @LF & @LF & _
											"NOTE - Hold down SHIFT when clicking OK" & @LF & _
											"to have alternate currency symbol used.", 0, $PriceQueryGUI)
										If $ans = 1 Then
											$continue = 1
											If _IsPressed("10") Then
												$price = $csign & "0.00"
											Else
												$price = "$0.00"
											EndIf
										Else
											IniDelete($catfle, $ASIN)
										EndIf
									EndIf
									If $check[0] > 1 Or $continue = 1 Then
										If $continue = "" Then
											If $etext = 1 Then
												$price = $check[2]
												$price = StringSplit($price, "</span>", 1)
												$price = $price[1]
												$price = StringSplit($price, ">", 1)
												$price = $price[$price[0]]
												$price = StringStripWS($price, 7)
											Else
;~ 												$html = $check[2]
;~ 												$pos = StringInStr($html, "</b>")
;~ 												$price = StringLeft($html, $pos - 1)
;~ 												$html = StringTrimLeft($html, $pos)
												$price = $check[2]
												$pos = StringInStr($price, "</b>")
												If $pos > 0 Then
													$price = StringLeft($price, $pos - 1)
												Else
													$pos = StringInStr($price, "</tr>")
													If $pos > 0 Then
														$price = StringLeft($price, $pos - 1)
													Else
														$price = ""
													EndIf
												EndIf
												;$html = StringTrimLeft($html, $pos)
												;MsgBox(262192, "Error Check 1", $pos, 0)
											EndIf
											While 1
												$check = StringLeft($price, 1)
												If $check = "$" Or $check = $csign Then
													$price = StringSplit($price, "<", 1)
													$price = $price[1]
													$price = StringStripWS($price, 7)
													ExitLoop
												Else
													$price = StringTrimLeft($price, 1)
													If $price = "" Then
														$ans = MsgBox(262193, "Price Missing", _
															"The ebook's 'Price' could not be determined!" & @LF & @LF & _
															"OK = Use a price of $0.00 for the ebook." & @LF & _
															"CANCEL = Use " & $csign & "0.00 instead.", 0, $PriceQueryGUI)
														If $ans = 1 Then
															$price = "$0.00"
														Else
															$price = $csign & "0.00"
														EndIf
														ExitLoop
													EndIf
												EndIf
											WEnd
										EndIf
										StoreInitialPrices()
										;
										;MsgBox(262208, "Got Here 1", $price, 0, $PriceQueryGUI)
										; Get Title
										;$check = StringSplit($html, 'ebooksProductTitle', 1)
										$check = StringSplit($html, '"productTitle"', 1)
										If $check[0] = 1 Then
											$check = StringSplit($html, '"ebooksProductTitle"', 1)
											If $check[0] = 1 Then
												$check = StringSplit($html, "ProductTitle", 1)
												If $check[0] = 1 Then $check = StringSplit($html, "productTitle", 1)
											EndIf
										EndIf
										
;~ 										$check = StringSplit($html, "productTitle", 1) ; Line 3346
;~ 										If $check[0] = 1 Then $check = StringSplit($html, "ProductTitle", 1) ; Line 3346
										;MsgBox(262208, "Got Here A", $check[0], 0, $PriceQueryGUI)
										If $check[0] > 1 Then
											;MsgBox(262208, "Got Here 2", $price, 0, $PriceQueryGUI)
											$html = $check[2]
											$title = StringSplit($html, "<", 1)
											If $title[0] > 1 Then
												;MsgBox(262208, "Got Here 3", $price, 0, $PriceQueryGUI)
												;$html = $title[2]
												$title = $title[1]
												$title = StringSplit($title, ">", 1)
												If $title[0] > 1 Then
													$title = $title[2]
													$title = StringStripWS($title, 7)
													$title = StringReplace($title, "|", "-")
												Else
													$title = ""
												EndIf
												If $title <> "" Then
													IniWrite($catfle, $ASIN, "title", $title)
													;
													; Get Author
													$author = ""
													If StringInStr($html, "(Author)") > 0 Then
														$remain = StringSplit($html, "(Author)", 1) ; Line 3362
													Else
														$remain = StringSplit($html, "(Editor)", 1)
														$author = "(Editors) "
													EndIf
													If $remain[0] > 1 Then
														$other = $remain[1]
														GetTheAuthor()
														$restof = $remain[2]
														If $remain[0] > 2 Then
															; Not yet tested in New Method.
															; Appears to be more than one author or editor.
															$html = StringTrimLeft($html, StringLen($other) + 8)
															$other = $restof
															GetTheAuthor()
															If $remain[0] > 3 Then
																; Appears to be more than two authors or editors.And StringInStr($author, " & ") > 0 
																$html = StringTrimLeft($html, StringLen($other) + 8)
																$other = $remain[3]
																GetTheAuthor()
																;MsgBox(262208, "$author", $author, 0, $PriceQueryGUI)
																If $remain[0] > 4 Then
																	; Appears to be more than three authors or editors.
																	$html = StringTrimLeft($html, StringLen($other) + 8)
																	$other = $remain[4]
																	$html = StringTrimLeft($html, StringLen($other) + 8)
																	GetTheAuthor()
																	; Ignore any more authors or editors.
																	If $remain[0] > 5 Then $author = $author & " (etc)"
																EndIf
															EndIf
														Else
															$html = $restof
														EndIf
														;MsgBox(262208, "$html", $html, 0, $PriceQueryGUI)
														If $author <> "" Then
															IniWrite($catfle, $ASIN, "author", $author)
															AddNewEbookToList(1)
														Else
															CheckFromOtherUser("7")
														EndIf
													Else
														CheckFromOtherUser("6")
													EndIf
												Else
													CheckFromOtherUser("5")
												EndIf
											Else
												CheckFromOtherUser("4")
											EndIf
										Else
											CheckFromOtherUser("3")
										EndIf
									EndIf
								Else
									MsgBox(262192, "Read Error 1", "The Web Page may no longer exist!", 0, $PriceQueryGUI)
									IniDelete($catfle, $ASIN)
								EndIf
							EndIf
						EndIf
					Else
						;MsgBox(262192, "ADD Error", "This title already exists in the database!", 0, $PriceQueryGUI)
						$ans = MsgBox(262193, "ADD Error", _
							"The title ID already exists in the " & @LF & _
							"database for the current user." & @LF & @LF & _
							"OK = Go to that entry." & @LF & _
							"CANCEL = Skip and Exit.", 0, $PriceQueryGUI)
						If $ans = 1 Then
							$e = _GUICtrlListView_FindInText($Listview_ebooks, $ASIN, -1, True)
							If $e > -1 Then
								_GUICtrlListView_SetItemSelected($Listview_ebooks, $e, True, True)
								_GUICtrlListView_ClickItem($Listview_ebooks, $e, "left", False, 1, 1)
							Else
								MsgBox(262192, "Go To Result", "Oddly, nothing was found!", 0, $PriceQueryGUI)
							EndIf
						EndIf
					EndIf
					If $flash = 1 Then
						GUICtrlSetState($Label_wait, $GUI_HIDE)
					Else
						SplashOff()
					EndIf
				;ElseIf @error <> 1 And StringLeft($URL, 25) <> "http://www.amazon.com/dp/" Then
				ElseIf @error <> 1 And StringInStr($link, "://www.amazon.com/dp/") < 1 Then
					MsgBox(262192, "URL Error", _
						"Your web address (URL) must start with the following text." & @LF & @LF & _
						"'http' or 'https' folowed by '://www.amazon.com/dp/'" & @LF & @LF & _
						"This is a requirement, and indicates whether you have the" & @LF & _
						"correct type of Amazon page for a Kindle Ebook." & @LF & @LF & _
						"Each Kindle version of a book, has its own ebook page," & @LF & _
						"which is the correct page address to use. Do not use a" & @LF & _
						"page that is for Paperback or Hardcover, even if it also" & @LF & _
						"lists the Kindle ebook version." & @LF & _
						"NOTE -  Some of these restrictions can be reduced, by" & @LF & _
						"enabling the 'Relax URL ...' option in program Settings.", 0, $PriceQueryGUI)
					ExitLoop
				Else
					; Check for CTRL key to grab from clipboard again.
					If _IsPressed("11") = 0 Then ExitLoop
				EndIf
				If $loop = 4 Then ExitLoop
			WEnd
			;
			If $ontop = 1 And $disable = 1 Then
				; Restore On Top setting.
				WinSetOnTop($PriceQueryGUI, "", 1)
				GUICtrlSetState($Button_ontop, $ontop)
			EndIf
		Else
			MsgBox(262192, "Query Error", "No connection detected!", 0, $PriceQueryGUI)
		EndIf
		GUICtrlSetState($Button_add, $GUI_ENABLE)
	Case $msg = $Checkbox_sort
		; Keep the Sort order as default
		If GUICtrlRead($Checkbox_sort) = $GUI_CHECKED Then
			$sorted = 1
		Else
			$sorted = 4
		EndIf
		IniWrite($inifle, $user, "sorted", $sorted)
	Case $msg = $Checkbox_qufav
		; Query favorite ebooks
		$favorites = ""
		$secondfavs = ""
		If GUICtrlRead($Checkbox_qufav) = $GUI_CHECKED Then
			$favorites = 1
			GUICtrlSetData($Button_query, "QUERY" & @LF & "FAVS")
			GUICtrlSetTip($Checkbox_qufav, "Query favorite ebooks!")
		ElseIf GUICtrlRead($Checkbox_qufav) = $GUI_UNCHECKED Then
			GUICtrlSetData($Button_query, "QUERY" & @LF & "ALL")
			GUICtrlSetTip($Checkbox_qufav, "Query ALL ebooks!")
			GUICtrlSetState($Checkbox_nofav, $GUI_ENABLE)
		Else
			$secondfavs = 1
			GUICtrlSetData($Button_query, "QUERY" & @LF & "SECS")
			GUICtrlSetTip($Checkbox_qufav, "Query secondary favorite ebooks!")
			GUICtrlSetState($Checkbox_nofav, $GUI_DISABLE)
		EndIf
	Case $msg = $Checkbox_quall
		; Query all ebooks
		If GUICtrlRead($Checkbox_quall) = $GUI_CHECKED Then
			$quall = 1
			GUICtrlSetData($Button_query, "QUERY" & @LF & "ALL")
			GUICtrlSetState($Checkbox_qufav, $GUI_ENABLE)
			GUICtrlSetState($Checkbox_nofav, $GUI_ENABLE)
			;GUICtrlSetState($Item_start, $GUI_ENABLE)
			;GUICtrlSetState($Item_end, $GUI_ENABLE)
			;If $excel = 1 Then
			;	$excel = 4
			;	GUICtrlSetState($Item_mode, $excel)
			;EndIf
			If $list <> "" Then
				RemoveAllFromQueryList()
				DisableListChoices()
			EndIf
		Else
			$quall = 4
			GUICtrlSetData($Button_query, "QUERY")
			GUICtrlSetState($Checkbox_qufav, $GUI_UNCHECKED)
			$favorites = ""
			$secondfavs = ""
			GUICtrlSetState($Checkbox_qufav, $GUI_DISABLE)
			GUICtrlSetState($Checkbox_nofav, $GUI_DISABLE)
			ResetQueryAssignments()
			;GUICtrlSetState($Item_start, $GUI_DISABLE)
			;GUICtrlSetState($Item_end, $GUI_DISABLE)
			;GUICtrlSetState($Item_show, $GUI_DISABLE)
			If $others = 1 Then
				$others = 4
				;GUICtrlSetState($Item_others, $GUI_UNCHECKED)
				GUICtrlSetState($Checkbox_nofav, $GUI_UNCHECKED)
			EndIf
		EndIf
		GUICtrlSetTip($Checkbox_qufav, "Query favorite ebooks!")
	Case $msg = $Checkbox_nofav
		; Query - Non Favorites
		QueryNonFavorites()
	Case $msg = $Combo_where
		; SEARCH - Where
		$where = GUICtrlRead($Combo_where)
		GetPreviousSearches()
	Case $msg = $Combo_user
		; Select another username
		$user = GUICtrlRead($Combo_user)
		If $timer = 1 Then GUICtrlSetState($Label_time, $GUI_HIDE)
		;$contxtmenu = ""
		SetUsernameAndEbooks()
	Case $contxtmenu = 1
		;MsgBox(262192, "Selection Nest", $msg, 0, $PriceQueryGUI)
		Select
		Case $msg = $Item_wipe
			; Query List - Wipe
			GetLastControlID("delete")
			If $list <> "" Then
				GUICtrlSetData($Button_query, "QUERY")
				RemoveAllFromQueryList()
				DisableListChoices()
			EndIf
		Case $msg = $Item_web
			; Go to web page
			GetSelectedIndex("")
			If $ind <> -1 Then
				$URL = IniRead($catfle, $ASIN, "url", "")
				ShellExecute($URL)
			Else
				MsgBox(262192, "Go To Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_warn
			; Set a WARNING  (also see $Warn_Item)
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$warning = IniRead($catfle, $ASIN, "warning", "")
				$report = InputBox("Warning Comment", "ADD a Warning to the selected entry - " & $ASIN _
					& @LF & @LF & $author & " - " & $title, $warning, "", 500, 160, -1, -1, 0, $PriceQueryGUI)
				If @error = 0 Then
					$warning = $report
					IniWrite($catfle, $ASIN, "warning", $warning)
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_view
			; Query List - View & Tips
			GetLastControlID("delete")
			If $list <> "" Then
				Local $comm, $entries, $IDNB
				$entries = ""
				$check = StringSplit($list, "|")
				For $c = 1 To $check[0]
					$IDNB = $check[$c]
					If $IDNB <> "" Then
						$comm = IniRead($catfle, $IDNB, "title", "")
						$comm = $IDNB & " - " & $comm
						If $entries = "" Then
							$entries = $comm
						Else
							$entries = $entries & @LF & $comm
						EndIf
					EndIf
				Next
				$ans = MsgBox(262465, "Query List", $entries & @LF & @LF & _
					"TIPS - A quicker way to add an ebook to the Query, Move or" & @LF & _
					"Copy List, is to hold down LEFT CTRL while clicking the ebook" & @LF & _
					"entry. If clicking an already added entry, it will unlist it. Look" & @LF & _
					"at the QUERY button right-click menu for List choice selection." & @LF & @LF & _
					"OK = Wipe the Query List.", 0, $PriceQueryGUI)
				If $ans = 1 Then
					$ans = MsgBox(262177, "Wipe Query List", _
						"Are you sure you want to Clear the Query List?", 0, $PriceQueryGUI)
					If $ans = 1 Then
						GUICtrlSetData($Button_query, "QUERY")
						RemoveAllFromQueryList()
						DisableListChoices()
					EndIf
				EndIf
			EndIf
		Case $msg = $Item_user
			; ADD another USER or REMOVE one
			$name = InputBox("First Time Username", "Enter the name you wish to work with.", $user, " M", 240, 130, -1, -1, 0, $PriceQueryGUI)
			If @error = 0 And $name <> "" Then
				If $timer = 1 Then GUICtrlSetState($Label_time, $GUI_HIDE)
				If StringInStr($users, "|" & $name & "|") < 1 Then
					$user = $name
					IniWrite($inifle, "User", "name", $user)
					$fixed = 1
					IniWrite($inifle, "Spaces In Prices", $user & "_fixed", $fixed)
					$pipes = 1
					IniWrite($inifle, "Pipes In Title & Author", $user & "_fixed", $pipes)
					$catfle = $scriptdir & "\" & $user & ".ini"
					_FileCreate($catfle)
					$usertmp = $scriptdir & "\" & $user & ".tmp"
					_FileCreate($usertmp)
					$users = $users & $user & "|"
					IniWrite($inifle, "User", "names", $users)
					If $slick = 1 Then
						GUISetState($PriceQueryGUI, @SW_DISABLE + @SW_LOCK)
						_GUICtrlListView_BeginUpdate($Listview_ebooks)
					EndIf
					_GUICtrlListView_DeleteAllItems($Listview_ebooks)
					If $slick = 1 Then
						_GUICtrlListView_EndUpdate($Listview_ebooks)
						GUISetState($PriceQueryGUI, @SW_ENABLE + @SW_UNLOCK)
					EndIf
					$ind = -1
					GUICtrlSetData($Combo_comm, "", "")
					GUICtrlSetData($Combo_user, "", "")
					GUICtrlSetData($Combo_user, $users, $user)
					GetSaveSlots()
				Else
					$ans = MsgBox(262177, "Removal Query", _
						"Are you sure you wish to delete the specified user?" & @LF & @LF & _
						"WARNING - All listed Ebooks and values are erased." & @LF & @LF & _
						$name, 0, $PriceQueryGUI)
					If $ans = 1 Then
						$users = StringReplace($users, "|" & $name & "|", "|")
						IniWrite($inifle, "User", "names", $users)
						GUICtrlSetData($Combo_user, "", "")
						If $name = $user Then
							; If name selected equals current user.
							FileDelete($catfle)
							_FileCreate($usertmp)
							IniDelete($inifle, "Last Query Result - " & $user)
							IniDelete($inifle, "Save Query Results - " & $user)
							IniDelete($inifle, "Last Saved List File - " & $user)
							$user = StringSplit($users, "|")
							$user = $user[2]
							If $user <> "" Then
								SetUsernameAndEbooks()
							EndIf
						EndIf
						GUICtrlSetData($Combo_user, $users, $user)
					EndIf
				EndIf
			EndIf
		Case $msg = $Item_urls
			; Save - All URLs to file
			$ans = MsgBox(262435, "Save All URLs Query", _
				"Save ALL ebook URLs for the current user only?" & @LF & @LF & _
				"YES = Current user only." & @LF & _
				"NO = ALL users." & @LF & _
				"CANCEL = Abort saving to file.", 0, $PriceQueryGUI)
			If $ans <> 2 Then
				$urlini = IniRead($inifle, "Last Saved URL List File", "path", "URLs.ini")
				$pth = FileSaveDialog("Save List To File", "", "INI file (*.ini)", 18, $urlini, $PriceQueryGUI)
				If Not @error Then
					SplashTextOn("", "Saving URLS!", 200, 120, -1, -1, 33)
					$urlini = $pth
					IniWrite($inifle, "Last Saved URL List File", "path", $urlini)
					If $ans = 6 Then
						If FileExists($catfle) Then
							;$entries = IniReadSectionNames($catfle)
							;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
							;	$nmb = StringLen(_ArrayToString($entries, "|", 1))
							;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
							$entries = FileRead($catfle)
							$entries = StringSplit($entries, @LF, 1)
							If Not @error Then
								;$count = $entries[0]
								;For $u = 1 To $count
								;	$IDNB = $entries[$u]
								$u = 0
								$lines = $entries[0]
								For $l = 1 To $lines
									$linetxt = $entries[$l]
									If StringLeft($linetxt, 1) = "[" Then
										$IDNB = StringTrimLeft($linetxt, 1)
										$IDNB = StringStripCR($IDNB)
										$IDNB = StringTrimRight($IDNB, 1)
										;MsgBox(262192, "Line Text", $IDNB, 0, $PriceQueryGUI)
										If $IDNB <> "" Then
											$u = $u + 1
											$URL = IniRead($catfle, $IDNB, "url", "")
											IniWrite($urlini, $IDNB, "url", $URL)
										EndIf
									EndIf
								Next
								$count = $u
							EndIf
						EndIf
					ElseIf $ans = 7 Then
						$check = StringSplit($users, "|", 1)
						For $c = 1 To $check[0]
							$name = $check[$c]
							$namfle = $scriptdir & "\" & $name & ".ini"
							If FileExists($namfle) Then
								;$entries = IniReadSectionNames($namfle)
								;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
								;	$nmb = StringLen(_ArrayToString($entries, "|", 1))
								;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
								$entries = FileRead($namfle)
								$entries = StringSplit($entries, @LF, 1)
								If Not @error Then
									;$count = $entries[0]
									;For $u = 1 To $count
									;	$IDNB = $entries[$u]
									$u = 0
									$lines = $entries[0]
									For $l = 1 To $lines
										$linetxt = $entries[$l]
										If StringLeft($linetxt, 1) = "[" Then
											$IDNB = StringTrimLeft($linetxt, 1)
											$IDNB = StringStripCR($IDNB)
											$IDNB = StringTrimRight($IDNB, 1)
											;MsgBox(262192, "Line Text", $IDNB, 0, $PriceQueryGUI)
											If $IDNB <> "" Then
												$u = $u + 1
												$URL = IniRead($namfle, $IDNB, "url", "")
												$exist = IniRead($urlini, $IDNB, "url", "")
												If $exist = "" Then
													IniWrite($urlini, $IDNB, "url", $URL)
												EndIf
											EndIf
										EndIf
									Next
									$count = $u
								EndIf
							EndIf
						Next
					EndIf
					SplashOff()
					If FileExists($urlini) Then
						$urlfld = StringInStr($urlini, "\", 0, -1)
						$urlfld = StringLeft($urlini, $urlfld - 1)
						Run(@WindowsDir & "\Explorer.exe " & $urlfld)
						Run($notepad & $urlini)
					EndIf
				EndIf
			EndIf
		Case $msg = $Item_url
			; Copy URL to clipboard
			GetSelectedIndex("")
			If $ind <> -1 Then
				$URL = IniRead($catfle, $ASIN, "url", "")
				ClipPut($URL)
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_title
			; Restore the Title name
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$text = IniRead($catfle, $ASIN, "add_title", "")
				If $text <> "" Then
					$title = $text
					IniWrite($catfle, $ASIN, "title", $title)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $title, 1)	
				Else
					MsgBox(262192, "Restore Error", "Nothing to restore!", 0, $PriceQueryGUI)
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_time
			; Last Time Taken
			$timechk = IniRead($inifle, "Last Query", "time", "")
			MsgBox(262208, "Last Query", "Time Taken = " & $timechk, 0, $PriceQueryGUI)
		Case $msg = $Item_sweet
			; Set a SWEET price  (also see $Sweet_Item)
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$sweet = IniRead($catfle, $ASIN, "sweet", "")
				$report = InputBox("Price Alert", "ADD a SWEET price for selected entry - " & $ASIN _
					& @LF & @LF & $author & " - " & $title, $sweet, "", 500, 160, -1, -1, 0, $PriceQueryGUI)
				If @error = 0 Then
					$sweet = $report
					IniWrite($catfle, $ASIN, "sweet", $sweet)
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_summary
			; Get missing summary
			SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				CheckForConnection()
				If $connection = 1 Then
					;$ASIN = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 2)
					GetTheASIN()
					$URL = IniRead($catfle, $ASIN, "url", "")
					$html = _INetGetSource($URL)
					If @error <> 1 Then
						$html = StringStripWS($html, 7)
						GetBookDescription("")
					Else
						MsgBox(262192, "Read Error", "The Web Page may no longer exist!", 0, $PriceQueryGUI)
					EndIf
				Else
					MsgBox(262192, "Summary Error", "No connection detected!", 0, $PriceQueryGUI)
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
			SplashOff()
		Case $msg = $Item_stored
			; Remove a stored price
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				If $prices = 1 Then
					$prcfle = $pricefld & "\" & $ASIN & ".txt"
					If FileExists($prcfle) Then
						$changes = FileRead($prcfle)
					Else
						$changes = IniRead($catfle, $ASIN, "changes", "")
					EndIf
				Else
					$changes = IniRead($catfle, $ASIN, "changes", "")
				EndIf
				If $changes = "" Then
					MsgBox(262208, "Remove A Stored Price", "No changes have been recorded yet!", 0, $PriceQueryGUI)
				Else
					$range = InputBox("Remove A Stored Price", "Enter a price range to remove from the selected entry." _
						& @LF & "All prices at and below that range will be removed." & @LF & @LF & $ASIN & " - " & $author _
						& @LF & $title, "10", " 2", 295, 175, -1, -1, 0, $PriceQueryGUI)
					If @error = 0 And StringIsDigit($range) Then
						If $range > 0 Then
							$reduced = ""
							$check = StringSplit($changes, "|", 1)
							For $c = 1 To $check[0]
								$result = $check[$c]
								If StringInStr($result, "$") > 0 Then
									$curr = "$"
								Else
									$curr = $csign
								EndIf
								$result = StringSplit($result, " (" & $curr, 1)
								$result = $result[2]
								$result = StringSplit($result, ".")
								If $result[1] > 0 Then
									$reduced &= $check[$c] & "|"
								Else
									If StringLeft($result[2], 2) > $range Then $reduced &= $check[$c] & "|"
								EndIf
							Next
							If $reduced <> "" Then
								$changes = StringTrimRight($reduced, 1)
								If $prices = 1 Then
									_FileCreate($prcfle)
									FileWrite($prcfle, $changes)
								Else
									IniWrite($catfle, $ASIN, "changes", $changes)
								EndIf
							EndIf
						EndIf
					EndIf
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_start
			; Start a Query at selected
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				If $first = "" Then
					$first = $ASIN
					;GUICtrlSetState($Item_start, $GUI_CHECKED)
					;If $end = "" Then GUICtrlSetState($Item_show, $GUI_ENABLE)
				Else
					If $first <> $ASIN Then
						$assigned = IniRead($catfle, $first, "title", "")
						$ans = MsgBox(262179, "Start A Query At Selected", _
							"The Start position has previously been assigned to -" & @LF & @LF & _
							$assigned & @LF & @LF & _
							"Do you wish to use the currently selected entry instead?" & @LF & @LF & _
							"NO = Exit this dialog without making any changes." & @LF & _
							"CANCEL = De-select (Clear) the assigned Start position.", 0, $PriceQueryGUI)
						If $ans = 6 Then
							$first = $ASIN
						ElseIf $ans = 2 Then
							$ans = 1
						EndIf
					Else
						$ans = MsgBox(262177, "Assignment For Query", _
							"Do you wish to De-select (Clear) the" & @LF & _
							"currently assigned Start position?", 0, $PriceQueryGUI)
					EndIf
					If $ans = 1 Then
						$first = ""
						;GUICtrlSetState($Item_start, $GUI_UNCHECKED)
						;If $end = "" Then GUICtrlSetState($Item_show, $GUI_DISABLE)
					Else
						;If $end = "" Then GUICtrlSetState($Item_show, $GUI_ENABLE)
					EndIf
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_skip
			; Skip in any Query ALL
			GetLastControlID("delete")
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$lne = $lowid + $ind + 1
				$skipit = IniRead($catfle, $ASIN, "skip", "")
				If $skipit = 1 Then
					$skipit = 4
					If IsInt($lne / 2) = 1 Then
						; Pale Green
						GUICtrlSetBkColor($lne, 0xC0F0C0)
					Else
						; Pale Pink (alternate lines)
						GUICtrlSetBkColor($lne, 0xF0D0F0)
					EndIf
				Else
					$skipit = 1
					; Dark Pink (skip)
					GUICtrlSetBkColor($lne, $skicol)
				EndIf
				IniWrite($catfle, $ASIN, "skip", $skipit)
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_show
			; Show MOBI-ASIN (previously called ISBN) for Start & End
			MsgBox(262208, "Start & End MOBI-ASIN", "Start = " & $first & @LF & "End = " & $end, 0, $PriceQueryGUI)
		Case $msg = $Item_search
			; SEARCH Store
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				If $searchadd <> "" Then 
					$params = "/gp/search/ref=sr_adv_b/?search-alias=digital-text&unfiltered=1&field-keywords="
					$fndtxt = $title & " | " & $author
					; The%2BShepherd%27s%2BCrown&field-author=Terry+Pratchett"
					$fndtxt = InputBox("Find A Kindle Ebook At Specified Amazon Store", "Check that the name(s) are suitable, then click OK." _
						& @LF & @LF & "NOTE - Removing the pipe '|' character allows use of a single search term." _
						& @LF & @LF & "Title | Author", $fndtxt, "", 450, 170, Default, Default, 0, $PriceQueryGUI)
					If @error = 0 And $fndtxt <> "" Then
						If StringInStr($fndtxt, " | ") > 0 Then
							$fndtxt = StringReplace($fndtxt, " | ", "&field-author=")
						EndIf
						$fndtxt = StringReplace($fndtxt, "'", "%27")
						$fndtxt = StringReplace($fndtxt, " ", "%2B")
						$pth = $searchadd & $params & $fndtxt
						ShellExecute($pth)
					EndIf
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_save
			; Save the Ebook List to text file
			$dll = DllOpen("user32.dll")
			If _IsPressed("10", $dll) Then
				If FileExists($savpth) Then Run($notepad & $savpth)
			ElseIf _IsPressed("11", $dll) Then
				If FileExists($catfle) Then Run($notepad & $catfle)
			Else
				$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
				$ans = MsgBox(262177, "Save File Type", _
					"How would you like to save the list?" & @LF & @LF & _
					"CSV file is a comma delimited list, and contains every column value." & @LF & @LF & _
					"TXT file is each ebook title & author only per line, no other detail," & @LF & _
					"except the total number and date are listed at the start." & @LF & @LF & _
					"OK = CSV file." & @LF & _
					"CANCEL = TXT file.", 0, $PriceQueryGUI)
				If $ans = 1 Then
					$ftyp = ".csv"
					$report = "No. , Title , MOBI-ASIN , Author , Start , Low , High , Last, Current" & @CRLF
					For $e = 0 To $nums - 1
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 0) & " , "
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 1) & " , "
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 2) & " , "
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 3) & " , "
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 4) & " , "
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 5) & " , "
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 6) & " , "
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 7) & " , "
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 8) & @CRLF
					Next
				ElseIf $ans = 2 Then
					$ftyp = ".txt"
					$report = $nums & " Ebooks - " & _Now() & @CRLF & @CRLF
					For $e = 0 To $nums - 1
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 1) & " - "
						$report &= _GUICtrlListView_GetItemText($Listview_ebooks, $e, 3) & @CRLF
					Next
				EndIf
				If $report <> "" Then
					If $savpth = "" Or StringRight($savpth, 4) <> $ftyp Then
						$savpth = "Kindle Wishlist (" & $user & ")" & $ftyp
					EndIf
					$pth = FileSaveDialog("Save List To File", "", "Text files (*.csv;*.log;*.nfo;*.rtf;*.txt;*.wri)", 18, $savpth, $PriceQueryGUI)
					If Not @error Then
						$savpth = $pth
						_FileCreate($savpth)
						_FileWriteToLine($savpth, 1, $report, 1)
						IniWrite($inifle, "Last Saved List File - " & $user, "path", $savpth)
						If FileExists($savpth) Then Run($notepad & $savpth)
					EndIf
				EndIf
			EndIf
			DllClose($dll)
		Case $msg = $Item_restore
			; Restore after last Query
			If FileExists($querybak) Then
				$exist = IniRead($querybak, "User", "name", "#$@&!")
				If $user <> $exist Then
					MsgBox(262192, "Restore Error", "You are attempting to restore for wrong user!", 0, $PriceQueryGUI)
				Else
					If $timer = 1 Then GUICtrlSetState($Label_time, $GUI_HIDE)
					$missing = 0
					$ans = MsgBox(262195, "Restore After Query", _
						"Do you want to restore ALL price related entries?" & @LF & @LF & _
						"YES = ALL entries." & @LF & _
						"NO = Current entry only." & @LF & _
						"CANCEL = Abort any restoring", 0, $PriceQueryGUI)
					SplashTextOn("", "Restoring!", 200, 120, -1, -1, 33)
					If $ans = 6 Then
						$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
						For $e = 1 To $nums
							$ind = $e - 1
							$ASIN = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 2)
							If $ASIN <> "" Then
								$ASIN = StringReplace($ASIN, "Bought - ", "")
								$ASIN = StringReplace($ASIN, "Favorite - ", "")
								$ASIN = StringReplace($ASIN, "Secondary - ", "")
								$ASIN = StringReplace($ASIN, "Pre-Order - ", "")
								RestoreFromQueryBackup()
							EndIf
						Next
						If $slots > 0 Then
							If $missing > 0 And $missing <> $nums Then
								$ans = MsgBox(262449, "Restore Errors", _
									"Some " & $missing & " entries had missing prices." & @LF & @LF & _
									"Despite that, do you still want to restore the" & @LF & _
									"'Save Slot' reports for 'Last Query Result' for" & @LF & _
									"the current user?", 0, $PriceQueryGUI)
								If $ans = 1 Then
									$missing = 0
								EndIf
							EndIf
							If $missing = 0 Then
								RestorePreQuerySlotValues()
							EndIf
						EndIf
					ElseIf $ans = 7 Then
						GetSelectedIndex("detail")
						If $ind <> -1 Then
							RestoreFromQueryBackup()
							If $slots > 0 And $missing = 0 Then
								$ans = MsgBox(262433, "Restore Errors", _
									"Do you want to restore the 'Save Slot' reports" & @LF & _
									"for 'Last Query Result' for the current user?" & @LF & @LF & _
									"NOTE - This need only be done just once since" & @LF & _
									"the last query, and is not based on individual" & @LF & _
									"items being restored separately.", 0, $PriceQueryGUI)
								If $ans = 1 Then
									RestorePreQuerySlotValues()
								EndIf
							EndIf
						Else
							MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
						EndIf
					EndIf
					SplashOff()
				EndIf
			Else
				MsgBox(262192, "Restore Error", "Restore file does not exist!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_report
			; View the 'Report.txt' file
			If FileExists($repfle) Then
				Run($notepad & $repfle)
			Else
				MsgBox(262192, "File Error", "Report file does not yet exist!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_rename
			; RENAME currently selected User
			$text = InputBox("Rename Current User", $user, $user, "", 210, 130, -1, -1, 0, $PriceQueryGUI)
			If @error = 0 And $text <> "" Then
				If StringInStr($user, "|" & $text & "|") < 1 Then
					$name = $text
					$namfle = $scriptdir & "\" & $name & ".ini"
					If Not FileExists($namfle) Then
						FileMove($catfle, $namfle)
						$catfle = $namfle
						$users = StringReplace($users, "|" & $user & "|", "|" & $name & "|")
						IniWrite($inifle, "User", "names", $users)
						IniRenameSection($inifle, "Save Query Results - " & $user, "Save Query Results - " & $name)
						IniRenameSection($inifle, "Last Saved List File - " & $user, "Last Saved List File - " & $name)
						IniRenameSection($inifle, $user, $name)
						If IniRead($inifle, "Spaces In Prices", $user & "_fixed", "") = 1 Then
							IniWrite($inifle, "Spaces In Prices", $name & "_fixed", 1)
							IniDelete($inifle, "Spaces In Prices", $user & "_fixed")
						EndIf
						$user = $name
						IniWrite($inifle, "User", "name", $user)
						GUICtrlSetData($Combo_user, "", "")
						GUICtrlSetData($Combo_user, $users, $user)
					Else
						MsgBox(262192, "Rename Error", "User name file already exists!", 0, $PriceQueryGUI)
					EndIf
				Else
					MsgBox(262192, "Rename Error", "User name already exists!", 0, $PriceQueryGUI)
				EndIf
			EndIf
		Case $msg = $Item_rem
			; Query List - Remove selected
			GetLastControlID("delete")
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				RemoveSelectedFromQueryList("")
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_relocate
			; Relocate all Bought ebooks
			$ans = MsgBox(262435, "Relocate & Exit Query", _
				"Are you sure you want to Relocate all Bought" & @LF & _
				"items, as well as Exit (Close) the program?" & @LF & @LF & _
				"YES = Do Both (relocate & exit)." & @LF & _
				"NO = Just Relocate (no exit)." & @LF & _
				"CANCEL = Neither (don't relocate or exit)." & @LF & @LF & _
				"NOTE - This process essentially creates another" & @LF & _
				"user with the same name, but with (b) added to" & @LF & _
				"the end (unless the bought user already exists), " & @LF & _
				"to which all the Bought items will be transferred.", 0, $PriceQueryGUI)
			If $ans <> 2 Then
				If $ans = 6 Then $shut = 1
				If $timer = 1 Then GUICtrlSetState($Label_time, $GUI_HIDE)
				$name = $user & " (b)"
				$namfle = $scriptdir & "\" & $name & ".ini"
				If Not FileExists($namfle) Then
					_FileCreate($namfle)
					$users = $users & $name & "|"
					IniWrite($inifle, "User", "names", $users)
					GUICtrlSetData($Combo_user, "", "")
					GUICtrlSetData($Combo_user, $users, $user)
					IniWrite($inifle, "Save Query Results - " & $name, "slots", 5)
				EndIf
				If FileExists($catfle) Then
					If $flash = 1 Then
						GUICtrlSetData($Label_wait, "Please Wait!")
						GUICtrlSetState($Label_wait, $GUI_SHOW)
					Else
						SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
					EndIf
					GetLastControlID("delete")
					;$ents = IniReadSectionNames($catfle)
					;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
					;	$nmb = StringLen(_ArrayToString($ents, "|", 1))
					;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
					$ents = FileRead($catfle)
					$ents = StringSplit($ents, @CRLF, 1)
					If Not @error Then
						;$nums = $ents[0]
						;For $e = 1 To $nums
						;	$ASIN = $ents[$e]
						$e = 0
						$lines = $ents[0]
						For $l = 1 To $lines
							$linetxt = $ents[$l]
							If StringLeft($linetxt, 1) = "[" Then
								$ASIN = StringTrimLeft($linetxt, 1)
								$ASIN = StringStripCR($ASIN)
								$ASIN = StringTrimRight($ASIN, 1)
								;MsgBox(262192, "Line Text", $ASIN, 0, $PriceQueryGUI)
								If $ASIN <> "" Then
									$e = $e + 1
									$paid = IniRead($catfle, $ASIN, "bought", "")
									If $paid <> "" Then
										$entry = IniReadSection($catfle, $ASIN)
										If Not @error Then 
											IniWriteSection($namfle, $ASIN, $entry)
											If Not @error Then IniDelete($catfle, $ASIN)
										EndIf
									EndIf
								EndIf
							EndIf
						Next
						$nums = $e
						If $shut = "" Then
							If $slick = 1 Then
								GUISetState($PriceQueryGUI, @SW_DISABLE + @SW_LOCK)
								_GUICtrlListView_BeginUpdate($Listview_ebooks)
							EndIf
							_GUICtrlListView_DeleteAllItems($Listview_ebooks)
							$ind = -1
							GUICtrlSetData($Combo_comm, "", "")
							;FillTheListWithEbooks()
							If $sorted = 1 Then
								$colnum = IniRead($inifle, $user, "sortcol", 0)
								SortByColumnNumber()
								GUICtrlSetData($Group_list, "List Of Kindle Ebooks  (" & $nums & ")")
							Else
								FillTheListWithEbooks()
							EndIf
							If $slick = 1 Then
								_GUICtrlListView_EndUpdate($Listview_ebooks)
								GUISetState($PriceQueryGUI, @SW_ENABLE + @SW_UNLOCK)
							EndIf
							;GetSaveSlots()
							;$savpth = IniRead($inifle, "Last Saved List File - " & $user, "path", "")
						EndIf
					EndIf
					If $flash = 1 Then
						GUICtrlSetState($Label_wait, $GUI_HIDE)
					Else
						SplashOff()
					EndIf
				EndIf
			EndIf
		Case $msg = $Item_receiver
			; SET current USER as Copy or Move recipient
			$copyto = $user
		Case $msg = $Item_query
			; Query results
			If $slots > 0 Then
				$rec = 1
				While 1
					$report = IniRead($inifle, "Last Query Result - " & $user, $rec, "")
					If $report = "" And $rec = 1 Then
						MsgBox(262192, "Query Results", "No record has been created yet!", 0, $PriceQueryGUI)
						ExitLoop
					Else
						If $report = "" Then
							$rec = 1
						Else
							$report = StringReplace($report, "|", @LF)
							$ans = MsgBox(262691, "Query Results  -  " & $rec, _
								"Prices change record (" & $rec & ") of last " & $slots & " queries." & @LF & _
								"(1) being most recent query, up to (" & $slots & ") being oldest." & @LF & @LF & _
								$report & @LF & _
								"YES = Copy result to the clipboard." & @LF & _
								"NO = Skip to next result." & @LF & _
								"CANCEL = Quit showing Query results.", 0, $PriceQueryGUI)
							If $ans = 6 Then
								$report = StringReplace($report, @LF, @CRLF)
								ClipPut($report)
							ElseIf $ans = 7 Then
								; Skip to next result
							ElseIf $ans = 2 Then
								ExitLoop
							EndIf
							If $rec = $slots Then
								$rec = 1
							Else
								$rec = $rec + 1
							EndIf
						EndIf
					EndIf
				WEnd
			EndIf
		Case $msg = $Item_publish
			; Get Missing - Publisher
			SplashTextOn("", "Please Wait!", 300, 120, -1, -1, 33)
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				CheckForConnection()
				If $connection = 1 Or $test = 1 Then
					GetTheASIN()
					$URL = IniRead($catfle, $ASIN, "url", "")
					$html = _INetGetSource($URL)
					If @error <> 1 Or $test = 1 Then
						If $test = 1 Then
							; Testing only
							Local $txtfle
							; NOTE - Change the MOBI-ASIN (previously called ISBN) in the above section '$link = ' (line 1692) to avoid existing title response.
							;$txtfle = FileOpen($scriptdir & "\Ebook.html", 0)
							;$txtfle = FileOpen($scriptdir & "\HTML\Testing.htm", 0)
							$txtfle = FileOpen($scriptdir & "\HTML Query\John Marsden\Html.txt", 0)
							$html = FileRead($txtfle)
							FileClose($txtfle)
							$txtfle = ""
						EndIf
						$html = StringStripWS($html, 7)
						;
						If $sumfiles = 1 Then
							$sumfle = $sumfld & "\" & $ASIN & ".txt"
							If FileExists($sumfle) Then
								$summary = FileRead($sumfle)
							Else
								$summary = IniRead($catfle, $ASIN, "summary", "")
							EndIf
						Else
							$summary = IniRead($catfle, $ASIN, "summary", "")
						EndIf
						If StringInStr($summary, "Publisher:") < 1 Then
							GetPublisher()
							If $publisher <> "" Then
								$publisher = StringStripWS($publisher, 7)
								If $summary = "" Then
									$summary = $publisher
								Else
									$summary = $publisher & "|" & $summary
								EndIf
								If $sumfiles = 1 Then
									_FileCreate($sumfle)
									FileWrite($sumfle, $summary)
								Else
									IniWrite($catfle, $ASIN, "summary", $summary)
								EndIf
								SplashTextOn("", "Publisher added!", 300, 120, -1, -1, 33)
								Sleep(1500)
							Else
								MsgBox(262192, "Publisher Error", "Not found!", 0, $PriceQueryGUI)
							EndIf
						Else
							SplashTextOn("", "Publisher already exists!", 300, 120, -1, -1, 33)
							Sleep(1500)
						EndIf
						;
						$comment = IniRead($comfle, $ASIN, "comment", "")
						If StringInStr($comment, "Publication Date:") < 1 Then
							GetBookDescription(1)
							If $pubdate <> "" And $pubdate <> "Unknown" Then
								If $comment = "" Then
									$comment = "Publication Date: " & $pubdate & "|"
								Else
									$comment = "Publication Date: " & $pubdate & "||" & $comment
								EndIf
								IniWrite($comfle, $ASIN, "comment", $comment)
								SplashTextOn("", "Publication Date added!", 300, 120, -1, -1, 33)
								Sleep(1500)
							Else
								MsgBox(262192, "Publisher Error", "Publication Date Not found!", 0, $PriceQueryGUI)
							EndIf
						Else
							SplashTextOn("", "Publication Date already exists!", 300, 120, -1, -1, 33)
							Sleep(1500)
						EndIf
					Else
						MsgBox(262192, "Read Error", "The Web Page may no longer exist!", 0, $PriceQueryGUI)
					EndIf
				Else
					MsgBox(262192, "Publisher Error", "No connection detected!", 0, $PriceQueryGUI)
				EndIf
			Else
				MsgBox(262192, "Publisher Retrieval Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
			SplashOff()
		Case $msg = $Item_private
			; Add a Private comment  (also see $Private_Item)
			AddPrivateComment()
		Case $msg = $Item_price
			; View price results
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$start = IniRead($catfle, $ASIN, "start", "")
				$low = IniRead($catfle, $ASIN, "low", "")
				$high = IniRead($catfle, $ASIN, "high", "")
				$last = IniRead($catfle, $ASIN, "last", "")
				$current = IniRead($catfle, $ASIN, "current", "")
				$title = IniRead($catfle, $ASIN, "title", "")
				;
				$report = $title & @LF
				$curr = StringLeft($current, 1)
				$lowval = ""
				$highval = ""
				;
				$starval = GetValueForPrice($start)
				If $current <> $start Then
					$currval = GetValueForPrice($current)
					If $currval < $starval Then
						$result = $starval - $currval
						GetPriceDifferenceResult()
						$report = $report & @LF & "Current price is " & $curr & $result & " lower than start price." & @LF
					ElseIf $currval > $starval Then
						$result = $currval - $starval
						GetPriceDifferenceResult()
						$report = $report & @LF & "Current price is " & $curr & $result & " higher than start price." & @LF
					EndIf
				EndIf
				If $low <> $start And $current <> $low Then
					$lowval = GetValueForPrice($low)
					If $lowval < $starval Then
						$result = $starval - $lowval
						GetPriceDifferenceResult()
						$report = $report & @LF & "Low price is " & $curr & $result & " lower than Start price." & @LF
					ElseIf $lowval > $starval Then
						; This should never be the case.
						$result = $lowval - $starval
						GetPriceDifferenceResult()
						$report = $report & @LF & "Low price is " & $curr & $result & " higher than Start price." & @LF
					EndIf
				ElseIf $low <> $start Then
					$report = $report & @LF & "Low price is Current price." & @LF
				EndIf
				If $high <> $start And $current <> $high Then
					$highval = GetValueForPrice($high)
					If $highval < $starval Then
						; This should never be the case.
						$result = $starval - $highval
						GetPriceDifferenceResult()
						$report = $report & @LF & "High price is " & $curr & $result & " lower than Start price." & @LF
					ElseIf $highval > $starval Then
						$result = $highval - $starval
						GetPriceDifferenceResult()
						$report = $report & @LF & "High price is " & $curr & $result & " higher than Start price." & @LF
					EndIf
				ElseIf $high <> $start Then
					$report = $report & @LF & "High price is Current price." & @LF
				EndIf
				If $low <> $start And $high <> $start Then
					If $lowval = "" Then $lowval = GetValueForPrice($low)
					If $highval = "" Then $highval = GetValueForPrice($high)
					$result = $highval - $lowval
					GetPriceDifferenceResult()
					$report = $report & @LF & "Low price is " & $curr & $result & " lower than High price." & @LF
				EndIf
				If $report = $title & @LF Then $report = $report & @LF & " (no price changes)" & @LF
				$ans = MsgBox(262465, "Price Change Report", _
					$report & @LF & _
					"OK = Copy result to the clipboard.", 0, $PriceQueryGUI)
				If $ans = 1 Then
					$report = StringReplace($report, @LF, @CRLF)
					ClipPut($report)
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_preorder
			; Set as a Pre-Order
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$paid = IniRead($catfle, $ASIN, "bought", "")
				If $paid <> "" Then
					$preorder = ""
					;GUICtrlSetState($Item_preorder, $GUI_DISABLE)
					MsgBox(262192, "Assign Error", "A bought book cannot be set as a pre-order!", 0, $PriceQueryGUI)
				Else
					$preorder = IniRead($catfle, $ASIN, "preorder", "")
					If $preorder = "" Then
						$preorder = 1
						_GUICtrlListView_SetItemText($Listview_ebooks, $ind, "Pre-Order - " & $ASIN, 2)
						$favorite = IniRead($catfle, $ASIN, "favorite", "")
						If $favorite = 1 Then
							$favorite = ""
							IniWrite($catfle, $ASIN, "favorite", $favorite)
						EndIf
						$secondary = IniRead($catfle, $ASIN, "secondary", "")
						If $secondary = 1 Then
							$secondary = ""
							IniWrite($catfle, $ASIN, "secondary", $secondary)
						EndIf
					Else
						$preorder = ""
						_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $ASIN, 2)
					EndIf
					IniWrite($catfle, $ASIN, "preorder", $preorder)
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_preord
			; Include Pre-Orders with Favorites
			If $include = 4 Then
				$include = 1
				;GUICtrlSetState($Item_preord, $GUI_CHECKED)
			Else
				$include = 4
				;GUICtrlSetState($Item_preord, $GUI_UNCHECKED)
			EndIf
			IniWrite($inifle, "Preorders With Favorites", "include", $include)
		Case $msg = $Item_paid
			; Bought this ebook  (also see $Paid_Item)
			BoughtThisEbook()
		Case $msg = $Item_others
			; Query - Non Favorites
			QueryNonFavorites()
		Case $msg = $Item_notes
			; Add a Shared comment  (also see $Notes_Item)
			AddSharedComment()
		Case $msg = $Item_move
			; Selected Entry - Move to another user  (also see $Move_Item)
			GetLastControlID("delete")
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				AddEbookToAnotherUser("move")
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_list
			; View the List file (for Excel)
			If _IsPressed("11") Then
				$saved = ""
				MsgBox(262208, "Auto Save Reset", "Browsing for path is re-enabled!", 0, $PriceQueryGUI)
			Else
				$txtpth = IniRead($inifle, "Last Saved Excel List File - " & $user, "path", "")
				If $txtpth = "" Then
					MsgBox(262192, "List Error", "No path has been set!", 0, $PriceQueryGUI)
				Else
					If FileExists($txtpth) Then Run($notepad & $txtpth)
				EndIf
			EndIf
		Case $msg = $Item_last
			; Price Last
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$prev = IniRead($catfle, $ASIN, "last", "'not yet set'.")
				MsgBox(262208, "Last Price", _
					"Before changing to 'Current' price of " & $current & @LF & _
					"the 'Last' price was " & $prev, 0, $PriceQueryGUI)
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_jpeg
			; Get Missing - Image via URL
			If $data = 4 Then
				$data = 1
				IniWrite($inifle, "Image Data", "store", $data)
				;GUICtrlSetState($Item_image, $GUI_ENABLE)
				$ans = MsgBox(262179, "JPG Query (Future Setting)", _
					"Do you want to be prompted to Save the" & @LF & _
					"JPG file, when Image data is not present?" & @LF & @LF & _
					"YES = Prompt to Save the JPG file." & @LF & _
					"NO = Don't prompt, just Save the JPG." & @LF & @LF & _
					"CANCEL = Skip the saving of JPG files.", 0, $PriceQueryGUI)
				$jpgsav = $ans
				IniWrite($inifle, "JPG Image", "save", $jpgsav)
			EndIf
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				CheckForConnection()
				If $connection = 1 Or $test = 1 Then
					GetTheASIN()
					;$URL = IniRead($catfle, $ASIN, "url", "")
					;ShellExecute($URL)
					$clip = ClipGet()
					$http = StringLeft($clip, 7)
					If $http = "http://" Or $http = "https:/" Then
						$link = $clip
					Else
						$link = ""
					EndIf
					$link = InputBox("Download An Image File", "Enter the URL for an image (i.e. from the Amazon ebook page or other source).", _
						$link, "", 500, 130, Default, Default, 0, $PriceQueryGUI)
					If @error = 0 And $link <> "" Then
						IniWrite($catfle, $ASIN, "image", $link)
						If StringLeft($link, 7) = "http://" Or StringLeft($link, 8) = "https://" Then
							$imgfle = $imgfld & "\" & $ASIN & ".dat"
							If FileExists($imgfle) Then FileDelete($imgfle)
							$imgfle = $imgfld & "\" & $ASIN & ".jpg"
							If FileExists($imgfle) Then FileDelete($imgfle)
							$jpeg = InetGet($link, $imgfle)
							If $jpeg = 1 Then
								;GetImageData()
							Else
								MsgBox(262192, "Download Error", "The image file failed to download!", 0, $PriceQueryGUI)
							EndIf
						Else
							MsgBox(262192, "Download Error", "Incorrect URL format!", 0, $PriceQueryGUI)
						EndIf
					EndIf
				Else
					MsgBox(262192, "Image Error", "No connection detected!", 0, $PriceQueryGUI)
				EndIf
			Else
				MsgBox(262192, "Image Retrieval Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_image
			; Selected Entry Detail (image + text)  (also see $Image_Item)
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				ImageDataGUI()
				GUISetState(@SW_RESTORE, $PriceQueryGUI)
			Else
				MsgBox(262192, "Detail Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_history
			; Price History
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				If $record = 1 Then
					$reduced = ""
					If $prices = 1 Then
						$prcfle = $pricefld & "\" & $ASIN & ".txt"
						If FileExists($prcfle) Then
							$changes = FileRead($prcfle)
						Else
							$changes = IniRead($catfle, $ASIN, "changes", "")
						EndIf
					Else
						$changes = IniRead($catfle, $ASIN, "changes", "")
					EndIf
					If $changes = "" Then
						$report = "No changes have been recorded yet!" & @LF
					Else
						$check = StringSplit($changes, "|", 1)
						If $check[0] > $limit Then
							$start = IniRead($catfle, $ASIN, "start", "")
							$curr = StringLeft($start, 1)
							If StringInStr($changes, "(" & $curr & "0.0") > 0 Then
								; Reduce number of shown entries (where difference is less than 10 cents)
								$reduced = "(many entries, those less than " & $curr & "0.10 not shown)" & @LF
								For $c = 1 To $check[0]
									$result = $check[$c]
									If StringInStr($result, "(" & $curr & "0.0") < 1 Then
										$reduced &= $result & "|"
									EndIf
								Next
							EndIf
							$check = StringSplit($reduced, "|", 1)
							If $check[0] > ($limit + 1) Then
								; Previous check plus 1
								If StringInStr($changes, "(" & $curr & "0.") > 0 Then
									; Reduce number of shown entries (where difference is less than 1 dollar)
									$reduced = ""
									$reduced = "(many entries, those less than " & $curr & "1.00 not shown)" & @LF
									$check = StringSplit($changes, "|", 1)
									For $c = 1 To $check[0]
										$result = $check[$c]
										If StringInStr($result, "(" & $curr & "0.") < 1 Then
											$reduced &= $result & "|"
										EndIf
									Next
								EndIf
							EndIf
							If $reduced <> "" Then
								$reduced = StringReplace($reduced, "|", @LF)
								$reduced = "'" & $title & "'" & @LF & "by " & $author & @LF & @LF & $reduced
							EndIf
						EndIf
						$report = $changes & @LF
						$report = StringReplace($report, "|", @LF)
					EndIf
					$report = "'" & $title & "'" & @LF & "by " & $author & @LF & @LF & $report
					If $reduced = "" Then
						$result = $report
					Else
						$result = $reduced
					EndIf
					$ans = MsgBox(262465, "History Of Price Changes", _
						$result & @LF & _
						"OK = Copy full result to the clipboard.", 0, $PriceQueryGUI)
					If $ans = 1 Then
						$report = StringReplace($report, @LF, @CRLF)
						ClipPut($report)
					EndIf
				EndIf
			Else
				MsgBox(262192, "History Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_gotitle Or $msg = $Item_goauthor
			; WIKIPEDIA - Go to Ebook Title or Author
			GetSelectedIndex("")
			If $ind <> -1 Then
				If $msg = $Item_gotitle Then
					$win = "Go to Wikipedia for Ebook Title"
					$goto = IniRead($catfle, $ASIN, "title", "")
					If StringRight($goto, 5) = ", The" Then
						$goto = "The " & StringTrimRight($goto, 5)
					EndIf
				ElseIf $msg = $Item_goauthor Then
					$win = "Go to Wikipedia for Author"
					$goto = IniRead($catfle, $ASIN, "author", "")
				EndIf
				$goto = StringReplace($goto, " ", "_")
				;
				$wikurl = "https://en.wikipedia.org/wiki/" & $goto
				$pth = InputBox($win, "Check that the link is suitable then click OK.", $wikurl, "", 500, 130, Default, Default, 0, $PriceQueryGUI)
				If @error = 0 And StringLeft($pth, 4) = "http" Then
					ShellExecute($pth)
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_find
			; Check to Remove
			GetSelectedIndex("")
			If $ind <> -1 Then
				If _GUICtrlListView_GetItemSelected($Listview_ebooks, $ind) = True Then
					$shut = ""
					$users = IniRead($inifle, "User", "names", "")
					SplashTextOn("", "Searching!", 200, 140, -1, -1, 33)
					$check = StringSplit($users, "|", 1)
					For $c = 1 To $check[0]
						$name = $check[$c]
						If $name <> $user Then
							$namfle = $scriptdir & "\" & $name & ".ini"
							If FileExists($namfle) Then
								$val = IniRead($namfle, $ASIN, "title", "")
								If $val <> "" Then
									$ans = MsgBox(262435, "Removal Query", _
										"Currently selected ebook was found in another user." & @LF & @LF & _
										"Title = " & $val & @LF & _
										"User = " & $name & @LF & @LF & _
										"YES = Remove from " & $user & @LF & _
										"NO = Continue searching." & @LF & _
										"CANCEL = Abort searching.", 0, $PriceQueryGUI)
									If $ans <> 7 Then
										If $ans = 6 Then RemoveSelectedEbook()
										ExitLoop
									EndIf
								EndIf
							EndIf
						EndIf
						If $c = $check[0] Then
							SplashTextOn("", "No Removal!", 200, 140, -1, -1, 33)
							Sleep(500)
						EndIf
					Next
					SplashOff()
				Else
					MsgBox(262192, "Check Error", "Entry is not properly selected!", 0, $PriceQueryGUI)
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_favorite
			; Set ebook as a favorite  (also see $Favorite_Item)
			SetItemAsFavorite()
		Case $msg = $Item_failed
			; View the 'Failed.txt' file
			If FileExists($failtxt) Then Run($notepad & $failtxt)
		Case $msg = $Item_exempt
			; EXEMPT current from Exchange Rate
			$exempt = IniRead($inifle, $user, "exempt", "")
			If $exempt = 4 Then
				$exempt = 1
				IniWrite($inifle, $user, "exempt", $exempt)
			Else
				$ans = MsgBox(262177, "Exempt Status", _
					"Current user is exempt from Exchange Rate." & @LF & @LF & _
					"OK = Remove the exemption.", 0, $PriceQueryGUI)
				If $ans = 1 Then
					$exempt = 4
					IniWrite($inifle, $user, "exempt", $exempt)
				EndIf
			EndIf
		Case $msg = $Item_excel
			; Add to List for Excel  (also see $Excel_Item)
			AddToListForExcel()
		Case $msg = $Item_entry
			; Selected Entry Detail (text)  (also see $Entry_Item)
			SelectedEntryDetailText()
		Case $msg = $Item_end
			; End a Query at selected
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				If $end = "" Then
					$end = $ASIN
					;GUICtrlSetState($Item_end, $GUI_CHECKED)
					;If $first = "" Then GUICtrlSetState($Item_show, $GUI_ENABLE)
				Else
					If $end <> $ASIN Then
						$assigned = IniRead($catfle, $end, "title", "")
						$ans = MsgBox(262435, "End A Query At Selected", _
							"The End position has previously been assigned to -" & @LF & @LF & _
							$assigned & @LF & @LF & _
							"Do you wish to use the currently selected entry instead?" & @LF & @LF & _
							"NO = Exit this dialog without making any changes." & @LF & _
							"CANCEL = De-select (Clear) the assigned End position.", 0, $PriceQueryGUI)
						If $ans = 6 Then
							$end = $ASIN
						ElseIf $ans = 2 Then
							$ans = 1
						EndIf
					Else
						$ans = MsgBox(262177, "Assignment For Query", _
							"Do you wish to De-select (Clear) the" & @LF & _
							"currently assigned End position?", 0, $PriceQueryGUI)
					EndIf
					If $ans = 1 Then
						$end = ""
						;GUICtrlSetState($Item_end, $GUI_UNCHECKED)
						;If $first = "" Then GUICtrlSetState($Item_show, $GUI_DISABLE)
					Else
						;If $first = "" Then GUICtrlSetState($Item_show, $GUI_ENABLE)
					EndIf
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_edit
			; Edit Title or Author name  (also see $Edit_Item)
			EditTitleOrAuthorName()
		Case $msg = $Item_diff
			; Get Current Difference
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$start = IniRead($catfle, $ASIN, "start", "")
				$current = IniRead($catfle, $ASIN, "current", "")
				$title = IniRead($catfle, $ASIN, "title", "")
				;
				$report = $title & @LF
				$curr = StringLeft($current, 1)
				;
				$starval = GetValueForPrice($start)
				If $current <> $start Then
					$currval = GetValueForPrice($current)
					If $currval < $starval Then
						$result = $starval - $currval
						GetPriceDifferenceResult()
						$report = $report & @LF & "Current price is " & $curr & $result & " lower than start price." & @LF
					ElseIf $currval > $starval Then
						$result = $currval - $starval
						GetPriceDifferenceResult()
						$report = $report & @LF & "Current price is " & $curr & $result & " higher than start price." & @LF
					EndIf
				EndIf
				If $report = $title & @LF Then $report = $report & @LF & " (no price change)" & @LF
				$ans = MsgBox(262465, "Current Difference Report", _
					$report & @LF & _
					"OK = Copy result to the clipboard.", 0, $PriceQueryGUI)
				If $ans = 1 Then
					$report = StringReplace($report, @LF, @CRLF)
					ClipPut($report)
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_data
			; Get missing image data
			SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
			If $data = 4 Then
				$data = 1
				IniWrite($inifle, "Image Data", "store", $data)
				;GUICtrlSetState($Item_image, $GUI_ENABLE)
				$ans = MsgBox(262179, "JPG Query", _
					"Do you want to be prompted to Save the" & @LF & _
					"JPG file, when Image data is not present?" & @LF & @LF & _
					"YES = Prompt to Save the JPG file." & @LF & _
					"NO = Don't prompt, just Save the JPG." & @LF & @LF & _
					"CANCEL = Skip the saving of JPG files.", 0, $PriceQueryGUI)
				$jpgsav = $ans
				IniWrite($inifle, "JPG Image", "save", $jpgsav)
			EndIf
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				CheckForConnection()
				If $connection = 1 Then
					;$ASIN = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 2)
					GetTheASIN()
					$URL = IniRead($catfle, $ASIN, "url", "")
					$html = _INetGetSource($URL)
					If @error <> 1 Then
						$html = StringStripWS($html, 7)
						GetImageData()
					Else
						MsgBox(262192, "Read Error", "The Web Page may no longer exist!", 0, $PriceQueryGUI)
					EndIf
				Else
					MsgBox(262192, "Image Error", "No connection detected!", 0, $PriceQueryGUI)
				EndIf
			Else
				MsgBox(262192, "Image Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
			SplashOff()
		Case $msg = $Item_copy
			; Selected Entry - Copy to another user  (also see $Copy_Item)
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				AddEbookToAnotherUser("copy")
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_compare
			; Compare to another user
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				If $whom = "" Then
					MsgBox(262192, "User Error", "You need to set a user in Settings!", 0, $PriceQueryGUI)
				Else
					$name = $whom
					If $name <> $user Then
						$namfle = $scriptdir & "\" & $name & ".ini"
						If FileExists($namfle) Then
							$current = IniRead($catfle, $ASIN, "current", "")
							$exist = IniRead($namfle, $ASIN, "title", "")
							If $exist = "" Then
								MsgBox(262192, "Ebook Error", "Not found at the other user!", 0, $PriceQueryGUI)
							Else
								Local $comm = IniRead($namfle, $ASIN, "current", "")
								If $excon = 1 And IniRead($inifle, $name, "exempt", "") = 4 Then
									GetExchangeRate(2)
									If StringInStr($curval, "@") > 0 Then
										$curval = $current
									Else
										$curval = $current & " (" & $curval & " " & $currency & ")"
									EndIf
								Else
									$curval = $current
								EndIf
								$report = "You have elected to compare ebook price between two users." & @LF & @LF & _
									"Current User = " & $user & @LF & _
									"Other User = " & $whom & @LF & @LF & _
									"Current Price = " & $curval & @LF & _
									"Other Price = " & $comm
								$ans = MsgBox(262177, "Compare Price", _
									$report & @LF & @LF & _
									"OK = Copy to clipboard.", 0, $PriceQueryGUI)
								If $ans = 1 Then
									ClipPut($report)
								EndIf
							EndIf
						EndIf
					Else
						MsgBox(262192, "User Error", "No point if other user is current user!", 0, $PriceQueryGUI)
					EndIf
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_compall
			; SET current as Compare participant
			$compare = IniRead($inifle, "Compare", "first", "")
			If $compare = "" Then
				$compare = $user
				IniWrite($inifle, "Compare", "first", $compare)
			Else
				$with = IniRead($inifle, "Compare", "second", "")
				If $with = "" Then
					$with = $user
					IniWrite($inifle, "Compare", "second", $with)
				EndIf
				If $with = $user Then
					$ans = MsgBox(262177, "Compare Prices", _
						"You have elected to compare ebook prices between two users." & @LF & @LF & _
						"First = " & $compare & @LF & _
						"Second = " & $with & @LF & @LF & _
						"OK = Compare ebooks of Second participant with First." & @LF & _
						"CANCEL= Abort and clear both participant names." & @LF & @LF & _
						"NOTE - Ebooks that don't exist for both the participants are" & @LF & _
						"skipped for price checking, but listed as missing for Second." & @LF & _
						"Ebooks that are listed for the Second participant but missing" & @LF & _
						"from First, are completely ignored.", 0, $PriceQueryGUI)
					If $ans = 1 Then
						$name = $compare
						If $name <> $user Then
							$namfle = $scriptdir & "\" & $name & ".ini"
							If FileExists($namfle) Then
								Local $comm, $compare, $compfle, $entries, $IDNB, $line, $u, $with
								;
								;$entries = IniReadSectionNames($namfle)
								;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
								;	$nmb = StringLen(_ArrayToString($entries, "|", 1))
								;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
								$entries = FileRead($namfle)
								$entries = StringSplit($entries, @LF, 1)
								If Not @error Then
									$compfle = $scriptdir & "\Compare.txt"
									_FileCreate($compfle)
									$line = 0
									$missing = ""
									;$count = $entries[0]
									;For $u = 1 To $count
									;	$IDNB = $entries[$u]
									$e = 0
									$lines = $entries[0]
									For $l = 1 To $lines
										$linetxt = $entries[$l]
										If StringLeft($linetxt, 1) = "[" Then
											$IDNB = StringTrimLeft($linetxt, 1)
											$IDNB = StringStripCR($IDNB)
											$IDNB = StringTrimRight($IDNB, 1)
											;MsgBox(262192, "Line Text", $IDNB, 0, $PriceQueryGUI)
											If $IDNB <> "" Then
												$e = $e + 1
												$comm = IniRead($namfle, $IDNB, "title", "")
												If $comm <> "" Then
													$comm = $comm & " - " & IniRead($namfle, $IDNB, "author", "")
													$exist = IniRead($catfle, $IDNB, "title", "")
													If $exist = "" Then
														$missing &= @CRLF & "(missing) " & $comm
													Else
														$current = IniRead($namfle, $IDNB, "current", "")
														If $excon = 1 And IniRead($inifle, $name, "exempt", "") = 4 Then
															GetExchangeRate(2)
															If StringInStr($curval, "@") > 0 Then
																$curval = $current
															Else
																$curval = $current & " (" & $curval & " " & $currency & ")"
															EndIf
														Else
															$curval = $current
														EndIf
														$exist = $curval
														$current = IniRead($catfle, $IDNB, "current", "")
														If $excon = 1 And IniRead($inifle, $user, "exempt", "") = 4 Then
															GetExchangeRate(2)
															If StringInStr($curval, "@") > 0 Then
																$curval = $current
															Else
																$curval = $current & " (" & $curval & " " & $currency & ")"
															EndIf
														Else
															$curval = $current
														EndIf
														$exist = $comm & " -- " & $exist & " <--> " & $curval
														;
														$line = $line + 1
														_FileWriteToLine($compfle, $line, $exist, 0)
													EndIf
												EndIf
											EndIf
										EndIf
									Next
									$count = $e
									If $missing <> "" Then
										$line = $line + 1
										_FileWriteToLine($compfle, $line, $missing, 0)
									EndIf
									If FileExists($compfle) Then Run($notepad & $compfle)
									;
									$ans = MsgBox(262433, "Reset Query", "Do you want to clear user compare names?", 0, $PriceQueryGUI)
									If $ans = 1 Then
										IniWrite($inifle, "Compare", "first", "")
										IniWrite($inifle, "Compare", "second", "")
									EndIf
								EndIf
							EndIf
						Else
							MsgBox(262192, "User Error", "No point if both participants are the same!", 0, $PriceQueryGUI)
						EndIf
					ElseIf $ans = 2 Then
						IniWrite($inifle, "Compare", "first", "")
						IniWrite($inifle, "Compare", "second", "")
					EndIf
				Else
					MsgBox(262192, "Compare Error", _
						"Please change the List Of Kindle Ebooks to" & @LF & _
						"the following username, then try again." & @LF & @LF & _
						$with, 0, $PriceQueryGUI)
				EndIf
			EndIf
		Case $msg = $Item_clear
			; Selected Entry - Clear query indicator
			GetLastControlID("delete")
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$skipit = IniRead($catfle, $ASIN, "skip", "")
				If $skipit = 1 Then
					MsgBox(262192, "Selection Error", "This entry is designated as skip!", 0, $PriceQueryGUI)
				Else
					$current = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 8)
					$val = StringRight($current, 1)
					If $val = "*" Or $val = "#" Then
						$current = StringReplace($current, "*", "")
						$current = StringReplace($current, "#", "")
						_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current, 8)
						IniDelete($usertmp, $ASIN)
						$asterisk = ""
						$hash = ""
						$lne = $lowid + $ind + 1
						If IsInt($lne / 2) = 1 Then
							; Pale Green
							GUICtrlSetBkColor($lne, 0xC0F0C0)
						Else
							; Pale Pink (alternate lines)
							GUICtrlSetBkColor($lne, 0xF0D0F0)
						EndIf
					EndIf
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_check
			; Selected Entry - Check line values
			GetLastControlID("delete")
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$lne = $lowid + $ind + 1
				;MsgBox(262192, "$lne", $lne, 0, $PriceQueryGUI)
				$skipit = IniRead($catfle, $ASIN, "skip", "")
				If $skipit = 1 Then
					; Dark Pink (skip)
					GUICtrlSetBkColor($lne, $skicol)
				Else
					$asterisk = ""
					$hash = ""
					$result = IniRead($usertmp, $ASIN, "changed", "")
					If $result <> "" Then
						$current = IniRead($catfle, $ASIN, "current", "")
						$currval = GetValueForPrice($current)
						;$current = $current & "*"
						$asterisk = 1
					ElseIf IniRead($usertmp, $ASIN, "error", "") = 1 Then
						;$current = $current & "#"
						$hash = 1
					EndIf
					If $asterisk = 1 Then
						GetSetCorrectLineColor($lne)
					ElseIf $hash = 1 Then
						; Red (error)
						GUICtrlSetBkColor($lne, $errcol)
					ElseIf IsInt($lne / 2) = 1 Then
						; Pale Green
						GUICtrlSetBkColor($lne, 0xC0F0C0)
					Else
						; Pale Pink (alternate lines)
						GUICtrlSetBkColor($lne, 0xF0D0F0)
					EndIf
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_change
			; End a Query at selected
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				ChangePriceGUI()
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_author
			; Restore the Author name
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				$text = IniRead($catfle, $ASIN, "add_author", "")
				If $text <> "" Then
					$author = $text
					IniWrite($catfle, $ASIN, "author", $author)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $author, 3)
				Else
					MsgBox(262192, "Restore Error", "Nothing to restore!", 0, $PriceQueryGUI)
				EndIf
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $Item_add
			; Query List - Add selected
			GetLastControlID("delete")
			GetSelectedIndex("detail")
			If $ind <> -1 Then
				AddSelectedToQueryList("")
			Else
				MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
			EndIf
		Case $msg = $GUI_EVENT_PRIMARYUP
			; After left-click
			;$lowid = $Button_x
			;$contxtmenu = ""
			;GUICtrlDelete($Menu_list)
			;$lowid = $Item_mode
			GetLastControlID("delete")
			GetSelectedIndex("detail")
			;MsgBox(262192, "Message", "left-click!", 0, $PriceQueryGUI)
		Case $msg = $GUI_EVENT_SECONDARYDOWN
			; After right-click
			$cursor = GUIGetCursorInfo($PriceQueryGUI)
			If $cursor[4] <> $Listview_ebooks Then
				;$lowid = $Button_x
				;$contxtmenu = ""
				;GUICtrlDelete($Menu_list)
				;$lowid = $Item_mode
				GetLastControlID("delete")
			EndIf
			GetSelectedIndex("detail")
			;MsgBox(262192, "Message", "right-click!", 0, $PriceQueryGUI)
		Case Else
			;;;
		EndSelect
	Case $msg = $Item_totlist
		; Enable Get Total
		If $totlist = 1 Then
			$totlist = 4
			If StringRight(GUICtrlRead($Button_query), 5) = "TOTAL" Then
				If $list = "" Then
					GUICtrlSetData($Button_query, "QUERY")
				Else
					GUICtrlSetData($Button_query, "QUERY" & @LF & "LIST")
				EndIf
			EndIf
			GUICtrlSetState($Item_movlist, $GUI_ENABLE)
			GUICtrlSetState($Item_coplist, $GUI_ENABLE)
			GUICtrlSetState($Item_remlist, $GUI_ENABLE)
			If FileExists($koboexe) Then GUICtrlSetState($Item_kobo, $GUI_ENABLE)
		Else
			$totlist = 1
			If $list <> "" Then
				GUICtrlSetData($Button_query, "QUERY" & @LF & "TOTAL")
			EndIf
			GUICtrlSetState($Item_movlist, $GUI_DISABLE)
			GUICtrlSetState($Item_coplist, $GUI_DISABLE)
			GUICtrlSetState($Item_remlist, $GUI_DISABLE)
			If FileExists($koboexe) Then GUICtrlSetState($Item_kobo, $GUI_DISABLE)
		EndIf
		GUICtrlSetState($Item_totlist, $totlist)
	Case $msg = $Item_remlist
		; Enable Remove List
		If $remlist = 1 Then
			$remlist = 4
			If StringLeft(GUICtrlRead($Button_query), 6) = "REMOVE" Then
				If $list = "" Then
					GUICtrlSetData($Button_query, "QUERY")
				Else
					GUICtrlSetData($Button_query, "QUERY" & @LF & "LIST")
				EndIf
			EndIf
			GUICtrlSetState($Item_movlist, $GUI_ENABLE)
			GUICtrlSetState($Item_coplist, $GUI_ENABLE)
			GUICtrlSetState($Item_totlist, $GUI_ENABLE)
			If FileExists($koboexe) Then GUICtrlSetState($Item_kobo, $GUI_ENABLE)
		Else
			$remlist = 1
			If $list <> "" Then
				GUICtrlSetData($Button_query, "REMOVE" & @LF & "LIST")
			EndIf
			GUICtrlSetState($Item_movlist, $GUI_DISABLE)
			GUICtrlSetState($Item_coplist, $GUI_DISABLE)
			GUICtrlSetState($Item_totlist, $GUI_DISABLE)
			If FileExists($koboexe) Then GUICtrlSetState($Item_kobo, $GUI_DISABLE)
		EndIf
		GUICtrlSetState($Item_remlist, $remlist)
	Case $msg = $Item_movlist
		; Enable Move List
		If $movlist = 1 Then
			$movlist = 4
			If StringLeft(GUICtrlRead($Button_query), 4) = "MOVE" Then
				If $list = "" Then
					GUICtrlSetData($Button_query, "QUERY")
				Else
					GUICtrlSetData($Button_query, "QUERY" & @LF & "LIST")
				EndIf
			EndIf
			GUICtrlSetState($Item_coplist, $GUI_ENABLE)
			GUICtrlSetState($Item_remlist, $GUI_ENABLE)
			GUICtrlSetState($Item_totlist, $GUI_ENABLE)
			If FileExists($koboexe) Then GUICtrlSetState($Item_kobo, $GUI_ENABLE)
		Else
			$movlist = 1
			If $list <> "" Then
				GUICtrlSetData($Button_query, "MOVE" & @LF & "LIST")
			EndIf
			GUICtrlSetState($Item_coplist, $GUI_DISABLE)
			GUICtrlSetState($Item_remlist, $GUI_DISABLE)
			GUICtrlSetState($Item_totlist, $GUI_DISABLE)
			If FileExists($koboexe) Then GUICtrlSetState($Item_kobo, $GUI_DISABLE)
		EndIf
		GUICtrlSetState($Item_movlist, $movlist)
	Case $msg = $Item_mode
		; EXCEL Mode
		If $excel = 1 Then
			$excel = 4
			GUICtrlSetState($Checkbox_quall, $GUI_ENABLE)
			If $quall = 1 Then
				GUICtrlSetState($Checkbox_nofav, $GUI_ENABLE)
				If $favorites = 1 Then
					GUICtrlSetState($Checkbox_qufav, $GUI_ENABLE)
					GUICtrlSetData($Button_query, "QUERY" & @LF & "FAVS")
				ElseIf $secondfavs = 1 Then
					GUICtrlSetState($Checkbox_qufav, $GUI_ENABLE)
					GUICtrlSetData($Button_query, "QUERY" & @LF & "SECS")
				ElseIf $others = 1 Then
					GUICtrlSetData($Button_query, "QUERY" & @LF & "NONS")
				Else
					GUICtrlSetState($Checkbox_qufav, $GUI_ENABLE)
					GUICtrlSetData($Button_query, "QUERY" & @LF & "ALL")
				EndIf
			Else
				GUICtrlSetData($Button_query, "QUERY")
			EndIf
		Else
			$excel = 1
			GUICtrlSetData($Button_query, "QUERY" & @LF & "EXCEL")
			GUICtrlSetState($Checkbox_quall, $GUI_DISABLE)
			If $quall = 1 Then
				GUICtrlSetState($Checkbox_qufav, $GUI_DISABLE)
				GUICtrlSetState($Checkbox_nofav, $GUI_DISABLE)
			EndIf
			MsgBox(262192, "Warning Message", "Use this option at your own risk, as it was only designed" _
				& @LF & "for my use, and requires several specific elements!" & @LF _
				& @LF & "i.e. A same named Excel file with matching Author and" _
				& @LF & "Title column numbers and a matching worksheet name," _
				& @LF & "plus same named VBA Macro, etc!", 0, $PriceQueryGUI)
		EndIf
		If $list <> "" Then
			$list = ""
			DisableListChoices()
		EndIf
		GUICtrlSetState($Item_mode, $excel)
	Case $msg = $Item_kobo
		; Enable Kobo Query
		If $koboquery = 1 Then
			$koboquery = 4
			GUICtrlSetData($Button_query, "QUERY")
			;GUICtrlSetState($Item_coplist, $GUI_ENABLE)
			;GUICtrlSetState($Item_movlist, $GUI_ENABLE)
			;GUICtrlSetState($Item_remlist, $GUI_ENABLE)
			;GUICtrlSetState($Item_totlist, $GUI_ENABLE)
		Else
			$koboquery = 1
			GUICtrlSetData($Button_query, "KOBO" & @LF & "QUERY")
			;GUICtrlSetState($Item_coplist, $GUI_DISABLE)
			;GUICtrlSetState($Item_movlist, $GUI_DISABLE)
			;GUICtrlSetState($Item_remlist, $GUI_DISABLE)
			;GUICtrlSetState($Item_totlist, $GUI_DISABLE)
		EndIf
		GUICtrlSetState($Item_kobo, $koboquery)
	Case $msg = $Item_coplist
		; Enable Copy List
		If $coplist = 1 Then
			$coplist = 4
			If StringLeft(GUICtrlRead($Button_query), 4) = "COPY" Then
				If $list = "" Then
					GUICtrlSetData($Button_query, "QUERY")
				Else
					GUICtrlSetData($Button_query, "QUERY" & @LF & "LIST")
				EndIf
			EndIf
			GUICtrlSetState($Item_movlist, $GUI_ENABLE)
			GUICtrlSetState($Item_remlist, $GUI_ENABLE)
			GUICtrlSetState($Item_totlist, $GUI_ENABLE)
			If FileExists($koboexe) Then GUICtrlSetState($Item_kobo, $GUI_ENABLE)
		Else
			$coplist = 1
			If $list <> "" Then
				GUICtrlSetData($Button_query, "COPY" & @LF & "LIST")
			EndIf
			GUICtrlSetState($Item_movlist, $GUI_DISABLE)
			GUICtrlSetState($Item_remlist, $GUI_DISABLE)
			GUICtrlSetState($Item_totlist, $GUI_DISABLE)
			If FileExists($koboexe) Then GUICtrlSetState($Item_kobo, $GUI_DISABLE)
		EndIf
		GUICtrlSetState($Item_coplist, $coplist)
	Case $msg = $Label_rate
		; Show the Exchange Rate
		If $exchange = "" Then
			$val = "Not currently set."
			$val = $val & @LF & @LF & IniRead($inifle, "Conversion", "rate", "") & " (previous)"
		Else
			$val = $exchange
		EndIf
		If $excon = 1 Then
			$ans = MsgBox(262465, "Exchange Rate", _
				$val & @LF & @LF & _
				"OK = Copy to clipboard.", 0, $PriceQueryGUI)
			If $ans = 1 Then
				ClipPut($val)
			EndIf
		Else
			GetExchangeRate(1)
		EndIf
	Case $msg = $Label_find
		If GUICtrlGetState($Label_wait) = 96 Then
			GUICtrlSetState($Label_wait, $GUI_SHOW)
		Else
			GUICtrlSetState($Label_wait, $GUI_HIDE)
		EndIf
		If GUICtrlGetState($Label_time) = 96 Then
			GUICtrlSetState($Label_time, $GUI_SHOW)
		Else
			GUICtrlSetState($Label_time, $GUI_HIDE)
		EndIf
		;
		; Added purely for a manual reset
		;$lowid = $Button_x
		;$contxtmenu = ""
		;GUICtrlDelete($Menu_list)
		;$lowid = $Item_mode
		GetLastControlID("delete")
	Case $msg = $Listview_ebooks Or ($msg > $lowid And $msg < $bigid)
		; Select a List entry or Sort by column
		;MsgBox(262208, $msg, $lowid, 0, $PriceQueryGUI)
		If $msg = $Listview_ebooks Then
			$colnum = GUICtrlGetState($Listview_ebooks)
			;If $colnum = 0 Or $colnum = 1 Or $colnum = 2 Or $colnum = 3 Or $colnum = 5 Or $colnum = 8 Then
			If StringInStr("012358", $colnum) > 0 Then
				If $timer = 1 Then GUICtrlSetState($Label_time, $GUI_HIDE)
				If $colnum = 5 Then
					MsgBox(262208, "Advise On Sort Selected", _
						"Ebooks will be sorted by price changes" & @LF & _
						"and not numerically by price." & @LF & @LF & _
						"Price changes are shown by decrease" & @LF & _
						"first and increase last, with all results" & @LF & _
						"shown in Column 8 (Current)." & @LF & @LF & _
						"Dialog closes in 9 seconds.", 9, $PriceQueryGUI)
				EndIf
				If $slick = 1 Then
					GUISetState($PriceQueryGUI, @SW_DISABLE + @SW_LOCK)
					;GUICtrlSetState($Listview_ebooks, $GUI_DISABLE)
					_GUICtrlListView_BeginUpdate($Listview_ebooks)
				EndIf
				_GUICtrlListView_DeleteAllItems($Listview_ebooks)
				SortByColumnNumber()
				If $slick = 1 Then
					_GUICtrlListView_EndUpdate($Listview_ebooks)
					;GUICtrlSetState($Listview_ebooks, $GUI_ENABLE)
					GUISetState($PriceQueryGUI, @SW_ENABLE + @SW_UNLOCK)
				EndIf
				GUICtrlSetTip($Listview_ebooks, $ASIN & @LF & $title & @LF & $author)
				;
				If $sorted = 1 Then IniWrite($inifle, $user, "sortcol", $colnum)
			ElseIf $colnum <> 6 Then
				GUICtrlSetState($Listview_ebooks, $GUI_FOCUS)
				If $colnum = 4 Then
					Send("{HOME}")
					$ind = 0
					MsgBox(262208, "Advise On Sort Selected", "Jumping to FIRST entry" & @LF & @LF & "(no sorting).", 1, $PriceQueryGUI)
				ElseIf $colnum = 7 Then
					Send("{END}")
					$ind = _GUICtrlListView_GetItemCount($Listview_ebooks) - 1
					MsgBox(262208, "Advise On Sort Selected", "Jumping to LAST entry" & @LF & @LF & "(no sorting).", 1, $PriceQueryGUI)
				EndIf
				_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
				_GUICtrlListView_EnsureVisible($Listview_ebooks, $ind, False)
				_GUICtrlListView_ClickItem($Listview_ebooks, $ind, "left", False, 1, 1)
				;GUICtrlSetTip($Listview_ebooks, $ASIN & @LF & $title & @LF & $author)
			Else
				MsgBox(262208, "Advise On Sort Selected", "NO SORT available.", 1, $PriceQueryGUI)
			EndIf
		Else
			; $multi = 1 during a full Query.
			If $multi = "" Then
				$ind = $msg - $lowid - 1
				;$ASIN = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 2)
				GetTheASIN()
				$dll = DllOpen("user32.dll")
;~ 				If _IsPressed("11", $dll) Then
;~ 					AddSelectedToQueryList("")
;~ 				ElseIf _IsPressed("10", $dll) Then
;~ 					RemoveSelectedFromQueryList("")
;~ 				EndIf
				If _IsPressed("11", $dll) And $koboquery = 4 Then
					AddToOrRemoveFromQueryList("")
					;
					; Need this fix for CTRL staying down issue.
					$ctrl = 1
				ElseIf _IsPressed("10", $dll) Then
					; Need this fix for SHIFT staying down issue.
					$shift = 1
				EndIf
				DllClose($dll)
				$title = IniRead($catfle, $ASIN, "title", "")
				$author = IniRead($catfle, $ASIN, "author", "")
				DetermineComment()
				GetOtherDetails()
			EndIf
		EndIf
		If $show = 1 Then MsgBox(262208, "$msg $lowid $ind", $msg & " : " & $lowid & " : " & $ind, 0, $PriceQueryGUI)
		;MsgBox(262208, "$msg $lowid $ind $nums $lne", $msg & " : " & $lowid & " : " & $ind & " : " & $nums & " : " & $lne, 0, $PriceQueryGUI)
	Case $msg = $Warn_Item
		; Set a WARNING  (also see $Item_warn)
		GetSelectedIndex("detail")
		If $ind <> -1 Then
			$warning = IniRead($catfle, $ASIN, "warning", "")
			$report = InputBox("Warning Comment", "ADD a Warning to the selected entry - " & $ASIN _
				& @LF & @LF & $author & " - " & $title, $warning, "", 500, 160, -1, -1, 0, $PriceQueryGUI)
			If @error = 0 Then
				$warning = $report
				IniWrite($catfle, $ASIN, "warning", $warning)
			EndIf
		Else
			MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
		EndIf
	Case $msg = $Sweet_Item
		; Set a SWEET price  (also see $Item_sweet)
		GetSelectedIndex("detail")
		If $ind <> -1 Then
			$sweet = IniRead($catfle, $ASIN, "sweet", "")
			$report = InputBox("Price Alert", "ADD a SWEET price for selected entry - " & $ASIN _
				& @LF & @LF & $author & " - " & $title, $sweet, "", 500, 160, -1, -1, 0, $PriceQueryGUI)
			If @error = 0 Then
				$sweet = $report
				IniWrite($catfle, $ASIN, "sweet", $sweet)
			EndIf
		Else
			MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
		EndIf
	Case $msg = $Private_Item
		; Add a Private comment  (also see $Item_private)
		AddPrivateComment()
	Case $msg = $Paid_Item
		; Bought this ebook  (also see $Item_paid)
		BoughtThisEbook()
	Case $msg = $Notes_Item
		; Add a Shared comment  (also see $Item_notes)
		AddSharedComment()
	Case $msg = $Move_Item
		; Selected Entry - Move to another user  (also see $Item_move)
		GetSelectedIndex("detail")
		If $ind <> -1 Then
			AddEbookToAnotherUser("move")
		Else
			MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
		EndIf
	Case $msg = $Image_Item
		; Selected Entry Detail (image + text)  (also see $Item_image)
		GetSelectedIndex("detail")
		If $ind <> -1 Then
			ImageDataGUI()
			GUISetState(@SW_RESTORE, $PriceQueryGUI)
		Else
			MsgBox(262192, "Detail Error", "No list entry is selected!", 0, $PriceQueryGUI)
		EndIf
	Case $msg = $Favorite_Item
		; Set ebook as a favorite  (also see $Item_favorite)
		SetItemAsFavorite()
	Case $msg = $Excel_Item
		; Add to List for Excel  (also see $Item_excel)
		AddToListForExcel()
	Case $msg = $Entry_Item
		; Selected Entry Detail (text)  (also see $Item_entry)
		SelectedEntryDetailText()
	Case $msg = $Edit_Item
		; Edit Title or Genre name  (also see $Item_edit)
		EditTitleOrAuthorName()
	Case $msg = $Copy_Item
		; Selected Entry - Copy to another user  (also see $Item_copy)
		GetSelectedIndex("detail")
		If $ind <> -1 Then
			AddEbookToAnotherUser("copy")
		Else
			MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
		EndIf
	Case Else
		;;;
	EndSelect
WEnd

Exit


Func ImageDataGUI()
	Local $Button_adjust, $Button_check, $Button_comment, $Button_copy, $Button_down, $Button_favorite, $Button_goto
	Local $Button_kobo, $Button_select, $Button_summ, $Button_up, $Button_url, $Button_visit, $Button_x2
	Local $Checkbox_auto, $Input_kobo, $Input_price, $Label_kobo, $Label_price
	Local $GUIActiveX, $priors, $wintitle
	; The following need to be Global for GUISwitch etc
	; $Edit_rep, $Input_comms, $Input_URL, $ImageGUI
	
	_IEErrorHandlerRegister()
	;
	$oIE = _IECreateEmbedded()
	$wintitle = "Selected Entry Detail  (" & $ind + 1 & ")"
	$ImageGUI = GUICreate($wintitle, 790, 530, (@DesktopWidth - 790) / 2, (@DesktopHeight - 530) / 2, _
		$WS_OVERLAPPED + $WS_VISIBLE + $WS_CLIPSIBLINGS + $WS_MINIMIZEBOX + $WS_SYSMENU, $WS_EX_TOPMOST, $PriceQueryGUI)
	$GUIActiveX = GUICtrlCreateObj($oIE, 10, 10, 345, 360)
	;
	; CONTROLS
	$Edit_rep = GUICtrlCreateEdit("", 365, 10, 410, 110, $WS_VSCROLL + $ES_WANTRETURN + $ES_MULTILINE + $ES_AUTOVSCROLL)
	GUICtrlSetFont($Edit_rep, 8.5, 400)
	$Edit_com = GUICtrlCreateEdit("", 365, 120, 410, 250, $WS_VSCROLL + $ES_WANTRETURN + $ES_MULTILINE + $ES_AUTOVSCROLL)
	;
	$Input_URL = GUICtrlCreateInput("", 10, 380, 535, 20)
	$Button_url = GuiCtrlCreateButton("UP", 545, 379, 30, 21)
	GUICtrlSetFont($Button_url, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_url, "Update the URL to that currently shown!")
	$Button_visit = GuiCtrlCreateButton("VISIT PAGE", 580, 379, 70, 21)
	GUICtrlSetFont($Button_visit, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_visit, "Visit the web page for this ebook!")
	;
	$Button_summ = GuiCtrlCreateButton("UPDATE SUMMARY", 660, 379, 115, 21)
	GUICtrlSetFont($Button_summ, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_summ, "Update the Summary for this ebook!")
	;
	$Input_comms = GUICtrlCreateInput("", 10, 410, 405, 50, $WS_VSCROLL + $ES_WANTRETURN + $ES_MULTILINE + $ES_AUTOVSCROLL)
	$Button_comment = GuiCtrlCreateButton("ADD SOME" & @LF & "COMMENTS" & @LF & "AT LEFT", 415, 410, 75, 50, $BS_MULTILINE)
	GUICtrlSetFont($Button_comment, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_comment, "Update stored comments for this ebook!")
	;
	$Button_up = GuiCtrlCreateButton("UP", 500, 411, 30, 23, $BS_ICON)
	GUICtrlSetImage($Button_up, $icofle, $icoUp, 0)
	GUICtrlSetTip($Button_up, "View previous ebook entry image & detail!")
	;
	$Button_down = GuiCtrlCreateButton("DN", 500, 436, 30, 23, $BS_ICON)
	GUICtrlSetImage($Button_down, $icofle, $icoDwn, 0)
	GUICtrlSetTip($Button_down, "View next ebook entry image & detail!")
	;
	$Button_copy = GuiCtrlCreateButton("COPY ALL DETAILS", 540, 410, 110, 22)
	GUICtrlSetFont($Button_copy, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_copy, "Copy all details to clipboard!")
	;
	$Button_select = GuiCtrlCreateButton("SELECT FOR LIST", 540, 438, 110, 22)
	GUICtrlSetFont($Button_select, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_select, "Select ebook for COPY or MOVE LIST process!")
	;
	$Button_favorite = GuiCtrlCreateButton("", 655, 410, 65, 50, $BS_MULTILINE)
	GUICtrlSetFont($Button_favorite, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_favorite, "Toggle the Favorite status of current ebook!")
	;
	$Button_x2 = GuiCtrlCreateButton("EXIT", 725, 410, 50, 50, $BS_ICON)
	GUICtrlSetImage($Button_x2, $shell, $icoX, 1)
	GUICtrlSetTip($Button_x2, "Quit, Close or Exit window!")
	;
	$Label_kobo = GUICtrlCreateLabel("KOBO", 10, 468, 40, 20, $SS_CENTER + $SS_CENTERIMAGE)
	GUICtrlSetFont($Label_kobo, 7, 600, 0, "Small Fonts")
	GUICtrlSetBkColor($Label_kobo, $COLOR_BLUE)
	GUICtrlSetColor($Label_kobo, $COLOR_RED)
	$Input_kobo = GUICtrlCreateInput("", 50, 468, 370, 20)
	$Button_kobo = GuiCtrlCreateButton("UP", 420, 468, 30, 21)
	GUICtrlSetFont($Button_kobo, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_kobo, "Add or Update the URL to that currently shown!")
	;
	$Button_goto = GuiCtrlCreateButton("VISIT PAGE", 455, 468, 70, 21)
	GUICtrlSetFont($Button_goto, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_goto, "Visit the Kobo web page for this ebook!")
	;
	$Button_adjust = GuiCtrlCreateButton("ADJUST", 535, 468, 55, 21)
	GUICtrlSetFont($Button_adjust, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_adjust, "Adjust the Kobo price Notification value!")
	;
	$Label_price = GUICtrlCreateLabel("Price", 595, 468, 40, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetFont($Label_price, 7, 600, 0, "Small Fonts")
	GUICtrlSetBkColor($Label_price, $COLOR_BLUE)
	GUICtrlSetColor($Label_price, $COLOR_RED)
	GUICtrlSetTip($Label_price, "Click to cycle prior and current price!")
	$Input_price = GUICtrlCreateInput("", 635, 468, 45, 20)
	$Button_check = GuiCtrlCreateButton("CHECK", 680, 468, 50, 21)
	GUICtrlSetFont($Button_check, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_check, "Check the price at Kobo!")
	;
	$Checkbox_auto = GUICtrlCreateCheckbox("Auto", 735, 468, 40, 20)
	GUICtrlSetTip($Checkbox_auto, "Check the price at Kobo with QUERY!")
	;
	; SETTINGS
	GetDetailReport()
	GetAndSetOtherData()
	$kobo = IniRead($catfle, $ASIN, "kobo_url", "")
	GUICtrlSetData($Input_kobo, $kobo)
	$cost = IniRead($catfle, $ASIN, "kobo_price", "")
	GUICtrlSetData($Input_price, $cost)
	;
	GUICtrlSetState($Checkbox_auto, $kobocheck)
	;
	$favorite = IniRead($catfle, $ASIN, "favorite", "")
	$secondary = IniRead($catfle, $ASIN, "secondary", "")
	If $favorite = 1 Or $secondary = 1 Then
		GUICtrlSetData($Button_favorite, "REMOVE" & @LF & "THIS AS" & @LF & "FAVORITE")
	Else
		GUICtrlSetData($Button_favorite, "SET THIS" & @LF & "ONE AS A" & @LF & "FAVORITE")
	EndIf
	;
	GUISetState()
	;
	GUICtrlSetState($Input_URL, $GUI_FOCUS)
	Send("{HOME}")
	GUICtrlSetState($Input_kobo, $GUI_FOCUS)
	Send("{HOME}")
	;
	$imgfle = $imgfld & "\" & $ASIN & ".dat"
	If FileExists($imgfle) Then
		;_ReplaceStringInFile($imgfle, 'width="100%" height="100%">', 'width="100%">')
		GetImageDataForGUI()
	Else
		$imgfle = $imgfld & "\" & $ASIN & ".jpg"
		If Not FileExists($imgfle) Then
			$imgfle = $scriptdir & "\Missing.jpg"
		EndIf
		If FileExists($imgfle) Then
			$image = '<img src="' & $imgfle & '" width="210" height="325">'
		Else
			$image = ""
			MsgBox(262192, "File Error", "Image data file is missing!", 0, $ImageGUI)
		EndIf
	EndIf
	InsertHtmlImage()
	;_IELoadWait($oIE)
	;
	If StringInStr($list, $ASIN) > 0 Then GUICtrlSetBkColor($Button_select, 0xA0A000)
	;
;~ 	Local $loaded, $loops, $urlpage
;~ 	$loaded = _IEPropertyGet($oIE, "locationurl")
;~ 	MsgBox(262192, "Property Get URL", $loaded, 0, $ImageGUI)
;~ 	If $loaded <> "" Then
;~ 		_IEBodyWriteHTML($oIE, $loaded)
;~ 		;_IEDocInsertText($oIE, $loaded, "beforebegin")
;~ 	EndIf
;~ 	$urlpage = $loaded
;~ 	$loops = 0
		
	While 1
		$msg = GUIGetMsg()
		Select
		Case $msg = $GUI_EVENT_CLOSE Or $msg = $Button_x2
			; Quit, Close or Exit window
			GUIDelete($ImageGUI)
			ExitLoop
		Case $msg = $Button_visit
			; Visit the web page for this ebook
			If $URL <> "" Then ShellExecute($URL)
		Case $msg = $Button_url
			; Update the URL to that curently shown
			$URL = IniRead($catfle, $ASIN, "url", "")
			IniWrite($catfle, $ASIN, "url_backup", $URL)
			$URL = GUICtrlRead($Input_URL)
			If StringLeft($URL, 4) = "http" Then
				IniWrite($catfle, $ASIN, "url", $URL)
			Else
				MsgBox(262192, "Format Error", "URL did not start with 'http', so restoring.", 0, $ImageGUI)
				$URL = IniRead($catfle, $ASIN, "url_backup", "")
				IniWrite($catfle, $ASIN, "url", $URL)
				GUICtrlSetData($Input_URL, $URL)
			EndIf
		Case $msg = $Button_up
			; View previous ebook entry image & detail
			If $ind > 0 Then
				$ind = $ind - 1
			Else
				$ind = ($nums - 1)
			EndIf
			GetAnotherImageEntry()
			If $favorite = 1 Or $secondary = 1 Then
				GUICtrlSetData($Button_favorite, "REMOVE" & @LF & "THIS AS" & @LF & "FAVORITE")
			Else
				GUICtrlSetData($Button_favorite, "SET THIS" & @LF & "ONE AS A" & @LF & "FAVORITE")
			EndIf
			WinSetTitle($ImageGUI, "", "Selected Entry Detail  (" & $ind + 1 & ")")
			WinActivate($ImageGUI, "")
			If StringInStr($list, $ASIN) > 0 Then
				GUICtrlSetBkColor($Button_select, 0xA0A000)
			Else
				;$defcol = "0x" & Hex(_WinAPI_GetSysColor($COLOR_MENU), 6)
				;GUICtrlSetBkColor($Button_select, $defcol)
				GUICtrlSetStyle($Button_select, $GUI_SS_DEFAULT_BUTTON)
			EndIf
			GUICtrlSetData($Label_price, "Price")
			$kobo = IniRead($catfle, $ASIN, "kobo_url", "")
			GUICtrlSetData($Input_kobo, $kobo)
			$cost = IniRead($catfle, $ASIN, "kobo_price", "")
			GUICtrlSetData($Input_price, $cost)
			GUICtrlSetState($Input_URL, $GUI_FOCUS)
			Send("{HOME}")
			GUICtrlSetState($Input_kobo, $GUI_FOCUS)
			Send("{HOME}")
		Case $msg = $Button_summ
			; Update the Summary for this ebook
			$summary = GUICtrlRead($Edit_com)
			If StringLeft($summary, 10) = "Summary = " Then
				$summary = StringTrimLeft($summary, 10)
			EndIf
			$summary = StringReplace($summary, @CRLF, "|")
			If $sumfiles = 1 Then
				$sumfle = $sumfld & "\" & $ASIN & ".txt"
				_FileCreate($sumfle)
				FileWrite($sumfle, $summary)
			Else
				IniWrite($catfle, $ASIN, "summary", $summary)
			EndIf
		Case $msg = $Button_select
			; Select ebook for COPY or MOVE LIST process
			AddToOrRemoveFromQueryList("image")
			If StringInStr($list, $ASIN) > 0 Then
				GUICtrlSetBkColor($Button_select, 0xA0A000)
			Else
				;$defcol = "0x" & Hex(_WinAPI_GetSysColor($COLOR_MENU), 6)
				;GUICtrlSetBkColor($Button_select, $defcol)
				GUICtrlSetStyle($Button_select, $GUI_SS_DEFAULT_BUTTON)
			EndIf
		Case $msg = $Button_kobo
			; Add or Update the URL to that currently shown
			$kobo = IniRead($catfle, $ASIN, "kobo_url", "")
			IniWrite($catfle, $ASIN, "kobo_url_backup", $kobo)
			$kobo = GUICtrlRead($Input_kobo)
			If StringLeft($kobo, 4) = "http" Then
				IniWrite($catfle, $ASIN, "kobo_url", $kobo)
			Else
				MsgBox(262192, "Format Error", "URL did not start with 'http', so restoring.", 0, $ImageGUI)
				$kobo = IniRead($catfle, $ASIN, "kobo_url_backup", "")
				IniWrite($catfle, $ASIN, "kobo_url", $kobo)
				GUICtrlSetData($Input_kobo, $kobo)
			EndIf
		Case $msg = $Button_goto
			; Visit the Kobo web page for this ebook
			If $kobo <> "" Then ShellExecute($kobo)
		Case $msg = $Button_favorite
			; Toggle the Favorite status of current ebook
			GUISwitch($PriceQueryGUI)
			SetItemAsFavorite()
			GUISwitch($ImageGUI)
			If $favorite = 1 Or $secondary = 1 Then
				GUICtrlSetData($Button_favorite, "REMOVE" & @LF & "THIS AS" & @LF & "FAVORITE")
			Else
				GUICtrlSetData($Button_favorite, "SET THIS" & @LF & "ONE AS A" & @LF & "FAVORITE")
			EndIf
		Case $msg = $Button_down
			; View next ebook entry image & detail
			;MsgBox(262192, "$nums $ind", $nums & @LF & $ind, 0, $ImageGUI)
			If $ind < ($nums - 1) Then
				$ind = $ind + 1
			Else
				$ind = 0
			EndIf
			GetAnotherImageEntry()
			If $favorite = 1 Or $secondary = 1 Then
				GUICtrlSetData($Button_favorite, "REMOVE" & @LF & "THIS AS" & @LF & "FAVORITE")
			Else
				GUICtrlSetData($Button_favorite, "SET THIS" & @LF & "ONE AS A" & @LF & "FAVORITE")
			EndIf
			WinSetTitle($ImageGUI, "", "Selected Entry Detail  (" & $ind + 1 & ")")
			WinActivate($ImageGUI, "")
			If StringInStr($list, $ASIN) > 0 Then
				GUICtrlSetBkColor($Button_select, 0xA0A000)
			Else
				;$defcol = "0x" & Hex(_WinAPI_GetSysColor($COLOR_MENU), 6)
				;GUICtrlSetBkColor($Button_select, $defcol)
				GUICtrlSetStyle($Button_select, $GUI_SS_DEFAULT_BUTTON)
			EndIf
			GUICtrlSetData($Label_price, "Price")
			$kobo = IniRead($catfle, $ASIN, "kobo_url", "")
			GUICtrlSetData($Input_kobo, $kobo)
			$cost = IniRead($catfle, $ASIN, "kobo_price", "")
			GUICtrlSetData($Input_price, $cost)
			GUICtrlSetState($Input_URL, $GUI_FOCUS)
			Send("{HOME}")
			GUICtrlSetState($Input_kobo, $GUI_FOCUS)
			Send("{HOME}")
		Case $msg = $Button_copy
			; Copy all details to clipboard
			$report = GUICtrlRead($Edit_rep)
			$summary = GUICtrlRead($Edit_com)
			$report = $report & @CRLF & $summary & @CRLF & "URL = " & $URL
			If $comment <> "" Then $report = $report & @CRLF & "Comment = " & $comment
			If $changes <> "" Then $report = $report & @CRLF & $changes
			$report = StringStripWS($report, 1)
			ClipPut($report)
		Case $msg = $Button_comment
			; Update stored comments for this ebook
			$comment = GUICtrlRead($Input_comms)
			$comment = StringSplit($comment, "<-------", 1)
			$comment = $comment[1]
			$comment = StringReplace($comment, @CRLF, "|")
			;IniWrite($catfle, $ASIN, "comment", $comment)
			IniWrite($comfle, $ASIN, "comment", $comment)
		Case $msg = $Button_check
			; Check the price at Kobo
			$kobo = GUICtrlRead($Input_kobo)
			If $kobo <> "" Then
				If FileExists($catfle) Then
					;SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
					GUICtrlSetState($Button_check, $GUI_DISABLE)
					GUICtrlSetData($Input_price, "WAIT")
					$cost = ""
					$html = ""
					If $test = 1 Then
						$connection = 1
					Else
						CheckForConnection()
					EndIf
					If $connection = 1 Then
						If $test = 1 Then
							$pth = FileOpenDialog("Browse for a local saved Kobo web page.", @ScriptDir, "Web page (*.html;*.htm;*.txt)", 3, "", $ImageGUI)
							If @error = 0 Then
								$kobofle = $pth
								$html = FileRead($kobofle)
							EndIf
						Else
							IniWrite($inifle, "Kobo", "start", _NowTime(5))
							$kobofle = @ScriptDir & "\Kobo.html"
							_FileCreate($kobofle)
							;$html = _INetGetSource($kobo)
							;If @error <> 1 Then
							;	$html = StringStripWS($html, 7)
							;	_FileWriteToLine($kobofle, 1, $html, 1)
							;Else
							;	$html = ""
							;EndIf
							$oIE = _IECreate($kobo, 0, 0, 1, 0)
							If @error = 0 Then
								$html = _IEDocReadHTML($oIE)
								_FileWriteToLine($kobofle, 1, $html, 1)
							Else
								$html = ""
							EndIf
							_IEQuit($oIE)
							IniWrite($inifle, "Kobo", "finish", _NowTime(5))
						EndIf
						If $html <> "" Then
							$cost = StringSplit($html, '<span class="price">', 1)
							If $cost[0] > 1 Then
								$cost = $cost[2]
								$cost = StringSplit($cost, '</span>', 1)
								$cost = $cost[1]
								$cost = StringStripWS($cost, 8)
								$check = StringReplace($cost, "$", "")
								$check = StringReplace($check, $csign, "")
								$check = StringReplace($check, ".", "")
								If StringIsDigit($check) = 0 Then $cost = ""
							Else
								$cost = ""
							EndIf
						EndIf
					EndIf
					;SplashOff()
					$lne = $lowid + $ind + 1
					GUISwitch($PriceQueryGUI)
					If $cost <> "" Then
						; Get last saved price
						$price = IniRead($catfle, $ID, "kobo_price", "")
						; Get prior saved price
						$prior = IniRead($catfle, $ID, "kobo_prior", "")
						If $price <> $cost Then
							; Update
							;GUICtrlSetBkColor($Button_quit + $ind + 1, $COLOR_YELLOW)
							If $price <> $prior Then
								; Backup
								$prior = $price
								IniWrite($catfle, $ASIN, "kobo_prior", $prior)
								;_GUICtrlListView_SetItemText($ListView_ebooks, $ind, $prior, 3)
								$prior = GetValueForPrice($prior)
								$check = GetValueForPrice($cost)
								If $prior < $check Then
									; Latest price is more
									GUICtrlSetColor($lne, 0x800000)
								Else
									; Latest price is less
									GUICtrlSetColor($lne, $COLOR_BLUE)
								EndIf
							ElseIf $prior = "" Then
								; Price now exists
								GUICtrlSetColor($lne, $COLOR_BLACK)
							EndIf
							$price = $cost
							IniWrite($catfle, $ASIN, "kobo_price", $price)
							;_GUICtrlListView_SetItemText($ListView_ebooks, $ind, $price & "*", 4)
						Else
							; Price is unchanged
							GUICtrlSetColor($lne, $COLOR_BLACK)
						EndIf
						$start = IniRead($catfle, $ASIN, "kobo_start", "")
						If $start = "" Then
							If $prior = "" Then
								$start = $price
							Else
								$start = $prior
							EndIf
							IniWrite($catfle, $ASIN, "kobo_start", $start)
						EndIf
						$priors = IniRead($catfle, $ASIN, "kobo_prices", "")
						If $priors = "" Then
							If $prior = "" Then
								$priors = "|" & $price & "|"
							Else
								$priors = "|" & $prior & "|" & $price & "|"
							EndIf
							IniWrite($catfle, $ASIN, "kobo_prices", $priors)
						Else
							If StringInStr($priors, "|" & $price & "|") < 1 Then
								$priors = $priors & $price & "|"
								IniWrite($catfle, $ASIN, "kobo_prices", $priors)
							EndIf
						EndIf
;~ 						; Get last saved price
;~ 						$prior = IniRead($catfle, $ASIN, "kobo_price", "")
;~ 						If $cost <> $prior Then
;~ 							; Update
;~ 							IniWrite($catfle, $ASIN, "kobo_price", $cost)
;~ 							If $prior <> "" Then
;~ 								; Backup
;~ 								IniWrite($catfle, $ASIN, "kobo_prior", $prior)
;~ 								$prior = GetValueForPrice($prior)
;~ 								$check = GetValueForPrice($cost)
;~ 								If $prior < $check Then
;~ 									; Latest price is more
;~ 									GUICtrlSetColor($lne, 0x800000)
;~ 								Else
;~ 									; Latest price is less
;~ 									GUICtrlSetColor($lne, $COLOR_BLUE)
;~ 								EndIf
;~ 							Else
;~ 								; Price now exists
;~ 								GUICtrlSetColor($lne, $COLOR_BLACK)
;~ 							EndIf
;~ 						Else
;~ 							; Price is unchanged
;~ 							GUICtrlSetColor($lne, $COLOR_BLACK)
;~ 						EndIf
					Else
						If $html <> "" Then
							; Getting price failed
							GUICtrlSetColor($lne, 0x008000)
						Else
							; Downloading web page failed
							GUICtrlSetColor($lne, 0x9000F0)
						EndIf
					EndIf
					GUISwitch($ImageGUI)
					GUICtrlSetData($Input_price, $cost)
					GUICtrlSetState($Button_check, $GUI_ENABLE)
					;MsgBox(262192, "$lne $ind", $lne & @LF & $ind, 0, $ImageGUI)
				EndIf
			EndIf
		Case $msg = $Button_adjust
			; Adjust the Kobo price Notification value
			$val = InputBox("Adjust Notification", "Set a new value in cents (etc) only." & @LF & @LF & "(0 = disable) NOT RECOMMENDED", $notify, "", 200, 150, -1, -1, 0, $ImageGUI)
			If @error = 0 And StringIsDigit($val) Then
				$notify = $val
				IniWrite($inifle, "Kobo", "notify", $notify)
			EndIf
			GUISetState(@SW_RESTORE, $ImageGUI)
		Case $msg = $Checkbox_auto
			; Check the price at Kobo with QUERY
			GUICtrlSetState($Checkbox_auto, $GUI_UNCHECKED)
			MsgBox(262192, "Not Available", "Auto checking Kobo prices with a QUERY, is currently disabled." & @LF & @LF & "Use the right-click menu option of the QUERY button instead.", 0, $ImageGUI)
			;If GUICtrlRead($Checkbox_auto) = $GUI_CHECKED Then
			;	$kobocheck = 1
			;Else
			;	$kobocheck = 4
			;EndIf
			;IniWrite($inifle, "Kobo", "autocheck", $kobocheck)
		Case $msg = $Label_price
			; Click to cycle prior and current price
			$val = GUICtrlRead($Input_price)
			If $val = "" Then
				$val = IniRead($catfle, $ASIN, "kobo_price", "")
				If $val = "" Then
					$val = IniRead($catfle, $ASIN, "kobo_prior", "")
					GUICtrlSetData($Label_price, "Prior")
				Else
					GUICtrlSetData($Label_price, "Price")
				EndIf
			Else
				$cost = IniRead($catfle, $ASIN, "kobo_price", "")
				$prior = IniRead($catfle, $ASIN, "kobo_prior", "")
				If $val = $cost Then
					$val = $prior
					GUICtrlSetData($Label_price, "Prior")
				ElseIf $val = $prior Then
					$val = $cost
					GUICtrlSetData($Label_price, "Price")
				EndIf
			EndIf
			GUICtrlSetData($Input_price, $val)
		Case Else
			;;;
;~ 			If $loops = 20 Then
;~ 				$loops = 0
;~ 				_IEAction($oIE, "stop")
;~ 				$loaded = _IEPropertyGet($oIE, "locationurl")
;~ 				If $loaded <> $urlpage Then
;~ 					$urlpage = $loaded
;~ 					_IEBodyWriteHTML($oIE, '<div style="WORD-WRAP: normal; WORD-BREAK: break-all">' & $loaded & '</div>')
;~ 				EndIf
;~ 			Else
;~ 				$loops = $loops + 1
;~ 			EndIf
		EndSelect
	WEnd
	If $comment <> "" Then DetermineComment()
EndFunc ;=> ImageDataGUI

Func SettingsGUI()
	Local $Button_codes, $Button_defs, $Button_fold, $Button_i3, $Button_ini, $Button_log, $Button_reset
	Local $Button_tag, $Button_val, $Button_x3
	Local $Checkbox_act, $Checkbox_backup, $Checkbox_blank, $Checkbox_delay, $Checkbox_extra, $Checkbox_flash
	Local $Checkbox_less, $Checkbox_loop, $Checkbox_minclip, $Checkbox_others, $Checkbox_rate, $Checkbox_record
	Local $Checkbox_relax, $Checkbox_resort, $Checkbox_save, $Checkbox_show, $Checkbox_slick, $Checkbox_splash
	Local $Checkbox_stop, $Checkbox_store, $Checkbox_tab, $Checkbox_time, $Checkbox_timer
	Local $Combo_compare, $Combo_from, $Combo_mode, $Combo_to
	Local $Group_mode, $Group_html, $Group_read, $Group_semi, $Input_add, $Input_alert, $Input_browser
	Local $Input_delay, $Input_exchadd, $Input_extra, $Input_flash, $Input_reduct, $Input_save, $Input_search
	Local $Input_server, $Input_sign, $Input_tab, $Input_tag, $Input_timeout, $Input_val, $Label_alert
	Local $Label_arrow, $Label_colors, $Label_compare, $Label_errcol, $Label_exchadd, $Label_lescol
	Local $Label_mincol, $Label_morcol, $Label_read, $Label_save, $Label_search, $Label_server, $Label_sign
	Local $Label_skicol, $Label_swecol, $Label_tag, $Label_timeout, $Label_val
	Local $Updown_alert, $Updown_browser, $Updown_delay, $Updown_extra, $Updown_flash, $Updown_save, $Updown_tab
	Local $browsers, $currencies, $idx, $labcol, $note, $Settings
	; NOTE - some controls are Global - $Combo_tag, $Combo_val, 
	
	$Settings = GuiCreate("Settings", 640, 415, -1, -1, $WS_OVERLAPPED + $WS_CAPTION + $WS_SYSMENU _
								+ $WS_VISIBLE + $WS_CLIPSIBLINGS + $WS_MINIMIZEBOX, $WS_EX_TOPMOST, $PriceQueryGUI)
	; CONTROLS
	GUICtrlCreateGraphic(320, 5, 2, 405)
    GUICtrlSetBkColor(-1, 0xBBBBBB)
    ;GUICtrlSetColor(-1, 0xff)
	;GUICtrlSetGraphic(-1, $GUI_GR_COLOR, 0x000000)
	;
	; LEFT side
	$Checkbox_loop = GuiCtrlCreateCheckbox("Keep presenting the URL InputBox until CANCEL is clicked", 10, 10, 300, 20)
	$Checkbox_splash = GuiCtrlCreateCheckbox("Show splash screen if no price changes detected by Query", 10, 30, 300, 20)
	$Checkbox_stop = GuiCtrlCreateCheckbox("Enable STOP for a Query", 10, 50, 140, 20)
	$Label_save = GUICtrlCreateLabel("Save up to", 173, 50, 62, 20, $SS_CENTER + $SS_CENTERIMAGE)
	$Input_save = GUICtrlCreateInput("", 234, 50, 36, 20, $ES_NUMBER)
	GUICtrlSetTip($Input_save, "Current number of queries to save!")
	$Updown_save = GUICtrlCreateUpdown($Input_save)
	GUICtrlSetLimit($Updown_save, 99, 0)
	GUICtrlSetTip($Updown_save, "Adjust number of queries to save!")
	GUICtrlCreateLabel("queries", 273, 50, 40, 20, $SS_CENTERIMAGE)
	$Checkbox_backup = GuiCtrlCreateCheckbox("Create backups for user files (cycle up to 5 on program start)", 10, 70, 300, 20)
	$Checkbox_resort = GuiCtrlCreateCheckbox("Automatically resort entries after an ebook entry is removed", 10, 90, 300, 20)
	$Checkbox_flash = GuiCtrlCreateCheckbox("Use a flashing 'Please Wait!' instead of splash at rate", 10, 110, 265, 20)
	$Input_flash = GUICtrlCreateInput("", 280, 110, 31, 20, $ES_NUMBER)
	GUICtrlSetTip($Input_flash, "Current flashing rate!")
	$Updown_flash = GUICtrlCreateUpdown($Input_flash)
	GUICtrlSetLimit($Updown_flash, 9, 0)
	GUICtrlSetTip($Updown_flash, "Adjust rate of 'Please Wait' flashing!")
	$Checkbox_others = GuiCtrlCreateCheckbox("Do not prompt to Query non-favorites, just do Query instantly", 10, 130, 300, 20)
	$Checkbox_less = GuiCtrlCreateCheckbox("Display, but do not add price to ebook record if less than .10", 10, 150, 300, 20)
	GUICtrlSetTip($Checkbox_less, "Show result, but do not store for ebook if change is less than 10 cents (etc)!")
	$Checkbox_timer = GuiCtrlCreateCheckbox("Display a timer during Query and show Time Taken in report", 10, 170, 300, 20)
	;
	$Checkbox_delay = GuiCtrlCreateCheckbox("Delay", 10, 199, 45, 21)
	GUICtrlSetTip($Checkbox_delay, "Use a Delay between multiple queries!")
	$Input_delay = GUICtrlCreateInput("", 10, 224, 44, 20, $ES_NUMBER)
	GUICtrlSetTip($Input_delay, "Delay in seconds between multiple queries!")
	$Updown_delay = GUICtrlCreateUpdown($Input_delay)
	GUICtrlSetLimit($Updown_delay, 99, 0)
	GUICtrlSetTip($Updown_delay, "Adjust Delay between multiple queries!")
	;
	$Group_mode = GuiCtrlCreateGroup("Mode", 63, 194, 248, 55)
	$Combo_mode = GUICtrlCreateCombo("", 73, 215, 70, 21)
	$Checkbox_tab = GuiCtrlCreateCheckbox("Close Browser Tab (Crl + W)", 152, 207, 150, 18)
	GUICtrlSetTip($Checkbox_tab, "Close current browser tab after saving price!")
	$Checkbox_act = GuiCtrlCreateCheckbox("Activate Any Amazon Tab", 152, 225, 150, 18)
	GUICtrlSetTip($Checkbox_act, "Activate the Amazon browser tab prior to text copy process!")
	;
	$Group_semi = GuiCtrlCreateGroup("Semi-Auto Options  (delays in seconds)", 10, 258, 302, 70)
	GUICtrlCreateLabel("Browser Start Up", 20, 278, 80, 20, $SS_CENTERIMAGE)
	$Input_browser = GUICtrlCreateInput("", 105, 278, 45, 20, $ES_NUMBER)
	GUICtrlSetTip($Input_browser, "Delay in seconds while browser starts up!")
	$Updown_browser = GUICtrlCreateUpdown($Input_browser)
	GUICtrlSetLimit($Updown_browser, 999, 0)
	GUICtrlSetTip($Updown_browser, "Adjust Delay for browser start up!")
	GUICtrlCreateLabel("Browser Tab Load", 160, 278, 90, 20, $SS_CENTERIMAGE)
	$Input_tab = GUICtrlCreateInput("", 255, 278, 45, 20, $ES_NUMBER)
	GUICtrlSetTip($Input_tab, "Delay in seconds while browser tab loads!")
	$Updown_tab = GUICtrlCreateUpdown($Input_tab)
	GUICtrlSetLimit($Updown_tab, 999, 0)
	GUICtrlSetTip($Updown_tab, "Adjust Delay for browser tab loading!")
	$Checkbox_extra = GuiCtrlCreateCheckbox("Add an extra", 20, 300, 80, 18)
	GUICtrlSetTip($Checkbox_extra, "Activate using an extra delay when a failure occurs!")
	$Input_extra = GUICtrlCreateInput("", 103, 300, 37, 20, $ES_NUMBER)
	GUICtrlSetTip($Input_extra, "Extra delay in seconds while tab loads!")
	$Updown_extra = GUICtrlCreateUpdown($Input_extra)
	GUICtrlSetLimit($Updown_extra, 99, 0)
	GUICtrlSetTip($Updown_extra, "Adjust extra Delay for browser tab loading!")
	GUICtrlCreateLabel("seconds after copy failure occurs", 145, 300, 160, 20, $SS_CENTERIMAGE)
	;
	$Checkbox_rate = GuiCtrlCreateCheckbox("Enable exchange rate conversion", 10, 335, 180, 20)
	GUICtrlSetTip($Checkbox_rate, "Enable exchange rate currency conversion!")
	$Combo_from = GUICtrlCreateCombo("", 195, 335, 50, 21)
	$Label_arrow = GUICtrlCreateLabel("-->", 245, 335, 16, 21, $SS_CENTER + $SS_CENTERIMAGE)
	$Combo_to = GUICtrlCreateCombo("", 261, 335, 50, 21)
	;
	$Label_exchadd = GUICtrlCreateLabel("Google Converter", 10, 362, 100, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetBkColor($Label_exchadd, 0x007000)
	GUICtrlSetColor($Label_exchadd, 0xFFFFFF)
	GUICtrlSetTip($Label_exchadd, "Google Converter Address!")
	$Input_exchadd = GUICtrlCreateInput("", 110, 362, 145, 20)
	;
	$Button_reset = GuiCtrlCreateButton("RESET", 265, 362, 47, 20)
	GUICtrlSetFont($Button_reset, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_reset, "Clear the Exchange Rate for check time!")
	;
	$Label_search = GUICtrlCreateLabel("Search Address", 10, 387, 90, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetBkColor($Label_search, 0x007000)
	GUICtrlSetColor($Label_search, 0xFFFFFF)
	GUICtrlSetTip($Label_search, "Amazon Search Address to find an ebook!")
	$Input_search = GUICtrlCreateInput("", 100, 387, 155, 20)
	;
	$Button_codes = GuiCtrlCreateButton("CODES", 265, 387, 47, 20)
	GUICtrlSetFont($Button_codes, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_codes, "Fix or Add currency country codes!")
	;
	; RIGHT side
	$Checkbox_relax = GuiCtrlCreateCheckbox("Relax the URL format for ADD", 330, 10, 170, 20)
	;
	$Label_sign = GUICtrlCreateLabel("Alternate Currency", 515, 10, 95, 20, $SS_CENTER + $SS_CENTERIMAGE)
	$Input_sign = GUICtrlCreateInput("", 610, 10, 20, 20)
	;
	$Checkbox_show = GuiCtrlCreateCheckbox("Show ALL price changes in the Selected Entry Detail dialog", 330, 30, 300, 20)
	$Checkbox_record = GuiCtrlCreateCheckbox("Record ALL price changes for each ebook", 330, 50, 220, 20)
	$Checkbox_time = GuiCtrlCreateCheckbox("Include the Time in Date for price changes", 330, 70, 225, 20)
	;
	$Label_alert = GUICtrlCreateLabel("Alert amount for large price change", 330, 90, 170, 20, $SS_CENTERIMAGE)
	$Input_alert = GUICtrlCreateInput("", 500, 90, 47, 20, $ES_NUMBER)
	$Updown_alert = GUICtrlCreateUpdown($Input_alert, $UDS_NOTHOUSANDS)
	GUICtrlSetLimit($Updown_alert, 1000, 5)
	GUICtrlSetTip($Updown_alert, "Adjust the alert amount for large price change!")
	;
	$Checkbox_store = GuiCtrlCreateCheckbox("Store the Image data for each ebook", 330, 115, 195, 20)
	;
	$Button_ini = GuiCtrlCreateButton("I", 527, 114, 20, 20, $BS_ICON)
	GUICtrlSetImage($Button_ini, $shell, $icoN, 0)
	GUICtrlSetTip($Button_ini, "Open the Settings.ini or Catalog.ini file!")
	;
	$Button_defs = GuiCtrlCreateButton("DEFAULTS", 555, 50, 75, 35)
	GUICtrlSetFont($Button_defs, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_defs, "Restore settings to defaults!")
	;
	$Button_fold = GuiCtrlCreateButton("PROGRAM FOLDER", 555, 90, 75, 45, $BS_MULTILINE)
	GUICtrlSetFont($Button_fold, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_fold, "Open the Program Folder!")
	;
	$Label_server = GUICtrlCreateLabel("Server Address", 330, 142, 85, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetBkColor($Label_server, 0x007000)
	GUICtrlSetColor($Label_server, 0xFFFFFF)
	GUICtrlSetTip($Label_server, "Server Address to query for connection!")
	$Input_server = GUICtrlCreateInput("", 415, 142, 120, 20)
	GUICtrlSetTip($Input_server, "Server Address to query for connection!")
	$Label_timeout = GUICtrlCreateLabel("Timeout", 540, 142, 50, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetBkColor($Label_timeout, 0x007000)
	GUICtrlSetColor($Label_timeout, 0xFFFFFF)
	GUICtrlSetTip($Label_timeout, "Timeout for server query in milliseconds!")
	$Input_timeout = GUICtrlCreateInput("", 590, 142, 40, 20, $ES_NUMBER)
	GUICtrlSetTip($Input_timeout, "Timeout for server query in milliseconds!")
	;
	$Group_html = GuiCtrlCreateGroup("HTML Read Replacements", 330, 170, 240, 75)
	$Label_tag = GUICtrlCreateLabel("TAG", 340, 190, 35, 21, $SS_CENTER + $SS_CENTERIMAGE)
	GUICtrlSetBkColor($Label_tag, 0x000000)
	GUICtrlSetColor($Label_tag, 0xFFFFFF)
	$Combo_tag = GUICtrlCreateCombo("", 375, 190, 80, 21)
	$Input_tag = GUICtrlCreateInput("", 460, 190, 35, 21)
	$Button_tag = GuiCtrlCreateButton("UPDATE", 505, 190, 55, 21)
	GUICtrlSetFont($Button_tag, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_tag, "Add or Update a TAG!")
	;;;
	$Label_val = GUICtrlCreateLabel("VALUE", 340, 215, 45, 21, $SS_CENTER + $SS_CENTERIMAGE)
	GUICtrlSetBkColor($Label_val, 0x000000)
	GUICtrlSetColor($Label_val, 0xFFFFFF)
	$Combo_val = GUICtrlCreateCombo("", 385, 215, 70, 21)
	$Input_val = GUICtrlCreateInput("", 460, 215, 35, 21)
	$Button_val = GuiCtrlCreateButton("UPDATE", 505, 215, 55, 21)
	GUICtrlSetFont($Button_val, 6, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_val, "Add or Update a VALUE!")
	;
	$Group_read = GuiCtrlCreateGroup("HTML Read Characters (Removed + Add)", 330, 254, 240, 50)
	$Label_read = GUICtrlCreateLabel("Last Reduction", 340, 274, 90, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetBkColor($Label_read, 0x0000F0)
	GUICtrlSetColor($Label_read, 0xFFFFFF)
	$Input_reduct = GUICtrlCreateInput("", 430, 274, 60, 20, $ES_READONLY)
	$Input_add = GUICtrlCreateInput("", 500, 274, 60, 20, $ES_NUMBER)
	;
	$Button_log = GuiCtrlCreateButton("LOG", 580, 169, 50, 20)
	GUICtrlSetFont($Button_log, 7, 600, 0, "Small Fonts")
	GUICtrlSetTip($Button_log, "View the Log file!")
	;
	$Button_i3 = GuiCtrlCreateButton("Info", 580, 198, 50, 48, $BS_ICON)
	GUICtrlSetImage($Button_i3, $user32, $icoI, 1)
	GUICtrlSetTip($Button_i3, "Settings Information!")
	;
	$Button_x3 = GuiCtrlCreateButton("EXIT", 580, 256, 50, 48, $BS_ICON)
	GUICtrlSetImage($Button_x3, $shell, $icoX, 1)
	GUICtrlSetTip($Button_x3, "Quit, Close or Exit window!")
	;
	$Checkbox_blank = GuiCtrlCreateCheckbox("Remove blank lines from Summary when ADDING an ebook", 330, 310, 300, 20)
	;
	$Label_colors = GUICtrlCreateLabel("CHANGES", 330, 334, 55, 20, $SS_CENTER + $SS_CENTERIMAGE)
	GUICtrlSetBkColor($Label_colors, 0x000000)
	GUICtrlSetColor($Label_colors, 0xFFFFFF)
	GUICtrlSetFont($Label_colors, 6, 600, 0, "Small Fonts")
	$Label_errcol = GUICtrlCreateLabel("Error", 390, 334, 35, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetTip($Label_errcol, "Click to change the color!")
	$Label_mincol = GUICtrlCreateLabel("Minor", 429, 334, 40, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetTip($Label_mincol, "Click to change the color!")
	$Label_lescol = GUICtrlCreateLabel("Less", 473, 334, 35, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetTip($Label_lescol, "Click to change the color!")
	$Label_morcol = GUICtrlCreateLabel("More", 512, 334, 35, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetTip($Label_morcol, "Click to change the color!")
	$Label_swecol = GUICtrlCreateLabel("Sweet", 551, 334, 40, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetTip($Label_swecol, "Click to change the color!")
	$Label_skicol = GUICtrlCreateLabel("Skip", 595, 334, 35, 20, $SS_CENTER + $SS_CENTERIMAGE + $SS_NOTIFY)
	GUICtrlSetTip($Label_skicol, "Click to change the color!")
	;
	$Label_compare = GUICtrlCreateLabel("Compare Selected Entry With User", 330, 361, 180, 21, $SS_CENTER + $SS_CENTERIMAGE)
	GUICtrlSetBkColor($Label_compare, 0x907000)
	GUICtrlSetColor($Label_compare, 0xFFFFFF)
	GUICtrlSetTip($Label_compare, "Compare selected ebook with another user!")
	$Combo_compare = GUICtrlCreateCombo("", 510, 361, 70, 21)
	$Checkbox_save = GuiCtrlCreateCheckbox("Save", 588, 361, 50, 21)
	GUICtrlSetTip($Checkbox_save, "Record price from other user at purchase time!")
	;
	$Checkbox_slick = GuiCtrlCreateCheckbox("Slicker visuals for low powered PC", 330, 387, 180, 20)
	GUICtrlSetTip($Checkbox_slick, "Slicker visuals for low powered PC!")
	;
	$Checkbox_minclip = GuiCtrlCreateCheckbox("Clipboard Minimizes", 520, 387, 110, 20)
	GUICtrlSetTip($Checkbox_minclip, "Minimize program when clipboard button clicked!")
	;
	; SETTINGS
	GUICtrlSetBkColor($Label_errcol, $errcol)
	GUICtrlSetBkColor($Label_mincol, $mincol)
	GUICtrlSetBkColor($Label_lescol, $lescol)
	GUICtrlSetBkColor($Label_morcol, $morcol)
	GUICtrlSetBkColor($Label_swecol, $swecol)
	GUICtrlSetBkColor($Label_skicol, $skicol)
	;
	GUICtrlSetState($Checkbox_loop, $loop)
	GUICtrlSetState($Checkbox_splash, $splash)
	GUICtrlSetState($Checkbox_stop, $stop)
	GUICtrlSetState($Checkbox_backup, $backup)
	GUICtrlSetState($Checkbox_resort, $resort)
	;
	GUICtrlSetData($Input_save, $slots)
	;
	GUICtrlSetState($Checkbox_flash, $flash)
	GUICtrlSetData($Input_flash, $rate)
	If $flash = 4 Then
		GUICtrlSetState($Input_flash, $GUI_DISABLE)
		GUICtrlSetState($Updown_flash, $GUI_DISABLE)
	EndIf
	;
	GUICtrlSetState($Checkbox_others, $instant)
	GUICtrlSetState($Checkbox_less, $skip)
	GUICtrlSetState($Checkbox_timer, $timer)
	;
	GUICtrlSetState($Checkbox_delay, $pause)
	GUICtrlSetData($Input_delay, $delay)
	If $pause = 4 Then
		GUICtrlSetState($Input_delay, $GUI_DISABLE)
		GUICtrlSetState($Updown_delay, $GUI_DISABLE)
	EndIf
	;
	$mode = IniRead($inifle, "Query", "mode", "")
	GUICtrlSetData($Combo_mode, $modes, $mode)
	;
	GUICtrlSetState($Checkbox_tab, $tabclose)
	If $mode = "automatic" Then
		GUICtrlSetState($Checkbox_tab, $GUI_DISABLE)
	EndIf
	GUICtrlSetState($Checkbox_act, $activate)
	If $mode <> "semi-auto" And $mode <> "prompt" Then
		GUICtrlSetState($Checkbox_act, $GUI_DISABLE)
		GUICtrlSetState($Checkbox_extra, $GUI_DISABLE)
	EndIf
	GUICtrlSetData($Input_browser, $browdel)
	GUICtrlSetData($Input_tab, $tabdel)
	If $mode = "automatic" Or $mode = "manual" Then
		GUICtrlSetState($Input_browser, $GUI_DISABLE)
		GUICtrlSetState($Updown_browser, $GUI_DISABLE)
		GUICtrlSetState($Input_tab, $GUI_DISABLE)
		GUICtrlSetState($Updown_tab, $GUI_DISABLE)
	EndIf
	;
	GUICtrlSetState($Checkbox_extra, $extra)
	If $extra = 4 Or ($mode <> "semi-auto" And $mode <> "prompt") Then
		GUICtrlSetState($Input_extra, $GUI_DISABLE)
		GUICtrlSetState($Updown_extra, $GUI_DISABLE)
	EndIf
	GUICtrlSetData($Input_extra, $exdel)
	;
	$currencies = IniRead($inifle, "Conversion", "currencies", "")
	If $currencies = "" Then
		$currencies = "AUD|CAD|CHF|CNY|EUR|GBP|INR|JPY|NZD|RUB|SEK|TWD|USD|ZAR"
		IniWrite($inifle, "Conversion", "currencies", $currencies)
	EndIf
	GUICtrlSetData($Combo_from, $currencies, $usd)
	GUICtrlSetData($Combo_to, $currencies, $currency)
	;
	$googcon = IniRead($inifle, "Conversion", "link", "")
	GUICtrlSetData($Input_exchadd, $googcon)
	;
	GUICtrlSetData($Input_search, $searchadd)
	;
	GUICtrlSetState($Checkbox_rate, $excon)
	If $excon = 4 Then
		GUICtrlSetState($Combo_from, $GUI_DISABLE)
		GUICtrlSetState($Combo_to, $GUI_DISABLE)
	EndIf
	;
	GUICtrlSetState($Checkbox_relax, $relax)
	GUICtrlSetState($Checkbox_show, $excoms)
	GUICtrlSetState($Checkbox_record, $record)
	GUICtrlSetState($Checkbox_time, $time)
	GUICtrlSetState($Checkbox_store, $data)
	;
	GUICtrlSetData($Input_sign, $csign)
	;
	GUICtrlSetData($Input_alert, $alert)
	;
	GetTagSettings()
	;
	GetValueSettings()
	;
	$chrcnt = IniRead($inifle, "Html Read", "reduction", "")
	GUICtrlSetData($Input_reduct, $chrcnt)
	GUICtrlSetData($Input_add, $getcnt)
	;
	GUICtrlSetData($Input_server, $server)
	GUICtrlSetData($Input_timeout, $timeout)
	;
	GUICtrlSetState($Checkbox_blank, $blanks)
	;
	GUICtrlSetData($Combo_compare, $users, $whom)
	GUICtrlSetState($Checkbox_save, $save)
	;
	GUICtrlSetState($Checkbox_slick, $slick)
	;
	GUICtrlSetState($Checkbox_minclip, $minclip)
	;
	$note = ""
	

	GuiSetState()
	While 1
		$msg = GuiGetMsg()
		Select
		Case $msg = $GUI_EVENT_CLOSE Or $msg = $Button_x3
			; Quit, Close or Exit window
			$googcon = GUICtrlRead($Input_exchadd)
			If $googcon = "" Then
				;$googcon = "https://finance.google.com/finance/converter"
				$googcon = "https://www.google.com"
			EndIf
			IniWrite($inifle, "Conversion", "link", $googcon)
			;
			$searchadd = GUICtrlRead($Input_search)
			If $searchadd = "" Then $searchadd = "http://www.amazon.com.au"
			IniWrite($inifle, "Amazon Search", "address", $searchadd)
			;
			$csign = GUICtrlRead($Input_sign)
			If $csign = "" Then $csign = "£"
			IniWrite($inifle, "Currency", "sign", $csign)
			;
			$getcnt = GUICtrlRead($Input_add)
			If $getcnt = "" Then $getcnt = 0
			IniWrite($inifle, "Html Read", "increase", $getcnt)
			;
			$server = GUICtrlRead($Input_server)
			If $server = "" Then $server = "www.google.com"
			If $server = "autoit" Then $server = "www.autoitscript.com"
			IniWrite($inifle, "Web", "server", $server)
			;
			$timeout = GUICtrlRead($Input_timeout)
			If $timeout = "" Then $timeout = 4000
			IniWrite($inifle, "Ping", "timeout", $timeout)
			;
			GUIDelete($Settings)
			GUISetState(@SW_RESTORE, $PriceQueryGUI)
			ExitLoop
		Case $msg = $GUI_EVENT_RESTORE
			If $note = 1 Then
				$note = ""
				GUISetState(@SW_SHOW, $PriceQueryGUI)
			EndIf
		Case $msg = $Button_val
			; Add or Update a VALUE
			$val = GUICtrlRead($Combo_val)
			If $val = "" Then
				$ans = MsgBox(262433, "Restore Default Query", _
					"Do you want to restore the default program" & @LF & _
					"values for VALUES (characters)?" & @LF & @LF & _
					"WARNING - Any user additions will be lost.", 0, $Settings)
				If $ans = 1 Then
					$chars = $defchars
					IniWrite($inifle, "Html Replace", "characters", $chars)
					GUICtrlSetData($Combo_val, "", "")
					GetValueSettings()
				EndIf
			Else
				$rep = GUICtrlRead($Input_val)
				If StringInStr($allchars, "|" & $val & "|") < 1 Then
					;$allchars = $allchars & "|" & $val
					;$valreps = $valreps & "|" & $rep
					$allchars = $allchars & $val & "|"
					$valreps = $valreps & $rep & "|"
					GUICtrlSetData($Combo_val, "", "")
					GUICtrlSetData($Combo_val, $allchars, $val)
					;
					;$chars = $chars & "|" & $val & ":" & $rep
					$chars = $chars & $val & ":" & $rep & "|"
					IniWrite($inifle, "Html Replace", "characters", $chars)
				Else
					; Query removal
					$ans = MsgBox(262433, "VALUE Removal", _
						"Are you sure you wish to remove the selected VALUE" & @LF & @LF & _
						$val & @LF & @LF & _
						"from the stored checklist?", 0, $Settings)
					If $ans = 1 Then
						$allchars = StringReplace($allchars, "|" & $val & "|", "|")
						$idx = _GUICtrlComboBox_GetCurSel($Combo_val)
						If $idx > -1 Then
							$valreps = StringSplit($valreps, "|", 1)
							;_ArrayDelete($valreps, $idx + 2)
							_ArrayDelete($valreps, $idx)
							$valreps = _ArrayToString($valreps, "|", 1)
						EndIf
						GUICtrlSetData($Combo_val, "", "")
						GUICtrlSetData($Combo_val, $allchars, "")
						GUICtrlSetData($Input_val, "")
						;
						;$chars = StringReplace("|" & $chars, "|" & $val & ":" & $rep, "")
						;If StringLeft($chars, 1) = "|" Then $chars = StringTrimLeft($chars, 1)
						$chars = StringReplace($chars, "|" & $val & ":" & $rep & "|", "|")
						IniWrite($inifle, "Html Replace", "characters", $chars)
						;MsgBox(262192, "$valreps", $valreps, 0, $Settings)
					EndIf
				EndIf
			EndIf
		Case $msg = $Button_tag
			; Add or Update a TAG
			$tag = GUICtrlRead($Combo_tag)
			If $tag = "" Then
				$ans = MsgBox(262433, "Restore Default Query", _
					"Do you want to restore the default program" & @LF & _
					"values for TAGS?" & @LF & @LF & _
					"WARNING - Any user additions will be lost.", 0, $Settings)
				If $ans = 1 Then
					$tags = $deftags
					IniWrite($inifle, "Html Replace", "tags", $tags)
					GUICtrlSetData($Combo_tag, "", "")
					GetTagSettings()
				EndIf
			Else
				$rep = GUICtrlRead($Input_tag)
				If StringInStr($alltags, $tag) < 1 Then
					$alltags = $alltags & "|" & $tag
					If $rep = "|" Then $rep = "pipe"
					$tagreps = $tagreps & "|" & $rep
					GUICtrlSetData($Combo_tag, "", "")
					GUICtrlSetData($Combo_tag, $alltags, $tag)
					;
					$tags = $tags & "|" & $tag & ":" & $rep
					IniWrite($inifle, "Html Replace", "tags", $tags)
				Else
					; Query removal
					$ans = MsgBox(262433, "TAG Removal", _
						"Are you sure you wish to remove the selected TAG" & @LF & @LF & _
						$tag & @LF & @LF & _
						"from the stored checklist?", 0, $Settings)
					If $ans = 1 Then
						$alltags = StringReplace($alltags, "|" & $tag, "")
						$idx = _GUICtrlComboBox_GetCurSel($Combo_tag)
						If $idx > -1 Then
							$tagreps = StringSplit($tagreps, "|", 1)
							_ArrayDelete($tagreps, $idx + 2)
							$tagreps = _ArrayToString($tagreps, "|", 1)
						EndIf
						GUICtrlSetData($Combo_tag, "", "")
						GUICtrlSetData($Combo_tag, $alltags, "")
						GUICtrlSetData($Input_tag, "")
						;
						If $rep = "|" Then $rep = "pipe"
						$tags = StringReplace("|" & $tags, "|" & $tag & ":" & $rep, "")
						If StringLeft($tags, 1) = "|" Then $tags = StringTrimLeft($tags, 1)
						IniWrite($inifle, "Html Replace", "tags", $tags)
						;MsgBox(262192, "$tagreps", $tagreps, 0, $Settings)
					EndIf
				EndIf
			EndIf
		Case $msg = $Button_reset
			; Clear the Exchange Rate for check time
			$exchange = ""
			IniWrite($inifle, "Conversion", "time", "")
		Case $msg = $Button_log
			; View the Log file
			If FileExists($logfile) Then ShellExecute($logfile)
		Case $msg = $Button_ini
			; Open the Settings.ini or Catalog.ini file
			GUISetState(@SW_HIDE, $PriceQueryGUI)
			GUISetState(@SW_MINIMIZE, $Settings)
			If _IsPressed("11") Then
				If FileExists($catfle) Then
					Run($notepad & $catfle)
					WinWait($user & ".ini - Notepad", "", 5)
					WinSetOnTop($user & ".ini - Notepad", "", 1)
					Sleep(3000)
					WinSetOnTop($user & ".ini - Notepad", "", 0)
				EndIf
			Else
				If FileExists($inifle) Then
					Run($notepad & $inifle)
					WinWait("Settings.ini - Notepad", "", 5)
					WinSetOnTop("Settings.ini - Notepad", "", 1)
					Sleep(3000)
					WinSetOnTop("Settings.ini - Notepad", "", 0)
				EndIf
			EndIf
			$note = 1
		Case $msg = $Button_i3
			; Settings Information
			$ans = MsgBox(262465, "Settings Information", _
				"Unless you understand the various options in the Settings window," & @LF & _
				"I recommend you don't adjust them from the defaults." & @LF & @LF & _
				"Clicking the UPDATE buttons for TAG or VALUE, allows you to add" & @LF & _
				"other TAGS or VALUES (characters), or get prompted about the" & @LF & _
				"removal of the currently selected one, or restore the default." & @LF & @LF & _
				"The 'Replacement' fields (inputs) can be left blank if you don't wish" & @LF & _
				"to have a replacement. Use a pipe '|' character in the replacement" & @LF & _
				"field for TAG, to represent a carriage return." & @LF & @LF & _
				"Clicking the Blue 'Last Reduction' label, will return a toggled value" & @LF & _
				"('0' etc) to the ADD input field." & @LF & @LF & _
				"Any change to Alternate Currency, updates when window closes," & @LF & _
				"which likewise applies to ADD input for HTML Read Characters." & @LF & @LF & _
				"If your Currency is different to that of the Amazon store you use" & @LF & _
				"then you could enable the option for Exchange Rate Conversion," & @LF & _
				"so the field on the main program window displays the approximate" & @LF & _
				"current value when an entry is selected. (NOTES - Clicking on the" & @LF & _
				"black 'from -> to' label, will display the currently set rate. To add" & @LF & _
				"another currency, just edit 'currencies=' in the 'Settings.ini' file or" & @LF & _
				"CODES button will do this easily while preserving any differences." & @LF & _
				"The Exchange Rate is only queried & set once per session, so to" & @LF & _
				"update it, you need to disable + enable or restart the program.)" & @LF & @LF & _
				"Changes to some fields (Currency Sign, Google Converter Address," & @LF & _
				"Search Address, Server Address, Timeout, etc), will update those" & @LF & _
				"program settings when the 'Settings' window closes. Clicking a dark" & @LF & _
				"green label for some of them, will restore that program default.", 0, $Settings)
			If $ans = 1 Then
				MsgBox(262208, "Settings Information (cont.)", _
					"Clicking the various color labels for price CHANGES, will allow you" & @LF & _
					"set another color of your choice for that option (less, more, etc)." & @LF & @LF & _
					"The INI button can be used to view (open) either the 'Settings.ini'" & @LF & _
					"file or (while CTRL key held down) the user's ebook INI file.", 0, $Settings)
			EndIf
		Case $msg = $Button_fold
			; Open the Program Folder
			Run(@WindowsDir & "\Explorer.exe " & $scriptdir)
		Case $msg = $Button_defs
			; Restore settings to defaults
			$relax = 1
			IniWrite($inifle, "URL Format", "relax", $relax)
			GUICtrlSetState($Checkbox_relax, $relax)
			$excoms = 1
			IniWrite($inifle, "Selected Entry Detail", "changes", $excoms)
			GUICtrlSetState($Checkbox_show, $excoms)
			$record = 1
			IniWrite($inifle, "All Price Changes", "record", $record)
			GUICtrlSetState($Checkbox_record, $record)
			;GUICtrlSetState($Item_history, $GUI_ENABLE)
			$time = 4
			IniWrite($inifle, "Now Date Format", "time", $time)
			GUICtrlSetState($Checkbox_time, $time)
			$data = 1
			IniWrite($inifle, "Image Data", "store", $data)
			GUICtrlSetState($Checkbox_store, $data)
			;GUICtrlSetState($Item_image, $GUI_ENABLE)
			$ans = MsgBox(262179, "JPG Query (Future Setting)", _
				"Do you want to be prompted to Save the" & @LF & _
				"JPG file, when Image data is not present?" & @LF & @LF & _
				"YES = Prompt to Save the JPG file." & @LF & _
				"NO = Don't prompt, just Save the JPG." & @LF & @LF & _
				"CANCEL = Skip the saving of JPG files.", 0, $Settings)
			$jpgsav = $ans
			IniWrite($inifle, "JPG Image", "save", $jpgsav)
			;
			If $csign <> "£" Then
				$ans = MsgBox(262465, "Restore Defaults Query", _
					"Do you also want the pound sign" & @LF & _
					"restored for Alternate Currency?", 0, $Settings)
				If $ans = 1 Then
					$csign = "£"
					IniWrite($inifle, "Currency", "sign", $csign)
					GUICtrlSetData($Input_sign, $csign)
				EndIf
			EndIf
		Case $msg = $Button_codes
			; Fix or Add currency country codes
			$val = IniRead($inifle, "Conversion", "currencies", "")
			$val = InputBox("Country Currency Codes", "Add another country code. Preserves existing codes unless removed here.", $val, "", 400, 120, Default, Default, 0, $Settings)
			$currencies = "AUD|CAD|CHF|CNY|EUR|GBP|INR|JPY|NZD|RUB|SEK|TWD|USD|ZAR"
			$val = StringSplit($val, "|")
			For $v = 1 To $val[0]
				If StringInStr($currencies, $val[$v]) < 1 Then
					$currencies = $currencies & "|" & $val[$v]
				EndIf
			Next
			$currencies = StringSplit($currencies, "|")
			_ArraySort($currencies, 0, 1)
			$currencies = _ArrayToString($currencies, "|", 1)
			IniWrite($inifle, "Conversion", "currencies", $currencies)
			GUICtrlSetData($Combo_from, "", "")
			GUICtrlSetData($Combo_to, "", "")
			GUICtrlSetData($Combo_from, $currencies, $usd)
			GUICtrlSetData($Combo_to, $currencies, $currency)
		Case $msg = $Checkbox_timer
			; Display a timer during Query and show Time Taken in report
			If GUICtrlRead($Checkbox_timer) = $GUI_CHECKED Then
				$timer = 1
			Else
				If $timer = 1 Then
					GUISwitch($PriceQueryGUI)
					GUICtrlSetState($Label_time, $GUI_HIDE)
					GUISwitch($Settings)
				EndIf
				$timer = 4
			EndIf
			IniWrite($inifle, "Display", "timer", $timer)
		Case $msg = $Checkbox_time
			; Include the Time in Date for price changes
			If GUICtrlRead($Checkbox_time) = $GUI_CHECKED Then
				$time = 1
			Else
				$time = 4
			EndIf
			IniWrite($inifle, "Now Date Format", "time", $time)
		Case $msg = $Checkbox_tab
			; Close current browser tab after saving price (Crl + W)
			If GUICtrlRead($Checkbox_tab) = $GUI_CHECKED Then
				$tabclose = 1
				MsgBox(262192, "Close Tab Warning", _
					"USE WITH CAUTION - This could prove to be a tricky option." & @LF & _
					"This option relies on the browser tab title text starting with either -" & @LF & _
					"(1) Amazon.com   (this is most common but not always present)" & @LF & _
					"(2) Ebook title   (this probably won't work if renamed etc)" & @LF & _
					"(3) First 7 characters of ebook title, if starting with 'The '" & @LF & _
					"(4) First 4 characters of ebook title, if not starting with 'The '" & @LF & _
					"As it works by hopefully activating the correct program window and" & @LF & _
					"then sending a universal hotkey combination of 'Ctrl + W' to close it." & @LF & @LF & _
					"NOTE - Options 2 to 4 may fail if the ebook has been renamed." & @LF & _
					"A conflict may occur if another Amazon.com window is open, and" & @LF & _
					"the wrong window/tab may be closed. So take steps to avoid this." & @LF & _
					"A conflict may also occur if the first few title characters of another" & @LF & _
					"unrelated window/tab matches the ebooks, so it may be closed." & @LF & _
					"So all in all, it is best not to have other tabs open at the time." & @LF & @LF & _
					"Where the process fails, you will have to manually close the tab.", 0, $Settings)
			Else
				$tabclose = 4
			EndIf
			IniWrite($inifle, "Browser Tab", "close", $tabclose)
		Case $msg = $Checkbox_store
			; Store the Image data for each ebook
			If GUICtrlRead($Checkbox_store) = $GUI_CHECKED Then
				$data = 1
				;GUICtrlSetState($Item_image, $GUI_ENABLE)
				$ans = MsgBox(262179, "JPG Query", _
					"Do you want to be prompted to Save the" & @LF & _
					"JPG file, when Image data is not present?" & @LF & @LF & _
					"YES = Prompt to Save the JPG file." & @LF & _
					"NO = Don't prompt, just Save the JPG." & @LF & @LF & _
					"CANCEL = Skip the saving of JPG files.", 0, $Settings)
				$jpgsav = $ans
				IniWrite($inifle, "JPG Image", "save", $jpgsav)
			Else
				$data = 4
				;GUICtrlSetState($Item_image, $GUI_DISABLE)
			EndIf
			IniWrite($inifle, "Image Data", "store", $data)
		Case $msg = $Checkbox_stop
			; Enable STOP for a Query
			If GUICtrlRead($Checkbox_stop) = $GUI_CHECKED Then
				$stop = 1
			Else
				$stop = 4
			EndIf
			IniWrite($inifle, "Stop For Query", "enable", $stop)
		Case $msg = $Checkbox_splash
			; Show splash screen if no price changes detected with query
			If GUICtrlRead($Checkbox_splash) = $GUI_CHECKED Then
				$splash = 1
			Else
				$splash = 4
			EndIf
			IniWrite($inifle, "Query Splash Screen", "show", $splash)
		Case $msg = $Checkbox_slick
			; Slicker visuals for low powered PC
			If GUICtrlRead($Checkbox_slick) = $GUI_CHECKED Then
				$slick = 1
				MsgBox(262192, "Slicker Visuals Info", _
					"This option only applies to what you see when the list is being" & @LF & _
					"loaded or sorted, or when changing users, or when removing" & @LF & _
					"or moving (relocating) an ebook. It is a personal preference" & @LF & _
					"choice and is probably not necessary for those with a faster" & @LF & _
					"PC, though they may prefer how it looks and use it anyway.", 0, $Settings)
			Else
				$slick = 4
			EndIf
			IniWrite($inifle, "Visuals For Loading Etc", "slicker", $slick)
		Case $msg = $Checkbox_show
			; Show ALL price changes in the Selected Entry Detail dialog
			If GUICtrlRead($Checkbox_show) = $GUI_CHECKED Then
				$excoms = 1
			Else
				$excoms = 4
			EndIf
			IniWrite($inifle, "Selected Entry Detail", "changes", $excoms)
		Case $msg = $Checkbox_save
			; Record price from other user at purchase tim
			If GUICtrlRead($Checkbox_save) = $GUI_CHECKED Then
				$save = 1
			Else
				$save = 4
			EndIf
			IniWrite($inifle, "Other User Price", "record", $save)
		Case $msg = $Checkbox_resort
			; Automatically resort entries after an ebook entry is removed
			If GUICtrlRead($Checkbox_resort) = $GUI_CHECKED Then
				$resort = 1
			Else
				$resort = 4
			EndIf
			IniWrite($inifle, "After An Entry Removal", "resort", $resort)
		Case $msg = $Checkbox_relax
			; Relax the URL format for ADD
			If GUICtrlRead($Checkbox_relax) = $GUI_CHECKED Then
				$relax = 1
			Else
				$relax = 4
			EndIf
			IniWrite($inifle, "URL Format", "relax", $relax)
		Case $msg = $Checkbox_record
			; Record ALL price changes for each ebook
			If GUICtrlRead($Checkbox_record) = $GUI_CHECKED Then
				$record = 1
				;GUICtrlSetState($Item_history, $GUI_ENABLE)
			Else
				$record = 4
				;GUICtrlSetState($Item_history, $GUI_DISABLE)
			EndIf
			IniWrite($inifle, "All Price Changes", "record", $record)
		Case $msg = $Checkbox_rate
			; Enable exchange rate currency conversion
			If GUICtrlRead($Checkbox_rate) = $GUI_CHECKED Then
				$excon = 1
				GUICtrlSetState($Combo_from, $GUI_ENABLE)
				GUICtrlSetState($Combo_to, $GUI_ENABLE)
			Else
				$excon = 4
				GUICtrlSetState($Combo_from, $GUI_DISABLE)
				GUICtrlSetState($Combo_to, $GUI_DISABLE)
			EndIf
			IniWrite($inifle, "Conversion", "exchange", $excon)
			GUISwitch($PriceQueryGUI)
			If $excon = 1 Then
				GUICtrlSetState($Input_rate, $GUI_ENABLE)
				;GUICtrlSetState($Label_rate, $GUI_ENABLE)
			Else
				GUICtrlSetState($Input_rate, $GUI_DISABLE)
				;GUICtrlSetState($Label_rate, $GUI_DISABLE)
			EndIf
			GUISwitch($Settings)
			$exchange = ""
		Case $msg = $Checkbox_others
			; Do not prompt to Query non-favorites, just do Query instantly
			If GUICtrlRead($Checkbox_others) = $GUI_CHECKED Then
				$instant = 1
			Else
				$instant = 4
			EndIf
			IniWrite($inifle, "Query Non-Favorites", "instant", $instant)
		Case $msg = $Checkbox_minclip
			; Minimize program when clipboard button clicked
			If GUICtrlRead($Checkbox_minclip) = $GUI_CHECKED Then
				$minclip = 1
			Else
				$minclip = 4
			EndIf
			IniWrite($inifle, "Clipboard Button Clicked", "minimize", $minclip)
		Case $msg = $Checkbox_loop
			; Keep presenting the URL InputBox until CANCEL is clicked
			If GUICtrlRead($Checkbox_loop) = $GUI_CHECKED Then
				$loop = 1
			Else
				$loop = 4
			EndIf
			IniWrite($inifle, "ADD URL Input", "loop", $loop)
		Case $msg = $Checkbox_less
			; Show result, but do not store for ebook if change is less than 10 cents (etc)
			If GUICtrlRead($Checkbox_less) = $GUI_CHECKED Then
				$skip = 1
			Else
				$skip = 4
			EndIf
			IniWrite($inifle, "Price Change Less", "skip", $skip)
		Case $msg = $Checkbox_flash
			; Use a flashing 'Please Wait!' instead of splash
			If GUICtrlRead($Checkbox_flash) = $GUI_CHECKED Then
				$flash = 1
				GUICtrlSetState($Input_flash, $GUI_ENABLE)
				GUICtrlSetState($Updown_flash, $GUI_ENABLE)
			Else
				$flash = 4
				GUICtrlSetState($Input_flash, $GUI_DISABLE)
				GUICtrlSetState($Updown_flash, $GUI_DISABLE)
			EndIf
			IniWrite($inifle, "Flashing Please Wait", "use", $flash)
		Case $msg = $Checkbox_extra
			; Activate using an extra delay when a failure occurs
			If GUICtrlRead($Checkbox_extra) = $GUI_CHECKED Then
				$extra = 1
				GUICtrlSetState($Input_extra, $GUI_ENABLE)
				GUICtrlSetState($Updown_extra, $GUI_ENABLE)
			Else
				$extra = 4
				GUICtrlSetState($Input_extra, $GUI_DISABLE)
				GUICtrlSetState($Updown_extra, $GUI_DISABLE)
			EndIf
			IniWrite($inifle, "Extra On Failure", "use", $extra)
		Case $msg = $Checkbox_delay
			; Use a Delay between multiple queries
			If GUICtrlRead($Checkbox_delay) = $GUI_CHECKED Then
				$pause = 1
				GUICtrlSetState($Input_delay, $GUI_ENABLE)
				GUICtrlSetState($Updown_delay, $GUI_ENABLE)
				$ans = MsgBox(262177, "Random Query", _
					"Do you want to use a Random Delay between multiple queries?" & @LF & @LF & _
					"The Random variation will be between zero '0' seconds and the" & @LF & _
					"currently set (displayed) delay of '" & $delay & "' seconds.", 0, $Settings)
				If $ans = 1 Then
					$random = 1
				ElseIf $ans = 2 Then
					$random = 4
				EndIf
				IniWrite($inifle, "Multiple Queries", "random", $random)
			Else
				$pause = 4
				GUICtrlSetState($Input_delay, $GUI_DISABLE)
				GUICtrlSetState($Updown_delay, $GUI_DISABLE)
			EndIf
			IniWrite($inifle, "Multiple Queries", "pause", $pause)
		Case $msg = $Checkbox_blank
			; Remove blank lines from Summary when ADDING an ebook
			If GUICtrlRead($Checkbox_blank) = $GUI_CHECKED Then
				$blanks = 1
			Else
				$blanks = 4
			EndIf
			IniWrite($inifle, "Add Ebook Summary Remove", "blanks", $blanks)
		Case $msg = $Checkbox_backup
			; Create backups for user files
			If GUICtrlRead($Checkbox_backup) = $GUI_CHECKED Then
				$backup = 1
				BackupAllUsersFile()
			Else
				$backup = 4
			EndIf
			IniWrite($inifle, "User Files", "backup", $backup)
		Case $msg = $Checkbox_act
			; Activate the Amazon browser tab prior to text copy process
			If GUICtrlRead($Checkbox_act) = $GUI_CHECKED Then
				$activate = 1
				MsgBox(262192, "Option Advice", _
					"This option could cause errors if unrelated Amazon tabs are open," & @LF & _
					"and also if a similar named tab to the current ebook title is open." & @LF & @LF & _
					"It is only recommended to enable this option if you are having an" & @LF & _
					"issue with ebook web page text being highlighted and copied.", 0, $Settings)
			Else
				$activate = 4
			EndIf
			IniWrite($inifle, "Amazon Browser Tab", "activate", $activate)
		Case $msg = $Combo_val
			; VALUES - HTML Read Replacements
			$val = GUICtrlRead($Combo_val)
			If $val = "" Then
				GUICtrlSetData($Input_val, "")
			Else
				$idx = _GUICtrlComboBox_GetCurSel($Combo_val)
				If $idx > -1 Then
					$rep = StringSplit($valreps, "|", 1)
					;$rep = $rep[$idx]
					$rep = $rep[$idx + 2]
					;;If $rep = "pipe" Then $rep = "|"
					GUICtrlSetData($Input_val, $rep)
				Else
					GUICtrlSetData($Input_val, "")
				EndIf
			EndIf
		Case $msg = $Combo_to
			; Exchange rate conversion - To currency
			$currency = GUICtrlRead($Combo_to)
			If $currency <> "" Then
				IniWrite($inifle, "Conversion", "currency", $currency)
				GUISwitch($PriceQueryGUI)
				GUICtrlSetData($Label_rate, $usd & " -> " & $currency)
				GUICtrlSetData($Input_rate, "")
				GUISwitch($Settings)
			EndIf
		Case $msg = $Combo_tag
			; TAGS - HTML Read Replacements
			$tag = GUICtrlRead($Combo_tag)
			If $tag = "" Then
				GUICtrlSetData($Input_tag, "")
			Else
				$idx = _GUICtrlComboBox_GetCurSel($Combo_tag)
				If $idx > -1 Then
					$rep = StringSplit($tagreps, "|", 1)
					$rep = $rep[$idx + 2]
					If $rep = "pipe" Then $rep = "|"
					GUICtrlSetData($Input_tag, $rep)
				Else
					GUICtrlSetData($Input_tag, "")
				EndIf
			EndIf
		Case $msg = $Combo_mode
			; Query Mode
			$mode = GUICtrlRead($Combo_mode)
			IniWrite($inifle, "Query", "mode", $mode)
			If $mode = "automatic" Then
				GUICtrlSetState($Checkbox_tab, $GUI_DISABLE)
				MsgBox(262192, "Mode Warning", _
					"If the 'automatic' mode does not currently work," & @LF & _
					"it is advised you use 'semi-auto' mode instead.", 0, $Settings)
			ElseIf $mode = "manual" Or $mode = "semi-auto" Or $mode = "prompt" Then
				GUICtrlSetState($Checkbox_tab, $GUI_ENABLE)
				MsgBox(262192, "Mode Warning", _
					"It is advised, when using either the 'semi-auto' or 'manual' mode," & @LF & _
					"that you don't use your PC to do anything else, so as to prevent" & @LF & _
					"likely errors and unwanted consequences, some of which could" & @LF & _
					"conceivably be devastating." & @LF & @LF & _
					"NOTE - 'manual' mode relies on (if enabled) a hotkey combination" & @LF & _
					"of 'Ctrl+W' to close the current browser tab, as does 'semi-auto'" & @LF & _
					"mode, which also uses 'Ctrl+A' and 'Ctrl+C' and the Clipboard.", 0, $Settings)
			EndIf
			If $mode = "semi-auto" Or $mode = "prompt" Then
				GUICtrlSetState($Checkbox_act, $GUI_ENABLE)
				GUICtrlSetState($Input_browser, $GUI_ENABLE)
				GUICtrlSetState($Updown_browser, $GUI_ENABLE)
				GUICtrlSetState($Input_tab, $GUI_ENABLE)
				GUICtrlSetState($Updown_tab, $GUI_ENABLE)
				GUICtrlSetState($Checkbox_extra, $GUI_ENABLE)
				If $tabclose = 4 Then
					$tabclose = 1
					GUICtrlSetState($Checkbox_tab, $tabclose)
					IniWrite($inifle, "Browser Tab", "close", $tabclose)
				EndIf
				If $extra = 1 Then
					GUICtrlSetState($Input_extra, $GUI_ENABLE)
					GUICtrlSetState($Updown_extra, $GUI_ENABLE)
				EndIf
				If $browser = "" Then
					$browsers = "firefox.exe   chrome.exe   iexplore.exe   opera.exe"
					$browser = InputBox("Browser Executable", "Specifying your default browser filename can help speed things" & @LF _
						& "up, by skipping the 'Browser Start Up' delay (where applicable)," & @LF _
						& "but it isn't required. If unsure, definitely click CANCEL." & @LF & @LF _
						& "Leave only one of the following or replace with your own.", $browsers, "", 340, 180, -1, -1, 0, $Settings)
					If @error = 0 And $browser <> $browsers Then
						$browser = StringStripWS($browser, 3)
						IniWrite($inifle, "Web Browser", "executable", $browser)
					Else
						$browser = ""
					EndIf
				EndIf
			Else
				GUICtrlSetState($Checkbox_act, $GUI_DISABLE)
				GUICtrlSetState($Input_browser, $GUI_DISABLE)
				GUICtrlSetState($Updown_browser, $GUI_DISABLE)
				GUICtrlSetState($Input_tab, $GUI_DISABLE)
				GUICtrlSetState($Updown_tab, $GUI_DISABLE)
				GUICtrlSetState($Checkbox_extra, $GUI_DISABLE)
				If $extra = 1 Then
					GUICtrlSetState($Input_extra, $GUI_DISABLE)
					GUICtrlSetState($Updown_extra, $GUI_DISABLE)
				EndIf
			EndIf
		Case $msg = $Combo_from
			; Exchange rate conversion - From currency
			$usd = GUICtrlRead($Combo_from)
			If $usd <> "" Then
				IniWrite($inifle, "Conversion", "from", $usd)
				GUISwitch($PriceQueryGUI)
				GUICtrlSetData($Label_rate, $usd & " -> " & $currency)
				GUICtrlSetData($Input_rate, "")
				GUISwitch($Settings)
			EndIf
		Case $msg = $Combo_compare
			; Compare selected ebook with another user
			$whom = GUICtrlRead($Combo_compare)
			If $whom <> "" Then
				IniWrite($inifle, "Other User Price", "compare", $whom)
			EndIf
		Case $msg = $Label_timeout
			; Timeout for server query in milliseconds
			$timeout = 4000
			GUICtrlSetData($Input_timeout, $timeout)
		Case $msg = $Label_server
			; Server Address to query for connection
			$server = "www.google.com"
			GUICtrlSetData($Input_server, $server)
		Case $msg = $Label_search
			; Amazon Search Address to find an ebook
			$searchadd = "http://www.amazon.com.au"
			GUICtrlSetData($Input_search, $searchadd)
		Case $msg = $Label_read
			; Last Reduction for Add
			$getcnt = GUICtrlRead($Input_add)
			If $getcnt <> 0 Then
				$getcnt = 0
			Else
				$getcnt = GUICtrlRead($Input_reduct)
			EndIf
			GUICtrlSetData($Input_add, $getcnt)
		Case $msg = $Label_swecol
			; Price Change Color - sweet
			$labcol = _ChooseColor(2, $swecol, 2, $Settings)
			If $labcol <> -1 Then
				$swecol = $labcol
				GUICtrlSetBkColor($Label_swecol, $swecol)
				IniWrite($inifle, "Price Change Color", "sweet", $swecol)
			EndIf
		Case $msg = $Label_skicol
			; Price Change Color - skip
			$labcol = _ChooseColor(2, $skicol, 2, $Settings)
			If $labcol <> -1 Then
				$skicol = $labcol
				GUICtrlSetBkColor($Label_skicol, $skicol)
				IniWrite($inifle, "Price Change Color", "skip", $skicol)
			EndIf
		Case $msg = $Label_morcol
			; Price Change Color - more
			$labcol = _ChooseColor(2, $morcol, 2, $Settings)
			If $labcol <> -1 Then
				$morcol = $labcol
				GUICtrlSetBkColor($Label_morcol, $morcol)
				IniWrite($inifle, "Price Change Color", "more", $morcol)
			EndIf
		Case $msg = $Label_mincol
			; Price Change Color - minor
			$labcol = _ChooseColor(2, $mincol, 2, $Settings)
			If $labcol <> -1 Then
				$mincol = $labcol
				GUICtrlSetBkColor($Label_mincol, $mincol)
				IniWrite($inifle, "Price Change Color", "minor", $mincol)
			EndIf
		Case $msg = $Label_lescol
			; Price Change Color - less
			$labcol = _ChooseColor(2, $lescol, 2, $Settings)
			If $labcol <> -1 Then
				$lescol = $labcol
				GUICtrlSetBkColor($Label_lescol, $lescol)
				IniWrite($inifle, "Price Change Color", "less", $lescol)
			EndIf
		Case $msg = $Label_exchadd
			; Google Converter Address
			$googcon = "https://finance.google.com/finance/converter"
			GUICtrlSetData($Input_exchadd, $googcon)
		Case $msg = $Label_errcol
			; Price Change Color - error
			$labcol = _ChooseColor(2, $errcol, 2, $Settings)
			If $labcol <> -1 Then
				$errcol = $labcol
				GUICtrlSetBkColor($Label_errcol, $errcol)
				IniWrite($inifle, "Price Change Color", "error", $errcol)
			EndIf
		Case $msg = $Updown_tab
			; Adjust Delay for browser tab loading
			$tabdel = GUICtrlRead($Input_tab)
			IniWrite($inifle, "Browser Tab Load", "delay", $tabdel)
		Case $msg = $Updown_save
			; Adjust number of save slots for query results
			$slots = GUICtrlRead($Input_save)
			IniWrite($inifle, "Save Query Results - " & $user, "slots", $slots)
		Case $msg = $Updown_flash
			; Adjust rate of 'Please Wait' flashing
			$rate = GUICtrlRead($Input_flash)
			IniWrite($inifle, "Flashing Please Wait", "rate", $rate)
		Case $msg = $Updown_extra
			; Adjust Delay between multiple queries
			$exdel = GUICtrlRead($Input_extra)
			IniWrite($inifle, "Extra On Failure", "delay", $exdel)
		Case $msg = $Updown_delay
			; Adjust Delay between multiple queries
			$delay = GUICtrlRead($Input_delay)
			IniWrite($inifle, "Multiple Queries", "delay", $delay)
		Case $msg = $Updown_browser
			; Adjust Delay for browser start up
			$browdel = GUICtrlRead($Input_browser)
			IniWrite($inifle, "Browser Start Up", "delay", $browdel)
		Case $msg = $Updown_alert
			; Adjust the Alert amount for large price change
			$alert = GUICtrlRead($Input_alert)
			IniWrite($inifle, "Large Price Change", "alert", $alert)
		Case Else
			;;;
		EndSelect
	WEnd
EndFunc ;=> SettingsGUI

Func GetModeFromPromptGUI()
	Local $Group_Mode, $Label_note, $Radio_auto, $Radio_man, $Radio_semi
	Local $Selector

	; Script generated by AutoBuilder 0.9 Prototype
	$Selector = GuiCreate("Mode Selector Prompt", 290, 105, -1, -1, $WS_OVERLAPPED + $WS_CAPTION + $WS_VISIBLE _
					+ $WS_CLIPSIBLINGS, $WS_EX_TOPMOST, $PriceQueryGUI)
	; CONTROLS
	$Group_Mode = GuiCtrlCreateGroup("Select Mode To Use", 10, 10, 270, 52)
	$Radio_auto = GuiCtrlCreateRadio("Automatic", 20, 30, 70, 20)
	GUICtrlSetTip($Radio_auto, "Use automatic mode & continue!")
	$Radio_semi = GuiCtrlCreateRadio("Semi-Automatic", 105, 30, 100, 20)
	GUICtrlSetTip($Radio_semi, "Use semi-auto mode & continue!")
	$Radio_man = GuiCtrlCreateRadio("Manual", 215, 30, 55, 20)
	GUICtrlSetTip($Radio_man, "Use manual mode & continue!")
	$Label_note = GuiCtrlCreateLabel("No settings are changed  -  temporary mode only", 20, 73, 250, 22, $SS_CENTER + $SS_CENTERIMAGE + $SS_SUNKEN)
	GUICtrlSetBkColor($Label_note, 0x999999)
	GUICtrlSetColor($Label_note, 0xFFFFFF)

	GuiSetState()
	While 1
		$msg = GuiGetMsg()
		Select
		Case $msg = $Radio_auto Or $msg = $Radio_semi Or $msg = $Radio_man
			; Select Mode & Exit to Continue
			If $msg = $Radio_auto Then
				$mode = "automatic"
			ElseIf $msg = $Radio_semi Then
				$mode = "semi-auto"
			ElseIf $msg = $Radio_man Then
				$mode = "manual"
			EndIf
			GUIDelete($Selector)
			ExitLoop
		Case Else
			;;;
		EndSelect
	WEnd
EndFunc ;=> GetModeFromPromptGUI

Func ChangePriceGUI()
	Local $Button_update, $Group_current, $Group_high, $Group_last, $Group_low, $Group_start, $Input_current, $Input_high
	Local $Input_last, $Input_low, $Input_start
	Local $PriceChangeGUI
	;
	; Script generated by AutoBuilder 0.9 Prototype
	$PriceChangeGUI = GuiCreate("Prices For - " & $title & " by " & $author, 500, 80, -1, -1, $WS_OVERLAPPED + $WS_CAPTION + _
								$WS_SYSMENU + $WS_VISIBLE + $WS_CLIPSIBLINGS, $WS_EX_TOPMOST, $PriceQueryGUI)
	; CONTROLS
	$Group_start = GuiCtrlCreateGroup("Start", 10, 10, 70, 55)
	$Input_start = GuiCtrlCreateInput("", 20, 30, 50, 20)
	$Group_low = GuiCtrlCreateGroup("Low", 90, 10, 70, 55)
	$Input_low = GuiCtrlCreateInput("", 100, 30, 50, 20)
	$Group_high = GuiCtrlCreateGroup("High", 170, 10, 70, 55)
	$Input_high = GuiCtrlCreateInput("", 180, 30, 50, 20)
	$Group_last = GuiCtrlCreateGroup("Last", 250, 10, 70, 55)
	$Input_last = GuiCtrlCreateInput("", 260, 30, 50, 20)
	$Group_current = GuiCtrlCreateGroup("Current", 330, 10, 70, 55)
	$Input_current = GuiCtrlCreateInput("", 340, 30, 50, 20)
	;
	$Button_update = GuiCtrlCreateButton("UPDATE", 410, 15, 80, 50)
	GUICtrlSetFont($Button_update, 9, 600)
	GUICtrlSetTip($Button_update, "Update one or more stored prices!")
	;
	; SETTINGS
	$start = IniRead($catfle, $ASIN, "start", "")
	GUICtrlSetData($Input_start, $start)
	$low = IniRead($catfle, $ASIN, "low", "")
	GUICtrlSetData($Input_low, $low)
	$high = IniRead($catfle, $ASIN, "high", "")
	GUICtrlSetData($Input_high, $high)
	$last = IniRead($catfle, $ASIN, "last", "")
	$current = IniRead($catfle, $ASIN, "current", "")
	If $last = "" Then
		If $current <> "" Then
			$last = $current
			IniWrite($catfle, $ASIN, "last", $last)
		EndIf
	EndIf
	GUICtrlSetData($Input_last, $last)
	GUICtrlSetData($Input_current, $current)
	

	GuiSetState()
	While 1
		$msg = GuiGetMsg()
		Select
		Case $msg = $GUI_EVENT_CLOSE
			; Quit, Close or Exit window
			GUIDelete($PriceChangeGUI)
			ExitLoop
		Case $msg = $Button_update
			; 
			GUISwitch($PriceQueryGUI)
			If _IsPressed("11") Then
				$curr = StringLeft($start, 1)
				$start = $curr & "0.00"
				GUICtrlSetData($Input_start, $start)
				$low = $curr & "0.00"
				GUICtrlSetData($Input_low, $low)
				$high = $curr & "0.00"
				GUICtrlSetData($Input_high, $high)
				$last = $curr & "0.00"
				GUICtrlSetData($Input_last, $last)
				$current = $curr & "0.00"
				GUICtrlSetData($Input_current, $current)
			Else
				$start = GUICtrlRead($Input_start)
				If $start <> IniRead($catfle, $ASIN, "start", "") Then
					IniWrite($catfle, $ASIN, "start", $start)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $start, 4)
				EndIf
				$low = GUICtrlRead($Input_low)
				If $low <> IniRead($catfle, $ASIN, "low", "") Then
					IniWrite($catfle, $ASIN, "low", $low)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $low, 5)
				EndIf
				$high = GUICtrlRead($Input_high)
				If $high <> IniRead($catfle, $ASIN, "high", "") Then
					IniWrite($catfle, $ASIN, "high", $high)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $high, 6)
				EndIf
				$last = GUICtrlRead($Input_last)
				If $last <> IniRead($catfle, $ASIN, "last", "") Then
					IniWrite($catfle, $ASIN, "last", $last)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $last, 7)
				EndIf
				$current = GUICtrlRead($Input_current)
				If $current <> IniRead($catfle, $ASIN, "current", "") Then
					IniWrite($catfle, $ASIN, "current", $current)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current, 8)
				EndIf
			EndIf
			GUISwitch($PriceChangeGUI)
		Case Else
			;;;
		EndSelect
	WEnd
EndFunc ;=> ChangePriceGUI


Func AddEbookToAnotherUser($how)
	Local $heir = ""
	If $name = "" And $copyto = "" Then
		;$copyto = $user
		If $how = "move" Then
			$copyto = IniRead($inifle, "Last Move Recipient", "name", $user)
		Else
			$copyto = IniRead($inifle, "Last Copy Recipient", "name", $user)
		EndIf
	ElseIf $copyto = "" Then
		;$copyto = $name
		If $how = "move" Then
			$copyto = IniRead($inifle, "Last Move Recipient", "name", $name)
		Else
			$copyto = IniRead($inifle, "Last Copy Recipient", "name", $user)
		EndIf
	EndIf
	$dll = DllOpen("user32.dll")
	While 1
		If $heir = "" Then $heir = $copyto
		;"Enter the user name you wish to work with.
		$name = InputBox("Recipient Username - " & StringUpper($how), $ASIN & " - " & $author & @LF & _
			$title & @LF & @LF & "Enter the user name you wish to " & StringUpper($how) & " the current ebook to." _
			& @LF & @LF & "Hold down CTRL while clicking CANCEL to cycle through available names.", $heir, " M", 400, 190, -1, -1, 0, $PriceQueryGUI)
		If @error = 1 Then
			If _IsPressed("11", $dll) Then
				$check = StringSplit($users, "|", 1)
				If IsArray($check) Then
					$count = $check[0] - 1
					$c = _ArraySearch($check, $heir, 0, 0, 0, 0)
					If $c > -1 Then
						If $c < $count Then
							$c = $c + 1
						Else
							$c = 2
						EndIf
						$heir = $check[$c]
					EndIf
				EndIf
			Else
				ExitLoop
			EndIf
		ElseIf @error = 0 And $name <> "" And $name <> $user Then
			If StringInStr($users, "|" & $name & "|") > 0 Then
				SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
				$copyto = $name
				If $how = "move" Then
					IniWrite($inifle, "Last Move Recipient", "name", $name)
				Else
					IniWrite($inifle, "Last Copy Recipient", "name", $name)
				EndIf
				If $timer = 1 Then GUICtrlSetState($Label_time, $GUI_HIDE)
				$namfle = $scriptdir & "\" & $name & ".ini"
				If Not FileExists($namfle) Then _FileCreate($namfle)
				If FileExists($catfle) Then
					If IniRead($namfle, $ASIN, "title", "") = "" Then
						$entry = IniReadSection($catfle, $ASIN)
						If Not @error Then
							IniWriteSection($namfle, $ASIN, $entry)
							If Not @error Then
								$private = IniRead($catfle, $ASIN, "private", "")
								If $how = "move" Then
									RemoveSelectedEbook()
								ElseIf $how = "copy" Then
									SplashTextOn("", "Copied!", 200, 120, -1, -1, 33)
									Sleep(500)
								EndIf
								If $private <> "" Then
									$ans = MsgBox(262177, "Private Comments Query", _
										"Do you also want the Private Comments copied to this user?" & @LF & @LF & _
										"NOTE - If this is a move rather than copy, then the Private" & @LF & _
										"Comments will be lost, unless they are copied to this user.", 0, $PriceQueryGUI)
									If $ans = 2 Then
										If $how = "move" Then IniDelete($namfle, $ASIN, "private")
									EndIf
								EndIf
							EndIf
						EndIf
					Else
						If $how = "move" Then
							$ans = MsgBox(262193, "Move Selected Entry Error", _
								"The selected entry already exists on the recipient's list." & @LF & @LF & _
								"Do you wish to just Remove it from current user's list?", 0)
							If $ans = 1 Then
								RemoveSelectedEbook()
							EndIf
						ElseIf $how = "copy" Then
							SplashTextOn("", "Already Exists!", 200, 120, -1, -1, 33)
							Sleep(1000)
						EndIf
					EndIf
				EndIf
				SplashOff()
				ExitLoop
			Else
				MsgBox(262192, "User Error", "That name does not yet exist!", 0, $PriceQueryGUI)
			EndIf
		ElseIf $name = $user Then
			MsgBox(262192, "User Error", "You cannot Copy or Move to current user!", 0, $PriceQueryGUI)
		EndIf
	WEnd
	DllClose($dll)
EndFunc ;=> AddEbookToAnotherUser

Func AddNewEbookToList($val)
	; Get Summary
	If $val = 1 Then GetBookDescription("")
	If $preord = 1 Then
		; This is not yet discovered in the New Method.
		$BKID = "Pre-Order - " & $ASIN
		$preorder = 1
		IniWrite($catfle, $ASIN, "preorder", $preorder)
	Else
		$BKID = $ASIN
	EndIf
	If $val = 1 Then
		;IniWrite($catfle, $ASIN, "comment", "Publication Date: " & $pubdate & "|")
		IniWrite($comfle, $ASIN, "comment", "Publication Date: " & $pubdate & "|")
	EndIf
	;
	;
	_FileWriteLog($logfile, "ADDED = " & $BKID, -1)
	_FileWriteLog($logfile, "Title = " & $title, -1)
	_FileWriteLog($logfile, "Author = " & $author, -1)
	_FileWriteLog($logfile, "Price = " & $start, -1)
	FileWriteLine($logfile, "")
	GUICtrlCreateListViewItem($num & "|" & $title & "|" & $BKID & "|" & $author & "|" & $start & "|" & $low & "|" & $high & "|" & $last & "|" & $current, $Listview_ebooks)
	If IsInt($lne / 2) = 1 Then GUICtrlSetBkColor(-1, 0xF0D0F0)
	;
	$ind = $num - 1
	GetSetCurrentStateAfterChanges()
	GUICtrlSetData($Group_list, "List Of Kindle Ebooks  (" & $nums & ")")
	;
	$URL = ""
	$title = ""
	$author = ""
	$preord = ""
EndFunc ;=> AddNewEbookToList

Func AddPrivateComment()
	GetSelectedIndex("detail")
	If $ind <> -1 Then
		$private = IniRead($catfle, $ASIN, "private", "")
		$report = InputBox("ADD A Private Comment", "ADD a comment to the selected entry - " & $ASIN _
			& "   (Every pipe '|' indicates a carriage return)." _
			& @LF & @LF & $author & " - " & $title, $private, "", 500, 160, -1, -1, 0, $PriceQueryGUI)
		If @error = 0 Then
			$private = $report
			IniWrite($catfle, $ASIN, "private", $private)
			DetermineComment()
		EndIf
	Else
		MsgBox(262192, "Comment Error", "No list entry is selected!", 0, $PriceQueryGUI)
	EndIf
EndFunc ;=> AddPrivateComment

Func AddSelectedToQueryList($from)
	If $from = "image" Then GUISwitch($PriceQueryGUI)
	If $list = "" Then
		$list = $ASIN & "|"
		If $movlist = 1 Then
			GUICtrlSetData($Button_query, "MOVE" & @LF & "LIST")
		ElseIf $coplist = 1 Then
			GUICtrlSetData($Button_query, "COPY" & @LF & "LIST")
		ElseIf $remlist = 1 Then
			GUICtrlSetData($Button_query, "REMOVE" & @LF & "LIST")
		ElseIf $totlist = 1 Then
			GUICtrlSetData($Button_query, "QUERY" & @LF & "TOTAL")
		Else
			GUICtrlSetData($Button_query, "QUERY" & @LF & "LIST")
		EndIf
		GUICtrlSetState($Item_movlist, $GUI_ENABLE)
		GUICtrlSetState($Item_coplist, $GUI_ENABLE)
		GUICtrlSetState($Item_remlist, $GUI_ENABLE)
		GUICtrlSetState($Item_totlist, $GUI_ENABLE)
		;
		GUICtrlSetState($Item_rem, $GUI_ENABLE)
		GUICtrlSetState($Item_view, $GUI_ENABLE)
		GUICtrlSetState($Item_wipe, $GUI_ENABLE)
		If $first <> "" Then
			GUICtrlSetState($Item_start, $GUI_UNCHECKED)
			GUICtrlSetState($Item_start, $GUI_DISABLE)
		EndIf
		If $end <> "" Then
			GUICtrlSetState($Item_end, $GUI_UNCHECKED)
			GUICtrlSetState($Item_end, $GUI_DISABLE)
		EndIf
		If $first <> "" Or $end <> "" Then
			GUICtrlSetState($Item_show, $GUI_DISABLE)
			ResetQueryAssignments()
		EndIf
		If $quall = 1 Then
			$quall = 4
			GUICtrlSetState($Checkbox_qufav, $GUI_UNCHECKED)
			GUICtrlSetState($Checkbox_qufav, $GUI_DISABLE)
			GUICtrlSetState($Checkbox_nofav, $GUI_DISABLE)
			$favorites = ""
			$secondfavs = ""
			If $others = 1 Then
				$others = 4
				GUICtrlSetState($Checkbox_nofav, $GUI_UNCHECKED)
			EndIf
		EndIf
	ElseIf StringInStr($list, $ASIN) < 1 Then
		$list = $list & $ASIN & "|"
	EndIf
	$lne = $lowid + $ind + 1
	; Gold (skip)
	GUICtrlSetBkColor($lne, 0xB0B000)
	If $from = "image" Then GUISwitch($ImageGUI)
EndFunc ;=> AddSelectedToQueryList

Func AddSharedComment()
	GetSelectedIndex("detail")
	If $ind <> -1 Then
		;$comment = IniRead($catfle, $ASIN, "comment", "")
		$comment = IniRead($comfle, $ASIN, "comment", "")
		$report = InputBox("ADD A Shared Comment", "ADD a comment to the selected entry - " & $ASIN _
			& "   (Every pipe '|' indicates a carriage return)." _
			& @LF & @LF & $author & " - " & $title, $comment, "", 500, 160, -1, -1, 0, $PriceQueryGUI)
		If @error = 0 Then
			$comment = $report
			;IniWrite($catfle, $ASIN, "comment", $comment)
			IniWrite($comfle, $ASIN, "comment", $comment)
			DetermineComment()
		EndIf
	Else
		MsgBox(262192, "Comment Error", "No list entry is selected!", 0, $PriceQueryGUI)
	EndIf
EndFunc ;=> AddSharedComment

Func AddToListForExcel()
	Local $array
	GetSelectedIndex("detail")
	If $ind <> -1 Then
		$entry = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 1)
		If StringInStr($entry, " (") > 0 Then
			$report = StringSplit($entry, " (", 1)
			If $report[0] = 2 Then
				$series = "(" & $report[2]
			Else
				$series = StringMid($entry, StringLen($report[1]) + 1)
			EndIf
			$series = StringReplace($series, ", Book ", " ")
			$series = StringReplace($series, " - Book ", " ")
			$series = StringReplace($series, " Book ", " ")
			$series = StringReplace($series, "(The ", "(")
			$series = StringReplace($series, "(A ", "(")
			$series = StringReplace($series, "(An ", "(")
			$series = StringReplace($series, " Series ", " ")
			$series = StringReplace($series, " Series)", ")")
			$report = StringStripWS($report[1], 7)
			If StringRight($report, 1) = ":" Then $report = StringTrimRight($report, 1)
			$report = $report & "|" & StringStripWS($series, 7)
		Else
			$report = $entry
			$report = StringStripWS($report, 7)
			$series = ""
			If StringRight($report, 1) = ":" Then $report = StringTrimRight($report, 1)
		EndIf
		If StringInStr($report, ":") > 0 Or StringInStr($series, "(") > 1 Then
			$report = InputBox("Manual Text Editor", "Modify the text to suit. Use a leading pipe to define any series (i.e. Title|Series)." & @LF _
				& @LF & "NOTE - Holding down CTRL when clicking OK, will remove any ':' and trailing text.", $report, "", 430, 150, -1, -1, 0, $PriceQueryGUI)
			If _IsPressed("11") Then
				$report = StringSplit($report, ":", 1)
				$report = StringStripWS($report[1], 2)
			EndIf
		EndIf
		$report = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 3) & "|" & $report
		If $report <> "" Then
			SplashTextOn("", "Adding!", 200, 120, -1, -1, 33)
			$txtpth = IniRead($inifle, "Last Saved Excel List File - " & $user, "path", "")
			If $txtpth = "" Then
				$txtpth = @MyDocumentsDir & "\List for Excel (" & $user & ").txt"
			EndIf
			If $saved = 1 Then
				_FileWriteToLine($txtpth, 1, $report, 0)
				Sleep(500)
				_FileReadToArray($txtpth, $array)
				$array = _ArrayUnique($array, 1, 1, 0, @CRLF)
				_FileWriteFromArray($txtpth, $array, 1)
				SplashOff()
			Else
				If FileExists($txtpth) Then
					$ans = MsgBox(262177, "Save Query", _
						"The previous (last) save path & file exist." & @LF & @LF & _
						"OK = Add selected entry to previous file." & @LF & _
						"CANCEL = Browse to set a new path." & @LF & @LF & _
						"NOTE - If OK is selected, then browsing" & @LF & _
						"for the Save path can be enabled again," & @LF & _
						"by holding down CTRL while you select" & @LF & _
						"the right-click menu (Save) View option.", 0, $PriceQueryGUI)
					If $ans = 1 Then
						$saved = 1
						_FileWriteToLine($txtpth, 1, $report, 0)
						Sleep(500)
						_FileReadToArray($txtpth, $array)
						$array = _ArrayUnique($array, 1, 1, 0, @CRLF)
						_FileWriteFromArray($txtpth, $array, 1)
					EndIf
				Else
					$ans = 2
				EndIf
				SplashOff()
				If $ans = 2 Then
					$pth = FileSaveDialog("Save Entry To File For Excel List.", "", "Text files (*.log;*.nfo;*.rtf;*.txt;*.wri)", 18, $txtpth, $PriceQueryGUI)
					If Not @error Then
						$txtpth = $pth
						IniWrite($inifle, "Last Saved Excel List File - " & $user, "path", $txtpth)
						$saved = 1
						_FileCreate($txtpth)
						_FileWriteToLine($txtpth, 1, $report, 1)
						MsgBox(262208, "Auto Save Advice", "Browsing for the Save path can be enabled again," _
							& @LF & "by holding down CTRL when using the View option.", 0, $PriceQueryGUI)
					EndIf
				EndIf
			EndIf
		EndIf
	Else
		MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
	EndIf
EndFunc ;=> AddToListForExcel

Func AddToOrRemoveFromQueryList($from)
	If $list = "" Or StringInStr($list, $ASIN) < 1 Then
		AddSelectedToQueryList($from)
	Else
		RemoveSelectedFromQueryList($from)
	EndIf
EndFunc ;=> AddToOrRemoveFromQueryList

Func BackupAllUsersFile()
	$check = StringSplit($users, "|", 1)
	For $c = 1 To $check[0]
		$name = $check[$c]
		If $name <> "" Then BackupUserFile()
	Next
EndFunc ;=> BackupAllUsersFile

Func BackupUserFile()
	Local $bakfle, $bdate, $endfle, $nmb, $ndate
	$namfle = $scriptdir & "\" & $name & ".ini"
	If FileExists($namfle) Then
		If Not FileExists($backups) Then
			; Create Backup folder and backup User file for the first time.
			DirCreate($backups)
			FileCopy($namfle, $backups & "\" & $name & "_1.bak")
		Else
			; Backup the User file.
			$ndate = FileGetTime($namfle, 0, 1)
			$endfle = $backups & "\" & $name & "_5.bak"
			If FileExists($endfle) Then
				; Shuffle backups along and replace oldest, plus add current User file as newest backup.
				$bdate = FileGetTime($endfle, 0, 1)
				If $bdate <> $ndate Then
					$bakfle = $backups & "\" & $name
					For $nmb = 1 To 4
						FileMove($bakfle & "_" & ($nmb + 1) & ".bak", $bakfle & "_" & $nmb & ".bak", 1)
					Next
					FileCopy($namfle, $endfle, 1)
				EndIf
			Else
				; Add current User file as newest backup in an empty slot.
				For $nmb = 1 To 5
					$bakfle = $backups & "\" & $name & "_" & $nmb & ".bak"
					If Not FileExists($bakfle) Then
						If $nmb = 1 Then
							FileCopy($namfle, $bakfle)
						Else
							$bdate = FileGetTime($endfle, 0, 1)
							If $bdate <> $ndate Then FileCopy($namfle, $bakfle)
						EndIf
						ExitLoop
					EndIf
					$endfle = $bakfle
				Next
			EndIf
		EndIf
	EndIf
EndFunc ;=> BackupUserFile

Func BoughtThisEbook()
	GetSelectedIndex("")
	If $ind <> -1 Then
		$paid = IniRead($catfle, $ASIN, "bought", "")
		If $paid = "" Then
			$current = IniRead($catfle, $ASIN, "current", "")
			$paid = "Paid " & $current & " on " & _Now()
			;$exchange = 1.4203
			If $excon = 1 And $exchange <> "" And $exempt = 4 Then
				If StringIsFloat($exchange) = 1 Then
					$curval = StringTrimLeft($current, 1)
					$curval = Round($curval * $exchange, 2)
					If StringIsDigit($curval) Then $curval = $curval & ".00"
					While StringLeft(StringRight($curval, 3), 1) <> "."
						$curval = $curval & "0"
					WEnd
					$curval = StringLeft($current, 1) & $curval
					$paid = $paid & " (" & $curval & " " & $currency & " - Exchange Rate = " & $exchange & ")"
				EndIf
			EndIf
			If $save = 1 And $whom <> "" Then
				$name = $whom
				If $name <> $user Then
					$namfle = $scriptdir & "\" & $name & ".ini"
					If FileExists($namfle) Then
						$exist = IniRead($namfle, $ASIN, "title", "")
						If $exist <> "" Then
							$curval = IniRead($namfle, $ASIN, "current", "")
							If $curval <> "" Then
								$paid = $paid & " (" & $whom & " = " & $curval & ")"
							EndIf
						EndIf
					EndIf
				EndIf
			EndIf
		EndIf
		If $title = "" Then
			$paid = ""
			MsgBox(262192, "Bought Error", "No title reported, please re-select entry!", 0, $PriceQueryGUI)
		Else
			$report = InputBox("Bought This Ebook", "If needed, edit the values for the following ebook." & @LF & @LF & $title, $paid, "", 480, 160, -1, -1, 0, $PriceQueryGUI)
			If @error = 0 Then
				$paid = $report
				IniWrite($catfle, $ASIN, "bought", $paid)
				If $paid = "" Then
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $ASIN, 2)
				Else
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, "Bought - " & $ASIN, 2)
					$favorite = IniRead($catfle, $ASIN, "favorite", "")
					If $favorite = 1 Then
						$favorite = ""
						IniWrite($catfle, $ASIN, "favorite", $favorite)
					EndIf
					$secondary = IniRead($catfle, $ASIN, "secondary", "")
					If $secondary = 1 Then
						$secondary = ""
						IniWrite($catfle, $ASIN, "secondary", $secondary)
					EndIf
					$preorder = IniRead($catfle, $ASIN, "preorder", "")
					If $preorder = 1 Then
						$preorder = ""
						IniWrite($catfle, $ASIN, "preorder", $preorder)
					EndIf
				EndIf
			Else
				$paid = ""
			EndIf
		EndIf
	Else
		MsgBox(262192, "Bought Error", "No list entry is selected!", 0, $PriceQueryGUI)
	EndIf
EndFunc ;=> BoughtThisEbook

Func CheckForConnection()
	$rndtrip = Ping($server, $timeout)
	If $rndtrip > 0 Then
		$connection = 1
	Else
		If $pcsets = "Netbook" Then
			$test = 1
			Return
		EndIf
		$pingerr = @error
		IniWrite($inifle, "Ping", "error", $pingerr)
		$connection = ""
		$IP = _GetIP()
		If (@error = 1 Or $IP = -1) And $test = 4 Then
			MsgBox(262192, "Query Error", "No connection detected!", 0, $PriceQueryGUI)
		Else
			If $pingerr = 1 Then
				$pingerr = "Host is offline."
			ElseIf $pingerr = 2 Then
				$pingerr = "Host is unreachable."
			ElseIf $pingerr = 3 Then
				$pingerr = "Bad destination."
			ElseIf $pingerr = 4 Then
				$pingerr = "Other errors"
			EndIf
			Local $pingmsg = "Server Address could not be found." & @LF & @LF & _
				"Error = " & $pingerr & @LF & @LF & _
				"Timeout may need to be increased." & @LF & @LF & _
				"NOTE = If this continues to occur over" & @LF & _
				"a long length of time, then advise you" & @LF & _
				"manually check (browse) and perhaps" & @LF & _
				"change the server address in program" & @LF & _
				"settings. Or it may be a VPN issue."
			If $pingerr = "Other errors" Then
				$ans = MsgBox(262449, "Server Error", _
					$pingmsg & @LF & @LF & _
					"OK = Still proceed with connecting." & @LF & _
					"CANCEL = Abort.", 0, $PriceQueryGUI)
				If $ans = 1 Then $connection = 1
			Else
				MsgBox(262192, "Server Error", $pingmsg, 0, $PriceQueryGUI)
			EndIf
		EndIf
	EndIf
	IniWrite($inifle, "Ping", "roundtrip", $rndtrip & " milliseconds")
EndFunc ;=> CheckForConnection

Func CheckForNonFavorite()
	$favorite = IniRead($catfle, $ASIN, "favorite", "")
	$secondary = IniRead($catfle, $ASIN, "secondary", "")
	If $favorite = 1 Then
		$check = ""
	ElseIf $secondary = 1 Then
		$check = ""
	ElseIf $include = 1 Then
		$preorder = IniRead($catfle, $ASIN, "preorder", "")
		If $preorder = 1 Then
			$check = ""
		Else
			$check = 1
		EndIf
	Else
		$check = 1
	EndIf
EndFunc ;=> CheckForNonFavorite

Func CheckFromOtherUser($val)
	If $tit = "" Then
		If $val = "6" Or $val = "7" Then
			MsgBox(262192, "Read Error " & $val, "The 'Author' could not be determined, default used!", 0, $PriceQueryGUI)
		Else
			MsgBox(262192, "Read Error " & $val, "The 'Title' could not be determined, defaults used!", 0, $PriceQueryGUI)
			;IniDelete($catfle, $ASIN)
			; Perhaps provide an input instead of deletion. Or just use a default value, which can be renamed later.
			$title = "Title not found"
			IniWrite($catfle, $ASIN, "title", $title)
		EndIf
		$author = "Author unknown"
		IniWrite($catfle, $ASIN, "author", $author)
	Else
		MsgBox(262192, "Read Error " & $val, "The 'Title' & 'Author' could not be determined," & @LF & _
			"so getting them from the other user!", 0, $PriceQueryGUI)
		$title = $tit
		$author = $aut
	EndIf
	AddNewEbookToList(1)
EndFunc ;=> CheckFromOtherUser

Func CheckIfLowIsZero()
	; Fix the Low value, where it started at $0.00
	If StringTrimLeft($low, 1) = "0.00" Then
		If IniRead($catfle, $ASIN, "changed", "") = "" Then
			; Update only - No previous changes have occurred since the ebook was added.
			$low = $current
			IniWrite($catfle, $ASIN, "low", $low)
		Else
			; Fix & Update - A previous change has occurred since the ebook was added, so
			; need to determine what was the lowest price recorded.
			Local $resval, $valued
			$low = ""
			If $prices = 1 Then
				$prcfle = $pricefld & "\" & $ASIN & ".txt"
				If FileExists($prcfle) Then
					$changes = FileRead($prcfle)
				Else
					$changes = IniRead($catfle, $ASIN, "changes", "")
				EndIf
			Else
				$changes = IniRead($catfle, $ASIN, "changes", "")
			EndIf
			$valued = StringSplit($changes, "|")
			For $v = 1 To $valued[0]
				$result = $valued[$v]
				$result = StringSplit($result, " ")
				$result = $result[1]
				If $low = "" Then
					$low = $result
				Else
					$lowval = GetValueForPrice($low)
					$resval = GetValueForPrice($result)
					If $resval < $lowval Then
						$low = $result
					EndIf
				EndIf
			Next
			IniWrite($catfle, $ASIN, "low", $low)
		EndIf
		_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $low, 5)
	EndIf
EndFunc ;=> CheckIfLowIsZero

Func CheckIfOnlyDigits($digit)
	$digit = StringReplace($digit, "$", "")
	$digit = StringReplace($digit, $csign, "")
	$digit = StringReplace($digit, ".", "")
	Return StringIsDigit($digit)
EndFunc ;=> CheckIfOnlyDigits

Func CheckIfSweet()
	$sweet = IniRead($catfle, $ASIN, "sweet", "")
	If $sweet <> "" Then
		$sweetval = GetValueForPrice($sweet)
		If $currval > $sweetval Then
			$sweetval = ""
		EndIf
	Else
		$sweetval = ""
	EndIf
EndFunc ;=> CheckIfSweet

Func CheckOnSortRequirement($del)
	If $slick = 1 Then
		GUISetState($PriceQueryGUI, @SW_DISABLE + @SW_LOCK)
		_GUICtrlListView_BeginUpdate($Listview_ebooks)
	EndIf
	If $del = 1 Then _GUICtrlListView_DeleteAllItems($Listview_ebooks)
	$sorted = IniRead($inifle, $user, "sorted", "")
	If $sorted = "" Then
		$sorted = 4
		IniWrite($inifle, $user, "sorted", $sorted)
	ElseIf $sorted = 1 Then
		$fixed = IniRead($inifle, "Spaces In Prices", $user & "_fixed", "")
		$pipes = IniRead($inifle, "Pipes In Title & Author", $user & "_fixed", "")
		If $fixed = "" Or $pipes = "" Then
			$sorted = 4
			IniWrite($inifle, $user, "sorted", $sorted)
		EndIf
	EndIf
	GUICtrlSetState($Checkbox_sort, $sorted)
	If $sorted = 1 Then
		$colnum = IniRead($inifle, $user, "sortcol", 0)
		SortByColumnNumber()
		GUICtrlSetData($Group_list, "List Of Kindle Ebooks  (" & $nums & ")")
	Else
		FillTheListWithEbooks()
	EndIf
	If $slick = 1 Then
		_GUICtrlListView_EndUpdate($Listview_ebooks)
		GUISetState($PriceQueryGUI, @SW_ENABLE + @SW_UNLOCK)
	EndIf
EndFunc ;=> CheckOnSortRequirement

Func CreateContextMenuForListView()
	; IMPORTANT - When adding or removing items, don't forget to update DeleteContextMenuForListView()
	;
	; CONTEXT_MENU
	$Menu_list = GUICtrlCreateContextMenu($Listview_ebooks)
	IniWrite($inifle, "Last Control ID", "first", $Menu_list)
	$Item_search = GUICtrlCreateMenuItem("SEARCH Store", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	$Item_web = GUICtrlCreateMenuItem("Go to web page", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	$Item_url = GUICtrlCreateMenuItem("Copy URL to clipboard", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	; Sub Menu - Selected Entry Detail
	$Submenu_detail = GUICtrlCreateMenu("Selected Entry Detail", $Menu_list)
	$Item_image = GUICtrlCreateMenuItem("Image + Text" & @TAB & "(Ctrl+I)", $Submenu_detail)
	GUICtrlCreateMenuItem("", $Submenu_detail)
	$Item_entry = GUICtrlCreateMenuItem("Text only" & @TAB & "(Ctrl+T)", $Submenu_detail)
	GUICtrlCreateMenuItem("", $Menu_list)
	; Sub Menu - Selected Entry
	$Submenu_entry = GUICtrlCreateMenu("Selected Entry", $Menu_list)
	$Item_paid = GUICtrlCreateMenuItem("Set as Bought" & @TAB & "(Ctrl+B)", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_favorite = GUICtrlCreateMenuItem("Set as a Favorite" & @TAB & "(Ctrl+F)", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_preorder = GUICtrlCreateMenuItem("Set as a Pre-Order", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_stored = GUICtrlCreateMenuItem("Remove a stored low price", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_find = GUICtrlCreateMenuItem("Check to Remove", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_compare = GUICtrlCreateMenuItem("Compare to another user", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_copy = GUICtrlCreateMenuItem("Copy to another user" & @TAB & "(Alt+C)", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_move = GUICtrlCreateMenuItem("Move to another user" & @TAB & "(Alt+M)", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_check = GUICtrlCreateMenuItem("Check line values", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_clear = GUICtrlCreateMenuItem("Clear query indicator", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_sweet = GUICtrlCreateMenuItem("Set a SWEET price" & @TAB & "(Ctrl+S)", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_warn = GUICtrlCreateMenuItem("Set a WARNING" & @TAB & "(Ctrl+W)", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_skip = GUICtrlCreateMenuItem("Skip in any Query ALL", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_edit = GUICtrlCreateMenuItem("Edit the Title or Author name" & @TAB & "(Ctrl+E)", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_title = GUICtrlCreateMenuItem("Restore the Title name", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Submenu_entry)
	$Item_author = GUICtrlCreateMenuItem("Restore the Author name", $Submenu_entry)
	GUICtrlCreateMenuItem("", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	; Sub Menu - Price
	$Submenu_price = GUICtrlCreateMenu("Price", $Menu_list)
	$Item_last = GUICtrlCreateMenuItem("Last", $Submenu_price)
	GUICtrlCreateMenuItem("", $Submenu_price)
	$Item_history = GUICtrlCreateMenuItem("History", $Submenu_price)
	GUICtrlCreateMenuItem("", $Submenu_price)
	$Item_price = GUICtrlCreateMenuItem("View results", $Submenu_price)
	GUICtrlCreateMenuItem("", $Submenu_price)
	$Item_change = GUICtrlCreateMenuItem("Change", $Submenu_price)
	GUICtrlCreateMenuItem("", $Menu_list)
	$Item_diff = GUICtrlCreateMenuItem("Current Difference", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	; Sub Menu - Query
	$Submenu_queries = GUICtrlCreateMenu("Query", $Menu_list)
	$Item_query = GUICtrlCreateMenuItem("Results", $Submenu_queries)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	$Item_time = GUICtrlCreateMenuItem("Last Time Taken", $Submenu_queries)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	$Item_restore = GUICtrlCreateMenuItem("Restore previous prices", $Submenu_queries)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	$Item_report = GUICtrlCreateMenuItem("View the 'Report.txt' file", $Submenu_queries)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	$Item_failed = GUICtrlCreateMenuItem("View the 'Failed.txt' file", $Submenu_queries)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	$Item_preord = GUICtrlCreateMenuItem("Include Pre-Orders with Favorites", $Submenu_queries, -1, 0)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	$Item_others = GUICtrlCreateMenuItem("Non Favorites", $Submenu_queries, -1, 0)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	$Item_start = GUICtrlCreateMenuItem("Start at selected", $Submenu_queries, -1, 0)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	$Item_end = GUICtrlCreateMenuItem("End a at selected", $Submenu_queries, -1, 0)
	GUICtrlCreateMenuItem("", $Submenu_queries)
	$Item_show = GUICtrlCreateMenuItem("Show MOBI-ASIN for Start && End", $Submenu_queries)
	GUICtrlCreateMenuItem("", $Menu_list)
	; Sub Menu - Query List
	$Submenu_list = GUICtrlCreateMenu("Query List", $Menu_list)
	$Item_add = GUICtrlCreateMenuItem("Add selected", $Submenu_list)
	GUICtrlCreateMenuItem("", $Submenu_list)
	$Item_rem = GUICtrlCreateMenuItem("Remove selected", $Submenu_list)
	GUICtrlCreateMenuItem("", $Submenu_list)
	$Item_view = GUICtrlCreateMenuItem("View && Tips", $Submenu_list)
	GUICtrlCreateMenuItem("", $Submenu_list)
	$Item_wipe = GUICtrlCreateMenuItem("Wipe", $Submenu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	; Sub Menu - Add a comment
	$Submenu_notes = GUICtrlCreateMenu("Add a comment", $Menu_list)
	$Item_notes = GUICtrlCreateMenuItem("Shared" & @TAB & "(Alt+S)", $Submenu_notes)
	GUICtrlCreateMenuItem("", $Submenu_notes)
	$Item_private = GUICtrlCreateMenuItem("Private" & @TAB & "(Alt+P)", $Submenu_notes)
	GUICtrlCreateMenuItem("", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	$Item_relocate = GUICtrlCreateMenuItem("Relocate all Bought ebooks", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	; Sub Menu - Save
	$Submenu_save = GUICtrlCreateMenu("Save", $Menu_list)
	$Item_save = GUICtrlCreateMenuItem("Ebook List to file", $Submenu_save)
	GUICtrlCreateMenuItem("", $Submenu_save)
	$Item_urls = GUICtrlCreateMenuItem("All URLs to file", $Submenu_save)
	GUICtrlCreateMenuItem("", $Submenu_save)
	$Item_excel = GUICtrlCreateMenuItem("Add to List for Excel" & @TAB & "(Alt+X)", $Submenu_save)
	$Item_list = GUICtrlCreateMenuItem("View the List file", $Submenu_save)
	GUICtrlCreateMenuItem("", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	; Sub Menu - WIKIPEDIA
	$Submenu_wiki = GUICtrlCreateMenu("WIKIPEDIA", $Menu_list)
	$Item_goauthor = GUICtrlCreateMenuItem("Go to Author", $Submenu_wiki)
	GUICtrlCreateMenuItem("", $Submenu_wiki)
	$Item_gotitle = GUICtrlCreateMenuItem("Go to Ebook Title", $Submenu_wiki)
	GUICtrlCreateMenuItem("", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	; Sub Menu - Get Missing
	$Submenu_missing = GUICtrlCreateMenu("Get Missing", $Menu_list)
	$Item_publish = GUICtrlCreateMenuItem("Publisher", $Submenu_missing)
	GUICtrlCreateMenuItem("", $Submenu_missing)
	$Item_summary = GUICtrlCreateMenuItem("Summary", $Submenu_missing)
	GUICtrlCreateMenuItem("", $Submenu_missing)
	$Item_data = GUICtrlCreateMenuItem("Image data", $Submenu_missing)
	GUICtrlCreateMenuItem("", $Submenu_missing)
	$Item_jpeg = GUICtrlCreateMenuItem("Image via URL", $Submenu_missing)
	GUICtrlCreateMenuItem("", $Menu_list)
	GUICtrlCreateMenuItem("", $Menu_list)
	; Sub Menu - USERS
	$Submenu_users = GUICtrlCreateMenu("USERS", $Menu_list)
	$Item_user = GUICtrlCreateMenuItem("ADD another or REMOVE one", $Submenu_users)
	GUICtrlCreateMenuItem("", $Submenu_users)
	$Item_exempt = GUICtrlCreateMenuItem("EXEMPT current from Exchange Rate", $Submenu_users)
	GUICtrlCreateMenuItem("", $Submenu_users)
	$Item_compall = GUICtrlCreateMenuItem("SET current as Compare participant", $Submenu_users)
	GUICtrlCreateMenuItem("", $Submenu_users)
	$Item_receiver = GUICtrlCreateMenuItem("SET current as Copy or Move recipient", $Submenu_users)
	GUICtrlCreateMenuItem("", $Submenu_users)
	$Item_rename = GUICtrlCreateMenuItem("RENAME currently selected", $Submenu_users)
	;
	GetLastControlID("add")
	;$lowid = $Item_rename
	;$contxtmenu = 1
	;
	; SETTINGS
	If $record <> 1 Then GUICtrlSetState($Item_history, $GUI_DISABLE)
	If StringRight($user, 4) = " (b)" Then GUICtrlSetState($Item_relocate, $GUI_DISABLE)
	If $data = 4 Then GUICtrlSetState($Item_image, $GUI_DISABLE)
	If $quall = 4 Then
		GUICtrlSetState($Item_start, $GUI_DISABLE)
		GUICtrlSetState($Item_end, $GUI_DISABLE)
		GUICtrlSetState($Item_show, $GUI_DISABLE)
	Else
		If $first = "" And $end = "" Then
			GUICtrlSetState($Item_show, $GUI_DISABLE)
		Else
			If $first <> "" Then GUICtrlSetState($Item_start, $GUI_CHECKED)
			If $end <> "" Then GUICtrlSetState($Item_end, $GUI_CHECKED)
		EndIf
	EndIf
	$paid = IniRead($catfle, $ASIN, "bought", "")
	If $paid <> "" Then
		$preorder = ""
		GUICtrlSetState($Item_preorder, $GUI_DISABLE)
		$favorite = ""
		$secondary = ""
		GUICtrlSetState($Item_favorite, $GUI_DISABLE)
	EndIf
	If $others = 1 Then GUICtrlSetState($Item_others, $GUI_CHECKED)
	If $include = 1 Then GUICtrlSetState($Item_preord, $GUI_CHECKED)
	If $list = "" Then
		GUICtrlSetState($Item_rem, $GUI_DISABLE)
		GUICtrlSetState($Item_view, $GUI_DISABLE)
		GUICtrlSetState($Item_wipe, $GUI_DISABLE)
	EndIf
	If $user = "Search" Or $user = "Changed" Then
		GUICtrlSetState($Item_paid, $GUI_DISABLE)
		GUICtrlSetState($Item_favorite, $GUI_DISABLE)
		GUICtrlSetState($Item_preorder, $GUI_DISABLE)
		GUICtrlSetState($Item_move, $GUI_DISABLE)
		GUICtrlSetState($Item_relocate, $GUI_DISABLE)
		GUICtrlSetState($Item_private, $GUI_DISABLE)
		GUICtrlSetState($Item_restore, $GUI_DISABLE)
		GUICtrlSetState($Submenu_missing, $GUI_DISABLE)
	EndIf
EndFunc ;=> CreateContextMenuForListView

Func DeleteContextMenuForListView()
	; Sub Menu - USERS
	GUICtrlDelete($Item_rename)
	$Item_rename = ""
	GUICtrlDelete($Item_receiver + 1)
	GUICtrlDelete($Item_receiver)
	$Item_receiver = ""
	GUICtrlDelete($Item_compall + 1)
	GUICtrlDelete($Item_compall)
	$Item_compall = ""
	GUICtrlDelete($Item_exempt + 1)
	GUICtrlDelete($Item_exempt)
	$Item_exempt = ""
	GUICtrlDelete($Item_user + 1)
	GUICtrlDelete($Item_user)
	$Item_user = ""
	GUICtrlDelete($Submenu_users)
	$Submenu_users = ""
	; Sub Menu - Get Missing
	GUICtrlDelete($Item_jpeg + 2)
	GUICtrlDelete($Item_jpeg + 1)
	GUICtrlDelete($Item_jpeg)
	$Item_jpeg = ""
	GUICtrlDelete($Item_data + 1)
	GUICtrlDelete($Item_data)
	$Item_data = ""
	GUICtrlDelete($Item_summary + 1)
	GUICtrlDelete($Item_summary)
	$Item_summary = ""
	GUICtrlDelete($Item_publish + 1)
	GUICtrlDelete($Item_publish)
	$Item_publish = ""
	GUICtrlDelete($Submenu_missing)
	$Submenu_missing = ""
	; Sub Menu - WIKIPEDIA
	GUICtrlDelete($Item_gotitle + 2)
	GUICtrlDelete($Item_gotitle + 1)
	GUICtrlDelete($Item_gotitle)
	$Item_gotitle = ""
	GUICtrlDelete($Item_goauthor + 1)
	GUICtrlDelete($Item_goauthor)
	$Item_goauthor = ""
	GUICtrlDelete($Submenu_wiki)
	$Submenu_wiki = ""
	; Sub Menu - Save
	GUICtrlDelete($Item_list + 2)
	GUICtrlDelete($Item_list + 1)
	GUICtrlDelete($Item_list)
	$Item_list = ""
	GUICtrlDelete($Item_excel)
	$Item_excel = ""
	GUICtrlDelete($Item_urls + 1)
	GUICtrlDelete($Item_urls)
	$Item_urls = ""
	GUICtrlDelete($Item_save + 1)
	GUICtrlDelete($Item_save)
	$Item_save = ""
	GUICtrlDelete($Submenu_save)
	$Submenu_save = ""
	; Sub Menu - Add a comment
	GUICtrlDelete($Item_relocate + 2)
	GUICtrlDelete($Item_relocate + 1)
	GUICtrlDelete($Item_relocate)
	$Item_relocate = ""
	GUICtrlDelete($Item_private + 2)
	GUICtrlDelete($Item_private + 1)
	GUICtrlDelete($Item_private)
	$Item_private = ""
	GUICtrlDelete($Item_notes + 1)
	GUICtrlDelete($Item_notes)
	$Item_notes = ""
	GUICtrlDelete($Submenu_notes)
	$Submenu_notes = ""
	; Sub Menu - Query List
	GUICtrlDelete($Item_wipe + 2)
	GUICtrlDelete($Item_wipe + 1)
	GUICtrlDelete($Item_wipe)
	$Item_wipe = ""
	GUICtrlDelete($Item_view + 1)
	GUICtrlDelete($Item_view)
	$Item_view = ""
	GUICtrlDelete($Item_rem + 1)
	GUICtrlDelete($Item_rem)
	$Item_rem = ""
	GUICtrlDelete($Item_add + 1)
	GUICtrlDelete($Item_add)
	$Item_add = ""
	GUICtrlDelete($Submenu_list)
	$Submenu_list = ""
	; Sub Menu - Query
	GUICtrlDelete($Item_show + 1)
	GUICtrlDelete($Item_show)
	$Item_show = ""
	GUICtrlDelete($Item_end + 1)
	GUICtrlDelete($Item_end)
	$Item_end = ""
	GUICtrlDelete($Item_start + 1)
	GUICtrlDelete($Item_start)
	$Item_start = ""
	GUICtrlDelete($Item_others + 1)
	GUICtrlDelete($Item_others)
	$Item_others = ""
	GUICtrlDelete($Item_preord + 1)
	GUICtrlDelete($Item_preord)
	$Item_preord = ""
	GUICtrlDelete($Item_failed + 2)
	GUICtrlDelete($Item_failed + 1)
	GUICtrlDelete($Item_failed)
	$Item_failed = ""
	GUICtrlDelete($Item_report + 1)
	GUICtrlDelete($Item_report)
	$Item_report = ""
	GUICtrlDelete($Item_restore + 2)
	GUICtrlDelete($Item_restore + 1)
	GUICtrlDelete($Item_restore)
	$Item_restore = ""
	GUICtrlDelete($Item_time + 1)
	GUICtrlDelete($Item_time)
	$Item_time = ""
	GUICtrlDelete($Item_query + 1)
	GUICtrlDelete($Item_query)
	$Item_query = ""
	GUICtrlDelete($Submenu_queries)
	$Submenu_queries = ""
	; Sub Menu - Price
	GUICtrlDelete($Item_diff + 1)
	GUICtrlDelete($Item_diff)
	$Item_diff = ""
	GUICtrlDelete($Item_change + 1)
	GUICtrlDelete($Item_change)
	$Item_change = ""
	GUICtrlDelete($Item_price + 1)
	GUICtrlDelete($Item_price)
	$Item_price = ""
	GUICtrlDelete($Item_history + 1)
	GUICtrlDelete($Item_history)
	$Item_history = ""
	GUICtrlDelete($Item_last + 1)
	GUICtrlDelete($Item_last)
	$Item_last = ""
	GUICtrlDelete($Submenu_price)
	$Submenu_price = ""
	; Sub Menu - Selected Entry
	GUICtrlDelete($Item_author + 2)
	GUICtrlDelete($Item_author + 1)
	GUICtrlDelete($Item_author)
	$Item_author = ""
	GUICtrlDelete($Item_title + 1)
	GUICtrlDelete($Item_title)
	$Item_title = ""
	GUICtrlDelete($Item_edit + 1)
	GUICtrlDelete($Item_edit)
	$Item_edit = ""
	GUICtrlDelete($Item_skip + 2)
	GUICtrlDelete($Item_skip + 1)
	GUICtrlDelete($Item_skip)
	$Item_skip = ""
	GUICtrlDelete($Item_warn + 1)
	GUICtrlDelete($Item_warn)
	$Item_warn = ""
	GUICtrlDelete($Item_sweet + 1)
	GUICtrlDelete($Item_sweet)
	$Item_sweet = ""
	GUICtrlDelete($Item_clear + 2)
	GUICtrlDelete($Item_clear + 1)
	GUICtrlDelete($Item_clear)
	$Item_clear = ""
	GUICtrlDelete($Item_check + 1)
	GUICtrlDelete($Item_check)
	$Item_check = ""
	GUICtrlDelete($Item_move + 1)
	GUICtrlDelete($Item_move)
	$Item_move = ""
	GUICtrlDelete($Item_copy + 1)
	GUICtrlDelete($Item_copy)
	$Item_copy = ""
	GUICtrlDelete($Item_compare + 1)
	GUICtrlDelete($Item_compare)
	$Item_compare = ""
	GUICtrlDelete($Item_find + 2)
	GUICtrlDelete($Item_find + 1)
	GUICtrlDelete($Item_find)
	$Item_find = ""
	GUICtrlDelete($Item_stored + 2)
	GUICtrlDelete($Item_stored + 1)
	GUICtrlDelete($Item_stored)
	$Item_stored = ""
	GUICtrlDelete($Item_preorder + 2)
	GUICtrlDelete($Item_preorder + 1)
	GUICtrlDelete($Item_preorder)
	$Item_preorder = ""
	GUICtrlDelete($Item_favorite + 1)
	GUICtrlDelete($Item_favorite)
	$Item_favorite = ""
	GUICtrlDelete($Item_paid + 1)
	GUICtrlDelete($Item_paid)
	$Item_paid = ""
	GUICtrlDelete($Submenu_entry)
	$Submenu_entry = ""
	; Sub Menu -  - Selected Entry Detail
	GUICtrlDelete($Item_entry + 1)
	GUICtrlDelete($Item_entry)
	$Item_entry = ""
	GUICtrlDelete($Item_image + 1)
	GUICtrlDelete($Item_image)
	$Item_image = ""
	GUICtrlDelete($Submenu_detail)
	$Submenu_detail = ""
	; Sub Menu
	GUICtrlDelete($Item_url + 2)
	GUICtrlDelete($Item_url + 1)
	GUICtrlDelete($Item_url)
	$Item_url = ""
	GUICtrlDelete($Item_web + 1)
	GUICtrlDelete($Item_web)
	$Item_web = ""
	GUICtrlDelete($Item_search + 1)
	GUICtrlDelete($Item_search)
	$Item_search = ""
	;         
	GUICtrlDelete($Menu_list)
	$Menu_list = ""
EndFunc ;=> DeleteContextMenuForListView

Func DetermineComment()
	;$comment = IniRead($catfle, $ASIN, "comment", "")
	If $updated > 1 Then
		$pubdate = ""
		$preorder = IniRead($catfle, $ASIN, "preorder", "")
		$comment = IniRead($comfle, $ASIN, "comment", "")
		If $preorder = 1 Then
			If StringInStr($comment, "Publication Date:") > 0 Then
				$publish = StringSplit($comment, "Publication Date:", 1)
				$pubdate = $publish[2]
				If $pubdate <> "" Then
					$pubdate = StringSplit($pubdate, "|", 1)
					$pubdate = "Publication Date:" & $pubdate[1]
				EndIf
			EndIf
		EndIf
		;MsgBox(262192, "$pubdate", $pubdate, 0, $PriceQueryGUI)
		; NOTE - Not really sure why the pipes are being stripped from Comment and Private?
		If $pubdate = "" Then $comment = StringReplace($comment, "|", " ")
		$private = IniRead($catfle, $ASIN, "private", "")
		$private = StringReplace($private, "|", " ")
		$date = IniRead($catfle, $ASIN, "date", "")
		$query = IniRead($catfle, $ASIN, "query", $date)
		$comments = StringStripWS($comment & "|" & $private & "|added = " & $date & "|checked = " & $query, 1)
		If $prices = 1 Then
			$prcfle = $pricefld & "\" & $ASIN & ".txt"
			If FileExists($prcfle) Then
				$changes = FileRead($prcfle)
			Else
				$changes = IniRead($catfle, $ASIN, "changes", "")
			EndIf
		Else
			$changes = IniRead($catfle, $ASIN, "changes", "")
		EndIf
		;MsgBox(262192, "$changes", $changes, 0, $PriceQueryGUI)
		If $changes <> "" Then $comments = $comments & "|" & $changes
		GUICtrlSetData($Combo_comm, "", "")
		$cost = IniRead($catfle, $ASIN, "kobo_price", "")
		If $cost <> "" Then
			$val = "Kobo price = " & $cost
			GUICtrlSetData($Combo_comm, $val & "|" & $comments, $val)
		Else
			If $preorder = 1 And $pubdate <> "" Then
				GUICtrlSetData($Combo_comm, $comments, $pubdate)
			Else
				GUICtrlSetData($Combo_comm, $comments, "checked = " & $query)
			EndIf
		EndIf
		;MsgBox(262192, "$cost", $cost, 0, $PriceQueryGUI)
		GUICtrlSetState($Combo_comm, $GUI_FOCUS)
		Send("{HOME}")
		GUICtrlSetState($Listview_ebooks, $GUI_FOCUS)
		_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
	EndIf
EndFunc ;=> DetermineComment

Func DisableOrEnable($cstate)
	GUICtrlSetState($Label_find, $cstate)
	GUICtrlSetState($Combo_where, $cstate)
	GUICtrlSetState($Combo_find, $cstate)
	GUICtrlSetState($Button_find, $cstate)
	GUICtrlSetState($Input_where, $cstate)
	GUICtrlSetState($Button_changed, $cstate)
	GUICtrlSetState($Combo_comm, $cstate)
	GUICtrlSetState($Combo_user, $cstate)
	GUICtrlSetState($Button_add, $cstate)
	GUICtrlSetState($Button_rem, $cstate)
	GUICtrlSetState($Label_rate, $cstate)
	If $excon = 1 Then GUICtrlSetState($Input_rate, $cstate)
	If $quall = 1 Then
		If $favorites = 1 Or $secondfavs = 1 Or $others = 4 Then
			GUICtrlSetState($Checkbox_qufav, $cstate)
			GUICtrlSetState($Checkbox_nofav, $cstate)
		Else
			GUICtrlSetState($Checkbox_nofav, $cstate)
		EndIf
	EndIf
	GUICtrlSetState($Button_ontop, $cstate)
	GUICtrlSetState($Checkbox_sort, $cstate)
	GUICtrlSetState($Button_opts, $cstate)
	GUICtrlSetState($Button_i, $cstate)
	GUICtrlSetState($Button_x, $cstate)
EndFunc ;=> DisableOrEnable

Func DisableListChoices()
	If $movlist = 1 Then
		$movlist = 4
		GUICtrlSetState($Item_movlist, $GUI_UNCHECKED)
		GUICtrlSetState($Item_movlist, $GUI_DISABLE)
		;GUICtrlSetState($Item_coplist, $GUI_UNCHECKED)
		;GUICtrlSetState($Item_coplist, $GUI_DISABLE)
	ElseIf $coplist = 1 Then
		$coplist = 4
		GUICtrlSetState($Item_coplist, $GUI_UNCHECKED)
		GUICtrlSetState($Item_coplist, $GUI_DISABLE)
		;GUICtrlSetState($Item_coplist, $GUI_UNCHECKED)
		;GUICtrlSetState($Item_coplist, $GUI_DISABLE)
	ElseIf $remlist = 1 Then
		$remlist = 4
		GUICtrlSetState($Item_remlist, $GUI_UNCHECKED)
		GUICtrlSetState($Item_remlist, $GUI_DISABLE)
	ElseIf $totlist = 1 Then
		$totlist = 4
		GUICtrlSetState($Item_totlist, $GUI_UNCHECKED)
		GUICtrlSetState($Item_totlist, $GUI_DISABLE)
	EndIf
	GUICtrlSetState($Item_rem, $GUI_DISABLE)
	GUICtrlSetState($Item_view, $GUI_DISABLE)
	GUICtrlSetState($Item_wipe, $GUI_DISABLE)
EndFunc ;=> DisableListChoices

Func EditTitleOrAuthorName()
	GetSelectedIndex("detail")
	If $ind <> -1 Then
		$check = StringSplit($chars, "|")
		$value = $title
		For $c = 3 To ($check[0] - 1)
			$char = StringSplit($check[$c], ":")
			If $char[0] = 2 Then
				$replace = $char[2]
			Else
				$replace = ""
			EndIf
			$char = $char[1]
			$value = StringReplace($value, $char, $replace)
		Next
		$value = StringStripWS($value, 7)
		$text = InputBox("Edit Ebook Title", "Make desired changes. Author editing next." & @LF & @LF & $title, $value, "", 300, 160, -1, -1, 0, $PriceQueryGUI)
		If @error = 0 And $text <> "" And StringCompare($title, $text, 1) <> 0 Then
			; Case changes also detected.
			; Backup original title.
			IniWrite($catfle, $ASIN, "add_title", $title)
			; Update to new title.
			$title = $text
			IniWrite($catfle, $ASIN, "title", $title)
			_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $title, 1)
		EndIf
		;If _IsPressed("11") Then ContinueLoop
		If _IsPressed("11") Then Return
		$value = $author
		For $c = 3 To ($check[0] - 1)
			$char = StringSplit($check[$c], ":")
			If $char[0] = 2 Then
				$replace = $char[2]
			Else
				$replace = ""
			EndIf
			$char = $char[1]
			$value = StringReplace($value, $char, $replace)
		Next
		$value = StringStripWS($value, 7)
		$text = InputBox("Edit Ebook Author", "Make desired changes." & @LF & @LF & $author, $value, "", 240, 160, -1, -1, 0, $PriceQueryGUI)
		If @error = 0 And $text <> "" And StringCompare($author, $text, 1) <> 0 Then
			; Case changes also detected.
			; Backup original author.
			IniWrite($catfle, $ASIN, "add_author", $author)
			; Update to new author.
			$author = $text
			IniWrite($catfle, $ASIN, "author", $author)
			_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $author, 3)
		EndIf
	Else
		MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
	EndIf
EndFunc ;=> EditTitleOrAuthorName

Func FillTheListWithEbooks()
	If FileExists($catfle) Then
		IniWrite($inifle, "Fill List", "start", _Now())
		$begin = TimerInit()
		;$ents = IniReadSectionNames($catfle)
		;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
		;	$nmb = StringLen(_ArrayToString($ents, "|", 1))
		;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
		$ents = FileRead($catfle)
		;Local $novs = StringSplit($ents, @LF & "[", 1)
		;MsgBox(262192, "Sections", $novs[0], 0, $PriceQueryGUI)
		;$ents = StringSplit($ents, @CRLF, 1)
		$ents = StringSplit($ents, @LF & "[", 1)
		If Not @error Then
			;Local $ID = MouseGetCursor()
			GUISetCursor(15, 1, $PriceQueryGUI)
			DisableOrEnable($GUI_DISABLE)
			GUICtrlSetState($Button_query, $GUI_DISABLE)
			If $excel = 4 Then GUICtrlSetState($Checkbox_quall, $GUI_DISABLE)
			If $flash = 1 Then
				GUICtrlSetState($Label_wait, $GUI_SHOW)
			Else
				SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
			EndIf
			$fixed = IniRead($inifle, "Spaces In Prices", $user & "_fixed", "")
			If $fixed = "" Then
				; Removing spaces from prices (convoluted because of how INI processing handles spaces)
				SplashTextOn("", "Fixing!", 160, 120, -1, -1, 33)
				;$replaced = 0
				$tmpfle = $scriptdir & "\Tempcat.log"
			EndIf
			$pipes = IniRead($inifle, "Pipes In Title & Author", $user & "_fixed", "")
			If $pipes = "" Then
				SplashTextOn("", "Fixing!", 160, 120, -1, -1, 33)
			EndIf
			$e = 0
			$lines = $ents[0]
			For $l = 1 To $lines
				$linetxt = $ents[$l] & @LF
;~ 				$linetxt = StringSplit($linetxt, "]" & @CRLF, 1)
;~ 				$ASIN = $linetxt[1]
				$ASIN = StringSplit($linetxt, "]" & @CRLF, 1)
				$ASIN = $ASIN[1]
;~ 				If StringLeft($linetxt, 1) = "[" Then
;~ 					$ASIN = StringTrimLeft($linetxt, 1)
;~ 					$ASIN = StringStripCR($ASIN)
;~ 					$ASIN = StringTrimRight($ASIN, 1)
					;MsgBox(262192, "Line Text", $ASIN, 0, $PriceQueryGUI)
					If $ASIN <> "" Then
						If $l < 6 Then
							If StringLeft($ASIN, 1) = "[" Then $ASIN = StringTrimLeft($ASIN, 1)
						EndIf
						$e = $e + 1
						$num = StringRight("000" & $e, 4)
						$lne = $num
						$asterisk = ""
						$hash = ""
						;$ASIN = $ents[$e]
;~ 						$title = IniRead($catfle, $ASIN, "title", "")
;~ 						$author = IniRead($catfle, $ASIN, "author", "")
						$title = StringSplit($linetxt, @LF & "title=", 1)
						If $title[0] = 2 Then
							$title = $title[2]
							$title = StringSplit($title, @CRLF, 1)
							$title = $title[1]
						Else
							$title = ""
						EndIf
						$author = StringSplit($linetxt, @LF & "author=", 1)
						If $author[0] = 2 Then
							$author = $author[2]
							$author = StringSplit($author, @CRLF, 1)
							$author = $author[1]
						Else
							$author = ""
						EndIf
						If $pipes = "" Then
							$title = StringReplace($title, "|", "-")
							IniWrite($catfle, $ASIN, "title", $title)
							$author = StringReplace($author, "|", "-")
							IniWrite($catfle, $ASIN, "author", $author)
						EndIf
;~ 						$start = IniRead($catfle, $ASIN, "start", "")
						$start = StringSplit($linetxt, @LF & "start=", 1)
						If $start[0] = 2 Then
							$start = $start[2]
							$start = StringSplit($start, @CRLF, 1)
							$start = $start[1]
						Else
							$start = ""
						EndIf
						If $l > 3 Then
							If $title = "" And $author = "" And $start = "" Then
								$ans = MsgBox(262177, "Removal Query", _
									"A blank entry has been found for" & @LF & _
									"MOBI-ASIN - " & $ASIN & @LF & @LF & _
									"OK = Bypass & Remove." & @LF & _
									"CANCEL = Bypass & Ignore." & @LF & @LF & _
									"NOTE - After any removal, you" & @LF & _
									"should close this program then" & @LF & _
									"run the Fixfile shortcut.", 0, $PriceQueryGUI)
								If $ans = 1 Then
									IniDelete($catfle, $ASIN)
								EndIf
								$e = $e - 1
								ContinueLoop
							EndIf
						EndIf
;~ 						$low = IniRead($catfle, $ASIN, "low", "")
;~ 						$high = IniRead($catfle, $ASIN, "high", "")
;~ 						$last = IniRead($catfle, $ASIN, "last", "")
;~ 						$current = IniRead($catfle, $ASIN, "current", "")
						$low = StringSplit($linetxt, @LF & "low=", 1)
						If $low[0] = 2 Then
							$low = $low[2]
							$low = StringSplit($low, @CRLF, 1)
							$low = $low[1]
						Else
							$low = ""
						EndIf
						$high = StringSplit($linetxt, @LF & "high=", 1)
						If $high[0] = 2 Then
							$high = $high[2]
							$high = StringSplit($high, @CRLF, 1)
							$high = $high[1]
						Else
							$high = ""
						EndIf
						$last = StringSplit($linetxt, @LF & "last=", 1)
						If $last[0] = 2 Then
							$last = $last[2]
							$last = StringSplit($last, @CRLF, 1)
							$last = $last[1]
						Else
							$last = ""
						EndIf
						$current = StringSplit($linetxt, @LF & "current=", 1)
						If $current[0] = 2 Then
							$current = $current[2]
							$current = StringSplit($current, @CRLF, 1)
							$current = $current[1]
						Else
							$current = ""
						EndIf
						If $last = "" Then
							If $current <> "" Then
								$last = $current
								IniWrite($catfle, $ASIN, "last", $last)
							EndIf
						EndIf
						If $current <> $start Then $num = $num & "*"
;~ 						$paid = IniRead($catfle, $ASIN, "bought", "")
;~ 						$favorite = IniRead($catfle, $ASIN, "favorite", "")
;~ 						$secondary = IniRead($catfle, $ASIN, "secondary", "")
;~ 						$preorder = IniRead($catfle, $ASIN, "preorder", "")
						$paid = StringSplit($linetxt, @LF & "bought=", 1)
						If $paid[0] = 2 Then
							$paid = $paid[2]
							$paid = StringSplit($paid, @CRLF, 1)
							$paid = $paid[1]
						Else
							$paid = ""
						EndIf
						$favorite = StringSplit($linetxt, @LF & "favorite=", 1)
						If $favorite[0] = 2 Then
							$favorite = $favorite[2]
							$favorite = StringSplit($favorite, @CRLF, 1)
							$favorite = $favorite[1]
						Else
							$favorite = ""
						EndIf
						$secondary = StringSplit($linetxt, @LF & "secondary=", 1)
						If $secondary[0] = 2 Then
							$secondary = $secondary[2]
							$secondary = StringSplit($secondary, @CRLF, 1)
							$secondary = $secondary[1]
						Else
							$secondary = ""
						EndIf
						$preorder = StringSplit($linetxt, @LF & "preorder=", 1)
						If $preorder[0] = 2 Then
							$preorder = $preorder[2]
							$preorder = StringSplit($preorder, @CRLF, 1)
							$preorder = $preorder[1]
						Else
							$preorder = ""
						EndIf
						If $fixed = "" Then
							; Removing spaces from prices (convoluted because of how INI processing handles spaces)
							$date = IniRead($catfle, $ASIN, "date", "")
							IniWrite($tmpfle, $ASIN, "date", $date)
							$URL = IniRead($catfle, $ASIN, "url", "")
							IniWrite($tmpfle, $ASIN, "url", $URL)
							IniWrite($tmpfle, $ASIN, "title", $title)
							IniWrite($tmpfle, $ASIN, "author", $author)
							$start = RemoveSpacesFromPrice("start", $start)
							$low = RemoveSpacesFromPrice("low", $low)
							$high = RemoveSpacesFromPrice("high", $high)
							$last = RemoveSpacesFromPrice("last", $last)
							$current = RemoveSpacesFromPrice("current", $current)
							$query = IniRead($catfle, $ASIN, "query", "")
							IniWrite($tmpfle, $ASIN, "query", $query)
;~ 							If $sumfiles = 1 Then
;~ 								$sumfle = $sumfld & "\" & $ASIN & ".txt"
;~ 								If FileExists($sumfle) Then
;~ 									$summary = FileRead($sumfle)
;~ 								Else
;~ 									$summary = IniRead($catfle, $ASIN, "summary", "")
;~ 								EndIf
;~ 							Else
;~ 								$summary = IniRead($catfle, $ASIN, "summary", "")
;~ 							EndIf
;~ 							IniWrite($tmpfle, $ASIN, "summary", $summary)
							If $sumfiles <> 1 Then
								$summary = IniRead($catfle, $ASIN, "summary", "")
								IniWrite($tmpfle, $ASIN, "summary", $summary)
							EndIf
							$comment = IniRead($catfle, $ASIN, "comment", "")
							If $comment <> "" Then IniWrite($tmpfle, $ASIN, "comment", $comment)
							If $preorder <> "" Then IniWrite($tmpfle, $ASIN, "preorder", $preorder)
							If $paid <> "" Then IniWrite($tmpfle, $ASIN, "bought", $paid)
							If $favorite <> "" Then IniWrite($tmpfle, $ASIN, "favorite", $favorite)
							If $secondary <> "" Then IniWrite($tmpfle, $ASIN, "secondary", $secondary)
							$private = IniRead($catfle, $ASIN, "private", "")
							If $private <> "" Then IniWrite($tmpfle, $ASIN, "private", $private)
;~ 							If $prices = 1 Then
;~ 								$prcfle = $pricefld & "\" & $ASIN & ".txt"
;~ 								If FileExists($prcfle) Then
;~ 									$changes = FileRead($prcfle)
;~ 								Else
;~ 									$changes = IniRead($catfle, $ASIN, "changes", "")
;~ 								EndIf
;~ 							Else
;~ 								$changes = IniRead($catfle, $ASIN, "changes", "")
;~ 							EndIf
;~ 							If $changes <> "" Then IniWrite($tmpfle, $ASIN, "changes", $changes)
							If $prices <> 1 Then
								$changes = IniRead($catfle, $ASIN, "changes", "")
								If $changes <> "" Then IniWrite($tmpfle, $ASIN, "changes", $changes)
							EndIf
							$changed = IniRead($catfle, $ASIN, "changed", "")
							If $changed <> "" Then IniWrite($tmpfle, $ASIN, "changed", $changed)
							$previous = IniRead($catfle, $ASIN, "previous", "")
							If $previous <> "" Then IniWrite($tmpfle, $ASIN, "previous", $previous)
							$text = IniRead($catfle, $ASIN, "add_title", "")
							If $text <> "" Then IniWrite($tmpfle, $ASIN, "add_title", $text)
							$text = IniRead($catfle, $ASIN, "add_author", "")
							If $text <> "" Then IniWrite($tmpfle, $ASIN, "add_author", $text)
						EndIf
						;If IniRead($usertmp, $ASIN, "changed", "") = 1 Then
						$result = IniRead($usertmp, $ASIN, "changed", "")
						If $result <> "" Then
							$currval = GetValueForPrice($current)
							$current = $current & "*"
							$asterisk = 1
						ElseIf IniRead($usertmp, $ASIN, "error", "") = 1 Then
							$current = $current & "#"
							$hash = 1
						ElseIf $test = 1 Then
							; Testing only (should be anyway)
							If StringRight($current, 1) = "*" Then
								$asterisk = 1
							ElseIf StringRight($current, 1) = "#" Then
								$hash = 1
							EndIf
						EndIf
;~ 						$skipit = IniRead($catfle, $ASIN, "skip", "")
						$skipit = StringSplit($linetxt, @LF & "skip=", 1)
						If $skipit[0] = 2 Then
							$skipit = $skipit[2]
							$skipit = StringSplit($skipit, @CRLF, 1)
							$skipit = $skipit[1]
						Else
							$skipit = ""
						EndIf
						If $paid <> "" Then $ASIN = "Bought - " & $ASIN
						If $favorite = 1 Then $ASIN = "Favorite - " & $ASIN
						If $secondary = 1 Then $ASIN = "Secondary - " & $ASIN
						If $preorder = 1 Then $ASIN = "Pre-Order - " & $ASIN
						If $slick = 1 Then
							GUICtrlCreateListViewItem("||||||||", $Listview_ebooks)
							GUICtrlSetData($lowid + $e, $num & "|" & $title & "|" & $ASIN & "|" & $author & "|" & $start & "|" & $low & "|" & $high & "|" & $last & "|" & $current)
						Else
							GUICtrlCreateListViewItem($num & "|" & $title & "|" & $ASIN & "|" & $author & "|" & $start & "|" & $low & "|" & $high & "|" & $last & "|" & $current, $Listview_ebooks)
						EndIf
						If $asterisk = 1 Then
							; Green
							;GUICtrlSetBkColor(-1, $lescol)
							; Dark Blue
							;GUICtrlSetBkColor(-1, 0x00A0F0)
							; Yellow (minor)
							;GUICtrlSetBkColor(-1, $mincol)
							GetSetCorrectLineColor(-1)
						ElseIf $hash = 1 Then
							; Red (error)
							GUICtrlSetBkColor(-1, $errcol)
						ElseIf $skipit = 1 Then
							; Dark Pink (skip)
							GUICtrlSetBkColor(-1, $skicol)
						ElseIf IsInt($lne / 2) = 1 Then
							; Pale Pink (alternate lines)
							GUICtrlSetBkColor(-1, 0xF0D0F0)
						EndIf
						If $updated = "" And $record = 1 Then
							; Once only update (v1.6 or later) to store a changes value where appropriate.
							SplashTextOn("", "Updating!", 200, 120, -1, -1, 33)
							If $prices = 1 Then
								$prcfle = $pricefld & "\" & $ASIN & ".txt"
								If FileExists($prcfle) Then
									$changes = FileRead($prcfle)
								Else
									$changes = IniRead($catfle, $ASIN, "changes", "")
								EndIf
							Else
								$changes = IniRead($catfle, $ASIN, "changes", "")
							EndIf
							If $changes = "" Then
								If $low <> $start Or $high <> $start Then
									$query = IniRead($catfle, $ASIN, "query", $date)
									If $time = 1 Then
										$now = $query
									Else
										$now = StringSplit($query, " ", 1)
										$now = $now[1]
									EndIf
									$curr = StringLeft($start, 1)
									$starval = GetValueForPrice($start)
									If $low <> $start Then
										$lowval = GetValueForPrice($low)
										$result = $starval - $lowval
										GetPriceDifferenceResult()
										$changes = $low & " (" & $curr & $result & " lower) " & $now
									EndIf
									If $high <> $start Then
										$highval = GetValueForPrice($high)
										$result = $highval - $starval
										GetPriceDifferenceResult()
										$result = $high & " (" & $curr & $result & " higher) " & $now
										If $changes = "" Then
											$changes = $result
										Else
											$changes = $changes & "|" & $result
										EndIf
									EndIf
									If $prices = 1 Then
										_FileCreate($prcfle)
										FileWrite($prcfle, $changes)
									Else
										IniWrite($catfle, $ASIN, "changes", $changes)
									EndIf
								EndIf
							EndIf
						EndIf
					EndIf
;~ 				EndIf
			Next
			$nums = $e
			GUICtrlSetData($Group_list, "List Of Kindle Ebooks  (" & $nums & ")")
			;
			If $pipes = "" Then
				SplashOff()
				$pipes = 1
				IniWrite($inifle, "Pipes In Title & Author", $user & "_fixed", $pipes)
			EndIf
			If $fixed = "" Then
				; Removing spaces from prices (convoluted because of how INI processing handles spaces)
				SplashOff()
				If FileExists($tmpfle) Then
					$res = FileMove($catfle, $catfle & ".bak", 1)
					If $res = 1 Then
						$res = FileMove($tmpfle, $catfle, 1)
						If $res = 1 Then
							$fixed = 1
							IniWrite($inifle, "Spaces In Prices", $user & "_fixed", $fixed)
							MsgBox(262208, "Fix For Spaces In Prices", _
								"Any spaces in prices were removed." & @LF & @LF & _
								"(Start, Low, High, Current)", 0, $PriceQueryGUI)
								;$replaced & " space(s) in prices was removed." & @LF & @LF & _
						Else
							; Process failed, so Restore original user file.
							FileMove($catfle & ".bak", $catfle, 1)
						EndIf
					EndIf
				Else
					$res = 0
				EndIf
				If $res <> 1 Then
					MsgBox(262192, "Fix For Spaces In Prices", _
						"The process failed, cause unknown.", 0, $PriceQueryGUI)
				EndIf
			EndIf
			;
			If $updated = "" Then
				$updated = 1
				IniWrite($inifle, "Program", "updated", $updated)
			EndIf
			$ind = 0
			GetSetCurrentStateAfterChanges()
			$colnum = 0
			;
			If $flash = 1 Then
				GUICtrlSetState($Label_wait, $GUI_HIDE)
			Else
				SplashOff()
			EndIf
			DisableOrEnable($GUI_ENABLE)
			If $excel = 4 Then GUICtrlSetState($Checkbox_quall, $GUI_ENABLE)
			GUICtrlSetState($Button_query, $GUI_ENABLE)
			GUISetCursor($ID, 1, $PriceQueryGUI)
		EndIf
		$diff = TimerDiff($begin)
		IniWrite($inifle, "Fill List", "end", _Now())
		IniWrite($inifle, "Fill List", "taken", $diff)
		$diff = Round($diff / 1000, 1)
		IniWrite($inifle, "Fill List", "taken_secs", $diff)
		IniWrite($inifle, "Fill List", "user", $user)
		IniWrite($inifle, "Fill List", "entries", $nums)
	EndIf
EndFunc ;=> FillTheListWithEbooks

Func GetAllChanges()
	If $time = 1 Then
		$now = _Now()
	Else
		$now = _NowDate()
	EndIf
	If $prices = 1 Then
		$prcfle = $pricefld & "\" & $ASIN & ".txt"
		If FileExists($prcfle) Then
			$changes = FileRead($prcfle)
		Else
			$changes = IniRead($catfle, $ASIN, "changes", "")
		EndIf
	Else
		$changes = IniRead($catfle, $ASIN, "changes", "")
	EndIf
	If $changes <> "" Then $changes = $changes & "|"
EndFunc ;=> GetAllChanges

Func GetAndSetOtherData()
	If $sumfiles = 1 Then
		$sumfle = $sumfld & "\" & $ASIN & ".txt"
		If FileExists($sumfle) Then
			$summary = FileRead($sumfle)
		Else
			$summary = IniRead($catfle, $ASIN, "summary", "")
		EndIf
	Else
		$summary = IniRead($catfle, $ASIN, "summary", "")
	EndIf
	$summary = StringReplace($summary, "|", @CRLF)
	GUICtrlSetData($Edit_com, "Summary = " & $summary)
	;$report = $report & "Summary = " & $summary & @LF
	If $report <> "" Then
		$report = StringReplace($report, @LF, @CRLF)
		GUICtrlSetData($Edit_rep, $report)
	EndIf
	;
	$URL = IniRead($catfle, $ASIN, "url", "")
	GUICtrlSetData($Input_URL, $URL)
	;
	$comments = ""
	;
	;$comment = IniRead($catfle, $ASIN, "comment", "")
	$comment = IniRead($comfle, $ASIN, "comment", "")
	$comment = StringReplace($comment, "|", @CRLF)
	$private = IniRead($catfle, $ASIN, "private", "")
	$private = StringReplace($private, "|", @CRLF)
	If $private <> "" Then
		$comments = "<--------- Changes below this line are ignored (not updated) --------->" & @CRLF & $private
	EndIf
	If $prices = 1 Then
		$prcfle = $pricefld & "\" & $ASIN & ".txt"
		If FileExists($prcfle) Then
			$changes = FileRead($prcfle)
		Else
			$changes = IniRead($catfle, $ASIN, "changes", "")
		EndIf
	Else
		$changes = IniRead($catfle, $ASIN, "changes", "")
	EndIf
	If $changes <> "" Then
		$changes = StringReplace($changes, "|", @CRLF)
		If $comments <> "" Then
			$comments = $comments & @CRLF & $changes
		Else
			$comments = "<--------- Changes below this line are ignored (not updated) --------->" & @CRLF & $changes
		EndIf
		$comments = $comment & @CRLF & $comments
	ElseIf $private <> "" Then
		$comments = $comment & @CRLF & $comments
	Else
		$comments = $comment
	EndIf
	;$comments = StringStripWS($comments, 1)
	GUICtrlSetData($Input_comms, $comments)
EndFunc ;=> GetAndSetOtherData

Func GetAnotherImageEntry()
	GUISwitch($PriceQueryGUI)
	_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
	_GUICtrlListView_EnsureVisible($Listview_ebooks, $ind, False)
	GetTheASIN()
	$title = IniRead($catfle, $ASIN, "title", "")
	$author = IniRead($catfle, $ASIN, "author", "")
	DetermineComment()
	GUISwitch($ImageGUI)
	$favorite = IniRead($catfle, $ASIN, "favorite", "")
	$secondary = IniRead($catfle, $ASIN, "secondary", "")
	;
	GetDetailReport()
	GetAndSetOtherData()
	$imgfle = $imgfld & "\" & $ASIN & ".dat"
	If FileExists($imgfle) Then
		;_ReplaceStringInFile($imgfle, 'width="100%" height="100%">', 'width="100%">')
		GetImageDataForGUI()
	Else
		$imgfle = $imgfld & "\" & $ASIN & ".jpg"
		If Not FileExists($imgfle) Then
			$imgfle = $scriptdir & "\Missing.jpg"
		EndIf
		If FileExists($imgfle) Then
			$image = '<img src="' & $imgfle & '" width="210" height="325">'
		Else
			$image = ""
		EndIf
	EndIf
	InsertHtmlImage()
EndFunc ;=> GetAnotherImageEntry

Func GetBookDescription($pud)
	Local $day, $month, $pub, $publish, $pubyear
	; NEW METHOD
	$publish = StringSplit($html, "Publication Date:", 1)
	If $publish[0] = 1 Then
		$publish = StringSplit($html, ">Publication Date" & @LF & ":", 1)
	EndIf
	If $publish[0] > 1 Then
		$pubdate = $publish[2]
		If $pubdate <> "" Then
			;MsgBox(262192, "Got Here", "1", 0, $PriceQueryGUI)
			$pubdate = StringSplit($pubdate, @LF, 1)
			$pubdate = $pubdate[1]
			;MsgBox(262192, "$pubdate", $pubdate, 0, $PriceQueryGUI)
			$pubdate = StringReplace($pubdate, "</b>", "")
			$pubdate = StringReplace($pubdate, "</li>", "")
			$pubdate = StringStripWS($pubdate, 7)
			$publish = StringSplit($pubdate, " ", 1)
			If $publish[0] = 3 Then
				;MsgBox(262192, "Got Here", "2", 0, $PriceQueryGUI)
				$month = $publish[1]
				If StringIsDigit($month) = 0 Then
					For $pub = 1 To 12
						If _DateToMonth($pub, 0) = $month Then
							$month = $pub
							ExitLoop
						EndIf
					Next
				EndIf
				$month = StringRight("0" & $month, 2)
				$day = $publish[2]
				$day = StringReplace($day, ",", "")
				$day = StringRight("0" & $day, 2)
				$pubyear = $publish[3]
				If StringIsDigit($pubyear) Then
					;MsgBox(262192, "$pubyear $day $month $preord", $pubyear & "-" & $day & "-" & $month & " + " & $preord, 0, $PriceQueryGUI)
					If $pubyear > @YEAR Then
						$preord = 1
					ElseIf $pubyear = @YEAR Then
						;MsgBox(262192, "Got Here", "3", 0, $PriceQueryGUI)
						If StringIsDigit($month) Then
							;MsgBox(262192, "Got Here", "4", 0, $PriceQueryGUI)
							If $month > @MON Then
								$preord = 1
							ElseIf $month = @MON Then
								;MsgBox(262192, "Got Here", "5", 0, $PriceQueryGUI)
								If StringIsDigit($day) Then
									;MsgBox(262192, "$day @MDAY", $day & " = " & @MDAY, 0, $PriceQueryGUI)
									If $day > @MDAY Then $preord = 1
								EndIf
							EndIf
						EndIf
					EndIf
				Else
					$pubdate = "Unknown"
				EndIf
			Else
				$pubdate = "Unknown"
			EndIf
		Else
			$pubdate = "Unknown"
		EndIf
	Else
		$pubdate = "Unknown"
	EndIf
	If $pud = 1 Then Return
	;
	Local $readerr = ""
	$summary = ""
	$pos = StringInStr($html, '"bookDescription"') ; Line 3990
	If $pos > 0 Then
		$html = StringSplit($html, '"bookDescription"', 1)
		$html = $html[2]
		$check = StringSplit($html, "</noscript>", 1)
		If $check[0] > 1 Then
			$check = $check[1]
			$check = StringSplit($check, "<noscript>", 1)
			If $check[0] > 1 Then
				$check = $check[2]
				$check = StringReplace($check, "<div>", " ")
				$check = StringReplace($check, "</div>", " ")
				$check = StringReplace($check, "<h2>", "")
				$check = StringReplace($check, "</h2>", "|")
				$check = StringReplace($check, "<br /></li><li>", "|")
				$check = StringReplace($check, "<br /><li>", "|")
				$check = StringReplace($check, "<br />", "|")
				$check = StringReplace($check, "<br>", "|")
				$check = StringReplace($check, "<b>", "")
				$check = StringReplace($check, "<ul>", "")
				$check = StringReplace($check, "</ul>", "")
				$check = StringReplace($check, "<li>", "|")
				$check = StringReplace($check, "</li>", "|")
				$check = StringReplace($check, "<em>", "")
				$check = StringReplace($check, "</em>", "")
				$check = StringReplace($check, "&#x22;", "")
				$html = StringReplace($check, @CR, " ")
				$html = StringReplace($html, @CRLF, " ")
				$html = StringReplace($html, @LF, " ")
				$check = StringSplit($tags, "|")
				For $t = 1 To $check[0]
					$tag = StringSplit($check[$t], ":")
					If $tag[0] = 2 Then
						$replace = $tag[2]
						If $replace = "pipe" Then $replace = "|"
					Else
						$replace = ""
					EndIf
					$tag = $tag[1]
					$html = StringReplace($html, $tag, $replace)
				Next
				$html = StringReplace($html, "| |", "||")
				$html = StringReplace($html, "|||", "||")
				$html = StringReplace($html, "|||", "||")
				;
				For $pos = 1 To StringLen($html)
					$summary = StringRight($html, $pos)
					If StringLeft($summary, 1) = ">" Then
						$summary = StringTrimLeft($summary, 1)
						ExitLoop
					EndIf
				Next
				TidyUpSummary()
			Else
				$readerr = 10
			EndIf
		Else
			$readerr = 9
		EndIf
	Else
		$readerr = 8
	EndIf
	$html = ""
	If $readerr <> "" Then
		MsgBox(262192, "Read Error " & $readerr, "The 'Book Description' could not be determined!", 0, $PriceQueryGUI)
		$summary = ""
		TidyUpSummary()
	EndIf
EndFunc ;=> GetBookDescription

Func GetDetailReport()
	$report = "Title = " & $title & @LF
	;$author = IniRead($catfle, $ASIN, "author", "")
	$report = $report & "Author = " & $author & @LF
	$report = $report & "Added = " & $date & ".   Last checked = " & $query & @LF
	$changed = IniRead($catfle, $ASIN, "changed", "")
	$previous = IniRead($catfle, $ASIN, "previous", $changed)
	$report = $report & "Last change = " & $changed & ".  Prior change = " & $previous & @LF
	$start = IniRead($catfle, $ASIN, "start", "")
	$low = IniRead($catfle, $ASIN, "low", "")
	$high = IniRead($catfle, $ASIN, "high", "")
	$last = IniRead($catfle, $ASIN, "last", "")
	$report = $report & "Added price = " & $start & ".   Lowest price = " & $low & ".   Highest price = " & $high & @LF
	$current = IniRead($catfle, $ASIN, "current", "")
	$report = $report & "Current price = " & $current & ".   Previous price = " & $last & ".   MOBI-ASIN = " & $ASIN
	$paid = IniRead($catfle, $ASIN, "bought", "")
	If $paid <> "" Then $report = $report & @LF & $paid
EndFunc ;=> GetDetailReport

Func GetDifferenceToLastPrice()
	$resulted = $result
	If $currval > $prevval Then
		; Current value is greater than last recorded value.
		$dif = "higher"
		$result = $currval - $prevval
	Else
		; Current value is lower than last recorded value.
		$dif = "lower"
		$result = $prevval - $currval
	EndIf
	; Change price difference value to dollars and cents.
	GetPriceDifferenceResult()
	$differ = $result
	$result = $resulted
EndFunc ;=> GetDifferenceToLastPrice

Func GetExchangeRate($val)
	Local $googerr, $googup, $times
	If $exchange <> "" Then
		; Check how many minutes have passed since last query.
		$when = IniRead($inifle, "Conversion", "time", "")
		$when = _DateDiff("n", $when, _NowCalc())
		; If number of minutes is greater than specified default, then query Google for Exchange Rate again.
		If $when > IniRead($inifle, "Conversion", "recheck", "") Then $exchange = ""
	EndIf
	;
	If $exchange = "" Then
		; Check connection status.
		If $connection <> 1 Then CheckForConnection()
		If $connection = 1 Then
			; Query the Exchange Rate from Google.
			$ans = MsgBox(262433, "Exchange Rate Query", _
				"Automatic query of Google for Exchange Rate in 3 seconds." & @LF & @LF & _
				"CANCEL = Abort the Query until another entry is selected.", 3, $PriceQueryGUI)
			If $ans = 1 Or $ans = -1 Then
				DisableOrEnable($GUI_DISABLE)
				GUICtrlSetState($Listview_ebooks, $GUI_DISABLE)
				GUICtrlSetState($Button_query, $GUI_DISABLE)
				If $excel = 4 Then GUICtrlSetState($Checkbox_quall, $GUI_DISABLE)
				If $flash = 1 Then
					GUICtrlSetData($Label_wait, "(Exchange Rate Query)")
					GUICtrlSetState($Label_wait, $GUI_SHOW)
					$times = GUICtrlRead($Label_time)
					GUICtrlSetData($Label_time, "Wait!")
					GUICtrlSetState($Label_time, $GUI_SHOW)
				Else
					SplashTextOn("", "(Exchange Rate Query)" & @LF & @LF & "Please Wait!", 200, 120, -1, -1, 33)
				EndIf
				;Sleep(3000)
				If FileExists($exchprog) Then
					RunWait($exchprog)
					If IniRead($inifle, "Conversion", "time", "") <> "" Then
						$exchange = IniRead($inifle, "Conversion", "rate", "")
					EndIf
				Else
					; Unless Google have restored things, this code should no longer work.
					$googcon = IniRead($inifle, "Conversion", "link", "")
					If $googcon = "" Then
						;$googcon = "http://www.google.com/finance/converter"
						; new = https://finance.google.com/finance/converter?a=1&from=USD&to=AUD
						;$googcon = "https://finance.google.com/finance/converter"
						$googcon = "https://www.google.com"
						IniWrite($inifle, "Conversion", "link", $googcon)
					EndIf
					$googup = IniRead($inifle, "Conversion", "updated", "")
					If $googup <> 2 Then
						$prvlink = "https://finance.google.com/finance/converter"
						IniWrite($inifle, "Conversion", "previous", $prvlink)
						$googpart1 = "?a=1&from="
						IniWrite($inifle, "Conversion", "old_1", $googpart1)
						$googpart2 = "&to="
						IniWrite($inifle, "Conversion", "old_2", $googpart2)
						$googpart3 = "&hl=es"
						IniWrite($inifle, "Conversion", "old_3", $googpart3)
						;
						$googcon = "https://www.google.com"
						IniWrite($inifle, "Conversion", "link", $googcon)
						$googpart1 = "/search?q="
						IniWrite($inifle, "Conversion", "params_1", $googpart1)
						$googpart2 = "+to+"
						IniWrite($inifle, "Conversion", "params_2", $googpart2)
						$googpart3 = ""
						IniWrite($inifle, "Conversion", "params_3", $googpart3)
						$googup = 2
						IniWrite($inifle, "Conversion", "updated", $googup)
					Else
						$googpart1 = IniRead($inifle, "Conversion", "params_1", "")
						If $googpart1 = "" Then
							;$googpart1 = "?a=1&from="
							$googpart1 = "/search?q="
							IniWrite($inifle, "Conversion", "params_1", $googpart1)
						EndIf
						$googpart2 = IniRead($inifle, "Conversion", "params_2", "")
						If $googpart2 = "" Then
							;$googpart2 = "&to="
							$googpart2 = "+to+"
							IniWrite($inifle, "Conversion", "params_2", $googpart2)
						EndIf
						; Part 3 may or may not be required (currently not).
						$googpart3 = IniRead($inifle, "Conversion", "params_3", "")
					EndIf
					;$googet = $googcon & $googpart1 & StringLower($usd) & $googpart2 & StringLower($currency) & $googpart3
					$googet = $googcon & $googpart1 & StringUpper($usd) & $googpart2 & StringUpper($currency) & $googpart3
					IniWrite($inifle, "Conversion", "parameters", $googet)
					$html = _INetGetSource($googet)
					If @error <> 1 Then
						If $googcon = "https://www.google.com" Then
							$exchange = StringSplit($html, " = ", 1)
							If $exchange[0] > 1 Then
								$html = StringStripWS($exchange[2], 3)
								$exchange = StringSplit($html, " ", 1)
								$exchange = StringStripWS($exchange[1], 3)
								If StringIsFloat($exchange) = 1 Then
									IniWrite($inifle, "Conversion", "rate", $exchange)
									IniWrite($inifle, "Conversion", "time", _NowCalc())
								Else
									$exchange = ""
									$googerr = 3
								EndIf
							Else
								$exchange = ""
								$googerr = 2
							EndIf
						ElseIf $googcon = "https://finance.google.com/finance/converter" Then
							$exchange = StringSplit($html, "<span class=bld>", 1)
							If $exchange[0] > 1 Then
								$exchange = $exchange[2]
								$exchange = StringSplit($exchange, "</span>", 1)
								If $exchange[0] > 1 Then
									$exchange = $exchange[1]
									$exchange = StringSplit($exchange, " ", 1)
									If $exchange[0] > 1 Then
										$exchange = $exchange[1]
										If StringIsFloat($exchange) = 1 Then
											IniWrite($inifle, "Conversion", "rate", $exchange)
											IniWrite($inifle, "Conversion", "time", _NowCalc())
										Else
											$exchange = ""
											$googerr = 5
										EndIf
									Else
										$exchange = ""
										$googerr = 4
									EndIf
								Else
									$exchange = ""
									$googerr = 3
								EndIf
							Else
								$exchange = ""
								$googerr = 2
							EndIf
						EndIf
					Else
						$exchange = ""
						$googerr = 1
					EndIf
					; HTML is written to Query.txt file for error checking if need be.
					; The content is later overwritten during an ADD or Query.
					_FileWriteToLine($querytxt, 1, $html, 1)
				EndIf
				;
				DisableOrEnable($GUI_ENABLE)
				If $excel = 4 Then GUICtrlSetState($Checkbox_quall, $GUI_ENABLE)
				GUICtrlSetState($Button_query, $GUI_ENABLE)
				GUICtrlSetState($Listview_ebooks, $GUI_ENABLE)
				If $flash = 1 Then
					GUICtrlSetState($Label_time, $GUI_HIDE)
					GUICtrlSetData($Label_time, $times)
					GUICtrlSetState($Label_wait, $GUI_HIDE)
					GUICtrlSetData($Label_wait, "Please Wait!")
				Else
					SplashOff()
				EndIf
				If $exchange = "" Then
					;MsgBox(262192, "Exchange Rate Error", "Error = " & $googerr, 0, $PriceQueryGUI)
					$ans = MsgBox(262193, "Exchange Rate Error", _
						"Error = " & $googerr & @LF & @LF & _
						"Do you want to use previous" & @LF & _
						"Exchange Rate (if exists)?" & @LF & @LF & _
						"OK = Use the previous." & @LF & _
						"CANCEL = Continue as is.", 0, $PriceQueryGUI)
					If $ans = 1 Then
						$exchange = IniRead($inifle, "Conversion", "rate", "")
						If $exchange <> "" Then IniWrite($inifle, "Conversion", "time", _NowCalc())
					EndIf
				EndIf
			ElseIf $ans = 2 Then
				$ans = MsgBox(262433, "Exchange Rate Query", _
					"If you need to you can now disable the automatic query" & @LF & _
					"of the Exchange Rate, in the program 'Settings' window." & @LF & @LF & _
					"OK = Disable further Queries (for this session only)." & @LF & @LF & _
					"NOTE - You are probably here, because you are having" & @LF & _
					"an issue with the Google query, and need to disable it." & @LF & _
					"If OK is selected, then you can later restore the Query" & @LF & _
					"process (this session) by enabling the temporarily unset" & @LF & _
					"option. First selected entry will then initiate a Query.", 0, $PriceQueryGUI)
				If $ans = 1 Then
					$excon = 4
				EndIf
			EndIf
		EndIf
	EndIf
	If StringIsFloat($exchange) = 1 Then
		; Query of Exchange Rate succeeded now or previously (this session).
		$curval = StringTrimLeft($current, 1)
		$curval = Round($curval * $exchange, 2)
		If StringIsDigit($curval) Then $curval = $curval & ".00"
		While StringLeft(StringRight($curval, 3), 1) <> "."
			$curval = $curval & "0"
		WEnd
		$curval = StringLeft($current, 1) & $curval
	Else
		; Query of Exchange Rate failed this session (probably no web connection).
		$curval = $current & "@"
	EndIf
	If $val = 1 Then GUICtrlSetData($Input_rate, $curval)
EndFunc ;=> GetExchangeRate

Func GetImageData()
	$imgfle = $imgfld & "\" & $ASIN & ".jpg"
	If Not FileExists($imgfle) Then
		$imgfle = $imgfld & "\" & $ASIN & ".dat"
	EndIf
	If FileExists($imgfle) Then
		$ans = MsgBox(262449, "Replace Query", _
			"This ebook entry's Image Data file already Exists!" & @LF & @LF & _
			"OK = Replace (update) with the current version." & @LF & _
			"CANCEL = Abort updating and leave as is.", 0, $PriceQueryGUI)
	Else
		$ans = 1
	EndIf
	If $ans = 1 Then
		; NEW METHOD
		Local $readerr = ""
		$pos = StringInStr($html, '<script type="text/javascript">') ; Line 4
		If $pos > 0 Then
			$image = '<script type="text/javascript">' & @LF
			$startpos = StringInStr($html, '<div id="amsDetailRightEBook_feature_div"') ; Line 3030
			If $startpos > 0 Then
				$endpos = StringInStr($html, '<div id="flipAndSampleAudio"') ; Line 3058
				If $endpos > 0 Then
					$image = $image & StringMid($html, $startpos, $endpos - $startpos)
					$startpos = StringInStr($html, '<div id="dynamicIframe_feature_div"') ; Line 3619
					If $startpos > 0 Then
						$endpos = StringInStr($html, "return DynamicIframe;") ; Line 3986
						If $endpos > 0 Then
							$image = $image & StringMid($html, $startpos, $endpos - $startpos)
							$image = $image & @LF & "return DynamicIframe;"
							$image = $image & @LF & "});"
							$image = $image & @LF & "</script>"
							$image = $image & @LF & "</div>"
							If StringInStr($image, '<div id="sitbLogo') > 0 Then
								$startpos = StringInStr($image, '<div id="sitbLogo')
								$replace = StringMid($image, $startpos)
								$endpos = StringInStr($replace, "</div>")
								$image = StringLeft($image, $startpos - 1) & StringMid($image, $startpos + $endpos + 6)
							EndIf
							$imgfle = $imgfld & "\" & $ASIN & ".dat"
							_FileCreate($imgfle)
							_FileWriteToLine($imgfle, 1, $image)
						Else
							$readerr = 15
						EndIf
					Else
						$readerr = 14
					EndIf
				Else
					$readerr = 13
				EndIf
			Else
				$readerr = 12
			EndIf
		Else
			$readerr = 11
		EndIf
		;MsgBox(262192, "Image Read Error", $readerr, 0, $PriceQueryGUI)
		If $readerr <> "" Then
			; Data Image file couldn't be created.
			If $jpgsav <> 2 Then
				;id="imgBlkFront" data-a-dynamic-image="{&quot;http://ecx.images-amazon.com/images/I/51wdtp%2BUWWL._SX326_BO1,204,203,200_.jpg&quot;:
				$pos = StringInStr($html, 'id="imgBlkFront"')
				If $pos < 1 Then
					$pos = StringInStr($html, 'id="ebooksImgBlkFront"')
				EndIf
				If $pos > 0 Then
					$image = StringMid($html, $pos)
					$endpos = StringInStr($image, "_.jpg")
					If $endpos > 0 Then
						$endpos = $endpos + 4
						$image = StringLeft($image, $endpos)
						;MsgBox(262192, "$image", $image, 0, $PriceQueryGUI)
						$startpos = StringInStr($image, 'http:', 0, -1)
						If $startpos < 1 Then
							$startpos = StringInStr($image, 'https:', 0, -1)
							If $startpos < 1 Then
								$readerr = 18
							EndIf
						EndIf
						;MsgBox(262192, "Image Read Error", $readerr, 0, $PriceQueryGUI)
						If $startpos > 0 Then
							$image = StringMid($image, $startpos)
							;MsgBox(262192, "$image", $image, 0, $PriceQueryGUI)
							If StringInStr($image, "<") < 1 Then
								IniWrite($catfle, $ASIN, "image", $image)
								If $jpgsav = 6 Then
									$ans = MsgBox(262193, "Read Error " & $readerr, "The 'Image Data' could not be determined," _
										& @LF & "but a possible JPG candidate was found." _
										& @LF & @LF & $image _
										& @LF & @LF & "OK = Download the JPG cover file.", 0, $PriceQueryGUI)
								Else
									$ans = 1
								EndIf
								If $test <> 1 Then
									$readerr = ""
									If $ans = 1 Then
										$imgfle = $imgfld & "\" & $ASIN & ".jpg"
										If FileExists($imgfle) Then FileDelete($imgfle)
										$jpeg = InetGet($image, $imgfle)
										If $jpeg = 0 Then
											MsgBox(262192, "Download Error", "The image file failed to download!", 0, $PriceQueryGUI)
										EndIf
									EndIf
								EndIf
							Else
								MsgBox(262192, "Read Error " & $readerr, "The 'Image Data' could not be determined," _
									& @LF & "and a JPG candidate couldn't be found.", 0, $PriceQueryGUI)
							EndIf
						EndIf
					Else
						$readerr = 17
					EndIf
				Else
					$readerr = 16
				EndIf
			EndIf
				

;~ 				$startpos = StringInStr($image, 'http:')
;~ 				If $startpos > 0 Then
;~ 					$endpos = StringInStr($image, "_.jpg")
;~ 					If $endpos > 0 Then
;~ 						$endpos = $endpos + 5
;~ 						$image = StringMid($image, $startpos, $endpos - $startpos)
;~ 						If StringInStr($image, "<") < 1 Then
;~ 							IniWrite($catfle, $ASIN, "image", $image)
;~ 							$ans = MsgBox(262193, "Read Error " & $readerr, "The 'Image Data' could not be determined," _
;~ 								& @LF & "but a possible JPG candidate was found." _
;~ 								& @LF & @LF & $image _
;~ 								& @LF & @LF & "OK = Download the JPG cover file.", 0, $PriceQueryGUI)
;~ 							If $test <> 1 Then
;~ 								$readerr = ""
;~ 								If $ans = 1 Then
;~ 									$imgfle = $imgfld & "\" & $ASIN & ".jpg"
;~ 									If FileExists($imgfle) Then FileDelete($imgfle)
;~ 									$jpeg = InetGet($image, $imgfle)
;~ 									If $jpeg = 0 Then
;~ 										MsgBox(262192, "Download Error", "The image file failed to download!", 0, $PriceQueryGUI)
;~ 									EndIf
;~ 								EndIf
;~ 							EndIf
;~ 						Else
;~ 							MsgBox(262192, "Read Error " & $readerr, "The 'Image Data' could not be determined," _
;~ 								& @LF & "and a JPG candidate couldn't be found.", 0, $PriceQueryGUI)
;~ 						EndIf
;~ 					Else
;~ 						$readerr = 18
;~ 					EndIf
;~ 				Else
;~ 					$readerr = 17
;~ 				EndIf
;~ 			Else
;~ 				$readerr = 16
;~ 			EndIf
			If $readerr <> "" Then MsgBox(262192, "Read Error " & $readerr, "The 'Cover Image' could not be found!", 0, $PriceQueryGUI)
		EndIf
	EndIf
	;
	GetPublisher()
EndFunc ;=> GetImageData

Func GetImageDataForGUI()
	Local $picfle
	$picfle = FileOpen($imgfle, 0)
	$image = FileRead($picfle)
	FileClose($picfle)
	$picfle = ""
EndFunc ;=> GetImageDataForGUI

Func GetLastControlID($men)
	;$lowid = $Button_x
	If $men = "add" Then
		$contxtmenu = 1
		$lowid = $Item_rename
		IniWrite($inifle, "Last Control ID", "menu", $lowid)
	Else
		If $men = "delete" And $Menu_list <> "" Then
			;GUICtrlDelete($Menu_list)
			DeleteContextMenuForListView()
		EndIf
		$contxtmenu = ""
		$lowid = $Item_mode
		IniWrite($inifle, "Last Control ID", "standard", $lowid)
	EndIf
	IniWrite($inifle, "Last Control ID", "dateset", _Now())
	$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
	$bigid = $lowid + $nums + 1
	IniWrite($inifle, "Last Control ID", "limit", $bigid)
	;MsgBox(262192, "$Menu_list", $Menu_list, 0, $PriceQueryGUI)
EndFunc ;=> GetLastControlID

Func GetOtherDetails()
	If $where = "Titles" Or $where = "Simple" Then
		GUICtrlSetData($Input_where, $title)
	ElseIf $where = "Authors" Then
		GUICtrlSetData($Input_where, $author)
	ElseIf $where = "Both" Then
		GUICtrlSetData($Input_where, $author & " - " & $title)
	ElseIf $where = "ASIN" Then
		GUICtrlSetData($Input_where, $ASIN)
	EndIf
	$current = IniRead($catfle, $ASIN, "current", "")
	If $excon = 1 And $exempt = 4 Then
		GetExchangeRate(1)
	Else
		GUICtrlSetData($Input_rate, $current)
	EndIf
	;MsgBox(262192, "$cost 2", $cost, 0, $PriceQueryGUI)
	If $cost <> "" Then
		$curval = GUICtrlRead($Input_rate)
		$curval = StringReplace($curval, "@", "")
		$curval = StringTrimLeft($curval, 1)
		;MsgBox(262192, "$curval", $curval, 0, $PriceQueryGUI)
		;MsgBox(262192, "$leeway", $leeway, 0, $PriceQueryGUI)
		$curval = Number($curval + $leeway)
		;MsgBox(262192, "$curval", $curval, 0, $PriceQueryGUI)
		$curval = GetValueForPrice($curval)
		;MsgBox(262192, "$curval", $curval, 0, $PriceQueryGUI)
		$check = GetValueForPrice($cost)
		;MsgBox(262192, "$check", $check, 0, $PriceQueryGUI)
		If $curval >= $check Then
			GUICtrlSetBkColor($Input_rate, $COLOR_RED)
			;MsgBox(262192, "$notify", $notify, 0, $PriceQueryGUI)
			If $notify > 0 Then
				If ($curval - $check) >= $notify Then
					$ans = MsgBox(262449, "Price Alert", "Kobo price is significantly better right now." _
						& @LF & @LF & "CANCEL = Adjust the notification value." _
						& @LF & @LF & "(auto close in 5 seconds)", 5, $PriceQueryGUI)
					If $ans = 2 Then
						$val = InputBox("Adjust Notification", "Set a new value in cents (etc) only." & @LF & @LF & "(0 = disable) NOT RECOMMENDED", $notify, "", 200, 150, -1, -1, 0, $PriceQueryGUI)
						If @error = 0 And StringIsDigit($val) Then
							$notify = $val
							IniWrite($inifle, "Kobo", "notify", $notify)
						EndIf
					EndIf
				EndIf
			EndIf
		Else
			GUICtrlSetBkColor($Input_rate, $COLOR_LIME)
		EndIf
		;MsgBox(262192, "$check $curval", $check & @LF & $curval, 0, $PriceQueryGUI)
	Else
		GUICtrlSetBkColor($Input_rate, $COLOR_WHITE)
	EndIf
	;
	If $getot = 1 Then
		;$changes = IniRead($catfle, $ASIN, "changes", "")
		$totchans = StringSplit($changes, "|")
		$totchans = $totchans[0]
		GUICtrlSetData($Group_list, "List Of Kindle Ebooks  (" & $nums & ") --- [" & $totchans & " changes]")
	EndIf
	GUICtrlSetTip($Listview_ebooks, $ASIN & @LF & $title & @LF & $author)
	;
	$warning = IniRead($catfle, $ASIN, "warning", "")
	If $warning <> "" Then
		$ans = MsgBox(262193, "Warning Message  (closes in 4 secs)", "CANCEL = Keep Open." & @LF & @LF & $warning, 4, $PriceQueryGUI)
		If $ans = 2 Then
			MsgBox(262192, "Warning Message", $warning, 0, $PriceQueryGUI)
		EndIf
	EndIf
EndFunc ;=> GetOtherDetails

Func GetPreviousSearches()
	If $where = "Titles" Then
		$what = "searches"
		GUICtrlSetData($Input_where, $title)
	ElseIf $where = "Authors" Then
		$what = "findings"
		GUICtrlSetData($Input_where, $author)
	ElseIf $where = "Both" Then
		$what = ""
		GUICtrlSetData($Input_where, $author & " - " & $title)
	ElseIf $where = "Simple" Then
		$what = ""
	ElseIf $where = "ASIN" Then
		$what = ""
		GUICtrlSetData($Input_where, $ASIN)
	EndIf
	If $what <> "" Then
		$searches = IniRead($inifle, $user, $what, "")
		If $searches = "" Then
			$searches = "||"
			IniWrite($inifle, $user, $what, $searches)
		EndIf
		GUICtrlSetData($Combo_find, "", "")
		GUICtrlSetData($Combo_find, $searches, "")
	EndIf
EndFunc ;=> GetPreviousSearches

Func GetPriceDifferenceResult()
	; Check and make sure that result is at least two digits.
	$store = 1
	If StringLen($result) = 1 Then
		If $skip = 1 And $result <= $max Then $store = ""
		$result = "0" & $result
	EndIf
	; Make sure last two digits are preceded by a period character.
	$result = StringTrimRight($result, 2) & "." & StringRight($result, 2)
	; Check and make sure that result has at least one digit preceding the period, if only a zero.
	If StringLen($result) < 4 Then $result =  "0" & $result
EndFunc ;=> GetPriceDifferenceResult

Func GetPublisher()
	$pos = StringInStr($html, 'Publisher:')
	If $pos > 0 Then
		$publisher = StringMid($html, $pos)
		$pos = StringInStr($publisher, '</li>')
		If $pos > 0 Then
			$publisher = StringLeft($publisher, $pos - 1)
			$publisher = StringReplace($publisher, "</b>", "")
			If StringInStr($publisher, "<") > 0 Then
				$publisher = ""
			EndIf
		Else
			$publisher = ""
		EndIf
	Else
		$publisher = ""
	EndIf
EndFunc ;=> GetPublisher

Func GetQueryTimeTaken()
	$hrs = "00"
	$mins = "00"
	$secs = "00"
	$diff = TimerDiff($begin)
	If $diff > 999 Then
		$secs = Floor($diff / 1000)
		If $secs > 60 Then
			$mins = Floor($secs / 60)
			If $mins > 60 Then
				$hrs = Floor($mins / 60)
				$mins = $mins - ($hrs * 60)
				$secs = $secs - ($mins * 60)
			ElseIf $mins = 60 Then
				$secs = "00"
				$mins = "00"
				$hrs = "01"
			Else
				$secs = $secs - ($mins * 60)
			EndIf
		ElseIf $secs = 60 Then
			$secs = "00"
			$mins = "01"
		EndIf
	EndIf
	$timechk = StringRight("0" & $hrs, 2) & ":" & StringRight("0" & $mins, 2) & ":" & StringRight("0" & $secs, 2)
	GUICtrlSetData($Label_time, $timechk)
EndFunc ;=> GetQueryTimeTaken

Func GetSaveSlots()
	$slots = IniRead($inifle, "Save Query Results - " & $user, "slots", "")
	If $slots = "" Then
		$slots = 5
		IniWrite($inifle, "Save Query Results - " & $user, "slots", $slots)
	EndIf
EndFunc ;=> GetSaveSlots

Func GetSelectedIndex($for)
	Local $state
	If _GUICtrlListView_GetItemSelected($Listview_ebooks, $ind) = False Then
		;$ind = _GUICtrlListView_GetHotItem($Listview_ebooks) - 1
		;MsgBox(262192, "Index Checking 2", $ind, 0, $PriceQueryGUI)
		$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
		If $nums > 0 Then
			For $e = 1 To $nums
				$ind = $e - 1
				$state = _GUICtrlListView_GetItemState($Listview_ebooks, $ind, $LVIS_FOCUSED)
				;MsgBox(262192, "$state", $state, 0, $PriceQueryGUI)
				If $state = 1 Then
					_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
					ExitLoop
				Else
					$ind = -1
				EndIf
			Next
		Else
			$ind = -1
		EndIf
		If $ind <> -1 Then
			GetTheASIN()
			If $for = "detail" Then
				$title = IniRead($catfle, $ASIN, "title", "")
				$author = IniRead($catfle, $ASIN, "author", "")
				DetermineComment()
				GetOtherDetails()
			EndIf
		EndIf
	EndIf
EndFunc ;=> GetSelectedIndex

Func GetSetCorrectLineColor($row)
	CheckIfSweet()
	If $sweetval = "" Then
		$alert = Abs($alert)
		If $result < 0 Then
			$result = Abs($result)
			If $result > $alert Then
				; Orange (major more)
				GUICtrlSetBkColor($row, $morcol)
			Else
				; Blue (0x00A0F0)
				; Yellow (minor)
				GUICtrlSetBkColor($row, $mincol)
			EndIf
		Else
			If $result > $alert Then
				; Green (major less)
				GUICtrlSetBkColor($row, $lescol)
			Else
				; Blue (0x00A0F0)
				; Yellow (minor)
				GUICtrlSetBkColor($row, $mincol)
			EndIf
		EndIf
	Else
		; White (sweet)
		GUICtrlSetBkColor($row, $swecol)
	EndIf
EndFunc ;=> GetSetCorrectLineColor

Func GetSetCurrentStateAfterChanges()
	SetTheColumnWidths()
	;$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
	;$contxtmenu = ""
	;GUICtrlDelete($Menu_list)
	;$lowid = $Item_mode
	;$bigid = $lowid + $nums + 1
	GetLastControlID("delete")
	If $indx <> "" Then $ind = $indx
	If $ind <> -1 Then
		;MsgBox(262192, "$ind", $ind, 0, $PriceQueryGUI)
		;_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, False)
		_GUICtrlListView_EnsureVisible($Listview_ebooks, $ind, False)
		If WinActive($PriceQueryGUI, "") Then
			_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
			_GUICtrlListView_ClickItem($Listview_ebooks, $ind, "left", False, 1, 1)
		Else
			_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, False, True)
		EndIf
	EndIf
EndFunc ;=> GetSetCurrentStateAfterChanges

Func GetTagSettings()
	$alltags = "|"
	$tagreps = "|"
	$value = StringSplit($tags, "|", 1)
	For $v = 1 To $value[0]
		$check = StringSplit($value[$v], ":", 1)
		$tag = $check[1]
		$alltags &= "|" & $tag
		If $check[0] = 2 Then
			$rep = $check[2]
		Else
			$rep = ""
		EndIf
		$tagreps &= "|" & $rep
	Next
	GUICtrlSetData($Combo_tag, $alltags)
EndFunc ;=> GetTagSettings

Func GetTheAuthor()
	; NEW METHOD
	$other = StringStripWS($other, 2)
	If StringRight($other, 1) = ">" Then
		While 1
			While StringRight($other, 1) <> "<"
				$other = StringTrimRight($other, 1)
				If $other = "" Then
					;$author = ""
					ExitLoop
				EndIf
			WEnd
			$other = StringTrimRight($other, 1)
			$other = StringStripWS($other, 2)
			If StringRight($other, 1) <> ">" Then ExitLoop
		WEnd
		If $other <> "" Then
			$other = StringSplit($other, ">", 1)
			If $other[0] > 1 Then
				$other = $other[$other[0]]
				$other = StringStripWS($other, 7)
			Else
				;$author = ""
				$other = ""
			EndIf
		EndIf
	Else
		$other = StringSplit($other, ">", 1)
		If $other[0] > 1 Then
			$other = $other[2]
			If StringInStr($other, "<") > 0 Or StringInStr($other, ">") > 0 Then
				$other = ""
			Else
				$other = StringStripWS($other, 7)
			EndIf
		Else
			;$author = ""
			$other = ""
		EndIf
	EndIf
	If $other <> "" Then
		If $author = "" Then
			$author = $other
		ElseIf StringInStr($author, $other) < 1 Then
			If $author = "(Editors) " Then
				$author = $author & $other
			Else
				$author = $author & " & " & $other
			EndIf
		EndIf
	EndIf
	$author = StringReplace($author, "|", "-")
	;MsgBox(262192, "$author", $author, 0, $PriceQueryGUI)
	; OLD METHOD
;~ 	$other = StringSplit($other, "</a>", 1)
;~ 	$other = $other[1]
;~ 	$other = StringSplit($other, ">", 1)
;~ 	$other = $other[$other[0]]
;~ 	$other = StringStripWS($other, 7)
;~ 	If $author = "" Then
;~ 		$author = $other
;~ 	ElseIf $author = "(Editors) " Then
;~ 		$author = $author & $other
;~ 	Else
;~ 		$author = $author & " & " & $other
;~ 	EndIf
EndFunc ;=> GetTheAuthor

Func GetTheASIN()
	$ASIN = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 2)
	If $user <> "Search" And $user <> "Changed" Then
		If StringInStr($ASIN, "Bought - ") > 0 Then
			GUICtrlSetState($Item_favorite, $GUI_DISABLE)
			GUICtrlSetState($Item_preorder, $GUI_DISABLE)
		Else
			GUICtrlSetState($Item_favorite, $GUI_ENABLE)
			GUICtrlSetState($Item_preorder, $GUI_ENABLE)
		EndIf
	EndIf
	$ASIN = StringReplace($ASIN, "Bought - ", "")
	$ASIN = StringReplace($ASIN, "Favorite - ", "")
	$ASIN = StringReplace($ASIN, "Secondary - ", "")
	$ASIN = StringReplace($ASIN, "Pre-Order - ", "")
EndFunc ;=> GetTheASIN

Func GetValueForPrice($value)
	Local $vals
	$vals = StringReplace($value, "$", "")
	$vals = StringReplace($vals, $csign, "")
	; Obtain dollars and cents (etc)
	$vals = StringSplit($vals, ".")
	; Each dollar is 100 cents, to which existing cents are added.
	If $vals[0] = 2 Then
		$vals = ($vals[1] * 100) + StringLeft($vals[2] & 0, 2)
	Else
		$vals = ($vals[1] * 100)
	EndIf
	Return $vals
EndFunc ;=> GetValueForPrice

Func GetValueSettings()
	$allchars = "||"
	$valreps = "||"
	$value = StringSplit($chars, "|", 1)
	;For $v = 1 To $value[0]
	For $v = 3 To ($value[0] - 1)
		$check = StringSplit($value[$v], ":", 1)
		$val = $check[1]
		;$allchars &= "|" & $val
		$allchars &= $val & "|"
		If $check[0] = 2 Then
			$rep = $check[2]
		Else
			$rep = ""
		EndIf
		;$valreps &= "|" & $rep
		$valreps &= $rep & "|"
	Next
	GUICtrlSetData($Combo_val, $allchars)
EndFunc ;=> GetValueSettings

Func InsertHtmlImage()
	_IENavigate($oIE, $htmfle)
	$oBody = _IETagNameGetCollection($oIE, "body", 0)
	_IEDocInsertHTML($oBody, $image, "afterbegin")
EndFunc ;=> InsertHtmlImage

Func PriceFixAndTabCheck()
	$price = StringStripWS($price, 7)
	If $tabclose = 1 Then
		; $original is either $title or the original title name before editing (renaming).
		;Sleep(1000)
		;$wintit = WinGetTitle("[ACTIVE]", "")
		;Sleep(1000)
		If WinExists("Amazon.com", "") Then
			; Easy Peasie No Problemo unless an unrelated Amazon window or tab is open.
			WinActivate("Amazon.com", "")
			Send("^w")
		Else
			; Sometimes the title of an Amazon Ebook browser tab, does not start with Amazon.com
			If WinExists($original, "") Then
				; Easy Peasie No Problemo.
				WinActivate($original, "")
				Send("^w")
			Else
				; So not so Easy Peasie and may be tricky, with problems where multiple matching tab titles exist.
				; We also may have problems with a very short name (less than three characters).
				If StringLeft($original, 4) = "The " Then
					; Using the first seven characters from ebook title, so something like 'The Cab' will work.
					$wintit = StringLeft($original, 7)
					WinActivate($wintit, "")
					Send("^w")
					; Using the first three characters from ebook title, after removing 'The ', so something like 'Cab' will work.
					$wintit = StringTrimLeft($wintit, 4)
					WinActivate($wintit, "")
					Send("^w")
				Else
					; Using the first four characters from ebook title, so something like 'Barn' will work.
					$wintit = StringLeft($original, 4)
					WinActivate($wintit, "")
					Send("^w")
				EndIf
			EndIf
		EndIf
		Sleep(500)
		;MsgBox(262192, "Active Window", $wintit, 0, $PriceQueryGUI)
	EndIf
EndFunc ;=> PriceFixAndTabCheck

Func QueryCurrentPrice($val)
	;MsgBox(262192, "Error Check 1", "Some Text", 0, $PriceQueryGUI)
	;$ASIN = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 2)
	If $val = 1 Then GetTheASIN()
	$exist = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 2)
	If StringInStr($exist, $ASIN) < 1 Then
		; Selected item and entry being read don't match.
		;GUICtrlSetState($Button_query, $GUI_DISABLE)
		;GUICtrlSetData($Button_query, "WAIT")
		_FileWriteLog($logfile, "QUERY ERROR = " & $ASIN, -1)
		$quit = 1
		MsgBox(262192, "Query Error", _
			"The currently selected ebook item on the list and" & @LF & _
			"the current file entry being read do not match." & @LF & @LF & _
			"This could be a timing error or program bug, etc." & @LF & @LF & _
			"Querying will now stop, so you can try again." & @LF & @LF & _
			"NOTE - A program update is recommended, and" & @LF & _
			"advising the program author. However, this may" & @LF & _
			"be a one off occurence and be unlikely to occur" & @LF & _
			"again or be so very infrequent, that continuing" & @LF & _
			"to use this program version should be fine.", 0, $PriceQueryGUI)
	Else
		;MsgBox(262192, "Error Check 2", "Some Text", 0, $PriceQueryGUI)
		; Selected item and entry being read are same.
		$skipit = IniRead($catfle, $ASIN, "skip", "")
		$paid = IniRead($catfle, $ASIN, "bought", "")
		If $skipit <> 1 And $paid = "" Then
			$lne = $lowid + $ind + 1
			;
;~ 			$title = IniRead($catfle, $ASIN, "title", "")
;~ 			$text = IniRead($catfle, $ASIN, "add_title", "")
;~ 			If $text = "" Then
;~ 				$original = $title
;~ 			Else
;~ 				$original = $text
;~ 			EndIf
;~ 			;
;~ 			$low = IniRead($catfle, $ASIN, "low", "")
;~ 			$high = IniRead($catfle, $ASIN, "high", "")
;~ 			$current = IniRead($catfle, $ASIN, "current", "")
;~ 			;
;~ 			$query = IniRead($catfle, $ASIN, "query", "")
;~ 			$previous = IniRead($catfle, $ASIN, "previous", "")
;~ 			$changes = IniRead($catfle, $ASIN, "changes", "")
;~ 			;
;~ 			IniWrite($querybak, $ASIN, "low", $low)
;~ 			IniWrite($querybak, $ASIN, "high", $high)
;~ 			IniWrite($querybak, $ASIN, "current", $current)
;~ 			IniWrite($querybak, $ASIN, "query", $query)
;~ 			IniWrite($querybak, $ASIN, "previous", $previous)
;~ 			IniWrite($querybak, $ASIN, "changes", $changes)
;~ 			; Get last date & time change
;~ 			$previous = IniRead($catfle, $ASIN, "changed", "")
;~ 			IniWrite($querybak, $ASIN, "changed", $previous)
;~ 			;
			If $list = "" Then
				If $favorites = 1 Then
					$favorite = IniRead($catfle, $ASIN, "favorite", "")
					If $favorite = 1 Then
						$check = 1
					ElseIf $include = 1 Then
						$preorder = IniRead($catfle, $ASIN, "preorder", "")
						If $preorder = 1 Then
							$check = 1
						Else
							$check = ""
						EndIf
					Else
						$check = ""
					EndIf
				ElseIf $secondfavs = 1 Then
					$secondary = IniRead($catfle, $ASIN, "secondary", "")
					If $secondary = 1 Then
						$check = 1
					Else
						$check = ""
					EndIf
				ElseIf $first <> "" Then
					If $first = $ASIN Then
						If $end = $first Then $end = 1
						$first = ""
						;GUICtrlSetState($Item_start, $GUI_UNCHECKED)
						If $others = 1 Then
							CheckForNonFavorite()
						Else
							$check = 1
						EndIf
					Else
						$check = ""
					EndIf
				ElseIf $end <> "" Then
					If $end = $ASIN Then
						$end = 1
					Else
						If $others = 1 Then
							CheckForNonFavorite()
						Else
							$check = 1
						EndIf
					EndIf
				ElseIf $others = 1 Then
					CheckForNonFavorite()
				Else
					$check = 1
				EndIf
			Else
				If StringInStr($list, $ASIN) > 0 Then
					$check = 1
				Else
					$check = ""
				EndIf
			EndIf
			If $check = 1 Or $end = 1 Then
				;MsgBox(262192, "Error Check 3", "Some Text", 0, $PriceQueryGUI)
				If $end = 1 And $others = 1 Then
					CheckForNonFavorite()
					If $check = "" Then Return
				EndIf
				;
				; Relocated Section (due to unnecessary checking of entries that may be skipped) - 10 March 2016.
				$title = IniRead($catfle, $ASIN, "title", "")
				$text = IniRead($catfle, $ASIN, "add_title", "")
				If $text = "" Then
					$original = $title
				Else
					$original = $text
				EndIf
				;
				$low = IniRead($catfle, $ASIN, "low", "")
				$high = IniRead($catfle, $ASIN, "high", "")
				$last = IniRead($catfle, $ASIN, "last", "")
				$current = IniRead($catfle, $ASIN, "current", "")
				;
				If $quall = 4 And $list = "" Then
					; Fix for bad price entry.
					$digit = CheckIfOnlyDigits($low)
					If $digit = 0 Then
						$low = ""
					EndIf
					$digit = CheckIfOnlyDigits($high)
					If $digit = 0 Then
						$high = ""
					EndIf
					$digit = CheckIfOnlyDigits($current)
					If $digit = 0 Then
						$current = ""
					EndIf
					If $low = "" Or $high = "" Or $current = "" Then
						$start = IniRead($catfle, $ASIN, "start", "")
						$curr = StringLeft($price, 1)
						If $backup = 1 Then
							; Attempt to get a good restore price from a backup.
							Local $bakfle, $bdate, $ndate, $newest, $nmb, $odate, $oldest, $passon, $skipon
							$skipon = 1
							$passon = ""
							$oldest = ""
							$newest = $backups & "\" & $user & "_1.bak"
							$ndate = FileGetTime($newest, 0, 1)
							For $nmb = 1 To 5
								$bakfle = $backups & "\" & $user & "_" & $nmb & ".bak"
								$bdate = FileGetTime($bakfle, 0, 1)
								If $bdate > $ndate Then
									If $oldest = "" Then
										$oldest = $newest
									Else
										$odate = FileGetTime($oldest, 0, 1)
										If $ndate < $odate Then
											$oldest = $newest
										EndIf
									EndIf
									$newest = $bakfle
									$ndate = $bdate
									$skipon = $nmb
								ElseIf $bdate < $ndate Then
									If $oldest = "" Then
										$oldest = $bakfle
									Else
										$odate = FileGetTime($oldest, 0, 1)
										If $bdate < $odate Then
											$oldest = $bakfle
										EndIf
									EndIf
								EndIf
							Next
							$odate = FileGetTime($oldest, 0, 1)
							While 1
								If $low = "" Then
									$low = IniRead($newest, $ASIN, "low", "")
									$digit = CheckIfOnlyDigits($low)
									If $digit = 0 Then
										$low = ""
									Else
										IniWrite($catfle, $ASIN, "low", $low)
									EndIf
								EndIf
								If $high = "" Then
									$high = IniRead($newest, $ASIN, "high", "")
									$digit = CheckIfOnlyDigits($high)
									If $digit = 0 Then
										$high = ""
									Else
										IniWrite($catfle, $ASIN, "high", $high)
									EndIf
								EndIf
								If $last = "" Then
									$last = IniRead($newest, $ASIN, "last", "")
									$digit = CheckIfOnlyDigits($last)
									If $digit = 0 Then
										$last = ""
									Else
										IniWrite($catfle, $ASIN, "last", $last)
									EndIf
								EndIf
								If $current = "" Then
									$current = IniRead($newest, $ASIN, "current", "")
									$digit = CheckIfOnlyDigits($current)
									If $digit = 0 Then
										$current = ""
									Else
										IniWrite($catfle, $ASIN, "current", $current)
									EndIf
								EndIf
								If $low <> "" And $high <> "" And $last <> "" And $current <> "" Then
									; All prices restored
									MsgBox(262192, "Restore Advice", "Price(s) were restored from a good backup!", 0, $PriceQueryGUI)
									ExitLoop
								ElseIf StringLen($passon) = 5 Then
									; No suitable backup to restore from.
									If $low = "" Then
										$low = $curr & "0.00"
										IniWrite($catfle, $ASIN, "low", $low)
									EndIf
									If $high = "" Then
										$high = $curr & "0.00"
										IniWrite($catfle, $ASIN, "high", $high)
									EndIf
									If $last = "" Then
										$last = $curr & "0.00"
										IniWrite($catfle, $ASIN, "last", $last)
									EndIf
									If $current = "" Then
										$current = $curr & "0.00"
										IniWrite($catfle, $ASIN, "current", $current)
									EndIf
									MsgBox(262192, "Restore Advice (1)", "Price(s) were restored to " & $curr & "0.00!", 0, $PriceQueryGUI)
									ExitLoop
								Else
									; Try the next newest backup.
									$passon = $passon & $skipon
									For $nmb = 1 To 5
										If StringInStr($passon, $nmb) < 1 Then
											$bakfle = $backups & "\" & $user & "_" & $nmb & ".bak"
											$bdate = FileGetTime($bakfle, 0, 1)
											If $bdate > $odate Then
												$newest = $bakfle
												$ndate = $bdate
												$skipon = $nmb
											EndIf
										EndIf
									Next
								EndIf
							WEnd
						Else
							; No backup to restore from.
							If $low = "" Then
								$low = $curr & "0.00"
								IniWrite($catfle, $ASIN, "low", $low)
							EndIf
							If $high = "" Then
								$high = $curr & "0.00"
								IniWrite($catfle, $ASIN, "high", $high)
							EndIf
							If $last = "" Then
								$last = $curr & "0.00"
								IniWrite($catfle, $ASIN, "last", $last)
							EndIf
							If $current = "" Then
								$current = $curr & "0.00"
								IniWrite($catfle, $ASIN, "current", $current)
							EndIf
							MsgBox(262192, "Restore Advice (2)", "Price(s) were restored to " & $curr & "0.00!", 0, $PriceQueryGUI)
						EndIf
					EndIf
				EndIf
				;
				$query = IniRead($catfle, $ASIN, "query", "")
				$previous = IniRead($catfle, $ASIN, "previous", "")
				If $prices = 1 Then
					$prcfle = $pricefld & "\" & $ASIN & ".txt"
					If FileExists($prcfle) Then
						$changes = FileRead($prcfle)
					Else
						$changes = IniRead($catfle, $ASIN, "changes", "")
					EndIf
				Else
					$changes = IniRead($catfle, $ASIN, "changes", "")
				EndIf
				;
				IniWrite($querybak, $ASIN, "low", $low)
				IniWrite($querybak, $ASIN, "high", $high)
				IniWrite($querybak, $ASIN, "last", $last)
				IniWrite($querybak, $ASIN, "current", $current)
				IniWrite($querybak, $ASIN, "query", $query)
				IniWrite($querybak, $ASIN, "previous", $previous)
				IniWrite($querybak, $ASIN, "changes", $changes)
				; Get last date & time change
				$previous = IniRead($catfle, $ASIN, "changed", "")
				IniWrite($querybak, $ASIN, "changed", $previous)
				; Relocated Section - End Of
				;
				If $wipe <> "" Then
					$prev = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 8)
					If StringInStr($prev, "*") > 0 Or StringInStr($prev, "#") > 0 Then
						$prev = StringReplace($prev, "*", "")
						$prev = StringReplace($prev, "#", "")
						_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $prev, 8)
						If IsInt($lne / 2) = 1 Then
							; Pale Green (alternate odd number lines)
							GUICtrlSetBkColor($lne, 0xC0F0C0)
						Else
							; Pale Pink (alternate even number lines)
							GUICtrlSetBkColor($lne, 0xF0D0F0)
						EndIf
						If $wipe = 2 Then IniDelete($usertmp, $ASIN)
					EndIf
				EndIf
				;
				$prior = ""
				$price = ""
				; Get last recorded price.
				$last = $current
				$prev = $current
				$prevval = GetValueForPrice($prev)
				$URL = IniRead($catfle, $ASIN, "url", "")
				If $mode = "manual" Then
					SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
					If $connection = 1 And $test <> 1 Then ShellExecute($URL)
					$win = "Manually Add Price"
					SetWinOnTop()
					Sleep(1000)
					SplashOff()
					$price = InputBox($win, "Copy the price from web page &&" & @LF & "paste into the input field below." & @LF & @LF & $original, $current, "", 200, 175, 10, 30, 0, $PriceQueryGUI)
					If @error <> 0 Or $price = "" Then
						If $timer = 1 Then GetQueryTimeTaken()
						$quit = 1
						$price = ""
						Return
					Else
						PriceFixAndTabCheck()
					EndIf
				ElseIf $mode = "semi-auto" Then
					SplashTextOn("", "Please Wait!" & @LF & "(Item " & $ind + 1 & ")" & @LF & StringLeft($title, 22) & " ..." & @LF & "(" & $current & ")", 230, 140, -1, -1, 33)
					If $browser <> "" And $started = 1 Then
						If ProcessExists($browser) Then
							$started = ""
							Sleep($onedel * 1000)
						EndIf
					EndIf
					If $connection = 1 And $test <> 1 Then ShellExecute($URL)
					If $started = 1 Then
						$started = ""
						Sleep($browdel * 1000)
					Else
						Sleep($tabdel * 1000)
						If $moredel > 0 Then Sleep($moredel)
					EndIf
					; Store current clipboard text and then clear clipboard.
					$cliptxt = ClipGet()
					ClipPut("")
					$repeat = ""
					While 1
						If $activate = 1 Then TryToActivateAmazonTab()
						; Highlight all webpage text.
						Send("^a")
						Sleep($copywait)
						; Copy highlighted text.
						Send("^c")
						; Store webpage text.
						Sleep($copywait)
						$noprice = ""
						$webtxt = ClipGet()
						If $webtxt <> "" Then
							_FileCreate($webfle)
							_FileWriteToLine($webfle, 1, $webtxt, 1)
							;
							$kindtxt = StringSplit($webtxt, "Kindle Price:", 1)
							If $kindtxt[0] > 1 Then
								; Regular instance of price found.
								$pricetxt = $kindtxt[2]
							Else
								$kindtxt = StringSplit($webtxt, "Pre-order Price:", 1)
								If $kindtxt[0] > 1 Then
									; Pre-order instance of price found.
									$pricetxt = $kindtxt[2]
								Else
									$kindtxt = StringSplit($webtxt, "Kindle Price :", 1)
									If $kindtxt[0] > 1 Then
										; Irregular instance of price found.
										$pricetxt = $kindtxt[2]
									Else
										$kindtxt = StringSplit($webtxt, "Pre-order Price :", 1)
										If $kindtxt[0] > 1 Then
											; Irregular instance of Pre-order price found.
											$pricetxt = $kindtxt[2]
										Else
											$kindtxt = StringSplit($webtxt, ">Kindle<", 1)
											If $kindtxt[0] > 1 Then
												; New Amazon instance of price found.
												$pricetxt = $kindtxt[2]
											Else
												; No instance of price found.
												$pricetxt = ""
												$webtxt = ""
											EndIf
										EndIf
									EndIf
								EndIf
							EndIf
							If $pricetxt = "" And StringLen($current) = 5 And StringRight($current, 4) = "0.00" Then
								$noprice = 1
							EndIf
							If $noprice = "" Then
								If $webtxt <> "" Then
									; Check for more than one instance of price and continue.
									If $kindtxt[0] > 2 Then
										; More than one instance of price found.
										$win = "Manually Add Price"
										SetWinOnTop()
										Sleep(1000)
										SplashOff()
										$price = InputBox($win, "Copy the price from web page &&" & @LF & "paste into the input field below." & @LF & @LF & $original, $current, "", 200, 175, 10, 30, 0, $PriceQueryGUI)
										If @error <> 0 Or $price = "" Then
											$webtxt = ""
										EndIf
									Else
										; Only one instance of price found.
										; Get text with title.
										$titletxt = $pricetxt
										; Strip some unwanted elements in price text.
										$pricetxt = StringSplit($pricetxt, @CRLF, 1)
										If $pricetxt[0] > 1 Then
											; Strip remaining unwanted elements in price text.
											$pricetxt = StringStripWS($pricetxt[1], 3)
											$pricetxt = StringSplit($pricetxt, " ", 1)
											$price = $pricetxt[1]
											;
											If $titlecheck = 1 Then
												; Strip unwanted elements in title text to do a comparison.
												$titletxt = StringSplit($titletxt, "Kindle Edition", 1)
												; Get preceeding text.
												$titletxt = $titletxt[1]
												; Get text after last carriage return.
												$titletxt = StringSplit($titletxt, @CRLF, 1)
												If $titletxt[0] > 1 Then
													$titletxt = $titletxt[$titletxt[0]]
													; Strip leading and trailing whitespace
													$titletxt = StringStripWS($titletxt, 3)
													If $titletxt = "" Then
														$webtxt = ""
													Else
														; $original = $title unless $title was renamed.
														If $titletxt <> $original Or $titletxt <> $title Then
															If StringInStr($titletxt, $original) < 1 And StringInStr($titletxt, $title) < 1 Then
																If StringInStr($original, $titletxt) < 1 And StringInStr($title, $titletxt) < 1 Then
																	If StringLeft($titletxt, 4) = "The " Then
																		$titletxt = StringTrimLeft($titletxt, 4)
																		If StringInStr($original, $titletxt) < 1 And StringInStr($title, $titletxt) < 1 Then
																			$webtxt = ""
																		EndIf
																	EndIf
																EndIf
															EndIf
														EndIf
													EndIf
												Else
													$webtxt = ""
													MsgBox(262192, "Error Check", "Failed to split on carriage return for title.", 0, $PriceQueryGUI)
												EndIf
											EndIf
										Else
											$webtxt = ""
											MsgBox(262192, "Error Check", "Failed to split on carriage return for price.", 0, $PriceQueryGUI)
										EndIf
									EndIf
								EndIf
							EndIf
						EndIf
						SplashOff()
						;
						If $webtxt = "" And $noprice = "" Then
							; Price wasn't found or problem with ebook title.
							If $timer = 1 Then GetQueryTimeTaken()
							;
							If $failed = "" Then
								$failed = 1
								_FileWriteLog($failtxt, "The following are ebooks where Price Query failed.")
							EndIf
							;
							If $price <> "" Then
								_FileWriteLog($failtxt, "(title match failed) " & $title)
								MsgBox(262192, "Price Or Title Error", _
									"It appears as though the program had a problem" & @LF & _
									"matching titles with the currently selected ebook." & @LF & @LF & _
									"This could be due to the page layout by Amazon" & @LF & _
									"because they have made changes, or because" & @LF & _
									"the ebook has been renamed or another textual" & @LF & _
									"issue." & @LF & @LF & _
									"See the next dialog for options, but manual mode" & @LF & _
									"may be required for the currently selected ebook." & @LF & @LF & _
									"(dialog auto-closes in 30 seconds)", 30, $PriceQueryGUI)
							Else
								_FileWriteLog($failtxt, "(get price failed) " & $title)
							EndIf
							$price = ""
							Local $magnum
							If $repeat = "" Then
								; Default button is to Try Again.
								$magnum = 262454
								;
								If $extra = 1 Then
									$moredel = $moredel + ($exdel * 1000)
								EndIf
							ElseIf $repeat = 1 Then
								; Default button is to Continue.
								$magnum = 262710
								$repeat = ""
							Else
								$magnum = 262193
							EndIf
							$ans = MsgBox($magnum, "Price Error", _
								"(the default button will be the response in 50 seconds)" & @LF & @LF & _
								"The program could not determine the price of currently selected ebook." & @LF & @LF & _
								$original & @LF & @LF & _
								"This could be due to slow browser start (if first ebook) or slow tab load" & @LF & _
								"for other ebooks in a Query ALL. So adjust your settings and try again." & @LF & @LF & _
								"Or a price may not exist or Amazon have changed something or made" & @LF & _
								"an error in their page text - extra space(s) etc. If you definitely know" & @LF & _
								"that a price exists for the current ebook, then using 'manual' mode will" & @LF & _
								"be needed to overcome whatever issue there is." & @LF & @LF & _
								"NOTE - If shown 'Manually Add Price' then multiple prices were found." & @LF & @LF & _
								"CANCEL = Abort any Query ALL  (or Stop)." & @LF & _
								"TRY AGAIN = Make a second attempt at current ebook." & @LF & _
								"CONTINUE = Move on to the next listed ebook  (or Stop).", 50, $PriceQueryGUI)
							If $ans = -1 Then
								; Timeout was reached.
								If $magnum = 262454 Then
									; Try Again is default button.
									$ans = 10
								ElseIf $magnum = 262710 Then
									; Continue is default button.
									$ans = 11
								EndIf
							EndIf
							If $ans = 2 Then
								; Cancel was clicked.
								$quit = 1
							ElseIf $ans = 10 Then
								; Try Again was clicked.
								$repeat = 1
								$copywait = $copywait + 1000
								SplashTextOn("", "Please Wait!" & @LF & "(Item " & $ind + 1 & ")" & @LF & StringLeft($title, 22) & " ..." & @LF & "(" & $current & ")", 230, 140, -1, -1, 33)
							ElseIf $ans = 11 Then
								; Continue was clicked.
								; Close current browser tab.
								PriceFixAndTabCheck()
							EndIf
							;Return
						Else
							; Process the price found.
							PriceFixAndTabCheck()
							If $repeat = 1 Then
								$repeat = ""
								_FileWriteLog($failtxt, "(success on repeat) " & $title)
							EndIf
						EndIf
						;
						If $repeat = "" Then ExitLoop
					WEnd
					;
					; Restore clipboard text to original.
					ClipPut($cliptxt)
				ElseIf $mode = "automatic" Then
					IniWrite($inifle, "Time Taken", "4_mode", _NowTime(5))
					;MsgBox(262192, "Error Check 4", "Some Text", 0, $PriceQueryGUI)
					If $timer = 1 Then GetQueryTimeTaken()
					If $pause = 1 And $delay > 0 Then
						If $ind > 0 And $ind > $selected Then
							; Sleep is now split up to make a smoother time display
							; plus a quicker WAIT shown for STOP response.
							If $random = 1 Then
								; RANDOM DELAY
								;Sleep(Random(0, $delay, 1) * 1000)
								; Integer
								;$sleep = Random(0, $delay, 1)
								; One Decimal Point (changed to for greater variation)
								$sleep = Random(0, $delay)
								$sleep = Round($sleep, 1)
								;Sleep($sleep * 1000)
								$ceiling = Ceiling($sleep)
								For $d = 1 To $ceiling
									If $d = $ceiling Then
;~ 										$sleep = $sleep - 1
;~ 										Sleep($sleep * 1000)
										$sleep = $ceiling - $sleep
										If $sleep < 1 Then
											Sleep($sleep * 1000)
										Else
											Sleep(1000)
										EndIf
									Else
;~ 										Sleep(500)
;~ 										Sleep(500)
										Sleep(1000)
									EndIf
									If $timer = 1 Then GetQueryTimeTaken()
								Next
							Else
								; SET DELAY
								;Sleep($delay * 1000)
								For $d = 1 To $delay
									;Sleep(1000)
									Sleep(500)
									If $timer = 1 Then GetQueryTimeTaken()
									Sleep(500)
								Next
							EndIf
							IniWrite($inifle, "Time Taken", "5_delay", _NowTime(5))
						EndIf
					EndIf
					;
					Local $etxt = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 1)
					Local $auth = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 3)
					; About 10 seconds to get source (for me), during which time the timer doesn't get updated.
					; (This of course varies due to quality of connection at the time.)
					$html = _INetGetSource($URL)
					If @error <> 1 Then
						IniWrite($inifle, "Time Taken", "6_getsource", _NowTime(5))
						If $timer = 1 Then GetQueryTimeTaken()
						;MsgBox(262192, "Error Check 5", "Some Text", 0, $PriceQueryGUI)
						$html = StringStripWS($html, 7)
						;
						; About 7 seconds to save HTML (for me), during which time the timer doesn't get updated.
						; HTML is written to Query.txt file for error checking if need be.
						_FileWriteToLine($querytxt, 1, $html, 1)
						IniWrite($inifle, "Time Taken", "7_savehtml", _NowTime(5))
						If StringInStr($html, "Kindle Price:") > 0 Then
							$price = StringSplit($html, "Kindle Price:", 1)
						ElseIf StringInStr($html, "Pre-order Price:") > 0 Then
							$price = StringSplit($html, "Pre-order Price:", 1)
						Else
							$price = StringSplit($html, ">Kindle<", 1)
						EndIf
						If $price[0] > 1 Then
							$html = $price[2]
							$pos = StringInStr($html, "</b>")
							If $pos > 0 Then
								$price = StringLeft($html, $pos - 1)
							Else
								$pos = StringInStr($html, "</tr>")
								If $pos > 0 Then
									$price = StringLeft($html, $pos - 1)
								Else
									$price = ""
								EndIf
							EndIf
							;MsgBox(262192, "Error Check 1", "Price = " & $price, 0, $PriceQueryGUI)
							; NEW METHOD
;~ 							Local $calc = _NowCalc()
;~ 							Local $trim = 0, $calc2
;~ 							IniWrite($inifle, "Time Taken", $trim, $calc)
							While 1
								$check = StringLeft($price, 1)
								If $check = "$" Or $check = $csign Then
									$price = StringSplit($price, "<", 1)
									$price = $price[1]
									$price = StringStripWS($price, 7)
									If $timer = 1 Then GetQueryTimeTaken()
									ExitLoop
								Else
									$price = StringTrimLeft($price, 1)
									If $price = "" Then
										$errors = $errors + 1
										If $timer = 1 Then GetQueryTimeTaken()
										_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current & "#", 8)
										_FileWriteLog($logfile, "Price Failed = " & $ASIN, -1)
										_FileWriteLog($logfile, "Title = " & $etxt, -1)
										_FileWriteLog($logfile, "Author = " & $auth, -1)
										; Red (error)
										GUICtrlSetBkColor($lne, $errcol)
										IniWrite($usertmp, $ASIN, "error", 1)
										;$title = "Bobo the clown"
										MsgBox(262192, "Price Missing", "The ebook's 'Price' could not be determined!" & @LF & @LF & _
											$title & @LF & @LF & "(auto continue in 6 seconds)", $wait, $PriceQueryGUI)
										ExitLoop
;~ 									Else
;~ 										If $timer = 1 Then
;~ 											$trim = $trim + 1
;~ 											If StringRight($trim, 1) = 0 Then
;~ 												IniWrite($inifle, "Time Taken", "price_trim", $trim)
;~ 												$calc2 = _NowCalc()
;~ 												;If _DateDiff("s", $calc, $calc2) > 1 Then
;~ 													IniWrite($inifle, "Time Taken", $trim, $calc2)
;~ 													;$calc = $calc2
;~ 													GetQueryTimeTaken()
;~ 												;EndIf
;~ 											EndIf
;~ 										EndIf
									EndIf
								EndIf
							WEnd
							;MsgBox(262192, "Error Check 2", "Price = " & $price, 0, $PriceQueryGUI)
						ElseIf StringInStr($html, ">eTextbook<") > 0 Then
							$html = StringSplit($html, ">eTextbook<", 1)
							$html = $html[2]
							$html = StringSplit($html, "</span>", 1)
							$html = $html[1]
							;MsgBox(262192, "Error Check A", "Price = " & $html, 0, $PriceQueryGUI)
							$html = StringSplit($html, ">", 1)
							$price = $html[$html[0]]
							;MsgBox(262192, "Error Check B", "Price = " & $price, 0, $PriceQueryGUI)
							$price = StringStripWS($price, 7)
							$check = StringLeft($price, 1)
							If $check = "$" Or $check = $csign Then
								If $timer = 1 Then GetQueryTimeTaken()
							Else
								$price = ""
								$errors = $errors + 1
								If $timer = 1 Then GetQueryTimeTaken()
								_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current & "#", 8)
								_FileWriteLog($logfile, "Price Failed = " & $ASIN, -1)
								_FileWriteLog($logfile, "Title = " & $etxt, -1)
								_FileWriteLog($logfile, "Author = " & $auth, -1)
								; Red (error)
								GUICtrlSetBkColor($lne, $errcol)
								IniWrite($usertmp, $ASIN, "error", 1)
								MsgBox(262192, "Price Missing", "The ebook's 'Price' could not be determined!" & @LF & @LF & _
									$title & @LF & @LF & "(auto continue in 6 seconds)", $wait, $PriceQueryGUI)
							EndIf
						Else
							If $timer = 1 Then GetQueryTimeTaken()
							If StringLen($prev) = 5 And StringRight($prev, 4) = "0.00" Then
								; Skip due to no change.
							Else
								$errors = $errors + 1
;~ 								_FileWriteToLine($querytxt, 1, $html, 1)
								_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current & "#", 8)
								_FileWriteLog($logfile, "Price Failed = " & $ASIN, -1)
								_FileWriteLog($logfile, "Title = " & $etxt, -1)
								_FileWriteLog($logfile, "Author = " & $auth, -1)
								; Red (error)
								GUICtrlSetBkColor($lne, $errcol)
								IniWrite($usertmp, $ASIN, "error", 1)
								;MsgBox(262192, "Read Error", "The 'Price' could not be determined!", 0, $PriceQueryGUI)
								MsgBox(262192, "Price Error", "The ebook's 'Price' could not be determined!" & @LF & @LF & _
									$title & @LF & @LF & "(auto continue in 6 seconds)", $wait, $PriceQueryGUI)
							EndIf
						EndIf
					Else
						$errors = $errors + 1
						If $timer = 1 Then GetQueryTimeTaken()
						; Perhaps at some point, have the error recorded as well and shown at finish.
						_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current & "#", 8)
						_FileWriteLog($logfile, "Query Failed (URL) = " & $ASIN, -1)
						_FileWriteLog($logfile, "Title = " & $etxt, -1)
						_FileWriteLog($logfile, "Author = " & $auth, -1)
						; Red (error)
						GUICtrlSetBkColor($lne, $errcol)
						IniWrite($usertmp, $ASIN, "error", 1)
						;MsgBox(262192, "Read Error", "The Web Page may no longer exist!", 0, $PriceQueryGUI)
						MsgBox(262192, "Read Error", "The Web Page may no longer exist!" & @LF & @LF & _
							$title & @LF & @LF & "(auto continue in 6 seconds)", $wait, $PriceQueryGUI)
					EndIf
					If $kobocheck = 1 Then
						; Check for URL
						$kobo = IniRead($catfle, $ASIN, "kobo_url", "")
						If $kobo <> "" Then
							IniWrite($inifle, "Kobo", "start", _NowTime(5))
							$kobofle = @ScriptDir & "\Kobo.html"
							_FileCreate($kobofle)
							$html = _INetGetSource($kobo)
							If @error <> 1 Then
								$html = StringStripWS($html, 7)
								_FileWriteToLine($kobofle, 1, $html, 1)
							Else
								$html = ""
							EndIf
							Local $kobochk = ""
							IniWrite($inifle, "Kobo", "finish", _NowTime(5))
							If $html <> "" Then
								$cost = StringSplit($html, '<span class="price">', 1)
								If $cost[0] > 1 Then
									$cost = $cost[2]
									$cost = StringSplit($cost, '</span>', 1)
									$cost = $cost[1]
									$cost = StringStripWS($cost, 8)
									$check = StringReplace($cost, "$", "")
									$check = StringReplace($check, $csign, "")
									$check = StringReplace($check, ".", "")
									If StringIsDigit($check) = 0 Then $cost = ""
								Else
									$cost = ""
								EndIf
								If $cost <> "" Then
									; Get last saved price
									$prior = IniRead($catfle, $ASIN, "kobo_price", "")
									If $cost <> $prior Then
										; Update
										IniWrite($catfle, $ASIN, "kobo_price", $cost)
										If $prior <> "" Then
											; Backup
											IniWrite($catfle, $ASIN, "kobo_prior", $prior)
											$prior = GetValueForPrice($prior)
											$check = GetValueForPrice($cost)
											If $prior < $check Then
												; Latest price is more
												GUICtrlSetColor($lne, 0x800000)
												$kobochk = "Price (more) = " & $cost
											Else
												; Latest price is less
												GUICtrlSetColor($lne, $COLOR_BLUE)
												$kobochk = "Price (less) = " & $cost
											EndIf
										Else
											; Price now exists
											GUICtrlSetColor($lne, $COLOR_BLACK)
											$kobochk = "Price (first) = " & $cost
										EndIf
									Else
										; Price is unchanged
										GUICtrlSetColor($lne, $COLOR_BLACK)
									EndIf
								Else
									; Getting price failed
									GUICtrlSetColor($lne, 0x008000)
									$kobochk = "Price Failed."
								EndIf
							Else
								; Downloading web page failed
								GUICtrlSetColor($lne, 0x9000F0)
								$kobochk = "Price Failed (URL)."
							EndIf
							If $kobochk <> "" Then
								_FileWriteLog($logfile, "Kobo Query = " & $ASIN, -1)
								_FileWriteLog($logfile, $kobochk, -1)
							EndIf
						EndIf
					EndIf
				EndIf
				IniWrite($inifle, "Time Taken", "8_getprice", _NowTime(5))
				;
				$start = IniRead($catfle, $ASIN, "start", "")
				If $price <> "" And $start = "" Then
					;MsgBox(262192, "Error Check 3", "Price = " & $price, 0, $PriceQueryGUI)
					StoreInitialPrices()
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $start, 4)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $low, 5)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $high, 6)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $last, 7)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current, 8)
					_FileWriteLog($logfile, "Query = " & $ASIN, -1)
					_FileWriteLog($logfile, "Title = " & $etxt, -1)
					_FileWriteLog($logfile, "Author = " & $auth, -1)
					_FileWriteLog($logfile, "Price (start) = " & $start, -1)
				Else
					;MsgBox(262192, "Error Check 4", "Price = " & $price, 0, $PriceQueryGUI)
					$digit = CheckIfOnlyDigits($price)
					If $digit = 0 Then
						$price = ""
						MsgBox(262192, "Price Error", "The ebook's 'Price' could not be determined!" & @LF & @LF & _
							$title & @LF & @LF & "(auto continue in 6 seconds)", $wait, $PriceQueryGUI)
					EndIf
					$curr = StringLeft($price, 1)
					If $price <> "" And ($curr = "$" Or $curr = $csign) Then
						;MsgBox(262192, "Error Check 5", "Price = " & $price, 0, $PriceQueryGUI)
						$current = $price
						; Record the Date & Time of Query for selected ebook.
						IniWrite($catfle, $ASIN, "query", _Now())
						If $current <> $prev Then
							; Price has changed.
							;IniWrite($catfle, $ASIN, "last", $prev)
							IniWrite($catfle, $ASIN, "last", $last)
							_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $last, 7)
							If $flash = 1 Then
								$altered = $altered + 1
								GUICtrlSetData($Label_wait, "Please Wait   -   " & $altered & " changed")
							EndIf
							; Update to new price for current.
							IniWrite($catfle, $ASIN, "current", $current)
							; Update the list to show price has changed. This change is additionally indicated in Column 8
							; by a non permanent asterisk, which is lost after a sort, program start, etc.
							_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current & "*", 8)
							_FileWriteLog($logfile, "Query = " & $ASIN, -1)
							_FileWriteLog($logfile, "Title = " & $etxt, -1)
							_FileWriteLog($logfile, "Author = " & $auth, -1)
							;GUICtrlSetBkColor($lne, $lescol)
							;IniWrite($usertmp, $ASIN, "changed", 1)
							;
							$curr = StringLeft($current, 1)
							; Get a return for value as cents.
							$currval = GetValueForPrice($current)
							CheckIfSweet()
							; Get a return for value as cents.
							$lowval = GetValueForPrice($low)
							$num = StringRight("000" & $ind + 1, 4)
							If $currval < $lowval Then
								; Current value is less than lowest recorded value.
								_FileWriteLog($logfile, "Price (low) = " & $current, -1)
								; Set the Current value as new lowest recorded value.
								$low = $current
								IniWrite($catfle, $ASIN, "low", $low)
								; Set last date & time change as previous.
								IniWrite($catfle, $ASIN, "previous", $previous)
								; Set current date & time for changed.
								IniWrite($catfle, $ASIN, "changed", _Now())
								; Update the list to show new low value.
								_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current, 5)
								; Update the list to show a price change has occurred for that entry since the ebook was added.
								; There is no notable visual change, if the price has changed previously. This change, will be
								; reflected permanently by an asterisk in Column 1 after the entry number, unless same again.
								_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $num & "*", 0)
								;GUICtrlSetBkColor($lne, $lescol)
								; Get the price difference in cents.
								$result = $lowval - $currval
								If $sweetval = "" Then
									If $result > $alert Then
										; Green (major less)
										GUICtrlSetBkColor($lne, $lescol)
									Else
										; Blue (0x00A0F0)
										; Yellow (minor)
										GUICtrlSetBkColor($lne, $mincol)
									EndIf
								Else
									; White (sweet)
									GUICtrlSetBkColor($lne, $swecol)
								EndIf
								IniWrite($usertmp, $ASIN, "changed", $result)
								; Change price difference value to dollars and cents & create a Report entry.
								GetPriceDifferenceResult()
								GetDifferenceToLastPrice()
								$report = $report & $title & " (lower than lowest by " & $curr & $result & ") (" & $dif & " than last by " & $curr & $differ & ")" & @LF
								;$report = $report & $title & " (lower by " & $curr & $result & ")" & @LF
								If $record = 1 And $store = 1 Then
									; If enabled, add as a price change record for ebook.
									GetAllChanges()
									$changes &= $low & " (" & $curr & $result & " lower) " & $now & " (Lowest) " & $curr & $differ & " " & $dif  & " than last change."
									;$changes &= $low & " (" & $curr & $result & " lower) " & $now & " (Lowest)"
									If $prices = 1 Then
										_FileCreate($prcfle)
										FileWrite($prcfle, $changes)
									Else
										IniWrite($catfle, $ASIN, "changes", $changes)
									EndIf
								EndIf
							Else
								; Current value is greater or equal to lowest recorded value.
								CheckIfLowIsZero()
								; Get a return for value as cents.
								$highval = GetValueForPrice($high)
								If $currval > $highval Then
									; Current value is higher than highest recorded value.
									_FileWriteLog($logfile, "Price (high) = " & $current, -1)
									; Set the Current value as new highest recorded value.
									$high = $current
									IniWrite($catfle, $ASIN, "high", $high)
									; Set last date & time change as previous.
									IniWrite($catfle, $ASIN, "previous", $previous)
									; Set current date & time for changed.
									IniWrite($catfle, $ASIN, "changed", _Now())
									; Update the list to show new high value.
									_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current, 6)
									; Update the list to show a price change has occurred for that entry since the ebook was added.
									; There is no notable visual change, if the price has changed previously. This change, will be
									; reflected permanently by an asterisk in Column 1 after the entry number, unless same again.
									_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $num & "*", 0)
									;GUICtrlSetBkColor($lne, $lescol)
									$result = $currval - $highval
									If $sweetval = "" Then
										If $result > $alert Then
											; Orange (major more)
											GUICtrlSetBkColor($lne, $morcol)
										Else
											; Blue (0x00A0F0)
											; Yellow (minor)
											GUICtrlSetBkColor($lne, $mincol)
										EndIf
									Else
										; White (sweet)
										GUICtrlSetBkColor($lne, $swecol)
									EndIf
									IniWrite($usertmp, $ASIN, "changed", "-" & $result)
									; Change price difference value to dollars and cents & create a Report entry.
									GetPriceDifferenceResult()
									GetDifferenceToLastPrice()
									$report = $report & $title & " (higher than highest by " & $curr & $result & ") (" & $dif & " than last by " & $curr & $differ & ")" & @LF
									;$report = $report & $title & " (higher by " & $curr & $result & ")" & @LF
									If $record = 1 And $store = 1 Then
										; If enabled, add as a price change record for ebook.
										GetAllChanges()
										$changes &= $high & " (" & $curr & $result & " higher) " & $now & " (Highest) " & $curr & $differ & " " & $dif  & " than last change."
										;$changes &= $high & " (" & $curr & $result & " higher) " & $now & " (Highest)"
										If $prices = 1 Then
											_FileCreate($prcfle)
											FileWrite($prcfle, $changes)
										Else
											IniWrite($catfle, $ASIN, "changes", $changes)
										EndIf
									EndIf
								ElseIf $currval <> $highval And $currval <> $lowval Then
									; MISSING SECTION - added 9th February 2015.
									; Current value is greater than lowest recorded value, but lower than highest recorded value.
									; Get last date & time change and set as previous.
									; Get a return for value as cents.
									;$prevval = GetValueForPrice($prev)
									If $currval <> $prevval Then
										; Set last date & time change as previous.
										IniWrite($catfle, $ASIN, "previous", $previous)
										; Set current date & time for changed.
										IniWrite($catfle, $ASIN, "changed", _Now())
										; Update the list to show a price change has occurred for that entry since the ebook was added.
										; There is no notable visual change, if the price has changed previously. This change, will be
										; reflected permanently by an asterisk in Column 1 after the entry number, unless same again.
										_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $num & "*", 0)
										;GUICtrlSetBkColor($lne, $lescol)
										If $currval > $prevval Then
											; Current value is greater than last recorded value.
											_FileWriteLog($logfile, "Price (higher) = " & $current, -1)
											$dif = "higher"
											$result = $currval - $prevval
											If $sweetval = "" Then
												If $result > $alert Then
													; Orange (major more)
													GUICtrlSetBkColor($lne, $morcol)
												Else
													; Blue (0x00A0F0)
													; Yellow (minor)
													GUICtrlSetBkColor($lne, $mincol)
												EndIf
											Else
												; White (sweet)
												GUICtrlSetBkColor($lne, $swecol)
											EndIf
											IniWrite($usertmp, $ASIN, "changed", "-" & $result)
										Else
											; Current value is lower than last recorded value.
											_FileWriteLog($logfile, "Price (lower) = " & $current, -1)
											$dif = "lower"
											$result = $prevval - $currval
											If $sweetval = "" Then
												If $result > $alert Then
													; Green (major less)
													GUICtrlSetBkColor($lne, $lescol)
												Else
													; Blue (0x00A0F0)
													; Yellow (minor)
													GUICtrlSetBkColor($lne, $mincol)
												EndIf
											Else
												; White (sweet)
												GUICtrlSetBkColor($lne, $swecol)
											EndIf
											IniWrite($usertmp, $ASIN, "changed", $result)
										EndIf
										; Change price difference value to dollars and cents & create a Report entry.
										GetPriceDifferenceResult()
										$report = $report & $title & " (" & $dif & " by " & $curr & $result & ")" & @LF
										If $record = 1 And $store = 1 Then
											; If enabled, add as a price change record for ebook.
											GetAllChanges()
											$changes &= $current & " (" & $curr & $result & " " & $dif & ") " & $now & " (Last)"
											If $prices = 1 Then
												_FileCreate($prcfle)
												FileWrite($prcfle, $changes)
											Else
												IniWrite($catfle, $ASIN, "changes", $changes)
											EndIf
										EndIf
									Else
										; No change in price (same as last query).
									EndIf
								Else
									; Change in price to same as lowest or highest on record.
									If $currval = $lowval Then
										; Current value is lower than last recorded value.
										_FileWriteLog($logfile, "Price (lowest) = " & $current, -1)
										$dif = "lower"
										$result = $prevval - $currval
										If $sweetval = "" Then
											If $result > $alert Then
												; Green (major less)
												GUICtrlSetBkColor($lne, $lescol)
											Else
												; Blue (0x00A0F0)
												; Yellow (minor)
												GUICtrlSetBkColor($lne, $mincol)
											EndIf
										Else
											; White (sweet)
											GUICtrlSetBkColor($lne, $swecol)
										EndIf
										IniWrite($usertmp, $ASIN, "changed", $result)
									ElseIf $currval = $highval Then
										; Current value is greater than last recorded value.
										_FileWriteLog($logfile, "Price (highest) = " & $current, -1)
										$dif = "higher"
										$result = $currval - $prevval
										If $sweetval = "" Then
											If $result > $alert Then
												; Orange (major more)
												GUICtrlSetBkColor($lne, $morcol)
											Else
												; Blue (0x00A0F0)
												; Yellow (minor)
												GUICtrlSetBkColor($lne, $mincol)
											EndIf
										Else
											; White (sweet)
											GUICtrlSetBkColor($lne, $swecol)
										EndIf
										IniWrite($usertmp, $ASIN, "changed", "-" & $result)
									EndIf
									; Change price difference value to dollars and cents & create a Report entry.
									GetPriceDifferenceResult()
									$report = $report & $title & " (" & $dif & " by " & $curr & $result & " from last change)(" & StringReplace($dif, "er", "est)") & @LF
									If $record = 1 And $store = 1 Then
										; If enabled, add as a price change record for ebook.
										GetAllChanges()
										$changes &= $current & " (" & $curr & $result & " " & $dif & ") " & $now & " (Last)"
										If $prices = 1 Then
											_FileCreate($prcfle)
											FileWrite($prcfle, $changes)
										Else
											IniWrite($catfle, $ASIN, "changes", $changes)
										EndIf
									EndIf
								EndIf
							EndIf
						Else
							If StringTrimLeft($prev, 1) <> "0.00" Then CheckIfLowIsZero()
							; No change in price (same as last). Check if previous query reported an error (now not) or Asterisks were cleared.
							If IniRead($usertmp, $ASIN, "error", "") = "" And IniRead($usertmp, $ASIN, "changed", "") = "" Then
								; No stored change or error found (Asterisks & Hashes may have been wiped), so proceed with further checks.
								$prev = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 8)
								If $prev <> $current Then
									; Asterisk or Hash found in Listview entry.
									; Restore to normal price (no Asterisk or Hash).
									_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current, 8)
									; Restore line color.
									; $lne is a different value to elsewhere, as it is based on $lowid and not Index, so colors are swapped.
									If IsInt($lne / 2) = 1 Then
										; Pale Green (alternate odd number lines)
										GUICtrlSetBkColor($lne, 0xC0F0C0)
									Else
										; Pale Pink (alternate even number lines)
										GUICtrlSetBkColor($lne, 0xF0D0F0)
									EndIf
								EndIf
							EndIf
						EndIf
						If $timer = 1 Then GetQueryTimeTaken()
					ElseIf $price <> "" Then
						MsgBox(262192, "Price Error", "The leading currency sign is missing!", 0, $PriceQueryGUI)
					EndIf
				EndIf
				;IniWrite($inifle, "Time Taken", "get_change", _NowTime(5))
			EndIf
		Else
			Local $nosplash = ""
			If $paid = "" Then
				$favorite = IniRead($catfle, $ASIN, "favorite", "")
				$secondary = IniRead($catfle, $ASIN, "secondary", "")
				If $favorites = 1 Then
					If $favorite = 1 Then
						SplashTextOn("", "Skipping - Marked!", 200, 120, -1, -1, 33)
					Else
						$nosplash = 1
					EndIf
				ElseIf $secondfavs = 1 Then
					If $secondary = 1 Then
						SplashTextOn("", "Skipping - Marked!", 200, 120, -1, -1, 33)
					Else
						$nosplash = 1
					EndIf
				Else
					If $favorite <> 1 And $secondary <> 1 Then
						SplashTextOn("", "Skipping - Marked!", 200, 120, -1, -1, 33)
					Else
						$nosplash = 1
					EndIf
				EndIf
			Else
				SplashTextOn("", "Skipping - Bought!", 200, 120, -1, -1, 33)
			EndIf
			If $nosplash = "" Then
				Sleep(1500)
				If $flash = 1 Then
					SplashOff()
				Else
					SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
				EndIf
			EndIf
		EndIf
	EndIf
EndFunc ;=> QueryCurrentPrice

Func QueryNonFavorites()
	;MsgBox(262192, "Error Check", $others, 0)
	If $others = 4 Then
		$others = 1
		;GUICtrlSetState($Item_others, $GUI_CHECKED)
		$quall = 1
		GUICtrlSetState($Checkbox_quall, $GUI_CHECKED)
		GUICtrlSetState($Checkbox_qufav, $GUI_DISABLE)
		If $msg = $Item_others Then
			;GUICtrlSetState($Item_others, $GUI_CHECKED)
			GUICtrlSetState($Checkbox_nofav, $GUI_ENABLE)
			GUICtrlSetState($Checkbox_nofav, $GUI_CHECKED)
			If $instant = 1 Then
				$nons = 1
			Else
				$ans = MsgBox(262177, "Non Favorites Query", _
					"Do you wish to Query now?" & @LF & @LF & _
					"NOTE - This option also works in" & @LF & _
					"conjunction with any First & Last" & @LF & _
					"settings, so some non-favorites" & @LF & _
					"may be skipped.", 0, $PriceQueryGUI)
				If $ans = 1 Then
					$nons = 1
				EndIf
			EndIf
		EndIf
		;GUICtrlSetState($Item_start, $GUI_ENABLE)
		;GUICtrlSetState($Item_end, $GUI_ENABLE)
		If $favorites = 1 Or $secondfavs = 1 Then
			$favorites = ""
			$secondfavs = ""
			GUICtrlSetState($Checkbox_qufav, $GUI_UNCHECKED)
		EndIf
		GUICtrlSetData($Button_query, "QUERY" & @LF & "NONS")
	Else
		$others = 4
		;GUICtrlSetState($Item_others, $GUI_UNCHECKED)
		If $msg = $Item_others Then
			;GUICtrlSetState($Item_others, $GUI_UNCHECKED)
			GUICtrlSetState($Checkbox_nofav, $GUI_UNCHECKED)
		EndIf
		GUICtrlSetState($Checkbox_qufav, $GUI_ENABLE)
		GUICtrlSetData($Button_query, "QUERY" & @LF & "ALL")
	EndIf
EndFunc ;=> QueryNonFavorites

Func RemoveAllFromQueryList()
	SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
	$multi = 1
	$selected = 0
	$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
	GUICtrlSetState($Listview_ebooks, $GUI_FOCUS)
	Send("{HOME}")
	_GUICtrlListView_SetItemSelected($Listview_ebooks, 0, True, True)
	If $slick = 1 Then
		GUISetState($PriceQueryGUI, @SW_DISABLE + @SW_LOCK)
		_GUICtrlListView_BeginUpdate($Listview_ebooks)
	EndIf
	For $e = 1 To $nums
		$ind = $e - 1
		If $selected = 0 Or $ind >= $selected Then
			_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
			_GUICtrlListView_EnsureVisible($Listview_ebooks, $ind, False)
			;
			GetTheASIN()
			If StringInStr($list, $ASIN) > 0 Then
				RestoreLineColor()
			EndIf
		EndIf
	Next
	If $slick = 1 Then
		_GUICtrlListView_EndUpdate($Listview_ebooks)
		GUISetState($PriceQueryGUI, @SW_ENABLE + @SW_UNLOCK)
	EndIf
	$multi = ""
	$indx = ""
	$list = ""
	SplashOff()
EndFunc ;=> RemoveAllFromQueryList

Func RemoveSelectedEbook()
	; Renamed on JB Wishlist to - RemoveSelectedItem()
	; NOTE - It is important that $multi = "" or list item selection doesn't work after a delete.
	_GUICtrlListView_DeleteItem($Listview_ebooks, $ind)
	GUICtrlSetData($Combo_comm, "", "")
	IniDelete($catfle, $ASIN)
	_FileWriteLog($logfile, "REMOVED = " & $ASIN, -1)
	_FileWriteLog($logfile, "Title = " & $title, -1)
	_FileWriteLog($logfile, "Author = " & $author, -1)
	_FileWriteLog($logfile, "User = " & $user, -1)
	FileWriteLine($logfile, "")
	If $shut = 1 Then Return
	;
	$indx = ""
	$nums = _GUICtrlListView_GetItemCount($Listview_ebooks)
	If $resort = 1 And $nums > 0 Then
		If $ind > 0 Then $indx = $ind - 1
		If $slick = 1 Then
			GUISetState($PriceQueryGUI, @SW_DISABLE + @SW_LOCK)
			_GUICtrlListView_BeginUpdate($Listview_ebooks)
		EndIf
		_GUICtrlListView_DeleteAllItems($Listview_ebooks)
		SortByColumnNumber()
		If $slick = 1 Then
			_GUICtrlListView_EndUpdate($Listview_ebooks)
			GUISetState($PriceQueryGUI, @SW_ENABLE + @SW_UNLOCK)
		EndIf
		$indx = ""
	Else
		If $nums > 0 Then
			If $slick = 1 Then
				GUISetState($PriceQueryGUI, @SW_DISABLE + @SW_LOCK)
				_GUICtrlListView_BeginUpdate($Listview_ebooks)
			EndIf
			For $e = 1 To $nums
				$ind = $e - 1
				$num = StringRight("000" & $e, 4)
				$start = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 4)
				$current = _GUICtrlListView_GetItemText($Listview_ebooks, $ind, 8)
				If $current <> $start Then $num = $num & "*"
				_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $num, 0)
			Next
			If $slick = 1 Then
				_GUICtrlListView_EndUpdate($Listview_ebooks)
				GUISetState($PriceQueryGUI, @SW_ENABLE + @SW_UNLOCK)
			EndIf
			$ind = 0
		Else
			$ind = -1
		EndIf
		GetSetCurrentStateAfterChanges()
	EndIf
	GUICtrlSetData($Group_list, "List Of Kindle Ebooks  (" & $nums & ")")
EndFunc ;=> RemoveSelectedEbook

Func RemoveSelectedFromQueryList($from)
	If $from = "image" Then GUISwitch($PriceQueryGUI)
	If StringInStr($list, $ASIN) > 0 Then
		$list = StringReplace($list, $ASIN & "|", "")
		If $list = "" Then
			GUICtrlSetData($Button_query, "QUERY")
			DisableListChoices()
		EndIf
	EndIf
	$lne = $lowid + $ind + 1
	If IsInt($lne / 2) = 1 Then
		; Pale Green
		GUICtrlSetBkColor($lne, 0xC0F0C0)
	Else
		; Pale Pink (alternate lines)
		GUICtrlSetBkColor($lne, 0xF0D0F0)
	EndIf
	If $from = "image" Then GUISwitch($ImageGUI)
EndFunc ;=> RemoveSelectedFromQueryList

Func RemoveSpacesFromPrice($key, $value)
	; Removing spaces from prices (convoluted because of how INI processing handles spaces)
	;IniWrite($catfle, $ASIN, $key, StringStripWS($value, 8))
;~ 	$value = StringReplace($value, " ", "")
;~ 	$reps = @extended
;~ 	MsgBox(262192, "$value", "'" & $value & "'", 0)
;~ 	MsgBox(262192, "@extended", $reps, 0)
;~ 	If $reps > 0 Then
;~ 		$replaced = $replaced + $reps
;~ 		IniWrite($catfle, $ASIN, $key, $value)
;~ 	EndIf
	$value = StringStripWS($value, 8)
	;IniWrite($catfle, $ASIN, $key, $value)
	IniWrite($tmpfle, $ASIN, $key, $value)
	Return $value
EndFunc ;=> RemoveSpacesFromPrice

Func ReportForQuery()
	;$ans = MsgBox(262707, "Query Report  (" & $checktot & ")", _
	$ans = MsgBox(262707, "Query Report  (" & $realtot & ")", _
		"Some prices have changed since being added to the database." & @LF & @LF & _
		$reportmsg & $timechk & @LF & @LF & _
		"YES = Copy full result to the clipboard." & @LF & _
		"NO = See full result in temporary text file." & @LF & _
		"CANCEL = Continue or Exit.", 0, $PriceQueryGUI)
	If $ans <> 2 Then
		If $ans = 6 Then
			ClipPut($report)
		ElseIf $ans = 7 Then
			If FileExists($repfle) Then Run($notepad & $repfle)
		EndIf
	EndIf
EndFunc ;=> ReportForQuery

Func ResetQueryAssignments()
	If $first <> "" Then
		$first = ""
		;GUICtrlSetState($Item_start, $GUI_UNCHECKED)
	EndIf
	If $end <> "" Then
		$end = ""
		;GUICtrlSetState($Item_end, $GUI_UNCHECKED)
	EndIf
EndFunc ;=> ResetQueryAssignments

Func RestoreFromQueryBackup()
	; Check added for those items that were skipped during a Query. 10 March 2016.
	IniReadSection($querybak, $ASIN)
	If Not @error Then
		$low = IniRead($querybak, $ASIN, "low", "")
		If $low <> "" Then
			IniWrite($catfle, $ASIN, "low", $low)
			_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $low, 5)
			$high = IniRead($querybak, $ASIN, "high", "")
			If $high <> "" Then
				IniWrite($catfle, $ASIN, "high", $high)
				_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $high, 6)
				$current = IniRead($querybak, $ASIN, "current", "")
				If $current <> "" Then
					IniWrite($catfle, $ASIN, "current", $current)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $current, 8)
					$last = IniRead($querybak, $ASIN, "last", "")
					IniWrite($catfle, $ASIN, "last", $last)
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $last, 7)
					;
					$query = IniRead($querybak, $ASIN, "query", "")
					IniWrite($catfle, $ASIN, "query", $query)
					$previous = IniRead($querybak, $ASIN, "previous", "")
					IniWrite($catfle, $ASIN, "previous", $previous)
					$changes = IniRead($querybak, $ASIN, "changes", "")
					If $prices = 1 Then
						_FileCreate($prcfle)
						FileWrite($prcfle, $changes)
					Else
						IniWrite($catfle, $ASIN, "changes", $changes)
					EndIf
					$previous = IniRead($querybak, $ASIN, "changed", "")
					IniWrite($catfle, $ASIN, "changed", $previous)
				Else
					$missing = $missing + 1
					SplashTextOn("", "Current Missing! " & $ind + 1, 200, 120, -1, -1, 33)
					Sleep(250)
				EndIf
			Else
				$missing = $missing + 1
				SplashTextOn("", "High Missing! " & $ind + 1, 200, 120, -1, -1, 33)
				Sleep(250)
			EndIf
		Else
			$missing = $missing + 1
			SplashTextOn("", "Low Missing! " & $ind + 1, 200, 120, -1, -1, 33)
			Sleep(250)
		EndIf
	EndIf
EndFunc ;=> RestoreFromQueryBackup

Func RestoreLineColor()
	$lne = $lowid + $ind + 1
	If IsInt($lne / 2) = 1 Then
		; Pale Pink (alternate lines)
		GUICtrlSetBkColor($lne, 0xF0D0F0)
	Else
		; Pale Green
		GUICtrlSetBkColor($lne, 0xC0F0C0)
		;GUICtrlSetBkColor($lne, 0x000000)
	EndIf
	;MsgBox(262192, "$ASIN $lne", $ASIN & @LF & $lne, 0)
EndFunc ;=> RestoreLineColor

Func RestorePreQuerySlotValues()
	$rec = $slots
	While 1
		$exist = IniRead($querybak, "Last Query Result - " & $user, $rec, "")
		IniWrite($inifle, "Last Query Result - " & $user, $rec, $exist)
		$rec = $rec - 1
		If $rec = 0 Then ExitLoop
	WEnd
EndFunc ;=> RestorePreQuerySlotValues

Func SaveReportToFile()
	; Save Report to a temporary text file.
	_FileCreate($repfle)
	$report = StringReplace($report, @LF, @CRLF)
	_FileWriteToLine($repfle, 1, _Now() & @CRLF & $report & @CRLF & $timechk, 1)
EndFunc ;=> SaveReportToFile

Func SelectedEntryDetailText()
	GetSelectedIndex("detail")
	If $ind <> -1 Then
		While 1
			GetDetailReport()
			$URL = IniRead($catfle, $ASIN, "url", "")
			$report = $report & "URL = " & $URL & @LF & @LF
			;$comment = IniRead($catfle, $ASIN, "comment", "")
			$comment = IniRead($comfle, $ASIN, "comment", "")
			If $comment <> "" Then
				$report = $report & "Shared Comments = " & $comment & @LF & @LF
			EndIf
			$private = IniRead($catfle, $ASIN, "private", "")
			If $private <> "" Then
				$report = $report & "Private Comments = " & $private & @LF & @LF
			EndIf
			If $sumfiles = 1 Then
				$sumfle = $sumfld & "\" & $ASIN & ".txt"
				If FileExists($sumfle) Then
					$summary = FileRead($sumfle)
				Else
					$summary = IniRead($catfle, $ASIN, "summary", "")
				EndIf
			Else
				$summary = IniRead($catfle, $ASIN, "summary", "")
			EndIf
			$summary = StringReplace($summary, "|", @LF)
			$report = $report & "Summary = " & $summary & @LF
			If $excoms = 1 Then
				If $prices = 1 Then
					$prcfle = $pricefld & "\" & $ASIN & ".txt"
					If FileExists($prcfle) Then
						$changes = FileRead($prcfle)
					Else
						$changes = IniRead($catfle, $ASIN, "changes", "")
					EndIf
				Else
					$changes = IniRead($catfle, $ASIN, "changes", "")
				EndIf
				If $changes <> "" Then $report = $report & @LF & $changes & @LF
			EndIf
			If $report <> "" Then
				;$ans = MsgBox(262465, "Selected Entry Detail", _
					$ans = MsgBox(262451, "Selected Entry Detail", _
					$report & @LF & "YES = Copy result to the clipboard.   NO = Skip to next ebook entry.   CANCEL = Return to main window.", 0, $PriceQueryGUI)
				If $ans = 6 Then
					$report = StringReplace($report, @LF, @CRLF)
					ClipPut($report)
					$ans = MsgBox(262465, "Selected Entry Detail", "Go to the next ebook entry?" _
						& @LF & @LF & "ADVICE - Relocate the detail copied to" _
						& @LF & "clipboard elsewhere before clicking OK.", 0, $PriceQueryGUI)
					If $ans = 2 Then ExitLoop
				ElseIf $ans = 7 Then
					;
				Else
					ExitLoop
				EndIf
				If $ind < ($nums - 1) Then
					$ind = $ind + 1
				Else
					$ind = 0
				EndIf
				_GUICtrlListView_SetItemSelected($Listview_ebooks, $ind, True, True)
				_GUICtrlListView_EnsureVisible($Listview_ebooks, $ind, False)
				GetTheASIN()
				$title = IniRead($catfle, $ASIN, "title", "")
				$author = IniRead($catfle, $ASIN, "author", "")
				DetermineComment()
			EndIf
		WEnd
	Else
		MsgBox(262192, "Remove Error", "No list entry is selected!", 0, $PriceQueryGUI)
	EndIf
EndFunc ;=> SelectedEntryDetailText

Func SetItemAsFavorite()
	GetSelectedIndex("")
	If $ind <> -1 Then
		$paid = IniRead($catfle, $ASIN, "bought", "")
		If $paid <> "" Then
			$favorite = ""
			$secondary = ""
			;GUICtrlSetState($Item_favorite, $GUI_DISABLE)
			MsgBox(262192, "Assign Error", "A bought book cannot be set as a favorite!", 0, $PriceQueryGUI)
		Else
			$ans = MsgBox(262177, "Favorite Query", _
				"Do you want to set/unset the entry" & @LF & _
				"as a Primary or Secondary favorite?" & @LF & @LF & _
				"OK = Primary." & @LF & _
				"CANCEL = Secondary." & @LF & @LF & _
				"NOTE - This will unset or change" & @LF & _
				"any currently set indicator.", 0, $PriceQueryGUI)
			If $ans = 1 Then
				$favorite = IniRead($catfle, $ASIN, "favorite", "")
				If $favorite = "" Then
					$favorite = 1
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, "Favorite - " & $ASIN, 2)
				Else
					$favorite = ""
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $ASIN, 2)
				EndIf
				$secondary = ""
			ElseIf $ans = 2 Then
				$secondary = IniRead($catfle, $ASIN, "secondary", "")
				If $secondary = "" Then
					$secondary = 1
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, "Secondary - " & $ASIN, 2)
				Else
					$secondary = ""
					_GUICtrlListView_SetItemText($Listview_ebooks, $ind, $ASIN, 2)
				EndIf
				$favorite = ""
			EndIf
			IniWrite($catfle, $ASIN, "favorite", $favorite)
			IniWrite($catfle, $ASIN, "secondary", $secondary)
			;
			If $favorite = 1 Or $secondary = 1 Then
				$preorder = IniRead($catfle, $ASIN, "preorder", "")
				If $preorder = 1 Then
					$preorder = ""
					IniWrite($catfle, $ASIN, "preorder", $preorder)
				EndIf
			EndIf
		EndIf
	Else
		MsgBox(262192, "Selection Error", "No list entry is selected!", 0, $PriceQueryGUI)
	EndIf
EndFunc ;=> SetItemAsFavorite

Func SetTheColumnWidths()
	_GUICtrlListView_SetColumnWidth($Listview_ebooks, 0, 40)	; No.
	_GUICtrlListView_SetColumnWidth($Listview_ebooks, 1, 220)	; Title
	_GUICtrlListView_SetColumnWidth($Listview_ebooks, 2, 85)	; MOBI-ASIN
	_GUICtrlListView_SetColumnWidth($Listview_ebooks, 3, 165)	; Author
	_GUICtrlListView_SetColumnWidth($Listview_ebooks, 4, 55)	; Start
	_GUICtrlListView_SetColumnWidth($Listview_ebooks, 5, 55)	; Low
	_GUICtrlListView_SetColumnWidth($Listview_ebooks, 6, 55)	; High
	_GUICtrlListView_SetColumnWidth($Listview_ebooks, 7, 55)	; Last
	_GUICtrlListView_SetColumnWidth($Listview_ebooks, 8, 60)	; Current
	_GUICtrlListView_SetColumn($Listview_ebooks, 0, "No.", 40, 2)
	_GUICtrlListView_SetColumn($Listview_ebooks, 1, "Title", 220, 0)
	_GUICtrlListView_SetColumn($Listview_ebooks, 2, "MOBI-ASIN", 85, 2)
	_GUICtrlListView_SetColumn($Listview_ebooks, 3, "Author", 165, 0)
	_GUICtrlListView_SetColumn($Listview_ebooks, 4, "Start", 55, 2)
	_GUICtrlListView_SetColumn($Listview_ebooks, 5, "Low", 55, 2)
	_GUICtrlListView_SetColumn($Listview_ebooks, 6, "High", 55, 2)
	_GUICtrlListView_SetColumn($Listview_ebooks, 7, "Last", 55, 2)
	_GUICtrlListView_SetColumn($Listview_ebooks, 8, "Current", 60, 2)
EndFunc ;=> SetTheColumnWidths

Func SetUsernameAndEbooks()
	IniWrite($inifle, "User", "name", $user)
	$catfle = $scriptdir & "\" & $user & ".ini"
	If $user <> "Search" And $user <> "Changed" Then
		$usertmp = $scriptdir & "\" & $user & ".tmp"
	EndIf
	$exempt = IniRead($inifle, $user, "exempt", "")
	If $exempt = "" Then
		$exempt = 4
		IniWrite($inifle, $user, "exempt", $exempt)
	EndIf
	;_GUICtrlListView_DeleteAllItems($Listview_ebooks)
	$ind = -1
	GUICtrlSetData($Combo_comm, "", "")
	;
	;FillTheListWithEbooks()
	CheckOnSortRequirement(1)
	;
	GetSaveSlots()
	$savpth = IniRead($inifle, "Last Saved List File - " & $user, "path", "")
	;
	If $user = "Search" Or $user = "Changed" Then
		;GUICtrlSetState($Item_paid, $GUI_DISABLE)
		;GUICtrlSetState($Item_favorite, $GUI_DISABLE)
		;GUICtrlSetState($Item_preorder, $GUI_DISABLE)
		;GUICtrlSetState($Item_move, $GUI_DISABLE)
		;GUICtrlSetState($Item_relocate, $GUI_DISABLE)
		;GUICtrlSetState($Item_private, $GUI_DISABLE)
		;GUICtrlSetState($Item_restore, $GUI_DISABLE)
		;GUICtrlSetState($Submenu_missing, $GUI_DISABLE)
		;
		If $user = "Search" Then
			GUICtrlSetState($Combo_find, $GUI_DISABLE)
			GUICtrlSetState($Button_find, $GUI_DISABLE)
		EndIf
		GUICtrlSetState($Button_add, $GUI_DISABLE)
		GUICtrlSetState($Button_rem, $GUI_DISABLE)
	Else
		;GUICtrlSetState($Item_paid, $GUI_ENABLE)
		;GUICtrlSetState($Item_favorite, $GUI_ENABLE)
		;GUICtrlSetState($Item_preorder, $GUI_ENABLE)
		;GUICtrlSetState($Item_move, $GUI_ENABLE)
		;GUICtrlSetState($Item_private, $GUI_ENABLE)
		;GUICtrlSetState($Item_restore, $GUI_ENABLE)
		;GUICtrlSetState($Submenu_missing, $GUI_ENABLE)
		;
		GUICtrlSetState($Combo_find, $GUI_ENABLE)
		GUICtrlSetState($Button_find, $GUI_ENABLE)
		GUICtrlSetState($Button_add, $GUI_ENABLE)
		GUICtrlSetState($Button_rem, $GUI_ENABLE)
		If StringRight($user, 4) = " (b)" Then
			;GUICtrlSetState($Item_relocate, $GUI_DISABLE)
		Else
			;GUICtrlSetState($Item_relocate, $GUI_ENABLE)
		EndIf
		GetPreviousSearches()
	EndIf
EndFunc ;=> SetUsernameAndEbooks

Func SetWinOnTop()
	If FileExists($wincheck) Then Run($wincheck & ' "' & $win & '"', $scriptdir)
EndFunc ;=> SetWinOnTop

Func ShowNoResultSplash()
	Local $mpos, $xpos, $ypos
	SplashTextOn("", '"Query Report"' & @LF & @LF & _
		"(moved mouse closes this splash)" & @LF & @LF & _
		"No price change(s) detected!", 270, 200, -1, -1, 33)
	$mpos = MouseGetPos()
	$xpos = $mpos[0]
	$ypos = $mpos[1]
	Sleep(1500)
	While 1
		$mpos = MouseGetPos()
		If $xpos <> $mpos[0] Or $ypos <> $mpos[1] Then
			SplashOff()
			ExitLoop
		EndIf
		Sleep(500)
	WEnd
EndFunc ;=> ShowNoResultSplash

Func SortByColumnNumber()
	Local $allents, $section
	If FileExists($catfle) Then
		IniWrite($inifle, "Fill List With Sort", "start", _Now())
		$begin = TimerInit()
		;$ents = IniReadSectionNames($catfle)
		;	; NOTE - Limit for IniReadSectionNames is 32767 characters.
		;	$nmb = StringLen(_ArrayToString($ents, "|", 1))
		;	MsgBox(262192, "Character Count", $nmb & " characters in Section Names!", 0, $PriceQueryGUI)
		$allents = FileRead($catfle)
		;$ents = StringSplit($ents, @CRLF, 1)
		$ents = StringSplit($allents, @LF & "[", 1)
		If Not @error Then
			;Local $ID = MouseGetCursor()
			GUISetCursor(15, 1, $PriceQueryGUI)
			DisableOrEnable($GUI_DISABLE)
			GUICtrlSetState($Button_query, $GUI_DISABLE)
			If $excel = 4 Then GUICtrlSetState($Checkbox_quall, $GUI_DISABLE)
			If $flash = 1 Then
				GUICtrlSetState($Label_wait, $GUI_SHOW)
			Else
				SplashTextOn("", "Please Wait!", 200, 120, -1, -1, 33)
			EndIf
			$entry = ""
			$higher = ""
			$lower = ""
			$bought = ""
			$chosen = ""
			$second = ""
			$orders = ""
			;$nums = $ents[0]
			;If $colnum <> 0 Then
			;	For $e = 1 To $nums
			;		$ASIN = $ents[$e]
			$e = 0
			$items = ""
			$lines = $ents[0]
			For $l = 1 To $lines
				$linetxt = $ents[$l] & @LF
				$ASIN = StringSplit($linetxt, "]" & @CRLF, 1)
				$ASIN = $ASIN[1]
;~ 				If StringLeft($linetxt, 1) = "[" Then
;~ 					;$ASIN = StringTrimLeft($linetxt, 1)
;~ 					;$ASIN = StringStripCR($ASIN)
;~ 					;$ASIN = StringTrimRight($ASIN, 1)
;~ 					$ASIN = StringMid($linetxt, 2)
;~ 					$pos = StringInStr($ASIN, "]")
;~ 					If $pos > 0 Then
;~ 						$ASIN = StringLeft($ASIN, $pos - 1)
;~ 					Else
;~ 						$ASIN = StringStripCR($ASIN)
;~ 						$ASIN = StringTrimRight($ASIN, 1)
;~ 					EndIf
					;MsgBox(262192, "Line Text", $ASIN, 0, $PriceQueryGUI)
					If $ASIN <> "" Then
						If $l < 6 Then
							If StringLeft($ASIN, 1) = "[" Then $ASIN = StringTrimLeft($ASIN, 1)
						EndIf
						$e = $e + 1
						If $items = "" Then
							$items = $ASIN
						Else
							$items = $items & "|" & $ASIN
						EndIf
						If $colnum <> 0 Then
;~ 							$title = IniRead($catfle, $ASIN, "title", "")
;~ 							$author = IniRead($catfle, $ASIN, "author", "")
;~ 							$start = IniRead($catfle, $ASIN, "start", "")
							$title = StringSplit($linetxt, @LF & "title=", 1)
							If $title[0] = 2 Then
								$title = $title[2]
								$title = StringSplit($title, @CRLF, 1)
								$title = $title[1]
							Else
								$title = ""
							EndIf
							$author = StringSplit($linetxt, @LF & "author=", 1)
							If $author[0] = 2 Then
								$author = $author[2]
								$author = StringSplit($author, @CRLF, 1)
								$author = $author[1]
							Else
								$author = ""
							EndIf
							$start = StringSplit($linetxt, @LF & "start=", 1)
							If $start[0] = 2 Then
								$start = $start[2]
								$start = StringSplit($start, @CRLF, 1)
								$start = $start[1]
							Else
								$start = ""
							EndIf
							;If $l > ($lines - 30) Then
							If $l > 3 Then
								If $title = "" And $author = "" And $start = "" Then
									$ans = MsgBox(262177, "Removal Query", _
										"A blank entry has been found for" & @LF & _
										"MOBI-ASIN - " & $ASIN & @LF & @LF & _
										"OK = Bypass & Remove." & @LF & _
										"CANCEL = Bypass & Ignore." & @LF & @LF & _
										"NOTE - After any removal, you" & @LF & _
										"should close this program then" & @LF & _
										"run the Fixfile shortcut.", 0, $PriceQueryGUI)
									If $ans = 1 Then
										IniDelete($catfle, $ASIN)
									EndIf
									$e = $e - 1
									ContinueLoop
								EndIf
							EndIf
							If  $colnum = 1 Then
								; Sort by Title
								;$title = IniRead($catfle, $ASIN, "title", "")
								$entry &= $title & "<\-\>" & $ASIN & "|"
							ElseIf $colnum = 2 Then
								; Sort by Bought
								;$title = IniRead($catfle, $ASIN, "title", "")
;~ 								$paid = IniRead($catfle, $ASIN, "bought", "")
;~ 								$favorite = IniRead($catfle, $ASIN, "favorite", "")
;~ 								$secondary = IniRead($catfle, $ASIN, "secondary", "")
;~ 								$preorder = IniRead($catfle, $ASIN, "preorder", "")
								$paid = StringSplit($linetxt, @LF & "bought=", 1)
								If $paid[0] = 2 Then
									$paid = $paid[2]
									$paid = StringSplit($paid, @CRLF, 1)
									$paid = $paid[1]
								Else
									$paid = ""
								EndIf
								$favorite = StringSplit($linetxt, @LF & "favorite=", 1)
								If $favorite[0] = 2 Then
									$favorite = $favorite[2]
									$favorite = StringSplit($favorite, @CRLF, 1)
									$favorite = $favorite[1]
								Else
									$favorite = ""
								EndIf
								$secondary = StringSplit($linetxt, @LF & "secondary=", 1)
								If $secondary[0] = 2 Then
									$secondary = $secondary[2]
									$secondary = StringSplit($secondary, @CRLF, 1)
									$secondary = $secondary[1]
								Else
									$secondary = ""
								EndIf
								$preorder = StringSplit($linetxt, @LF & "preorder=", 1)
								If $preorder[0] = 2 Then
									$preorder = $preorder[2]
									$preorder = StringSplit($preorder, @CRLF, 1)
									$preorder = $preorder[1]
								Else
									$preorder = ""
								EndIf
								If $paid = "" And $favorite = "" And $secondary = "" And $preorder = "" Then
									$entry &= $title & "<\-\>" & $ASIN & "|"
								ElseIf $favorite = 1 Then
									$chosen &= $title & "<\-\>" & $ASIN & "|"
								ElseIf $secondary = 1 Then
									$second &= $title & "<\-\>" & $ASIN & "|"
								ElseIf $preorder = 1 Then
									$orders &= $title & "<\-\>" & $ASIN & "|"
								Else
									$bought &= $title & "<\-\>" & $ASIN & "|"
								EndIf
							ElseIf $colnum = 3 Then
								; Sort by Author
								;$author = IniRead($catfle, $ASIN, "author", "")
								$entry &= $author & "<\-\>" & $ASIN & "|"
							ElseIf $colnum = 5 Or $colnum = 8 Then
;~ 								$current = IniRead($catfle, $ASIN, "current", "")
								$current = StringSplit($linetxt, @LF & "current=", 1)
								If $current[0] = 2 Then
									$current = $current[2]
									$current = StringSplit($current, @CRLF, 1)
									$current = $current[1]
								Else
									$current = ""
								EndIf
								If $colnum = 5 Then
									; Sort by Price Change
									;$start = IniRead($catfle, $ASIN, "start", "")
;~ 									$current = IniRead($catfle, $ASIN, "current", "")
									$current = StringReplace($current, "*", "")
									$current = StringReplace($current, "#", "")
									$current = StringReplace($current, "$", "")
									$current = StringReplace($current, $csign, "")
									$start = StringReplace($start, "*", "")
									$start = StringReplace($start, "$", "")
									$start = StringReplace($start, $csign, "")
									If $current = $start Then
										$current = StringRight("000" & $current, 7)
										$entry &= $current & "<\-\>" & $ASIN & "|"
									Else
										$current = StringRight("000" & $current, 7)
										$start = StringRight("000" & $start, 7)
										If $current < $start Then
											$lower &= $current & "<\-\>" & $ASIN & "|"
										Else
											$higher &= $current & "<\-\>" & $ASIN & "|"
										EndIf
									EndIf
								ElseIf $colnum = 8 Then
									; Sort by Current price
;~ 									$current = IniRead($catfle, $ASIN, "current", "")
									$current = StringReplace($current, "*", "")
									$current = StringReplace($current, "#", "")
									$current = StringReplace($current, "$", "")
									$current = StringReplace($current, $csign, "")
									$current = StringRight("000" & $current, 7)
									$entry &= $current & "<\-\>" & $ASIN & "|"
								EndIf
							EndIf
						EndIf
					EndIf
;~ 				EndIf
			Next
			$nums = $e
			If $entry <> "" Or $lower <> "" Or $higher <> "" Or $bought <> "" Or $chosen <> "" Or $second <> "" Or $orders <> "" Then
				;MsgBox(262192, "Arrays Check", $entry & @LF & $lower & @LF & $higher, 0, $PriceQueryGUI)
				;MsgBox(262192, "Arrays Check", "entry = " & $entry & @LF & "lower = " & $lower & @LF & "higher = " & $higher & @LF _
				;	& "second = " & $second & @LF & "orders = " & $orders & @LF & "chosen = " & $chosen & @LF & "bought = " & $bought, 0, $PriceQueryGUI)
				If $entry = "" Then
					If $bought <> "" Then
						$entry = $bought
						$bought = ""
					ElseIf $chosen <> "" Then
						$entry = $chosen
						$chosen = ""
					ElseIf $orders <> "" Then
						$entry = $orders
						$orders = ""
					ElseIf $second <> "" Then
						$entry = $second
						$second = ""
					ElseIf $lower = "" Then
						$entry = $higher
						$higher = ""
					Else
						$entry = $lower
						$lower = ""
					EndIf
				EndIf
				$entry = StringTrimRight($entry, 1)
				$entry = StringSplit($entry, "|", 1)
				_ArraySort($entry, 0, 1)
				If $lower <> "" Then
					$lower = StringTrimRight($lower, 1)
					$lower = StringSplit($lower, "|", 1)
					_ArraySort($lower, 0, 1)
					;_ArrayConcatenate($lower, $entry)
					$lower = _ArrayToString($lower, "|", 1)
					$entry = _ArrayToString($entry, "|", 1)
					$entry = StringSplit($lower & "|" & $entry, "|", 1)
				EndIf
				If $higher <> "" Then
					$higher = StringTrimRight($higher, 1)
					$higher = StringSplit($higher, "|", 1)
					_ArraySort($higher, 0, 1)
					;_ArrayConcatenate($entry, $higher)
					$higher = _ArrayToString($higher, "|", 1)
					$entry = _ArrayToString($entry, "|", 1)
					$entry = StringSplit($entry & "|" & $higher, "|", 1)
				EndIf
				If $second <> "" Then
					$second = StringTrimRight($second, 1)
					$second = StringSplit($second, "|", 1)
					_ArraySort($second, 0, 1)
					$second = _ArrayToString($second, "|", 1)
					$entry = _ArrayToString($entry, "|", 1)
					$entry = StringSplit($second & "|" & $entry, "|", 1)
				EndIf
				If $orders <> "" Then
					$orders = StringTrimRight($orders, 1)
					$orders = StringSplit($orders, "|", 1)
					_ArraySort($orders, 0, 1)
					$orders = _ArrayToString($orders, "|", 1)
					$entry = _ArrayToString($entry, "|", 1)
					$entry = StringSplit($orders & "|" & $entry, "|", 1)
				EndIf
				If $chosen <> "" Then
					$chosen = StringTrimRight($chosen, 1)
					$chosen = StringSplit($chosen, "|", 1)
					_ArraySort($chosen, 0, 1)
					;_ArrayDisplay($chosen)
					$chosen = _ArrayToString($chosen, "|", 1)
					$entry = _ArrayToString($entry, "|", 1)
					$entry = StringSplit($chosen & "|" & $entry, "|", 1)
					;_ArrayDisplay($entry)
				EndIf
				If $bought <> "" Then
					$bought = StringTrimRight($bought, 1)
					$bought = StringSplit($bought, "|", 1)
					_ArraySort($bought, 0, 1)
					$bought = _ArrayToString($bought, "|", 1)
					$entry = _ArrayToString($entry, "|", 1)
					$entry = StringSplit($bought & "|" & $entry, "|", 1)
				EndIf
				;MsgBox(262192, "Arrays Check", $entry[0])
				;_ArrayDisplay($entry)
			EndIf
			$ents = StringSplit($items, "|", 1)
			For $s = 1 To $nums
				$num = StringRight("000" & $s, 4)
				$lne = $num
				$asterisk = ""
				$hash = ""
				If $entry = "" Then
					; Sort by original add order
					$ASIN = $ents[$s]
					;MsgBox(262192, "$ASIN", $ASIN)
				Else
					; Sort by Title, Author or Current price
					$ASIN = $entry[$s]
					$ASIN = StringSplit($ASIN, "<\-\>", 1)
					$ASIN = $ASIN[2]
					;MsgBox(262192, "$ASIN", $ASIN, 0.3, $PriceQueryGUI)
				EndIf
				$section = StringSplit($allents, "[" & $ASIN & "]", 1)
				If $section[0] = 2 Then
					$section = $section[2]
					$section = StringSplit($section, @LF & "[", 1)
					$section = $section[1] & @LF
					$title = StringSplit($section, @LF & "title=", 1)
					If $title[0] = 2 Then
						$title = $title[2]
						$title = StringSplit($title, @CRLF, 1)
						$title = $title[1]
					Else
						$title = ""
					EndIf
					$start = StringSplit($section, @LF & "start=", 1)
					If $start[0] = 2 Then
						$start = $start[2]
						$start = StringSplit($start, @CRLF, 1)
						$start = $start[1]
					Else
						$start = ""
					EndIf
					$low = StringSplit($section, @LF & "low=", 1)
					If $low[0] = 2 Then
						$low = $low[2]
						$low = StringSplit($low, @CRLF, 1)
						$low = $low[1]
					Else
						$low = ""
					EndIf
					$high = StringSplit($section, @LF & "high=", 1)
					If $high[0] = 2 Then
						$high = $high[2]
						$high = StringSplit($high, @CRLF, 1)
						$high = $high[1]
					Else
						$high = ""
					EndIf
					$last = StringSplit($section, @LF & "last=", 1)
					If $last[0] = 2 Then
						$last = $last[2]
						$last = StringSplit($last, @CRLF, 1)
						$last = $last[1]
					Else
						$last = ""
					EndIf
					$current = StringSplit($section, @LF & "current=", 1)
					If $current[0] = 2 Then
						$current = $current[2]
						$current = StringSplit($current, @CRLF, 1)
						$current = $current[1]
					Else
						$current = ""
					EndIf
				Else
					$section = ""
					$title = IniRead($catfle, $ASIN, "title", "")
					$start = IniRead($catfle, $ASIN, "start", "")
					$low = IniRead($catfle, $ASIN, "low", "")
					$high = IniRead($catfle, $ASIN, "high", "")
					$last = IniRead($catfle, $ASIN, "last", "")
					$current = IniRead($catfle, $ASIN, "current", "")
				EndIf
				If $last = "" Then
					If $current <> "" Then
						$last = $current
						IniWrite($catfle, $ASIN, "last", $last)
						;IniWrite($catfle, $ASIN, "bozo", $last)
					EndIf
				EndIf
				If $current <> $start Then $num = $num & "*"
				If $section = "" Then
					$author = IniRead($catfle, $ASIN, "author", "")
				Else
					$author = StringSplit($section, @LF & "author=", 1)
					If $author[0] = 2 Then
						$author = $author[2]
						$author = StringSplit($author, @CRLF, 1)
						$author = $author[1]
					Else
						$author = ""
					EndIf
				EndIf
				;If IniRead($usertmp, $ASIN, "changed", "") = 1 Then
				$result = IniRead($usertmp, $ASIN, "changed", "")
				If $result <> "" Then
					$currval = GetValueForPrice($current)
					$current = $current & "*"
					$asterisk = 1
				ElseIf IniRead($usertmp, $ASIN, "error", "") = 1 Then
					$current = $current & "#"
					$hash = 1
				ElseIf $test = 1 Then
					; Testing only (should be anyway)
					If StringRight($current, 1) = "*" Then
						$asterisk = 1
					ElseIf StringRight($current, 1) = "#" Then
						$hash = 1
					EndIf
				EndIf
				If $section = "" Then
					$skipit = IniRead($catfle, $ASIN, "skip", "")
					$paid = IniRead($catfle, $ASIN, "bought", "")
					$favorite = IniRead($catfle, $ASIN, "favorite", "")
					$secondary = IniRead($catfle, $ASIN, "secondary", "")
					$preorder = IniRead($catfle, $ASIN, "preorder", "")
				Else
					$skipit = StringSplit($section, @LF & "skip=", 1)
					If $skipit[0] = 2 Then
						$skipit = $skipit[2]
						$skipit = StringSplit($skipit, @CRLF, 1)
						$skipit = $skipit[1]
					Else
						$skipit = ""
					EndIf
					$paid = StringSplit($section, @LF & "bought=", 1)
					If $paid[0] = 2 Then
						$paid = $paid[2]
						$paid = StringSplit($paid, @CRLF, 1)
						$paid = $paid[1]
					Else
						$paid = ""
					EndIf
					$favorite = StringSplit($section, @LF & "favorite=", 1)
					If $favorite[0] = 2 Then
						$favorite = $favorite[2]
						$favorite = StringSplit($favorite, @CRLF, 1)
						$favorite = $favorite[1]
					Else
						$favorite = ""
					EndIf
					$secondary = StringSplit($section, @LF & "secondary=", 1)
					If $secondary[0] = 2 Then
						$secondary = $secondary[2]
						$secondary = StringSplit($secondary, @CRLF, 1)
						$secondary = $secondary[1]
					Else
						$secondary = ""
					EndIf
					$preorder = StringSplit($section, @LF & "preorder=", 1)
					If $preorder[0] = 2 Then
						$preorder = $preorder[2]
						$preorder = StringSplit($preorder, @CRLF, 1)
						$preorder = $preorder[1]
					Else
						$preorder = ""
					EndIf
				EndIf
				If $paid <> "" Then $ASIN = "Bought - " & $ASIN
				If $favorite = 1 Then $ASIN = "Favorite - " & $ASIN
				If $secondary = 1 Then $ASIN = "Secondary - " & $ASIN
				If $preorder = 1 Then $ASIN = "Pre-Order - " & $ASIN
				If $slick = 1 Then
					GUICtrlCreateListViewItem("||||||||", $Listview_ebooks)
					GUICtrlSetData($lowid + $s, $num & "|" & $title & "|" & $ASIN & "|" & $author & "|" & $start & "|" & $low & "|" & $high & "|" & $last & "|" & $current)
					;If $s = 1 Then MsgBox(262192, "$lowid", $lowid)
				Else
					GUICtrlCreateListViewItem($num & "|" & $title & "|" & $ASIN & "|" & $author & "|" & $start & "|" & $low & "|" & $high & "|" & $last & "|" & $current, $Listview_ebooks)
				EndIf
				;MsgBox(262192, $Listview_ebooks, $lowid + $s)
				If $asterisk = 1 Then
					; Green
					;GUICtrlSetBkColor(-1, $lescol)
					; Dark Blue
					;GUICtrlSetBkColor(-1, 0x00A0F0)
					; Yellow (minor)
					;GUICtrlSetBkColor(-1, $mincol)
					GetSetCorrectLineColor(-1)
				ElseIf $hash = 1 Then
					; Red (error)
					GUICtrlSetBkColor(-1, $errcol)
				ElseIf $skipit = 1 Then
					; Dark Pink (skip)
					GUICtrlSetBkColor(-1, $skicol)
				ElseIf IsInt($lne / 2) = 1 Then
					; Pale Pink (alternate lines)
					GUICtrlSetBkColor(-1, 0xF0D0F0)
				EndIf
			Next
			$ind = 0
			;
			If $flash = 1 Then
				GUICtrlSetState($Label_wait, $GUI_HIDE)
			Else
				SplashOff()
			EndIf
			DisableOrEnable($GUI_ENABLE)
			If $excel = 4 Then GUICtrlSetState($Checkbox_quall, $GUI_ENABLE)
			GUICtrlSetState($Button_query, $GUI_ENABLE)
			GUISetCursor($ID, 1, $PriceQueryGUI)
		Else
			$ind = -1
		EndIf
		GetSetCurrentStateAfterChanges()
		$diff = TimerDiff($begin)
		IniWrite($inifle, "Fill List With Sort", "end", _Now())
		IniWrite($inifle, "Fill List With Sort", "taken", $diff)
		$diff = Round($diff / 1000, 1)
		IniWrite($inifle, "Fill List With Sort", "taken_secs", $diff)
		IniWrite($inifle, "Fill List With Sort", "user", $user)
		IniWrite($inifle, "Fill List With Sort", "entries", $nums)
	EndIf
EndFunc ;=> SortByColumnNumber

Func StopCheck()
;~ 	$msg = GUIGetMsg()
;~ 	If $msg = $Button_query Then
;~ 		GUICtrlSetState($Button_query, $GUI_DISABLE)
;~ 		GUICtrlSetData($Button_query, "WAIT")
;~ 		$quit = 1
;~ 	ElseIf $flash = 1 And $rate > 0 Then
	If $flash = 1 And $rate > 0 Then
		If $passes = $rate Then
			$passes = 0
			If $waitcol = 0xF00000 Then
				$waitcol = 0x00F000
			Else
				$waitcol = 0xF00000
			EndIf
			GUICtrlSetColor($Label_wait, $waitcol)
		EndIf
		$passes = $passes + 1
	EndIf
	If $timer = 1 Then
		If $up = "" Then
			$up = 1
			GetQueryTimeTaken()
		ElseIf $up = 1 Then
			$up = ""
		EndIf
	EndIf
;~ 	If $mode = "semi-auto" Then
;~ 		; Check for END key held down.
;~ 		;If _IsPressed("23", $dll) Then
;~ 		; Check for PAUSE key held down.
;~ 		If _IsPressed("13", $dll) Then
;~ 			SplashTextOn("", "Stopping!", 200, 120, -1, -1, 33)
;~ 			GUICtrlSetState($Button_query, $GUI_DISABLE)
;~ 			GUICtrlSetData($Button_query, "WAIT")
;~ 			$quit = 1
;~ 		EndIf
;~ 		; NOTE - Perhaps add a query prompt to quit for the above.
;~ 	EndIf
EndFunc ;=> StopCheck

Func StoreInitialPrices()
	$start = $price
	IniWrite($catfle, $ASIN, "start", $start)
	$low = $price
	IniWrite($catfle, $ASIN, "low", $low)
	$high = $price
	IniWrite($catfle, $ASIN, "high", $high)
	$current = $price
	IniWrite($catfle, $ASIN, "current", $current)
	$last = $price
	IniWrite($catfle, $ASIN, "last", $last)
	$prev = $price
EndFunc ;=> StoreInitialPrices

Func TidyUpSummary()
	If $summary = "" Then
		If $publisher <> "" Then
			$summary = StringStripWS($publisher, 7)
		EndIf
	Else
		$check = StringSplit($chars, "|")
		;For $c = 1 To $check[0]
		For $c = 3 To ($check[0] - 1)
			$char = StringSplit($check[$c], ":")
			If $char[0] = 2 Then
				$replace = $char[2]
			Else
				$replace = ""
			EndIf
			$char = $char[1]
			$summary = StringReplace($summary, $char, $replace)
		Next
		$summary = StringStripWS($summary, 7)
		$summary = StringReplace($summary, "| |", "||")
;~ 		$summary = StringReplace($summary, "|||", "||")
;~ 		$summary = StringReplace($summary, "|||", "||")
		Do
			;$summary = StringRegExpReplace($summary, "(?:\|\s\||\|{3})", "||")
			$summary = StringReplace($summary, "|||", "||")
		Until @extended = 0
		;
		If $publisher <> "" Then
			$summary = StringStripWS($publisher, 7) & "|" & $summary
		EndIf
		; NOTES on StringRegExpReplace - the pipe is a special character, being escaped using the backslash
		; to be processed as a pipe. So \|\s\| = pipe space pipe pattern. The next pipe is an OR statement.
		; \|{3} = replace any three pipes pattern. ?: = treat as a normal group, except non capturing (which
		; I do not understand really ... need to research further).
		;
		If $blanks = 1 Then $summary = StringReplace($summary, "||", "|")
		While StringLeft($summary, 1) = "|"
			$summary = StringTrimLeft($summary, 1)
		WEnd
		While StringRight($summary, 1) = "|"
			$summary = StringTrimRight($summary, 1)
		WEnd
	EndIf
	If $summary <> "" Then
		If $sumfiles = 1 Then
			$sumfle = $sumfld & "\" & $ASIN & ".txt"
			_FileCreate($sumfle)
			FileWrite($sumfle, $summary)
		Else
			IniWrite($catfle, $ASIN, "summary", $summary)
		EndIf
		$summary = ""
	EndIf
EndFunc ;=> TidyUpSummary

Func TimeCheck()
	GetQueryTimeTaken()
EndFunc ;=> TimeCheck

Func TryToActivateAmazonTab()
	If WinExists("Amazon.com", "") Then
		; Easy Peasie No Problemo unless an unrelated Amazon window or tab is open.
		WinActivate("Amazon.com", "")
	Else
		; Sometimes the title of an Amazon Ebook browser tab, does not start with Amazon.com
		If WinExists($original, "") Then
			; Easy Peasie No Problemo.
			WinActivate($original, "")
		Else
			; So not so Easy Peasie and may be tricky, with problems where multiple matching tab titles exist.
			; We also may have problems with a very short name (less than three characters).
			If StringLeft($original, 4) = "The " Then
				; Using the first seven characters from ebook title, so something like 'The Cab' will work.
				$wintit = StringLeft($original, 7)
				WinActivate($wintit, "")
				$wintit = StringTrimLeft($wintit, 4)
				WinActivate($wintit, "")
			Else
				; Using the first four characters from ebook title, so something like 'Barn' will work.
				$wintit = StringLeft($original, 4)
				WinActivate($wintit, "")
			EndIf
		EndIf
	EndIf
	Sleep(500)
EndFunc ;=> TryToActivateAmazonTab

;~ Local $bakfle, $bdate, $browsers, $calc, $calc2, $comm, $compare, $compfle, $count, $currencies
;~ Local $day, $endfle, $entries, $exauthor, $exe, $extitle, $GUIActiveX, $handle, $IDNB, $idx
;~ Local $labcol, $line, $magnum, $month, $mpos, $ndate, $nmb, $note, $oExcel, $picfle, $pid, $pingmsg
;~ Local $pub, $publish, $pubyear, $r, $readerr, $resval, $script, $Selector, $Settings, $SheetArray
;~ Local $state, $status, $string, $trim, $txtfle, $u, $vals, $valued, $w, $wins, $wintitle
;~ Local $wintxt, $with, $xpos, $ypos

